<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cardiology Interactive | EMS Education</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700&family=Playfair+Display:wght@700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
  --cardiac-red:#C8102E;--arterial:#E63946;--venous:#457B9D;--oxy-red:#FF4D6D;
  --deoxy-blue:#1D3557;--ecg-green:#00FF88;--bg-dark:#0A0E17;--bg-card:#111827;
  --bg-surface:#1A2332;--text-primary:#F1F5F9;--text-secondary:#94A3B8;
  --text-muted:#64748B;--accent-gold:#FFD166;--sa-node:#FFD166;--av-node:#06D6A0;
  --bundle-his:#118AB2;--purkinje:#EF476F;--warning:#FF6B35;--success:#06D6A0;
  --ecg-paper:#1C1410;--ecg-grid-sm:rgba(180,100,80,0.18);--ecg-grid-lg:rgba(180,100,80,0.38);
  --ecg-grid-6s:rgba(200,120,90,0.55);
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{font-family:'DM Sans',sans-serif;background:var(--bg-dark);color:var(--text-primary);overflow-x:hidden;line-height:1.7;}

/* NAV */
.nav{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(10,14,23,0.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(200,16,46,0.15);padding:0 2rem;display:flex;align-items:center;justify-content:space-between;height:60px;}
.nav-brand{font-family:'Playfair Display',serif;font-weight:800;font-size:1.05rem;background:linear-gradient(135deg,var(--cardiac-red),var(--oxy-red));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.nav-links{display:flex;gap:0.2rem;overflow-x:auto;scrollbar-width:none;max-width:72vw;}
.nav-links::-webkit-scrollbar{display:none;}
.nav-link{padding:0.35rem 0.7rem;border-radius:6px;font-size:0.72rem;font-weight:500;color:var(--text-secondary);cursor:pointer;white-space:nowrap;transition:all 0.2s;text-decoration:none;border:1px solid transparent;}
.nav-link:hover,.nav-link.active{color:var(--text-primary);background:rgba(200,16,46,0.12);border-color:rgba(200,16,46,0.25);}
.progress-bar{position:fixed;top:60px;left:0;height:3px;background:linear-gradient(90deg,var(--cardiac-red),var(--oxy-red),var(--ecg-green));z-index:99;transition:width 0.3s;}

/* SECTIONS */
section{min-height:100vh;padding:90px 2rem 4rem;max-width:1200px;margin:0 auto;opacity:0;transform:translateY(30px);transition:all 0.8s cubic-bezier(0.16,1,0.3,1);}
section.visible{opacity:1;transform:translateY(0);}
.section-label{font-size:0.68rem;text-transform:uppercase;letter-spacing:3px;color:var(--cardiac-red);font-weight:700;margin-bottom:0.4rem;}
.section-title{font-family:'Playfair Display',serif;font-size:clamp(2rem,5vw,3.2rem);font-weight:900;line-height:1.15;margin-bottom:1.2rem;}
.section-title .gradient{background:linear-gradient(135deg,var(--cardiac-red),var(--oxy-red),var(--accent-gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.section-subtitle{font-size:1.05rem;color:var(--text-secondary);max-width:700px;margin-bottom:2rem;}

/* CARDS */
.card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.15rem;}
.card{background:var(--bg-card);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:1.5rem;transition:all 0.3s;position:relative;overflow:hidden;cursor:pointer;}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--cardiac-red),var(--oxy-red));opacity:0;transition:opacity 0.3s;}
.card:hover{transform:translateY(-3px);border-color:rgba(200,16,46,0.2);}
.card:hover::before{opacity:1;}
.card-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.15rem;margin-bottom:0.8rem;}
.card h3{font-size:1rem;font-weight:700;margin-bottom:0.4rem;}
.card p{font-size:0.85rem;color:var(--text-secondary);line-height:1.6;}

/* ===== ECG PAPER BACKGROUND (realistic) ===== */
.ecg-paper-bg{
  position:relative;
  background:var(--ecg-paper);
  border-radius:12px;overflow:hidden;
  border:2px solid rgba(180,100,80,0.25);
}
.ecg-paper-bg canvas{display:block;position:relative;z-index:2;}
.ecg-paper-grid{
  position:absolute;inset:0;z-index:1;
  /* We draw the grid in JS for accuracy */
}

/* ECG MONITOR FRAME */
.ecg-monitor{margin:2rem 0;position:relative;}
.ecg-monitor-header{display:flex;justify-content:space-between;align-items:center;padding:0.75rem 1.25rem;background:rgba(28,20,16,0.95);border:2px solid rgba(180,100,80,0.25);border-bottom:none;border-radius:12px 12px 0 0;}
.ecg-monitor-header .lead-label{font-family:'JetBrains Mono',monospace;font-size:0.8rem;color:rgba(180,100,80,0.7);}
.ecg-monitor-header .rate-display{font-family:'JetBrains Mono',monospace;font-size:2.2rem;font-weight:600;color:var(--ecg-green);line-height:1;}
.ecg-monitor-header .rate-display span{font-size:0.7rem;color:var(--text-muted);display:block;}
.ecg-monitor-header .rhythm-name{font-family:'JetBrains Mono',monospace;font-size:0.85rem;color:var(--ecg-green);text-align:right;}
.ecg-paper-bg.monitor-body{border-radius:0 0 12px 12px;border-top:none;}

.ecg-controls{display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:1rem;align-items:center;}
.ecg-btn{padding:0.45rem 0.85rem;border-radius:7px;font-size:0.78rem;font-weight:600;border:1px solid rgba(255,255,255,0.1);background:var(--bg-surface);color:var(--text-primary);cursor:pointer;transition:all 0.2s;font-family:'DM Sans',sans-serif;}
.ecg-btn:hover{border-color:var(--ecg-green);color:var(--ecg-green);}
.ecg-btn.active{background:rgba(6,214,160,0.15);border-color:var(--ecg-green);color:var(--ecg-green);}

/* 6-second markers */
.ecg-6s-markers{display:flex;justify-content:space-around;padding:0.3rem 1rem;font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:rgba(180,100,80,0.6);}

/* ===== MODAL / POPUP ===== */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:500;display:none;align-items:center;justify-content:center;padding:1.5rem;backdrop-filter:blur(6px);opacity:0;transition:opacity 0.3s;}
.modal-overlay.open{display:flex;opacity:1;}
.modal{background:var(--bg-card);border:1px solid rgba(200,16,46,0.2);border-radius:20px;max-width:900px;width:100%;max-height:88vh;overflow-y:auto;position:relative;animation:modalIn 0.35s cubic-bezier(0.16,1,0.3,1);}
@keyframes modalIn{from{opacity:0;transform:translateY(20px) scale(0.97);}to{opacity:1;transform:translateY(0) scale(1);}}
.modal-close{position:sticky;top:0;right:0;float:right;z-index:10;width:42px;height:42px;border-radius:50%;border:1px solid rgba(255,255,255,0.1);background:var(--bg-dark);color:var(--text-primary);font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;margin:1rem 1rem 0 0;transition:all 0.2s;}
.modal-close:hover{background:var(--cardiac-red);border-color:var(--cardiac-red);}
.modal-body{padding:0 2.5rem 2.5rem;}
.modal-body h2{font-family:'Playfair Display',serif;font-size:2rem;font-weight:900;margin-bottom:0.3rem;}
.modal-body h2 .gradient{background:linear-gradient(135deg,var(--cardiac-red),var(--oxy-red));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.modal-body .modal-sub{font-size:0.9rem;color:var(--text-muted);margin-bottom:1.5rem;}
.modal-body h3{font-size:1.15rem;font-weight:700;margin:1.5rem 0 0.5rem;color:var(--accent-gold);}
.modal-body p,.modal-body li{font-size:0.95rem;color:var(--text-secondary);line-height:1.75;margin-bottom:0.5rem;}
.modal-body ul{padding-left:1.2rem;}
.modal-body .highlight-box{background:rgba(6,214,160,0.08);border-left:3px solid var(--ecg-green);padding:1rem 1.25rem;border-radius:0 10px 10px 0;margin:1rem 0;}
.modal-body .highlight-box.red{background:rgba(200,16,46,0.08);border-left-color:var(--cardiac-red);}
.modal-body .highlight-box.gold{background:rgba(255,209,102,0.08);border-left-color:var(--accent-gold);}
.modal-body .formula{font-family:'JetBrains Mono',monospace;font-size:1.3rem;color:var(--ecg-green);text-align:center;padding:1rem;background:rgba(6,214,160,0.06);border-radius:10px;margin:1rem 0;}
.modal-body .ecg-paper-bg{margin:1rem 0;}

/* Rhythm card in modal */
.modal-rhythm-strip{margin:1rem 0;}
.modal-rhythm-chars{display:grid;grid-template-columns:1fr 1fr;gap:0.5rem 1.5rem;margin:1rem 0;}
.modal-rhythm-chars .char-item{font-size:0.9rem;color:var(--text-secondary);}
.modal-rhythm-chars .char-item strong{color:var(--text-primary);}

/* ===== HERO ===== */
.hero{min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;position:relative;padding-top:60px;}
.hero-bg{position:absolute;inset:0;background:radial-gradient(ellipse at 50% 30%,rgba(200,16,46,0.12) 0%,transparent 60%),radial-gradient(ellipse at 80% 70%,rgba(69,123,157,0.08) 0%,transparent 50%);}
.hero-content{position:relative;z-index:1;}
.hero-chapter{font-size:0.72rem;text-transform:uppercase;letter-spacing:4px;color:var(--cardiac-red);margin-bottom:0.8rem;font-weight:700;}
.hero h1{font-family:'Playfair Display',serif;font-size:clamp(3rem,8vw,5.5rem);font-weight:900;line-height:1.05;margin-bottom:1.2rem;}
.hero h1 .red{background:linear-gradient(135deg,var(--cardiac-red),var(--oxy-red));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.hero-sub{font-size:1.1rem;color:var(--text-secondary);max-width:600px;margin:0 auto 2rem;}
@keyframes heroHeartbeat{0%,100%{transform:scale(1);}10%{transform:scale(1.15);}20%{transform:scale(1);}30%{transform:scale(1.1);}40%{transform:scale(1);}}
.hero-heart{font-size:3rem;margin-bottom:0.8rem;display:inline-block;animation:heroHeartbeat 1.5s ease-in-out infinite;}
.hero-stats{display:flex;gap:3rem;justify-content:center;flex-wrap:wrap;}
.hero-stat .num{font-family:'JetBrains Mono',monospace;font-size:2rem;font-weight:700;color:var(--ecg-green);}
.hero-stat .lbl{font-size:0.72rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;}
/* Hero ECG strip */
.hero-ecg-wrap{margin-top:2.5rem;width:min(90vw,800px);}

/* ===== HEART SVG ===== */
.heart-container{display:flex;flex-wrap:wrap;gap:2.5rem;align-items:center;justify-content:center;margin:1.5rem 0;}
.heart-svg-wrap{flex:1;min-width:320px;max-width:460px;}
.heart-info{flex:1;min-width:280px;}
.heart-info .info-item{padding:0.9rem 1.1rem;border-radius:10px;margin-bottom:0.6rem;cursor:pointer;border:1px solid rgba(255,255,255,0.05);transition:all 0.3s;}
.heart-info .info-item:hover,.heart-info .info-item.active{background:var(--bg-surface);border-color:rgba(200,16,46,0.3);}
.info-item .label{font-size:0.65rem;text-transform:uppercase;letter-spacing:2px;color:var(--text-muted);margin-bottom:0.2rem;}
.info-item .title{font-weight:700;font-size:0.9rem;margin-bottom:0.15rem;}
.info-item .desc{font-size:0.8rem;color:var(--text-secondary);}
#heartSvg{width:100%;height:auto;}
.heart-chamber{transition:all 0.4s;cursor:pointer;}
.heart-chamber:hover{filter:brightness(1.3);}
@keyframes heartbeat{0%,100%{transform:scale(1);}15%{transform:scale(1.04);}30%{transform:scale(0.98);}45%{transform:scale(1.02);}}
.heart-beating{animation:heartbeat 0.86s ease-in-out infinite;transform-origin:center;}
@keyframes pulseRing{0%{r:8;opacity:0.8;}100%{r:25;opacity:0;}}
.pulse-ring{animation:pulseRing 0.86s ease-out infinite;}

/* Conduction */
.conduction-visual{display:flex;flex-wrap:wrap;gap:2rem;align-items:flex-start;margin:2rem 0;}
.conduction-svg-wrap{flex:1.2;min-width:320px;}
.conduction-timeline{flex:1;min-width:260px;}
.timeline-step{display:flex;gap:1rem;margin-bottom:1.3rem;opacity:0.4;transition:all 0.4s;padding:0.7rem 0.8rem;border-radius:8px;border-left:3px solid transparent;cursor:pointer;position:relative;}
.timeline-step:hover{opacity:0.85;background:rgba(255,255,255,0.04);transform:translateX(6px);border-left-color:rgba(255,255,255,0.2);}
.timeline-step:active{transform:translateX(8px) scale(0.99);}
.timeline-step.active{opacity:1;background:rgba(6,214,160,0.07);transform:translateX(6px);border-left-color:var(--ecg-green);}
.formula{text-align:center;font:700 1.2rem 'JetBrains Mono',monospace;color:var(--ecg-green);background:rgba(0,230,118,0.08);border:1px solid rgba(0,230,118,0.15);padding:0.6rem 1rem;border-radius:8px;margin:0.8rem 0;}
.step-dot{width:14px;height:14px;border-radius:50%;flex-shrink:0;margin-top:4px;position:relative;}
.step-dot::after{content:'';position:absolute;top:14px;left:50%;width:2px;height:36px;transform:translateX(-50%);background:rgba(255,255,255,0.08);}
.timeline-step:last-child .step-dot::after{display:none;}
.step-content h4{font-size:0.85rem;font-weight:700;margin-bottom:0.15rem;}
.step-content p{font-size:0.78rem;color:var(--text-secondary);}
.step-content .rate{font-family:'JetBrains Mono',monospace;font-size:0.72rem;color:var(--accent-gold);}

/* ECG Component viewer */
.ecg-components{position:relative;margin:2rem 0;background:var(--bg-card);border-radius:14px;padding:1.75rem;border:1px solid rgba(255,255,255,0.06);}
.ecg-comp-labels{display:flex;flex-wrap:wrap;gap:0.4rem;margin-top:1rem;justify-content:center;}
.comp-label{padding:0.35rem 0.8rem;border-radius:18px;font-size:0.75rem;font-weight:600;cursor:pointer;border:2px solid transparent;transition:all 0.3s;background:var(--bg-surface);}
.comp-label:hover,.comp-label.active{transform:scale(1.05);}
.comp-detail{text-align:center;margin-top:1rem;min-height:50px;}
.comp-detail h4{font-size:1rem;margin-bottom:0.2rem;}
.comp-detail p{font-size:0.85rem;color:var(--text-secondary);max-width:600px;margin:0 auto;}

/* Dysrhythmia Gallery */
.rhythm-gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(310px,1fr));gap:1.15rem;margin:1.5rem 0;}
.rhythm-card{background:var(--bg-card);border-radius:14px;border:1px solid rgba(255,255,255,0.06);overflow:hidden;transition:all 0.3s;cursor:pointer;}
.rhythm-card:hover{border-color:rgba(6,214,160,0.3);transform:translateY(-3px);}
.rhythm-canvas-wrap{padding:0.75rem;border-bottom:1px solid rgba(255,255,255,0.04);}
.rhythm-info{padding:1.1rem 1.25rem;}
.rhythm-info h4{font-size:0.92rem;margin-bottom:0.25rem;}
.rhythm-info .rhythm-chars{font-size:0.78rem;color:var(--text-secondary);margin-bottom:0.4rem;}
.rhythm-badge{display:inline-block;padding:0.15rem 0.5rem;border-radius:5px;font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;}
.badge-sa{background:rgba(255,209,102,0.15);color:var(--sa-node);}
.badge-atrial{background:rgba(6,214,160,0.15);color:var(--av-node);}
.badge-junctional{background:rgba(17,138,178,0.15);color:var(--bundle-his);}
.badge-ventricular{background:rgba(239,71,111,0.15);color:var(--purkinje);}
.badge-block{background:rgba(255,107,53,0.15);color:var(--warning);}

/* Tabs */
.tab-bar{display:flex;gap:0.2rem;margin-bottom:1.5rem;border-bottom:1px solid rgba(255,255,255,0.06);overflow-x:auto;scrollbar-width:none;}
.tab-bar::-webkit-scrollbar{display:none;}
.tab-btn{padding:0.65rem 1.1rem;font-size:0.82rem;font-weight:600;border:none;background:none;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:all 0.3s;font-family:'DM Sans',sans-serif;}
.tab-btn:hover{color:var(--text-secondary);}
.tab-btn.active{color:var(--text-primary);border-bottom-color:var(--cardiac-red);}
.tab-content{display:none;}
.tab-content.active{display:block;animation:fadeIn 0.4s;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

/* Key grid */
.key-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:0.9rem;margin:1.2rem 0;}
.key-item{padding:1.1rem;border-radius:11px;background:var(--bg-card);border:1px solid rgba(255,255,255,0.06);cursor:pointer;transition:all 0.3s;}
.key-item:hover{border-color:rgba(200,16,46,0.2);transform:translateY(-2px);}
.key-item h4{font-size:0.88rem;margin-bottom:0.25rem;}
.key-item p{font-size:0.8rem;color:var(--text-secondary);}
.key-item .highlight{font-family:'JetBrains Mono',monospace;color:var(--ecg-green);font-weight:600;}

/* Pathway */
.pathway{display:flex;flex-direction:column;gap:0;margin:1.5rem 0;position:relative;}
.pathway::before{content:'';position:absolute;left:24px;top:0;bottom:0;width:2px;background:rgba(200,16,46,0.2);}
.pathway-step{display:flex;gap:1.1rem;position:relative;padding:1rem 0;}
.pathway-num{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1rem;flex-shrink:0;background:var(--bg-card);border:2px solid var(--cardiac-red);color:var(--cardiac-red);z-index:1;}
.pathway-content{background:var(--bg-card);border-radius:12px;padding:1.1rem 1.3rem;flex:1;border:1px solid rgba(255,255,255,0.06);}
.pathway-content h4{font-size:0.95rem;margin-bottom:0.3rem;}
.pathway-content p{font-size:0.82rem;color:var(--text-secondary);}

/* Quiz */
.quiz-container{max-width:700px;margin:2rem auto;}
.quiz-question-card{background:var(--bg-card);border-radius:14px;padding:1.75rem;border:1px solid rgba(255,255,255,0.06);}
.quiz-progress{display:flex;gap:3px;margin-bottom:1.2rem;}
.quiz-dot{flex:1;height:4px;border-radius:2px;background:rgba(255,255,255,0.08);transition:background 0.3s;}
.quiz-dot.done{background:var(--ecg-green);}
.quiz-dot.current{background:var(--accent-gold);}
.quiz-q{font-size:1.05rem;font-weight:700;margin-bottom:0.35rem;}
.quiz-q-sub{font-size:0.82rem;color:var(--text-secondary);margin-bottom:1.2rem;}
.quiz-options{display:flex;flex-direction:column;gap:0.5rem;}
.quiz-opt{padding:0.75rem 1rem;border-radius:9px;border:1px solid rgba(255,255,255,0.08);background:var(--bg-surface);cursor:pointer;font-size:0.88rem;font-weight:500;transition:all 0.25s;font-family:'DM Sans',sans-serif;color:var(--text-primary);text-align:left;}
.quiz-opt:hover{border-color:rgba(255,255,255,0.2);}
.quiz-opt.correct{border-color:var(--ecg-green);background:rgba(6,214,160,0.12);}
.quiz-opt.wrong{border-color:var(--arterial);background:rgba(230,57,70,0.12);}
.quiz-feedback{margin-top:0.8rem;padding:0.9rem;border-radius:9px;font-size:0.85rem;display:none;}
.quiz-feedback.show{display:block;}
.quiz-next{margin-top:0.8rem;padding:0.5rem 1.2rem;background:var(--cardiac-red);border:none;color:white;border-radius:7px;cursor:pointer;font-weight:600;font-size:0.82rem;font-family:'DM Sans',sans-serif;display:none;}
.quiz-next.show{display:inline-block;}
.quiz-score{text-align:center;padding:2.5rem 1.5rem;}
.quiz-score .big-num{font-family:'Playfair Display',serif;font-size:3.5rem;font-weight:900;}
.quiz-type-badge{margin-bottom:0.5rem;}
.quiz-submit-btn{margin-top:0.7rem;padding:0.55rem 1.4rem;background:var(--cardiac-red);border:none;color:white;border-radius:7px;cursor:pointer;font-weight:700;font-size:0.82rem;font-family:'DM Sans',sans-serif;display:inline-block;transition:all 0.2s;}
.quiz-submit-btn:hover{filter:brightness(1.15);transform:translateY(-1px);}
/* Multi-select */
.multi-opt.selected{border-color:var(--bundle-his);background:rgba(17,138,178,0.15);color:var(--bundle-his);}
/* Fill-in */
.quiz-fill-wrap{display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;}
.quiz-fill-input{flex:1;min-width:180px;padding:0.7rem 1rem;background:var(--bg-surface);border:1.5px solid rgba(255,255,255,0.12);border-radius:8px;color:var(--text-primary);font-size:0.95rem;font-family:'DM Sans',sans-serif;outline:none;transition:border-color 0.3s;}
.quiz-fill-input:focus{border-color:var(--accent-gold);}
.quiz-fill-input::placeholder{color:var(--text-muted);}
/* Matching */
.match-container{display:grid;grid-template-columns:1fr 1fr;gap:0.6rem;}
.match-left,.match-right{display:flex;flex-direction:column;gap:0.4rem;}
.match-item{padding:0.6rem 0.8rem;border-radius:8px;border:1.5px solid rgba(255,255,255,0.08);background:var(--bg-surface);font-size:0.82rem;cursor:pointer;transition:all 0.25s;font-family:'DM Sans',sans-serif;color:var(--text-primary);user-select:none;}
.match-item:hover{border-color:rgba(255,255,255,0.2);}
.match-left-item.selected{border-color:var(--accent-gold);background:rgba(255,209,102,0.12);box-shadow:0 0 10px rgba(255,209,102,0.15);}
.match-item.matched{border-color:var(--bundle-his);background:rgba(17,138,178,0.1);}
.match-item.correct{border-color:var(--ecg-green)!important;background:rgba(6,214,160,0.12)!important;}
.match-item.wrong{border-color:var(--arterial)!important;background:rgba(230,57,70,0.12)!important;}
.match-right-item{position:relative;padding-left:0.8rem;}
/* Order / Sequence */
.order-list{display:flex;flex-direction:column;gap:0.35rem;}
.order-item{display:flex;align-items:center;gap:0.5rem;padding:0.6rem 0.8rem;border-radius:8px;border:1.5px solid rgba(255,255,255,0.08);background:var(--bg-surface);font-size:0.82rem;transition:all 0.25s;font-family:'DM Sans',sans-serif;color:var(--text-primary);}
.order-handle{color:var(--text-muted);font-size:0.9rem;cursor:grab;}
.order-num{font-weight:800;color:var(--accent-gold);font-family:'JetBrains Mono',monospace;font-size:0.75rem;min-width:1.2rem;}
.order-arrows{margin-left:auto;display:flex;gap:2px;}
.order-arrows button{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:var(--text-secondary);font-size:0.65rem;padding:0.2rem 0.4rem;border-radius:4px;cursor:pointer;transition:all 0.2s;}
.order-arrows button:hover{background:rgba(255,255,255,0.12);color:var(--text-primary);}
.order-item.correct{border-color:var(--ecg-green);background:rgba(6,214,160,0.08);}
.order-item.wrong{border-color:var(--arterial);background:rgba(230,57,70,0.08);}
/* Nested / Scenario */
.nested-parts{display:flex;flex-direction:column;gap:1rem;}
.nested-part{padding:0.8rem;border-radius:10px;border:1px solid rgba(255,255,255,0.05);background:rgba(255,255,255,0.015);transition:all 0.4s;}
.nested-part-label{font:700 0.65rem 'JetBrains Mono',monospace;color:var(--cardiac-red);margin-bottom:0.3rem;letter-spacing:1px;}
.nested-fb{font-size:0.8rem;}
@media(max-width:600px){.match-container{grid-template-columns:1fr;} .quiz-fill-wrap{flex-direction:column;} .quiz-fill-input{width:100%;}}
/* Quiz Registration */
.quiz-reg{max-width:480px;margin:0 auto;text-align:center;}
.quiz-reg-title{font:800 1.6rem 'Playfair Display',serif;color:var(--text-primary);margin-bottom:0.3rem;}
.quiz-reg-sub{font-size:0.85rem;color:var(--text-secondary);margin-bottom:1.5rem;line-height:1.5;}
.quiz-reg-field{display:flex;flex-direction:column;gap:0.3rem;text-align:left;margin-bottom:1rem;}
.quiz-reg-label{font:600 0.75rem 'JetBrains Mono',monospace;color:var(--text-secondary);letter-spacing:0.5px;text-transform:uppercase;}
.quiz-reg-input{padding:0.75rem 1rem;background:var(--bg-surface);border:1.5px solid rgba(255,255,255,0.10);border-radius:8px;color:var(--text-primary);font-size:0.95rem;font-family:'DM Sans',sans-serif;outline:none;transition:border-color 0.3s;}
.quiz-reg-input:focus{border-color:var(--accent-gold);}
.quiz-reg-input::placeholder{color:var(--text-muted);}
.quiz-reg-start{margin-top:0.5rem;padding:0.75rem 2.5rem;background:var(--cardiac-red);border:none;color:white;border-radius:8px;cursor:pointer;font:700 1rem 'DM Sans',sans-serif;transition:all 0.25s;letter-spacing:0.3px;}
.quiz-reg-start:hover{filter:brightness(1.15);transform:translateY(-1px);}
.quiz-reg-start:disabled{opacity:0.4;cursor:not-allowed;transform:none;filter:none;}
.quiz-reg-info{display:flex;gap:1rem;justify-content:center;margin-top:1.2rem;flex-wrap:wrap;}
.quiz-reg-stat{font:0.72rem 'JetBrains Mono',monospace;color:var(--text-muted);display:flex;align-items:center;gap:0.3rem;}
.quiz-reg-stat span{color:var(--accent-gold);font-weight:700;}
/* Certificate button */
.cert-btn{display:inline-flex;align-items:center;gap:0.5rem;margin-top:0.8rem;padding:0.7rem 2rem;background:linear-gradient(135deg,#C9A84C,#E8D48B,#C9A84C);border:none;color:#1a1a2e;border-radius:8px;cursor:pointer;font:700 0.9rem 'DM Sans',sans-serif;transition:all 0.25s;letter-spacing:0.3px;box-shadow:0 2px 12px rgba(201,168,76,0.3);}
.cert-btn:hover{transform:translateY(-2px);box-shadow:0 4px 20px rgba(201,168,76,0.4);}
.cert-btn svg{width:18px;height:18px;}

.fade-up{opacity:0;transform:translateY(18px);transition:all 0.6s cubic-bezier(0.16,1,0.3,1);}
.fade-up.visible{opacity:1;transform:translateY(0);}

@media(max-width:768px){
  section{padding:80px 1.1rem 2.5rem;}
  .nav{padding:0 0.8rem;}
  .nav-links{max-width:55vw;}
  .heart-container,.conduction-visual{flex-direction:column;}
  .hero-stats{gap:1.5rem;}
  .modal-body{padding:0 1.5rem 1.5rem;}
  .modal-body h2{font-size:1.5rem;}
  .modal{max-height:92vh;}
}
/* 12-Lead ECG */
.twelve-lead-controls{display:flex;flex-wrap:wrap;gap:0.4rem;justify-content:center;margin:1.2rem 0 0.8rem;}
.twelve-btn{font-size:0.75rem;padding:0.4rem 0.9rem;}
.twelve-btn.active{background:rgba(0,230,118,0.2);border-color:var(--ecg-green);color:var(--ecg-green);}
.twelve-lead-info{text-align:center;margin-bottom:1rem;padding:0.6rem 1rem;background:var(--bg-card);border:1px solid rgba(255,255,255,0.06);border-radius:8px;}
.tl-info-title{font:700 1rem 'Playfair Display',serif;color:var(--text-primary);margin-bottom:0.2rem;}
.tl-info-desc{font-size:0.78rem;color:var(--text-secondary);line-height:1.5;}
.twelve-lead-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:3px;background:#0D0D0D;border:2px solid rgba(255,255,255,0.08);border-radius:10px;overflow:hidden;padding:2px;}
.tl-col{display:flex;flex-direction:column;gap:3px;}
.tl-lead{position:relative;background:#1C1410;border-radius:3px;overflow:hidden;border:2px solid transparent;transition:border-color 0.3s;}
.tl-label{position:absolute;left:6px;top:3px;font:700 0.7rem 'JetBrains Mono',monospace;color:rgba(255,255,255,0.5);z-index:2;text-shadow:0 1px 3px rgba(0,0,0,0.8);transition:color 0.3s;}
.tl-canvas{width:100%;height:100px;display:block;}
.tl-lead.ste{border-color:rgba(255,82,82,0.6);background:#1C1410;}
.tl-lead.ste .tl-label{color:#FF5252;font-weight:800;}
.tl-lead.ste::after{content:'‚Üë STE';position:absolute;right:5px;top:3px;font:700 0.55rem 'JetBrains Mono',monospace;color:#FF5252;opacity:0.8;}
.tl-lead.std{border-color:rgba(68,138,255,0.5);background:#1C1410;}
.tl-lead.std .tl-label{color:#448AFF;font-weight:800;}
.tl-lead.std::after{content:'‚Üì STD';position:absolute;right:5px;top:3px;font:700 0.55rem 'JetBrains Mono',monospace;color:#448AFF;opacity:0.8;}
.tl-lead.twarn{border-color:rgba(255,179,0,0.5);background:#1C1410;}
.tl-lead.twarn .tl-label{color:#FFB300;font-weight:800;}
.tl-lead.twarn::after{content:'‚ö† T‚àÜ';position:absolute;right:5px;top:3px;font:700 0.55rem 'JetBrains Mono',monospace;color:#FFB300;opacity:0.8;}
.tl-rhythm-strip{position:relative;margin-top:3px;background:#1C1410;border:2px solid rgba(255,255,255,0.08);border-radius:8px;overflow:hidden;}
.tl-rhythm-strip .tl-canvas{width:100%;height:90px;display:block;}
.tl-legend{display:flex;gap:1.2rem;justify-content:center;margin-top:0.6rem;font:0.7rem 'JetBrains Mono',monospace;color:var(--text-secondary);}
.tl-legend-item{display:flex;align-items:center;gap:0.3rem;}
.tl-legend-dot{width:10px;height:10px;border-radius:2px;}
@media(max-width:700px){.twelve-lead-grid{grid-template-columns:repeat(2,1fr);} .tl-canvas{height:80px;}}

/* 12-Lead Guide */
.subsection-title{font:800 1.2rem 'Playfair Display',serif;color:var(--text-primary);margin:1.8rem 0 0.8rem;text-align:center;}
.axis-interactive{display:flex;gap:1.5rem;align-items:center;margin:1.2rem auto 1.5rem;max-width:720px;flex-wrap:wrap;justify-content:center;}
.axis-display{position:relative;display:flex;align-items:center;gap:1rem;}
#axisCanvas{border-radius:50%;border:2px solid rgba(255,255,255,0.06);}
.axis-result{text-align:center;min-width:130px;}
.axis-result-title{font:800 1.1rem 'Playfair Display',serif;color:var(--ecg-green);transition:color 0.3s;}
.axis-result-range{font:600 0.8rem 'JetBrains Mono',monospace;color:var(--text-secondary);}
.axis-buttons{display:flex;flex-direction:column;gap:0.6rem;flex:1;min-width:240px;}
.axis-quick-title{font:700 0.75rem 'JetBrains Mono',monospace;color:var(--accent-gold);letter-spacing:0.5px;margin-bottom:0.2rem;}
.axis-grid-btns{display:flex;flex-wrap:wrap;gap:0.3rem;}
.axis-btn{font-size:0.72rem;padding:0.35rem 0.7rem;}
.axis-btn.active{background:rgba(0,230,118,0.2);border-color:var(--ecg-green);color:var(--ecg-green);}
.axis-method{display:flex;flex-direction:column;gap:0.3rem;margin-top:0.3rem;}
.axis-method-row{display:flex;align-items:center;gap:0.5rem;padding:0.3rem 0.6rem;background:var(--bg-card);border-radius:6px;border:1px solid rgba(255,255,255,0.05);}
.axis-lead-name{font:700 0.8rem 'JetBrains Mono',monospace;color:var(--text-secondary);min-width:55px;}
.axis-lead-val{font:700 0.8rem 'DM Sans',sans-serif;transition:color 0.3s;}
.axis-lead-val.pos{color:var(--ecg-green);}
.axis-lead-val.neg{color:var(--arterial);}

/* Heart Sounds */
.hs-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.2rem;margin-top:1.5rem;}
.hs-card{background:var(--bg-card);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:1.2rem;transition:all 0.3s;}
.hs-card:hover{border-color:rgba(255,255,255,0.12);transform:translateY(-2px);}
.hs-header{display:flex;align-items:center;gap:0.6rem;margin-bottom:0.6rem;}
.hs-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0;}
.hs-header h3{margin:0;font-size:1rem;color:var(--text-primary);font-family:'Playfair Display',serif;}
.hs-canvas{width:100%;border-radius:8px;background:#1C1410;margin-bottom:0.5rem;}
.hs-desc{font-size:0.78rem;color:var(--text-secondary);line-height:1.5;margin:0 0 0.7rem;}
.hs-play{width:100%;padding:0.5rem;font-size:0.8rem;justify-content:center;}
.hs-combos{display:flex;flex-wrap:wrap;gap:0.8rem;justify-content:center;margin-bottom:1rem;}
.hs-combo-btn{display:flex;flex-direction:column;align-items:center;gap:0.15rem;padding:0.7rem 1.2rem;min-width:180px;}
.hs-combo-label{font-weight:700;font-size:0.85rem;}
.hs-combo-sub{font-size:0.65rem;opacity:0.6;font-family:'JetBrains Mono',monospace;letter-spacing:0.5px;}
.hs-card.playing{border-color:var(--ecg-green);box-shadow:0 0 20px rgba(0,230,118,0.15);}
.hs-card.playing .hs-play{background:rgba(0,230,118,0.2);color:var(--ecg-green);}
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav">
  <div class="nav-brand">‚ô• Cardiology Interactive</div>
  <div class="nav-links">
    <a class="nav-link active" href="#hero">Home</a>
    <a class="nav-link" href="#anatomy">Anatomy</a>
    <a class="nav-link" href="#heartsounds">Heart Sounds</a>
    <a class="nav-link" href="#conduction">Conduction</a>
    <a class="nav-link" href="#ecg">ECG Monitor</a>
    <a class="nav-link" href="#ecg-components">Waveforms</a>
    <a class="nav-link" href="#rhythms">Dysrhythmias</a>
    <a class="nav-link" href="#blocks">AV Blocks</a>
    <a class="nav-link" href="#twelve-lead">12-Lead</a>
    <a class="nav-link" href="#twelve-lead-guide">Interpretation</a>
    <a class="nav-link" href="#acs">ACS</a>
    <a class="nav-link" href="#emergencies">Emergencies</a>
    <a class="nav-link" href="#resuscitation">Resuscitation</a>
    <a class="nav-link" href="#quiz">Quiz</a>
  </div>
</nav>
<div class="progress-bar" id="progressBar"></div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<!-- HERO -->
<section class="hero" id="hero">
  <div class="hero-bg"></div>
  <div class="hero-content">
    <div class="hero-heart">ü´Ä</div>
    <div class="hero-chapter">Cardiology Interactive ‚Äî Sanders' Paramedic Textbook</div>
    <h1><span class="red">Cardiology</span></h1>
    <p class="hero-sub">Interactive cardiac anatomy, electrophysiology, ECG interpretation, dysrhythmia recognition, and emergency cardiac care for EMS professionals.</p>
    <div class="hero-stats">
      <div class="hero-stat"><div class="num">236</div><div class="lbl">Topics Covered</div></div>
      <div class="hero-stat"><div class="num">31</div><div class="lbl">ECG Rhythms</div></div>
      <div class="hero-stat"><div class="num">10</div><div class="lbl">Quiz Questions</div></div>
    </div>
    <div class="hero-ecg-wrap">
      <div class="ecg-paper-bg" style="margin-top:1rem">
        <canvas id="heroEcgCanvas" height="100"></canvas>
      </div>
    </div>
  </div>
</section>

<!-- 1. RISK FACTORS -->
<section id="risk">
  <div class="section-label">Section 01</div>
  <div class="section-title">Risk Factors & <span class="gradient">Prevention</span></div>
  <p class="section-subtitle">CAD with sudden death remains a major cause of morbidity and mortality. Click any card to expand.</p>
  <div class="card-grid">
    <div class="card fade-up" onclick="openModal('risk-nonmod')"><div class="card-icon" style="background:rgba(239,71,111,0.12);color:var(--purkinje)">‚ö†Ô∏è</div><h3>Non-Modifiable Risk Factors</h3><p>Advanced age, male sex, hereditary factors, ethnicity.</p></div>
    <div class="card fade-up" onclick="openModal('risk-mod')"><div class="card-icon" style="background:rgba(6,214,160,0.12);color:var(--ecg-green)">‚úÖ</div><h3>Modifiable Risk Factors</h3><p>Smoking, BP, diabetes, cholesterol, exercise, weight, diet.</p></div>
    <div class="card fade-up" onclick="openModal('risk-prevent')"><div class="card-icon" style="background:rgba(255,209,102,0.12);color:var(--accent-gold)">üíä</div><h3>Prevention Strategies</h3><p>Statins, aspirin, beta blockers, lifestyle changes, community education.</p></div>
  </div>
</section>

<!-- 2. ANATOMY -->
<section id="anatomy">
  <div class="section-label">Section 02</div>
  <div class="section-title">Anatomy of the <span class="gradient">Heart</span></div>
  <p class="section-subtitle">Click each structure on the heart or the labels to explore.</p>
  <div class="heart-container">
    <div class="heart-svg-wrap">
      <svg id="heartSvg" viewBox="0 0 500 480" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <radialGradient id="raGrad" cx="50%" cy="50%"><stop offset="0%" stop-color="#6B3A3A"/><stop offset="100%" stop-color="#3D1F1F"/></radialGradient>
          <radialGradient id="rvGrad" cx="50%" cy="50%"><stop offset="0%" stop-color="#2B4A6B"/><stop offset="100%" stop-color="#1A2F45"/></radialGradient>
          <radialGradient id="laGrad" cx="50%" cy="50%"><stop offset="0%" stop-color="#8B3A3A"/><stop offset="100%" stop-color="#5A2222"/></radialGradient>
          <radialGradient id="lvGrad" cx="50%" cy="50%"><stop offset="0%" stop-color="#C8102E"/><stop offset="100%" stop-color="#7A0A1C"/></radialGradient>
          <filter id="glow"><feGaussianBlur stdDeviation="3" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        </defs>
        <g class="heart-beating">
          <path d="M250,60 C250,60 220,30 190,50 C160,70 180,110 210,130" fill="none" stroke="#C8102E" stroke-width="14" stroke-linecap="round" opacity="0.7"/>
          <path d="M250,60 C250,60 280,20 320,40 C350,55 340,100 310,120" fill="none" stroke="#C8102E" stroke-width="14" stroke-linecap="round" opacity="0.7"/>
          <path d="M150,50 C150,50 155,90 160,130" fill="none" stroke="#457B9D" stroke-width="12" stroke-linecap="round" opacity="0.6"/>
          <path d="M270,80 C290,60 330,50 350,65" fill="none" stroke="#457B9D" stroke-width="8" stroke-linecap="round" opacity="0.5"/>
          <path d="M230,80 C210,55 170,45 150,55" fill="none" stroke="#E63946" stroke-width="8" stroke-linecap="round" opacity="0.5"/>
          <path d="M250,100 C160,100 100,160 100,240 C100,340 180,420 250,450 C320,420 400,340 400,240 C400,160 340,100 250,100Z" fill="#2A1520" stroke="rgba(200,16,46,0.3)" stroke-width="2"/>
          <line x1="250" y1="120" x2="250" y2="430" stroke="rgba(255,255,255,0.15)" stroke-width="3"/>
          <path class="heart-chamber" data-chamber="ra" d="M145,135 C145,135 120,160 120,200 C120,230 140,250 170,250 L245,250 L245,135 C220,135 180,130 145,135Z" fill="url(#raGrad)" opacity="0.9"/>
          <path class="heart-chamber" data-chamber="la" d="M355,135 C355,135 380,160 380,200 C380,230 360,250 330,250 L255,250 L255,135 C280,135 320,130 355,135Z" fill="url(#laGrad)" opacity="0.9"/>
          <path class="heart-chamber" data-chamber="rv" d="M120,260 C110,300 120,360 160,400 C190,430 220,440 245,445 L245,260 Z" fill="url(#rvGrad)" opacity="0.9"/>
          <path class="heart-chamber" data-chamber="lv" d="M380,260 C390,300 380,360 340,400 C310,430 280,440 255,445 L255,260 Z" fill="url(#lvGrad)" opacity="0.9"/>
          <ellipse cx="210" cy="252" rx="30" ry="6" fill="rgba(255,255,255,0.2)" class="heart-chamber" data-chamber="tv"/>
          <ellipse cx="290" cy="252" rx="30" ry="6" fill="rgba(255,255,255,0.25)" class="heart-chamber" data-chamber="mv"/>
          <text x="175" y="200" fill="rgba(255,255,255,0.7)" font-size="13" font-weight="700" font-family="DM Sans" text-anchor="middle">RA</text>
          <text x="325" y="200" fill="rgba(255,255,255,0.7)" font-size="13" font-weight="700" font-family="DM Sans" text-anchor="middle">LA</text>
          <text x="185" y="350" fill="rgba(255,255,255,0.7)" font-size="13" font-weight="700" font-family="DM Sans" text-anchor="middle">RV</text>
          <text x="325" y="350" fill="rgba(255,255,255,0.7)" font-size="13" font-weight="700" font-family="DM Sans" text-anchor="middle">LV</text>
          <circle cx="165" cy="145" r="8" fill="var(--sa-node)" filter="url(#glow)" class="heart-chamber" data-chamber="sa"/>
          <circle cx="165" cy="145" r="8" fill="var(--sa-node)" class="pulse-ring" opacity="0.5"/>
          <text x="165" y="132" fill="var(--sa-node)" font-size="9" font-weight="700" font-family="DM Sans" text-anchor="middle">SA</text>
          <circle cx="250" cy="245" r="7" fill="var(--av-node)" filter="url(#glow)" class="heart-chamber" data-chamber="av"/>
          <text x="250" y="235" fill="var(--av-node)" font-size="9" font-weight="700" font-family="DM Sans" text-anchor="middle">AV</text>
          <path d="M270,110 C290,150 310,200 300,260 C290,310 270,350 260,400" fill="none" stroke="rgba(200,16,46,0.4)" stroke-width="2.5" stroke-dasharray="4,3"/>
          <path d="M230,110 C210,150 190,200 200,260 C210,310 230,350 240,400" fill="none" stroke="rgba(200,16,46,0.4)" stroke-width="2.5" stroke-dasharray="4,3"/>
        </g>
      </svg>
    </div>
    <div class="heart-info" id="heartInfo">
      <div class="info-item active" data-target="ra"><div class="label">Chamber</div><div class="title">Right Atrium (RA)</div><div class="desc">Receives deoxygenated venous blood from SVC, IVC, and coronary sinus.</div></div>
      <div class="info-item" data-target="rv"><div class="label">Chamber</div><div class="title">Right Ventricle (RV)</div><div class="desc">Low-pressure pump. Sends blood to lungs via pulmonary artery.</div></div>
      <div class="info-item" data-target="la"><div class="label">Chamber</div><div class="title">Left Atrium (LA)</div><div class="desc">Receives oxygenated blood from lungs via four pulmonary veins.</div></div>
      <div class="info-item" data-target="lv"><div class="label">Chamber</div><div class="title">Left Ventricle (LV)</div><div class="desc">High-pressure pump. Thickest wall. Pumps to body via aorta. CO = SV √ó HR.</div></div>
      <div class="info-item" data-target="sa"><div class="label">Conduction</div><div class="title">SA Node ‚Äî The Pacemaker</div><div class="desc">Chief pacemaker 60-100 bpm. Medial to SVC opening.</div></div>
      <div class="info-item" data-target="av"><div class="label">Conduction</div><div class="title">AV Node ‚Äî The Gatekeeper</div><div class="desc">Delays impulse ~0.12s. Backup rate 40-60 bpm.</div></div>
    </div>
  </div>
</section>

<!-- 3. PHYSIOLOGY -->
<section id="physiology">
  <div class="section-label">Section 03</div>
  <div class="section-title">Cardiac <span class="gradient">Physiology</span></div>
  <p class="section-subtitle">Click any card to open a detailed popup with complete explanations and clinical pearls.</p>
  <div class="card-grid">
    <div class="card fade-up" onclick="openModal('phys-cycle')"><div class="card-icon" style="background:rgba(200,16,46,0.12);color:var(--cardiac-red)">üîÑ</div><h3>Cardiac Cycle</h3><p>Systole, diastole, heart sounds, pressure changes, phases.</p></div>
    <div class="card fade-up" onclick="openModal('phys-preload')"><div class="card-icon" style="background:rgba(255,209,102,0.12);color:var(--accent-gold)">üìà</div><h3>Preload & Starling's Law</h3><p>End-diastolic volume, venous return, fiber stretch.</p></div>
    <div class="card fade-up" onclick="openModal('phys-afterload')"><div class="card-icon" style="background:rgba(69,123,157,0.12);color:var(--venous)">üéØ</div><h3>Afterload & Contractility</h3><p>SVR, wall tension, inotropy, ejection fraction.</p></div>
    <div class="card fade-up" onclick="openModal('phys-co')"><div class="card-icon" style="background:rgba(239,71,111,0.12);color:var(--purkinje)">üìä</div><h3>Cardiac Output & MAP</h3><p>CO = SV √ó HR. MAP = CO √ó SVR. Blood pressure determinants.</p></div>
    <div class="card fade-up" onclick="openModal('phys-ans')"><div class="card-icon" style="background:rgba(17,138,178,0.12);color:var(--bundle-his)">‚ö°</div><h3>ANS Control</h3><p>Sympathetic vs. Parasympathetic. Receptors. Baroreceptors.</p></div>
    <div class="card fade-up" onclick="openModal('phys-electrolytes')"><div class="card-icon" style="background:rgba(6,214,160,0.12);color:var(--ecg-green)">üß™</div><h3>Electrolytes & Action Potential</h3><p>Na‚Å∫, K‚Å∫, Ca¬≤‚Å∫, Mg¬≤‚Å∫. Phases 0-4. Depolarization, repolarization.</p></div>
    <div class="card fade-up" onclick="openModal('phys-coronary')"><div class="card-icon" style="background:rgba(200,16,46,0.12);color:var(--cardiac-red)">ü´Ä</div><h3>Coronary Circulation</h3><p>RCA, LCA, LAD, circumflex. Supply territories. Collateral flow.</p></div>
    <div class="card fade-up" onclick="openModal('phys-bp')"><div class="card-icon" style="background:rgba(255,107,53,0.12);color:var(--warning)">üíâ</div><h3>Blood Pressure & Perfusion</h3><p>Systolic, diastolic, pulse pressure. Baroreceptor reflex. Shock physiology ‚Äî all 4 types.</p></div>
    <div class="card fade-up" onclick="openModal('phys-valves')"><div class="card-icon" style="background:rgba(200,16,46,0.12);color:var(--cardiac-red)">üîß</div><h3>Valvular Heart Disease</h3><p>Stenosis vs. regurgitation. Aortic, mitral, tricuspid, pulmonic pathology.</p></div>
    <div class="card fade-up" onclick="openModal('phys-markers')"><div class="card-icon" style="background:rgba(69,123,157,0.12);color:var(--venous)">üî¨</div><h3>Cardiac Biomarkers</h3><p>Troponin, CK-MB, BNP, lactate, D-dimer. Timing and clinical significance.</p></div>
    <div class="card fade-up" onclick="openModal('phys-pacing')"><div class="card-icon" style="background:rgba(239,71,111,0.12);color:var(--purkinje)">üì°</div><h3>Automaticity & Pacing Hierarchy</h3><p>SA node, AV junction, ventricular escape. Overdrive suppression. Escape rhythms.</p></div>
  </div>
</section>

<!-- 3B. HEART SOUNDS -->
<section id="heartsounds">
  <div class="section-label">Section 03B</div>
  <div class="section-title">Heart <span class="gradient">Sounds</span></div>
  <p class="section-subtitle">Click each sound to hear a synthesized audio sample and see its waveform. Then try the combination patterns below.</p>

  <div class="hs-grid">
    <div class="hs-card fade-up" id="hs-s1">
      <div class="hs-header"><div class="hs-dot" style="background:var(--cardiac-red)"></div><h3>S‚ÇÅ ‚Äî "Lub"</h3></div>
      <canvas class="hs-canvas" id="hsCanvas-s1" height="80"></canvas>
      <p class="hs-desc"><strong>Closure of AV valves</strong> (mitral + tricuspid) at onset of ventricular systole. Best heard at apex (mitral area). Lower pitched than S‚ÇÇ. Louder with tachycardia, mitral stenosis, thin chest wall.</p>
      <button class="ecg-btn hs-play" onclick="playHeartSound('s1')">‚ñ∂ Play S‚ÇÅ</button>
    </div>
    <div class="hs-card fade-up" id="hs-s2">
      <div class="hs-header"><div class="hs-dot" style="background:var(--bundle-his)"></div><h3>S‚ÇÇ ‚Äî "Dub"</h3></div>
      <canvas class="hs-canvas" id="hsCanvas-s2" height="80"></canvas>
      <p class="hs-desc"><strong>Closure of semilunar valves</strong> (aortic + pulmonic) at onset of diastole. Best heard at base (aortic area, 2nd R ICS). Higher pitched, shorter duration than S‚ÇÅ. Physiologic splitting widens with inspiration.</p>
      <button class="ecg-btn hs-play" onclick="playHeartSound('s2')">‚ñ∂ Play S‚ÇÇ</button>
    </div>
    <div class="hs-card fade-up" id="hs-s3">
      <div class="hs-header"><div class="hs-dot" style="background:var(--ecg-green)"></div><h3>S‚ÇÉ ‚Äî Ventricular Gallop</h3></div>
      <canvas class="hs-canvas" id="hsCanvas-s3" height="80"></canvas>
      <p class="hs-desc"><strong>Rapid passive ventricular filling</strong> in early diastole. Low-pitched "thud" best heard at apex with bell. Normal in children/young adults and pregnancy. <strong>Pathologic in adults > 40:</strong> indicates volume overload, CHF, dilated ventricle. "Ken-TUC-ky" cadence.</p>
      <button class="ecg-btn hs-play" onclick="playHeartSound('s3')">‚ñ∂ Play S‚ÇÉ</button>
    </div>
    <div class="hs-card fade-up" id="hs-s4">
      <div class="hs-header"><div class="hs-dot" style="background:var(--accent-gold)"></div><h3>S‚ÇÑ ‚Äî Atrial Gallop</h3></div>
      <canvas class="hs-canvas" id="hsCanvas-s4" height="80"></canvas>
      <p class="hs-desc"><strong>Atrial contraction against a stiff, non-compliant ventricle</strong> in late diastole (presystolic). Low-pitched, best heard at apex with bell. <strong>Always pathologic.</strong> Indicates LV hypertrophy, HTN, aortic stenosis, acute MI, HCM. Absent in A-Fib (no organized atrial contraction). "TEN-nes-see" cadence.</p>
      <button class="ecg-btn hs-play" onclick="playHeartSound('s4')">‚ñ∂ Play S‚ÇÑ</button>
    </div>
  </div>

  <h3 style="text-align:center;color:var(--text-secondary);margin:2rem 0 1rem;font-family:'DM Sans'">Combination Patterns</h3>
  <div class="hs-combos">
    <button class="ecg-btn hs-combo-btn" onclick="playHeartPattern('normal')">
      <span class="hs-combo-label">Normal</span>
      <span class="hs-combo-sub">S‚ÇÅ ‚Äî S‚ÇÇ ¬∑ ¬∑ ¬∑ S‚ÇÅ ‚Äî S‚ÇÇ</span>
    </button>
    <button class="ecg-btn hs-combo-btn" onclick="playHeartPattern('s3gallop')">
      <span class="hs-combo-label">S‚ÇÉ Gallop (CHF)</span>
      <span class="hs-combo-sub">S‚ÇÅ ‚Äî S‚ÇÇ ‚Äî S‚ÇÉ ¬∑ ¬∑ ¬∑ S‚ÇÅ ‚Äî S‚ÇÇ ‚Äî S‚ÇÉ</span>
    </button>
    <button class="ecg-btn hs-combo-btn" onclick="playHeartPattern('s4gallop')">
      <span class="hs-combo-label">S‚ÇÑ Gallop (LVH/MI)</span>
      <span class="hs-combo-sub">S‚ÇÑ ‚Äî S‚ÇÅ ‚Äî S‚ÇÇ ¬∑ ¬∑ ¬∑ S‚ÇÑ ‚Äî S‚ÇÅ ‚Äî S‚ÇÇ</span>
    </button>
    <button class="ecg-btn hs-combo-btn" onclick="playHeartPattern('summation')">
      <span class="hs-combo-label">Summation Gallop</span>
      <span class="hs-combo-sub">S‚ÇÑ ‚Äî S‚ÇÅ ‚Äî S‚ÇÇ ‚Äî S‚ÇÉ (all four)</span>
    </button>
  </div>
</section>

<!-- 4. CONDUCTION -->
<section id="conduction">
  <div class="section-label">Section 04</div>
  <div class="section-title">Electrical <span class="gradient">Conduction System</span></div>
  <p class="section-subtitle">Click each label to animate one step at a time, or Play All for the full sequence.</p>
  <div class="conduction-visual">
    <div class="conduction-svg-wrap">
      <svg id="conductionSvg" viewBox="0 0 400 500" xmlns="http://www.w3.org/2000/svg">
        <path d="M200,80 C130,80 70,130 70,200 C70,300 140,380 200,410 C260,380 330,300 330,200 C330,130 270,80 200,80Z" fill="#1A1020" stroke="rgba(200,16,46,0.2)" stroke-width="1.5"/>
        <line x1="200" y1="95" x2="200" y2="395" stroke="rgba(255,255,255,0.08)" stroke-width="2"/>
        <circle id="cSA" cx="130" cy="115" r="12" fill="var(--sa-node)" opacity="0.3"/>
        <text x="130" y="100" fill="var(--sa-node)" font-size="10" font-weight="700" text-anchor="middle" font-family="DM Sans">SA Node</text>
        <path id="cInter" d="M130,127 C150,150 170,180 200,210" fill="none" stroke="var(--sa-node)" stroke-width="3" opacity="0.2" stroke-dasharray="4,3"/>
        <circle id="cAV" cx="200" cy="220" r="10" fill="var(--av-node)" opacity="0.3"/>
        <text x="200" y="208" fill="var(--av-node)" font-size="10" font-weight="700" text-anchor="middle" font-family="DM Sans">AV Node</text>
        <line id="cHis" x1="200" y1="232" x2="200" y2="280" stroke="var(--bundle-his)" stroke-width="3" opacity="0.2"/>
        <text x="215" y="260" fill="var(--bundle-his)" font-size="9" font-weight="600" font-family="DM Sans">Bundle of His</text>
        <path id="cLBB" d="M200,280 C220,300 250,330 270,370" fill="none" stroke="var(--bundle-his)" stroke-width="2.5" opacity="0.2"/>
        <path id="cRBB" d="M200,280 C180,300 150,330 130,370" fill="none" stroke="var(--bundle-his)" stroke-width="2.5" opacity="0.2"/>
        <text x="100" y="355" fill="var(--bundle-his)" font-size="8" font-family="DM Sans">RBB</text>
        <text x="282" y="355" fill="var(--bundle-his)" font-size="8" font-family="DM Sans">LBB</text>
        <g id="cPurk" opacity="0.2">
          <path d="M130,370 C120,380 110,390 105,395" fill="none" stroke="var(--purkinje)" stroke-width="1.5"/>
          <path d="M130,370 C135,385 140,395 145,400" fill="none" stroke="var(--purkinje)" stroke-width="1.5"/>
          <path d="M270,370 C280,380 290,390 295,395" fill="none" stroke="var(--purkinje)" stroke-width="1.5"/>
          <path d="M270,370 C265,385 260,395 255,400" fill="none" stroke="var(--purkinje)" stroke-width="1.5"/>
        </g>
        <text x="200" y="420" fill="var(--purkinje)" font-size="9" font-weight="600" text-anchor="middle" font-family="DM Sans">Purkinje Fibers</text>
        <circle id="impulseDot" cx="130" cy="115" r="6" fill="white" filter="url(#glow)" opacity="0"/>
      </svg>
      <div style="display:flex;gap:0.4rem;justify-content:center;margin-top:0.6rem;flex-wrap:wrap">
        <button class="ecg-btn" onclick="startConductionAnim()" style="background:rgba(6,214,160,0.15);border-color:var(--ecg-green);color:var(--ecg-green)">‚ñ∂ Play All</button>
        <button class="ecg-btn" onclick="resetConduction()">‚Ü∫ Reset</button>
      </div>
    </div>
    <div class="conduction-timeline" id="conductionTimeline">
      <div class="timeline-step" id="ts-sa" onclick="animateSingleStep(0)" style="cursor:pointer">
        <div class="step-dot" style="background:var(--sa-node)"></div>
        <div class="step-content"><h4>‚ë† SA Node Fires</h4><p>Chief pacemaker of the heart. Located in the right atrium near the SVC opening. Generates impulse that initiates each heartbeat. Contains specialized autorhythmic cells with fastest intrinsic rate.</p><div class="rate">Intrinsic rate: 60‚Äì100 bpm</div></div>
      </div>
      <div class="timeline-step" id="ts-inter" onclick="animateSingleStep(1)" style="cursor:pointer">
        <div class="step-dot" style="background:var(--sa-node)"></div>
        <div class="step-content"><h4>‚ë° Atrial Depolarization</h4><p>Impulse spreads across both atria via internodal pathways (anterior, middle, posterior) and Bachmann's bundle to the left atrium. Atrial contraction produces the <strong>P wave</strong> on ECG. "Atrial kick" contributes ~20-30% of ventricular filling.</p><div class="rate">ECG: P wave (< 0.12s, < 2.5mm)</div></div>
      </div>
      <div class="timeline-step" id="ts-av" onclick="animateSingleStep(2)" style="cursor:pointer">
        <div class="step-dot" style="background:var(--av-node)"></div>
        <div class="step-content"><h4>‚ë¢ AV Node Delay</h4><p>AV node is the "gatekeeper" ‚Äî deliberately slows conduction ~0.05s to allow complete atrial emptying before ventricular contraction. This is the only normal pathway between atria and ventricles. Receives dual autonomic innervation.</p><div class="rate">Backup pacemaker: 40‚Äì60 bpm</div></div>
      </div>
      <div class="timeline-step" id="ts-his" onclick="animateSingleStep(3)" style="cursor:pointer">
        <div class="step-dot" style="background:var(--bundle-his)"></div>
        <div class="step-content"><h4>‚ë£ Bundle of His ‚Üí Bundle Branches</h4><p>Bundle of His penetrates the fibrous skeleton and divides into the Right Bundle Branch (RBB) and Left Bundle Branch (LBB). The LBB further subdivides into anterior and posterior fascicles. Block in either branch = Bundle Branch Block (BBB) with characteristic wide QRS.</p><div class="rate">ECG: PR interval 0.12‚Äì0.20s</div></div>
      </div>
      <div class="timeline-step" id="ts-purk" onclick="animateSingleStep(4)" style="cursor:pointer">
        <div class="step-dot" style="background:var(--purkinje)"></div>
        <div class="step-content"><h4>‚ë§ Purkinje Fibers</h4><p>Fastest-conducting fibers in the heart (~4m/s). Spread throughout ventricular myocardium from endocardium to epicardium, causing simultaneous ventricular contraction from apex to base. Produces the <strong>QRS complex</strong> on ECG. Ventricular repolarization follows as the <strong>T wave</strong>.</p><div class="rate">Escape pacemaker: 20‚Äì40 bpm</div></div>
      </div>
    </div>
  </div>
</section>

<!-- 5. ECG MONITOR -->
<section id="ecg">
  <div class="section-label">Section 05</div>
  <div class="section-title">Live ECG <span class="gradient">Monitor</span></div>
  <p class="section-subtitle">Real ECG paper background with countable grid squares. Select any rhythm ‚Äî click rhythm name to open detailed popup.</p>
  <div class="ecg-monitor">
    <div class="ecg-monitor-header">
      <div><div class="lead-label">LEAD II ¬∑ 25mm/s ¬∑ 10mm/mV</div></div>
      <div style="text-align:center"><div class="rhythm-name" id="rhythmName" style="cursor:pointer" onclick="openRhythmModal(currentRhythm)">Normal Sinus Rhythm ‚Üó</div></div>
      <div style="text-align:right"><div class="rate-display" id="ecgRate">72<span>BPM</span></div></div>
    </div>
    <div class="ecg-paper-bg monitor-body">
      <canvas id="ecgCanvas" height="280"></canvas>
    </div>
    <div class="ecg-6s-markers"><span>|‚Üê 1s ‚Üí|</span><span>|‚Üê 2s ‚Üí|</span><span>|‚Üê 3s ‚Üí|</span><span>|‚Üê 4s ‚Üí|</span><span>|‚Üê 5s ‚Üí|</span><span>|‚Üê 6s ‚Üí|</span></div>
    <div class="ecg-controls" id="ecgControls"></div>
  </div>
</section>

<!-- 6. ECG COMPONENTS -->
<section id="ecg-components">
  <div class="section-label">Section 06</div>
  <div class="section-title">ECG <span class="gradient">Waveform Components</span></div>
  <p class="section-subtitle">Click each component to highlight and learn its clinical significance.</p>
  <div class="ecg-components">
    <div class="ecg-paper-bg"><canvas id="ecgCompCanvas" height="220"></canvas></div>
    <div class="ecg-comp-labels">
      <div class="comp-label active" style="border-color:var(--sa-node);color:var(--sa-node)" onclick="showComp('p')">P Wave</div>
      <div class="comp-label" style="border-color:var(--bundle-his);color:var(--bundle-his)" onclick="showComp('pr')">PR Interval</div>
      <div class="comp-label" style="border-color:var(--ecg-green);color:var(--ecg-green)" onclick="showComp('qrs')">QRS Complex</div>
      <div class="comp-label" style="border-color:var(--venous);color:var(--venous)" onclick="showComp('st')">ST Segment</div>
      <div class="comp-label" style="border-color:var(--purkinje);color:var(--purkinje)" onclick="showComp('t')">T Wave</div>
      <div class="comp-label" style="border-color:var(--warning);color:var(--warning)" onclick="showComp('qt')">QT Interval</div>
      <div class="comp-label" style="border-color:#00BCD4;color:#00BCD4" onclick="showComp('jwave')">J Wave (Osborn)</div>
      <div class="comp-label" style="border-color:#E040FB;color:#E040FB" onclick="showComp('delta')">Delta Wave (WPW)</div>
    </div>
    <div class="comp-detail" id="compDetail"><h4 style="color:var(--sa-node)">P Wave</h4><p>First positive deflection. Atrial depolarization. Duration &lt; 0.12s. Should be upright in Lead II for sinus origin.</p></div>
  </div>
</section>

<!-- 7. 5-STEP ANALYSIS -->
<section id="rhythm-analysis">
  <div class="section-label">Section 07</div>
  <div class="section-title">5-Step <span class="gradient">Rhythm Analysis</span></div>
  <p class="section-subtitle">Click each step for the detailed popup explanation.</p>
  <div class="card-grid">
    <div class="card fade-up" onclick="openModal('step1')"><div class="card-icon" style="background:rgba(200,16,46,0.12);color:var(--cardiac-red);font-weight:800;font-family:'JetBrains Mono'">1</div><h3>Analyze the Rate</h3><p>6-second count, triplicate, or R-R method.</p></div>
    <div class="card fade-up" onclick="openModal('step2')"><div class="card-icon" style="background:rgba(255,209,102,0.12);color:var(--accent-gold);font-weight:800;font-family:'JetBrains Mono'">2</div><h3>Analyze the Rhythm</h3><p>Regular, regularly irregular, or irregularly irregular?</p></div>
    <div class="card fade-up" onclick="openModal('step3')"><div class="card-icon" style="background:rgba(6,214,160,0.12);color:var(--ecg-green);font-weight:800;font-family:'JetBrains Mono'">3</div><h3>Analyze QRS</h3><p>Narrow (&lt;0.12s) or wide (‚â•0.12s)?</p></div>
    <div class="card fade-up" onclick="openModal('step4')"><div class="card-icon" style="background:rgba(17,138,178,0.12);color:var(--bundle-his);font-weight:800;font-family:'JetBrains Mono'">4</div><h3>Analyze P Waves</h3><p>Present? Upright? 1:1 with QRS?</p></div>
    <div class="card fade-up" onclick="openModal('step5')"><div class="card-icon" style="background:rgba(239,71,111,0.12);color:var(--purkinje);font-weight:800;font-family:'JetBrains Mono'">5</div><h3>Analyze PR Interval</h3><p>Normal 0.12-0.20s? Consistent? Lengthening?</p></div>
  </div>
</section>

<!-- 8. DYSRHYTHMIAS -->
<section id="rhythms">
  <div class="section-label">Section 08</div>
  <div class="section-title">Dysrhythmia <span class="gradient">Recognition Gallery</span></div>
  <p class="section-subtitle">Click any rhythm card to open a detailed popup with full characteristics, etiology, and management.</p>
  <div class="tab-bar">
    <button class="tab-btn active" onclick="showTab('sa-tab',this)">SA Node</button>
    <button class="tab-btn" onclick="showTab('atrial-tab',this)">Atrial</button>
    <button class="tab-btn" onclick="showTab('junct-tab',this)">Junctional</button>
    <button class="tab-btn" onclick="showTab('vent-tab',this)">Ventricular</button>
    <button class="tab-btn" onclick="showTab('block-tab',this)">AV Blocks</button>
  </div>
  <div class="tab-content active" id="sa-tab"><div class="rhythm-gallery" id="saGallery"></div></div>
  <div class="tab-content" id="atrial-tab"><div class="rhythm-gallery" id="atrialGallery"></div></div>
  <div class="tab-content" id="junct-tab"><div class="rhythm-gallery" id="junctGallery"></div></div>
  <div class="tab-content" id="vent-tab"><div class="rhythm-gallery" id="ventGallery"></div></div>
  <div class="tab-content" id="block-tab"><div class="rhythm-gallery" id="blockGallery"></div></div>
</section>

<!-- 9. AV BLOCKS (summary) -->
<section id="blocks">
  <div class="section-label">Section 09</div>
  <div class="section-title">AV <span class="gradient">Conduction Blocks</span></div>
  <p class="section-subtitle">Click each block type for the detailed popup with rhythm strip.</p>
  <div class="card-grid">
    <div class="card fade-up" onclick="openModal('block-1st')"><div class="card-icon" style="background:rgba(255,209,102,0.12);color:var(--accent-gold)">1¬∞</div><h3>First-Degree AV Block</h3><p>Not a true block ‚Äî delay. PR &gt; 0.20s but constant.</p></div>
    <div class="card fade-up" onclick="openModal('block-2nd1')"><div class="card-icon" style="background:rgba(255,107,53,0.12);color:var(--warning)">2¬∞I</div><h3>Second-Degree Type I</h3><p>Wenckebach. Progressive PR lengthening ‚Üí dropped QRS.</p></div>
    <div class="card fade-up" onclick="openModal('block-2nd2')"><div class="card-icon" style="background:rgba(239,71,111,0.12);color:var(--purkinje)">2¬∞II</div><h3>Second-Degree Type II</h3><p>Mobitz. Constant PR then sudden drop. Below Bundle of His.</p></div>
    <div class="card fade-up" onclick="openModal('block-3rd')"><div class="card-icon" style="background:rgba(200,16,46,0.2);color:var(--cardiac-red)">3¬∞</div><h3>Third-Degree (Complete)</h3><p>Complete AV dissociation. P waves independent of QRS.</p></div>
  </div>
</section>

<!-- 9B. 12-LEAD ECG -->
<section id="twelve-lead">
  <div class="section-label">Section 09B</div>
  <div class="section-title">Interactive <span class="gradient">12-Lead ECG</span></div>
  <p class="section-subtitle">Select a clinical scenario to see lead-specific waveform changes. Identify ST elevation, reciprocal depression, and infarct territories.</p>
  <div class="twelve-lead-controls">
    <button class="ecg-btn twelve-btn active" onclick="set12Lead('normal')">Normal</button>
    <button class="ecg-btn twelve-btn" onclick="set12Lead('anterior')">Anterior STEMI</button>
    <button class="ecg-btn twelve-btn" onclick="set12Lead('inferior')">Inferior STEMI</button>
    <button class="ecg-btn twelve-btn" onclick="set12Lead('lateral')">Lateral STEMI</button>
    <button class="ecg-btn twelve-btn" onclick="set12Lead('posterior')">Posterior MI</button>
    <button class="ecg-btn twelve-btn" onclick="set12Lead('anteroseptal')">Anteroseptal</button>
    <button class="ecg-btn twelve-btn" onclick="set12Lead('rv_infarct')">RV Infarct</button>
    <button class="ecg-btn twelve-btn" onclick="set12Lead('wellens')">Wellens</button>
    <button class="ecg-btn twelve-btn" onclick="set12Lead('hyperkalemia')">Hyperkalemia</button>
    <button class="ecg-btn twelve-btn" onclick="set12Lead('early_repol')">Early Repolarization</button>
    <button class="ecg-btn twelve-btn" onclick="set12Lead('rbbb')">RBBB</button>
    <button class="ecg-btn twelve-btn" onclick="set12Lead('lbbb')">LBBB</button>
  </div>
  <div class="twelve-lead-info" id="twelveleadInfo">
    <div class="tl-info-title" id="tlInfoTitle">Normal Sinus Rhythm</div>
    <div class="tl-info-desc" id="tlInfoDesc">Normal axis. No ST changes. Normal R-wave progression V1‚ÜíV6.</div>
  </div>
  <div class="twelve-lead-grid">
    <div class="tl-col">
      <div class="tl-lead"><div class="tl-label">I</div><canvas class="tl-canvas" id="tl-I"></canvas></div>
      <div class="tl-lead"><div class="tl-label">II</div><canvas class="tl-canvas" id="tl-II"></canvas></div>
      <div class="tl-lead"><div class="tl-label">III</div><canvas class="tl-canvas" id="tl-III"></canvas></div>
    </div>
    <div class="tl-col">
      <div class="tl-lead"><div class="tl-label">aVR</div><canvas class="tl-canvas" id="tl-aVR"></canvas></div>
      <div class="tl-lead"><div class="tl-label">aVL</div><canvas class="tl-canvas" id="tl-aVL"></canvas></div>
      <div class="tl-lead"><div class="tl-label">aVF</div><canvas class="tl-canvas" id="tl-aVF"></canvas></div>
    </div>
    <div class="tl-col">
      <div class="tl-lead"><div class="tl-label">V1</div><canvas class="tl-canvas" id="tl-V1"></canvas></div>
      <div class="tl-lead"><div class="tl-label">V2</div><canvas class="tl-canvas" id="tl-V2"></canvas></div>
      <div class="tl-lead"><div class="tl-label">V3</div><canvas class="tl-canvas" id="tl-V3"></canvas></div>
    </div>
    <div class="tl-col">
      <div class="tl-lead"><div class="tl-label">V4</div><canvas class="tl-canvas" id="tl-V4"></canvas></div>
      <div class="tl-lead"><div class="tl-label">V5</div><canvas class="tl-canvas" id="tl-V5"></canvas></div>
      <div class="tl-lead"><div class="tl-label">V6</div><canvas class="tl-canvas" id="tl-V6"></canvas></div>
    </div>
  </div>
  <div class="tl-rhythm-strip">
    <div class="tl-label" style="position:absolute;left:8px;top:4px">II (Rhythm Strip)</div>
    <canvas class="tl-canvas" id="tl-rhythm" style="height:90px"></canvas>
  </div>
  <div class="tl-legend">
    <div class="tl-legend-item"><div class="tl-legend-dot" style="background:#FF5252"></div> ST Elevation</div>
    <div class="tl-legend-item"><div class="tl-legend-dot" style="background:#448AFF"></div> ST Depression</div>
    <div class="tl-legend-item"><div class="tl-legend-dot" style="background:#FFB300"></div> T-Wave Abnormality</div>
    <div class="tl-legend-item"><div class="tl-legend-dot" style="background:#00E676"></div> Normal</div>
  </div>
</section>

<!-- 9C. 12-LEAD INTERPRETATION GUIDE -->
<section id="twelve-lead-guide">
  <div class="section-label">Section 09C</div>
  <div class="section-title">12-Lead <span class="gradient">Interpretation Guide</span></div>
  <p class="section-subtitle">Systematic approach to reading a 12-lead ECG, axis deviation, bundle branch blocks, chamber enlargement, and critical syndromes.</p>

  <!-- Systematic Approach -->
  <div class="subsection-title" style="margin-top:1.5rem">Systematic Interpretation</div>
  <div class="card-grid">
    <div class="card fade-up" onclick="openModal('tl-systematic')"><div class="card-icon" style="background:rgba(0,230,118,0.12);color:var(--ecg-green)">üìã</div><h3>10-Step Method</h3><p>Systematic approach: Rate ‚Üí Rhythm ‚Üí Axis ‚Üí Intervals ‚Üí Hypertrophy ‚Üí Ischemia.</p></div>
    <div class="card fade-up" onclick="openModal('tl-leads')"><div class="card-icon" style="background:rgba(17,138,178,0.12);color:var(--bundle-his)">üìê</div><h3>Lead Placement & Views</h3><p>Limb leads, augmented leads, precordial leads ‚Äî what each "sees" and contiguous lead groups.</p></div>
    <div class="card fade-up" onclick="openModal('tl-axis')"><div class="card-icon" style="background:rgba(255,209,102,0.12);color:var(--accent-gold)">üß≠</div><h3>Axis Deviation</h3><p>Normal, LAD, RAD, extreme axis. Quick I + aVF method and hexaxial reference system.</p></div>
    <div class="card fade-up" onclick="openModal('tl-intervals')"><div class="card-icon" style="background:rgba(239,71,111,0.12);color:var(--purkinje)">‚è±</div><h3>Intervals & Segments</h3><p>PR, QRS, QT/QTc ‚Äî normal values, what prolongation or shortening means clinically.</p></div>
  </div>

  <!-- Axis Deviation Interactive -->
  <div class="axis-interactive" id="axisInteractive">
    <div class="axis-display">
      <canvas id="axisCanvas" width="320" height="320"></canvas>
      <div class="axis-result" id="axisResult">
        <div class="axis-result-title">Normal Axis</div>
        <div class="axis-result-range">‚àí30¬∞ to +90¬∞</div>
      </div>
    </div>
    <div class="axis-buttons">
      <div class="axis-quick-title">Quick Axis Determination: Lead I + aVF</div>
      <div class="axis-grid-btns">
        <button class="ecg-btn axis-btn active" onclick="setAxis('normal')">Normal Axis</button>
        <button class="ecg-btn axis-btn" onclick="setAxis('lad')">Left Axis Deviation</button>
        <button class="ecg-btn axis-btn" onclick="setAxis('rad')">Right Axis Deviation</button>
        <button class="ecg-btn axis-btn" onclick="setAxis('extreme')">Extreme Axis</button>
      </div>
      <div class="axis-method" id="axisMethod">
        <div class="axis-method-row"><span class="axis-lead-name">Lead I</span><span class="axis-lead-val pos" id="axisLeadI">‚Üë Positive</span></div>
        <div class="axis-method-row"><span class="axis-lead-name">Lead aVF</span><span class="axis-lead-val pos" id="axisLeadAVF">‚Üë Positive</span></div>
      </div>
    </div>
  </div>

  <!-- Bundle Branch Blocks & Chamber Enlargement -->
  <div class="subsection-title">Bundle Branch Blocks & Hypertrophy</div>
  <div class="card-grid">
    <div class="card fade-up" onclick="openModal('tl-rbbb')"><div class="card-icon" style="background:rgba(68,138,255,0.12);color:#448AFF">R</div><h3>RBBB</h3><p>Right Bundle Branch Block ‚Äî "MaRRoW" pattern. RSR' in V1, wide S in I/V6.</p></div>
    <div class="card fade-up" onclick="openModal('tl-lbbb')"><div class="card-icon" style="background:rgba(255,82,82,0.12);color:#FF5252">L</div><h3>LBBB</h3><p>Left Bundle Branch Block ‚Äî "WiLLiaM" pattern. Broad notched R in I/V5-V6, deep S in V1.</p></div>
    <div class="card fade-up" onclick="openModal('tl-lvh')"><div class="card-icon" style="background:rgba(255,179,0,0.12);color:#FFB300">LV</div><h3>LVH</h3><p>Left ventricular hypertrophy ‚Äî Sokolow-Lyon & Cornell criteria. Strain pattern.</p></div>
    <div class="card fade-up" onclick="openModal('tl-rvh')"><div class="card-icon" style="background:rgba(224,64,251,0.12);color:#E040FB">RV</div><h3>RVH</h3><p>Right ventricular hypertrophy ‚Äî Tall R in V1, RAD, RV strain pattern T inversions.</p></div>
  </div>

  <!-- ECG Syndromes -->
  <div class="subsection-title">Critical ECG Syndromes</div>
  <div class="card-grid">
    <div class="card fade-up" onclick="openModal('tl-wpw')"><div class="card-icon" style="background:rgba(0,230,118,0.12);color:var(--ecg-green)">Œî</div><h3>WPW Syndrome</h3><p>Delta wave, short PR, wide QRS ‚Äî accessory pathway. Risk of fatal rapid A-Fib.</p></div>
    <div class="card fade-up" onclick="openModal('tl-brugada')"><div class="card-icon" style="background:rgba(255,82,82,0.12);color:#FF5252">‚ò†</div><h3>Brugada Syndrome</h3><p>Coved ST elevation V1-V3 with RBBB pattern. Risk of sudden death at rest/sleep.</p></div>
    <div class="card fade-up" onclick="openModal('tl-longqt')"><div class="card-icon" style="background:rgba(224,64,251,0.12);color:#E040FB">QT</div><h3>Long QT Syndrome</h3><p>Prolonged QTc &gt; 0.46s. Congenital vs. acquired. Torsades de Pointes risk.</p></div>
    <div class="card fade-up" onclick="openModal('tl-stpatterns')"><div class="card-icon" style="background:rgba(255,209,102,0.12);color:var(--accent-gold)">ST</div><h3>ST Segment Patterns</h3><p>Elevation vs. depression ‚Äî STEMI, pericarditis, BER, Wellens, de Winter, and mimics.</p></div>
    <div class="card fade-up" onclick="openModal('tl-peri-vs-stemi')"><div class="card-icon" style="background:rgba(200,16,46,0.12);color:var(--cardiac-red)">‚ö°</div><h3>Pericarditis vs. STEMI</h3><p>The critical differential. Diffuse vs. territorial, PR depression, reciprocal changes.</p></div>
    <div class="card fade-up" onclick="openModal('tl-electrolytes')"><div class="card-icon" style="background:rgba(17,138,178,0.12);color:var(--bundle-his)">K‚Å∫</div><h3>Electrolyte Effects</h3><p>Hyper/hypokalemia, hyper/hypocalcemia ‚Äî ECG manifestations and emergent treatment.</p></div>
  </div>
</section>


<!-- 10. ACS -->
<section id="acs">
  <div class="section-label">Section 10</div>
  <div class="section-title">Acute Coronary <span class="gradient">Syndromes</span></div>
  <p class="section-subtitle">Most common cause of sudden cardiac death. Click any card for comprehensive clinical detail.</p>
  <div class="card-grid">
    <div class="card fade-up" onclick="openModal('acs-patho')"><div class="card-icon" style="background:rgba(200,16,46,0.12);color:var(--cardiac-red)">ü´Ä</div><h3>Pathophysiology</h3><p>Atherosclerosis ‚Üí plaque rupture ‚Üí thrombosis ‚Üí ischemia ‚Üí injury ‚Üí infarction cascade.</p></div>
    <div class="card fade-up" onclick="openModal('acs-spectrum')"><div class="card-icon" style="background:rgba(239,71,111,0.12);color:var(--purkinje)">üìã</div><h3>ACS Spectrum</h3><p>Unstable angina vs. NSTEMI vs. STEMI. Troponin and ECG differentiation.</p></div>
    <div class="card fade-up" onclick="openModal('acs-signs')"><div class="card-icon" style="background:rgba(255,209,102,0.12);color:var(--accent-gold)">‚ö†Ô∏è</div><h3>Signs & Symptoms</h3><p>Classic vs. atypical presentations. Women, elderly, diabetic differences.</p></div>
    <div class="card fade-up" onclick="openModal('acs-12lead')"><div class="card-icon" style="background:rgba(6,214,160,0.12);color:var(--ecg-green)">üìä</div><h3>12-Lead ECG & STEMI</h3><p>ST elevation, reciprocal changes, right-sided & posterior leads.</p></div>
    <div class="card fade-up" onclick="openModal('acs-territory')"><div class="card-icon" style="background:rgba(17,138,178,0.12);color:var(--bundle-his)">üó∫Ô∏è</div><h3>Infarct Territories</h3><p>Anterior, inferior, lateral, posterior, RV. Artery-lead-wall correlations.</p></div>
    <div class="card fade-up" onclick="openModal('acs-mgmt')"><div class="card-icon" style="background:rgba(69,123,157,0.12);color:var(--venous)">üöë</div><h3>EMS Management</h3><p>Aspirin, NTG, anticoagulants, early PCI activation, fibrinolytics.</p></div>
    <div class="card fade-up" onclick="openModal('acs-complications')"><div class="card-icon" style="background:rgba(255,107,53,0.12);color:var(--warning)">üí•</div><h3>Complications of AMI</h3><p>Dysrhythmias, CHF, cardiogenic shock, mechanical rupture, Dressler syndrome.</p></div>
    <div class="card fade-up" onclick="openModal('acs-mimics')"><div class="card-icon" style="background:rgba(200,16,46,0.12);color:var(--cardiac-red)">üîç</div><h3>ACS Mimics & Differentials</h3><p>PE, dissection, pericarditis, GERD, pneumothorax ‚Äî what else causes chest pain?</p></div>
  </div>
</section>

<!-- 11. EMERGENCIES -->
<section id="emergencies">
  <div class="section-label">Section 11</div>
  <div class="section-title">Cardiac <span class="gradient">Emergencies</span></div>
  <p class="section-subtitle">Life-threatening conditions requiring immediate recognition and intervention. Click for detailed management.</p>
  <div class="card-grid">
    <div class="card fade-up" onclick="openModal('emerg-hf')"><div class="card-icon" style="background:rgba(69,123,157,0.12);color:var(--venous)">ü´Å</div><h3>Heart Failure & Pulmonary Edema</h3><p>Left vs. right failure, NYHA classes, acute decompensation, CPAP/BiPAP.</p></div>
    <div class="card fade-up" onclick="openModal('emerg-shock')"><div class="card-icon" style="background:rgba(200,16,46,0.12);color:var(--cardiac-red)">üíî</div><h3>Cardiogenic Shock</h3><p>Extreme pump failure. Swan-Ganz findings, vasopressor selection, IABP.</p></div>
    <div class="card fade-up" onclick="openModal('emerg-tamp')"><div class="card-icon" style="background:rgba(255,209,102,0.12);color:var(--accent-gold)">ü´Ä</div><h3>Cardiac Tamponade</h3><p>Beck's Triad, pulsus paradoxus, electrical alternans, pericardiocentesis.</p></div>
    <div class="card fade-up" onclick="openModal('emerg-dissect')"><div class="card-icon" style="background:rgba(239,71,111,0.12);color:var(--purkinje)">ü©∏</div><h3>Aortic Dissection</h3><p>Stanford/DeBakey classification, tearing pain, BP differentials, management.</p></div>
    <div class="card fade-up" onclick="openModal('emerg-htn')"><div class="card-icon" style="background:rgba(255,107,53,0.12);color:var(--warning)">üìà</div><h3>Hypertensive Crisis</h3><p>Urgency vs. emergency, end-organ damage targets, controlled BP reduction.</p></div>
    <div class="card fade-up" onclick="openModal('emerg-pe')"><div class="card-icon" style="background:rgba(17,138,178,0.12);color:var(--bundle-his)">ü´Å</div><h3>Pulmonary Embolism</h3><p>DVT origin, right heart strain, S1Q3T3, massive vs. submassive, tPA.</p></div>
    <div class="card fade-up" onclick="openModal('emerg-pericarditis')"><div class="card-icon" style="background:rgba(6,214,160,0.12);color:var(--ecg-green)">üî•</div><h3>Acute Pericarditis</h3><p>Diffuse ST elevation, PR depression, pleuritic pain, friction rub.</p></div>
    <div class="card fade-up" onclick="openModal('emerg-syncope')"><div class="card-icon" style="background:rgba(200,16,46,0.12);color:var(--cardiac-red)">üí´</div><h3>Cardiac Syncope</h3><p>Structural vs. dysrhythmic causes, risk stratification, Brugada, HOCM, long QT.</p></div>
  </div>
</section>

<!-- 12. RESUSCITATION -->
<section id="resuscitation">
  <div class="section-label">Section 12</div>
  <div class="section-title">Cardiac Arrest & <span class="gradient">Resuscitation</span></div>
  <div class="key-grid">
    <div class="key-item fade-up" onclick="openModal('resus-cpr')"><h4>ü´Å High-Quality CPR</h4><p>Rate: <span class="highlight">100‚Äì120/min</span>. Depth: <span class="highlight">‚â•2 inches</span>.</p></div>
    <div class="key-item fade-up" onclick="openModal('resus-defib')"><h4>‚ö° Defibrillation</h4><p>Most common initial rhythm: <span class="highlight">VF</span>.</p></div>
    <div class="key-item fade-up" onclick="openModal('resus-cardio')"><h4>üîÑ Synchronized Cardioversion</h4><p>Unstable tachycardias (not VF/pVT).</p></div>
    <div class="key-item fade-up" onclick="openModal('resus-pea')"><h4>üè• PEA & Asystole</h4><p>H's and T's. Pseudo-PEA.</p></div>
    <div class="key-item fade-up" onclick="openModal('resus-pit')"><h4>üë• Pit Crew CPR</h4><p>Team roles. 2-min rotations.</p></div>
    <div class="key-item fade-up" onclick="openModal('resus-rosc')"><h4>üîã Post-ROSC Care</h4><p>TTM, 12-lead, hemodynamic support.</p></div>
  </div>
</section>

<!-- 13. QUIZ -->
<section id="quiz">
  <div class="section-label">Section 13</div>
  <div class="section-title">Comprehensive <span class="gradient">Assessment</span></div>
  <p class="section-subtitle">100 questions ‚Äî multiple choice, fill-in-the-blank, matching, sequencing, select-all, and clinical scenarios. Questions randomize each attempt.</p>
  <div class="quiz-container" id="quizContainer"></div>
</section>

<div style="text-align:center;padding:2.5rem 1rem 3rem;color:var(--text-muted);font-size:0.78rem">
  <div style="font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--text-secondary);margin-bottom:0.4rem">Cardiology Interactive</div>
  Sanders' Paramedic Textbook ¬∑ Interactive Edition ¬∑ Paul D. Camp Community College EMS Program
</div>

<script>
// ================================================================
// ECG PAPER GRID DRAWING ‚Äî Realistic salmon-pink ECG paper
// ================================================================
function drawECGPaper(ctx, w, h) {
  // Background
  ctx.fillStyle = '#1C1410';
  ctx.fillRect(0, 0, w, h);
  
  // Small grid (1mm = ~4px at 25mm/s scale)
  const sm = Math.round(w / 150); // ~4px per small square
  const smSize = Math.max(sm, 3);
  
  ctx.strokeStyle = 'rgba(180,100,80,0.18)';
  ctx.lineWidth = 0.5;
  for (let x = 0; x < w; x += smSize) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke();
  }
  for (let y = 0; y < h; y += smSize) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
  }
  
  // Large grid (5mm = 5 small squares)
  const lgSize = smSize * 5;
  ctx.strokeStyle = 'rgba(180,100,80,0.40)';
  ctx.lineWidth = 1;
  for (let x = 0; x < w; x += lgSize) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke();
  }
  for (let y = 0; y < h; y += lgSize) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
  }
  
  // 6-second markers (every 30 large squares = 6 seconds at 25mm/s, but we scale)
  const sixSec = lgSize * 5; // 5 large boxes = 1 second
  ctx.strokeStyle = 'rgba(200,120,90,0.55)';
  ctx.lineWidth = 1.5;
  for (let x = 0; x < w; x += sixSec) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, 6); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x, h-6); ctx.lineTo(x, h); ctx.stroke();
  }
  
  return { smSize, lgSize };
}

// ================================================================
// CLINICALLY ACCURATE ECG WAVEFORM GENERATORS
// ================================================================
// Each generator takes a phase 0-1 within one cardiac cycle and returns amplitude -1 to 1

function waveNSR(t) {
  // Normal sinus: P wave, flat PR, narrow QRS (Q,R,S), flat ST, T wave
  if (t < 0.02) return 0; // baseline
  if (t < 0.12) { // P wave: smooth dome
    const p = (t - 0.02) / 0.10;
    return 0.12 * Math.sin(p * Math.PI);
  }
  if (t < 0.20) return 0; // PR segment (isoelectric)
  if (t < 0.22) { // Q wave: small downward
    const q = (t - 0.20) / 0.02;
    return -0.08 * Math.sin(q * Math.PI);
  }
  if (t < 0.26) { // R wave: tall sharp upward
    const r = (t - 0.22) / 0.04;
    return -0.08 + 1.08 * Math.sin(r * Math.PI);
  }
  if (t < 0.29) { // S wave: small downward
    const s = (t - 0.26) / 0.03;
    return -0.12 * Math.sin(s * Math.PI);
  }
  if (t < 0.42) return 0; // ST segment (isoelectric)
  if (t < 0.60) { // T wave: rounded asymmetric
    const tw = (t - 0.42) / 0.18;
    return 0.22 * Math.sin(tw * Math.PI) * (1 - 0.3 * tw);
  }
  return 0; // TP segment
}

function waveAFib(t, x) {
  // A-Fib: no P waves, fibrillatory baseline, irregular R-R handled by caller
  const fib = 0.035 * (Math.sin(x*1.7) + Math.sin(x*2.9+1) + 0.7*Math.sin(x*4.3+2));
  if (t < 0.18) return fib;
  if (t < 0.20) { const q = (t-0.18)/0.02; return fib - 0.06 * Math.sin(q*Math.PI); }
  if (t < 0.24) { const r = (t-0.20)/0.04; return fib + 0.85 * Math.sin(r*Math.PI); }
  if (t < 0.27) { const s = (t-0.24)/0.03; return fib - 0.10 * Math.sin(s*Math.PI); }
  if (t < 0.40) return fib;
  if (t < 0.55) { const tw = (t-0.40)/0.15; return fib + 0.18 * Math.sin(tw*Math.PI); }
  return fib;
}

function waveAFlutter(t, x) {
  // A-Flutter: sawtooth flutter waves ~300/min with 2:1-4:1 block
  // Draw sawtooth pattern continuously, then superimpose narrow QRS every cycle
  const flutterFreq = 4.2; // relative to ventricular rate
  const ft = (x * flutterFreq) % 1;
  const flutter = 0.15 * (ft < 0.6 ? -ft/0.6 : (ft-0.6)/0.4 - 1);
  
  if (t > 0.22 && t < 0.24) return flutter + 0.05;
  if (t > 0.24 && t < 0.28) { const r=(t-0.24)/0.04; return flutter + 0.80 * Math.sin(r*Math.PI); }
  if (t > 0.28 && t < 0.31) { const s=(t-0.28)/0.03; return flutter - 0.08 * Math.sin(s*Math.PI); }
  return flutter;
}

function waveSVT(t) {
  // SVT/PSVT: Rate 150-220, regular, NARROW QRS, P waves hidden in/near QRS
  // No visible P waves, very narrow QRS, short R-R
  if (t < 0.15) return 0;
  if (t < 0.17) { const q=(t-0.15)/0.02; return -0.05*Math.sin(q*Math.PI); }
  if (t < 0.21) { const r=(t-0.17)/0.04; return 0.85*Math.sin(r*Math.PI); } // tall narrow R
  if (t < 0.24) { const s=(t-0.21)/0.03; return -0.08*Math.sin(s*Math.PI); }
  if (t < 0.35) return 0;
  if (t < 0.52) { const tw=(t-0.35)/0.17; return 0.15*Math.sin(tw*Math.PI); } // small T, may merge with next cycle
  return 0;
}

function waveVTach(t) {
  // V-Tach: wide QRS ‚â•0.12s, monomorphic, sinusoidal appearance, no P waves
  if (t < 0.05) return 0;
  if (t < 0.45) { // Wide sinusoidal QRS
    const q = (t-0.05)/0.40;
    return 0.85 * Math.sin(q * Math.PI) * (1 + 0.15*Math.sin(q*Math.PI*2));
  }
  if (t < 0.55) { // negative deflection
    const s = (t-0.45)/0.10;
    return -0.35 * Math.sin(s * Math.PI);
  }
  return 0.02 * Math.sin(t*20); // slight wobble baseline
}

function waveVFib(x) {
  // V-Fib: completely chaotic, no organized complexes
  return 0.5 * (
    0.4*Math.sin(x*0.31+1.2) +
    0.3*Math.sin(x*0.73+0.5) +
    0.25*Math.sin(x*1.17+2.8) +
    0.2*Math.sin(x*1.91+0.3) +
    0.15*Math.sin(x*2.83+1.7) +
    0.1*Math.sin(x*4.1)
  );
}

function waveAsystole(x) {
  return 0.008 * Math.sin(x*0.03) + 0.003*(Math.random()-0.5);
}

function waveTorsades(t, beatNum) {
  // Torsades: wide QRS that changes amplitude (spindle), twisting around baseline
  const amplitude = 0.3 + 0.6 * Math.abs(Math.sin(beatNum * 0.35));
  if (t < 0.05) return 0;
  if (t < 0.50) {
    const q = (t-0.05)/0.45;
    const polarity = Math.sin(beatNum * 0.35) > 0 ? 1 : -1;
    return polarity * amplitude * Math.sin(q * Math.PI);
  }
  return 0;
}

function wavePVC(t) {
  // PVC Morphology 1: wide, bizarre QRS, no preceding P wave, compensatory pause after
  if (t < 0.05) return 0;
  if (t < 0.20) { const r=(t-0.05)/0.15; return -0.75*Math.sin(r*Math.PI); }
  if (t < 0.35) { const s=(t-0.20)/0.15; return 0.45*Math.sin(s*Math.PI); }
  if (t < 0.50) { const tw=(t-0.35)/0.15; return -0.20*Math.sin(tw*Math.PI); }
  return 0;
}

function wavePVC2(t) {
  // PVC Morphology 2: different focus ‚Äî upright wide QRS (different vector)
  if (t < 0.05) return 0;
  if (t < 0.18) { const r=(t-0.05)/0.13; return 0.80*Math.sin(r*Math.PI); }
  if (t < 0.30) { const s=(t-0.18)/0.12; return -0.55*Math.sin(s*Math.PI); }
  if (t < 0.40) { const tw=(t-0.30)/0.10; return 0.15*Math.sin(tw*Math.PI); }
  return 0;
}

function wavePVC3(t) {
  // PVC Morphology 3: third focus ‚Äî biphasic wide QRS
  if (t < 0.04) return 0;
  if (t < 0.12) { const r=(t-0.04)/0.08; return 0.50*Math.sin(r*Math.PI); }
  if (t < 0.25) { const s=(t-0.12)/0.13; return -0.70*Math.sin(s*Math.PI); }
  if (t < 0.38) { const r2=(t-0.25)/0.13; return 0.35*Math.sin(r2*Math.PI); }
  if (t < 0.50) { const tw=(t-0.38)/0.12; return -0.18*Math.sin(tw*Math.PI); }
  return 0;
}

function wave1AVB(t) {
  // 1st degree: same as NSR but PR > 0.20s (longer flat segment before QRS)
  if (t < 0.02) return 0;
  if (t < 0.10) { const p=(t-0.02)/0.08; return 0.12*Math.sin(p*Math.PI); }
  if (t < 0.26) return 0; // prolonged PR
  if (t < 0.28) { const q=(t-0.26)/0.02; return -0.06*Math.sin(q*Math.PI); }
  if (t < 0.32) { const r=(t-0.28)/0.04; return 0.90*Math.sin(r*Math.PI); }
  if (t < 0.35) { const s=(t-0.32)/0.03; return -0.10*Math.sin(s*Math.PI); }
  if (t < 0.48) return 0;
  if (t < 0.64) { const tw=(t-0.48)/0.16; return 0.20*Math.sin(tw*Math.PI); }
  return 0;
}

function wave3AVB(t, x, period) {
  // 3rd degree: P waves march independently, ventricular escape rhythm
  // P waves at atrial rate (~75bpm), QRS at ventricular rate (~35bpm)
  const pPeriod = period * 0.47;
  const pt = ((x % pPeriod) / pPeriod);
  let pWave = 0;
  if (pt > 0.05 && pt < 0.18) pWave = 0.12 * Math.sin((pt-0.05)/0.13 * Math.PI);
  
  // Ventricular escape (wide QRS)
  if (t > 0.12 && t < 0.16) { const q=(t-0.12)/0.04; return pWave - 0.06*Math.sin(q*Math.PI); }
  if (t > 0.16 && t < 0.24) { const r=(t-0.16)/0.08; return pWave + 0.65*Math.sin(r*Math.PI); }
  if (t > 0.24 && t < 0.30) { const s=(t-0.24)/0.06; return pWave - 0.15*Math.sin(s*Math.PI); }
  if (t > 0.45 && t < 0.65) { const tw=(t-0.45)/0.20; return pWave + 0.18*Math.sin(tw*Math.PI); }
  return pWave;
}

function waveWenck(t, beatInCycle) {
  // Wenckebach: PR progressively lengthens then drops
  // beatInCycle: 0,1,2 = conducted with increasing PR; 3 = dropped
  if (beatInCycle >= 3) {
    // dropped beat - only P wave, no QRS
    if (t > 0.05 && t < 0.15) { const p=(t-0.05)/0.10; return 0.12*Math.sin(p*Math.PI); }
    return 0;
  }
  const prDelay = 0.04 * beatInCycle; // increasing delay
  if (t < 0.02) return 0;
  if (t < 0.10) { const p=(t-0.02)/0.08; return 0.12*Math.sin(p*Math.PI); }
  const qrsStart = 0.20 + prDelay;
  if (t < qrsStart) return 0;
  if (t < qrsStart+0.02) { const q=(t-qrsStart)/0.02; return -0.06*Math.sin(q*Math.PI); }
  if (t < qrsStart+0.06) { const r=(t-qrsStart-0.02)/0.04; return 0.85*Math.sin(r*Math.PI); }
  if (t < qrsStart+0.09) { const s=(t-qrsStart-0.06)/0.03; return -0.10*Math.sin(s*Math.PI); }
  const tStart = qrsStart + 0.20;
  if (t > tStart && t < tStart+0.15) { const tw=(t-tStart)/0.15; return 0.18*Math.sin(tw*Math.PI); }
  return 0;
}

function waveJunctional(t) {
  // Junctional: no preceding P wave (or inverted after QRS), narrow QRS, rate 40-60
  if (t < 0.18) return 0;
  if (t < 0.20) { const q=(t-0.18)/0.02; return -0.06*Math.sin(q*Math.PI); }
  if (t < 0.24) { const r=(t-0.20)/0.04; return 0.90*Math.sin(r*Math.PI); }
  if (t < 0.27) { const s=(t-0.24)/0.03; return -0.10*Math.sin(s*Math.PI); }
  // Retrograde P wave (inverted) right after QRS
  if (t > 0.28 && t < 0.35) { const rp=(t-0.28)/0.07; return -0.08*Math.sin(rp*Math.PI); }
  if (t < 0.48) return 0;
  if (t < 0.62) { const tw=(t-0.48)/0.14; return 0.20*Math.sin(tw*Math.PI); }
  return 0;
}

function waveSinusArrhythmia(t, xPos) {
  // Same as NSR but R-R varies with "breathing" cycle
  return waveNSR(t);
}

function waveSinusArrest(t, beatNum) {
  // Normal sinus with one dropped beat (no P, no QRS ‚Äî flat line)
  if (beatNum % 5 === 3) return 0; // dropped beat
  return waveNSR(t);
}

function waveWAP(t, beatNum) {
  // Wandering Atrial Pacemaker: at least 3 different P wave morphologies, rate ‚â§ 100
  const pMorphs = [0.12, 0.08, -0.06, 0.10, -0.04]; // varying P amplitudes
  const pAmp = pMorphs[beatNum % 5];
  if (t < 0.02) return 0;
  if (t < 0.12) { const p = (t - 0.02) / 0.10; return pAmp * Math.sin(p * Math.PI); }
  if (t < 0.20) return 0;
  if (t < 0.22) { const q = (t - 0.20) / 0.02; return -0.08 * Math.sin(q * Math.PI); }
  if (t < 0.26) { const r = (t - 0.22) / 0.04; return 0.95 * Math.sin(r * Math.PI); }
  if (t < 0.29) { const s = (t - 0.26) / 0.03; return -0.12 * Math.sin(s * Math.PI); }
  if (t < 0.42) return 0;
  if (t < 0.60) { const tw = (t - 0.42) / 0.18; return 0.20 * Math.sin(tw * Math.PI); }
  return 0;
}

function waveMAT(t, beatNum) {
  // Multifocal Atrial Tachycardia: ‚â•3 P morphs, irregular, rate > 100
  const pMorphs = [0.14, -0.08, 0.06, 0.11, -0.10];
  const pAmp = pMorphs[beatNum % 5];
  const prVar = [0, 0.02, 0.01, 0.03, 0]; // varying PR intervals
  const pr = prVar[beatNum % 5];
  if (t < 0.02) return 0;
  if (t < 0.10) { const p = (t - 0.02) / 0.08; return pAmp * Math.sin(p * Math.PI); }
  const qrsStart = 0.18 + pr;
  if (t < qrsStart) return 0;
  if (t < qrsStart + 0.02) { const q = (t - qrsStart) / 0.02; return -0.06 * Math.sin(q * Math.PI); }
  if (t < qrsStart + 0.06) { const r = (t - qrsStart - 0.02) / 0.04; return 0.85 * Math.sin(r * Math.PI); }
  if (t < qrsStart + 0.09) { const s = (t - qrsStart - 0.06) / 0.03; return -0.10 * Math.sin(s * Math.PI); }
  const tStart = qrsStart + 0.18;
  if (t > tStart && t < tStart + 0.14) { const tw = (t - tStart) / 0.14; return 0.16 * Math.sin(tw * Math.PI); }
  return 0;
}

function waveJunctTach(t) {
  // Junctional Tachycardia: rate 100-180, narrow QRS, no visible P or retrograde P
  if (t < 0.14) return 0;
  if (t < 0.16) { const q = (t - 0.14) / 0.02; return -0.05 * Math.sin(q * Math.PI); }
  if (t < 0.20) { const r = (t - 0.16) / 0.04; return 0.88 * Math.sin(r * Math.PI); }
  if (t < 0.23) { const s = (t - 0.20) / 0.03; return -0.10 * Math.sin(s * Math.PI); }
  if (t > 0.24 && t < 0.30) { const rp = (t - 0.24) / 0.06; return -0.06 * Math.sin(rp * Math.PI); }
  if (t < 0.42) return 0;
  if (t < 0.56) { const tw = (t - 0.42) / 0.14; return 0.16 * Math.sin(tw * Math.PI); }
  return 0;
}

function waveIdioventricular(t) {
  // Idioventricular Rhythm: wide QRS (ventricular escape), rate 20-40, no P waves
  if (t < 0.05) return 0;
  if (t < 0.14) { const r = (t - 0.05) / 0.09; return -0.25 * Math.sin(r * Math.PI); }
  if (t < 0.28) { const r2 = (t - 0.14) / 0.14; return 0.70 * Math.sin(r2 * Math.PI); }
  if (t < 0.38) { const s = (t - 0.28) / 0.10; return -0.30 * Math.sin(s * Math.PI); }
  if (t < 0.55) return 0;
  if (t < 0.72) { const tw = (t - 0.55) / 0.17; return -0.22 * Math.sin(tw * Math.PI); }
  return 0;
}

function waveAIVR(t) {
  // Accelerated Idioventricular Rhythm: same wide morphology, rate 40-100
  if (t < 0.05) return 0;
  if (t < 0.13) { const r = (t - 0.05) / 0.08; return -0.20 * Math.sin(r * Math.PI); }
  if (t < 0.26) { const r2 = (t - 0.13) / 0.13; return 0.65 * Math.sin(r2 * Math.PI); }
  if (t < 0.35) { const s = (t - 0.26) / 0.09; return -0.25 * Math.sin(s * Math.PI); }
  if (t < 0.50) return 0;
  if (t < 0.66) { const tw = (t - 0.50) / 0.16; return -0.18 * Math.sin(tw * Math.PI); }
  return 0;
}

function waveAgonal(t) {
  // Agonal / Dying Heart: very wide, bizarre, slow, irregular
  if (t < 0.08) return 0;
  if (t < 0.22) { const r = (t - 0.08) / 0.14; return 0.40 * Math.sin(r * Math.PI) * (1 + 0.3 * Math.sin(r * Math.PI * 3)); }
  if (t < 0.38) { const s = (t - 0.22) / 0.16; return -0.25 * Math.sin(s * Math.PI); }
  if (t < 0.55) { const tw = (t - 0.38) / 0.17; return 0.10 * Math.sin(tw * Math.PI); }
  return 0.005 * Math.sin(t * 15);
}

function wavePaced(t) {
  // Ventricular Paced: pacer spike then wide QRS
  if (t < 0.15) return 0;
  // Pacer spike (sharp vertical line)
  if (t >= 0.15 && t < 0.155) return 0.55;
  if (t >= 0.155 && t < 0.16) return -0.10;
  // Wide paced QRS
  if (t < 0.22) { const r = (t - 0.16) / 0.06; return -0.55 * Math.sin(r * Math.PI); }
  if (t < 0.34) { const r2 = (t - 0.22) / 0.12; return 0.30 * Math.sin(r2 * Math.PI); }
  if (t < 0.42) { const s = (t - 0.34) / 0.08; return -0.10 * Math.sin(s * Math.PI); }
  if (t < 0.55) return 0;
  if (t < 0.72) { const tw = (t - 0.55) / 0.17; return -0.20 * Math.sin(tw * Math.PI); }
  return 0;
}

// J Wave (Osborn wave) ‚Äî NSR with prominent J-point notch
function waveJWave(t) {
  if (t < 0.02) return 0;
  if (t < 0.12) { const p = (t - 0.02) / 0.10; return 0.12 * Math.sin(p * Math.PI); }
  if (t < 0.20) return 0;
  // Q wave
  if (t < 0.22) { const q = (t - 0.20) / 0.02; return -0.08 * Math.sin(q * Math.PI); }
  // R wave
  if (t < 0.26) { const r = (t - 0.22) / 0.04; return 0.90 * Math.sin(r * Math.PI); }
  // S wave
  if (t < 0.29) { const s = (t - 0.26) / 0.03; return -0.12 * Math.sin(s * Math.PI); }
  // J WAVE ‚Äî prominent positive hump at J point
  if (t < 0.34) { const j = (t - 0.29) / 0.05; return 0.28 * Math.sin(j * Math.PI); }
  // ST segment slightly elevated
  if (t < 0.42) return 0.04;
  // T wave
  if (t < 0.60) { const tw = (t - 0.42) / 0.18; return 0.20 * Math.sin(tw * Math.PI); }
  return 0;
}

// Delta Wave (WPW) ‚Äî short PR + slurred QRS upstroke + wide QRS
function waveDelta(t) {
  if (t < 0.02) return 0;
  // P wave
  if (t < 0.10) { const p = (t - 0.02) / 0.08; return 0.12 * Math.sin(p * Math.PI); }
  // SHORT PR interval (only to 0.16 instead of 0.20)
  if (t < 0.16) return 0;
  // DELTA WAVE ‚Äî slow slurred upstroke before the main R wave
  if (t < 0.22) { const d = (t - 0.16) / 0.06; return 0.35 * d; }
  // Merged R wave peak (wide QRS continues)
  if (t < 0.28) { const r = (t - 0.22) / 0.06; return 0.35 + 0.55 * Math.sin(r * Math.PI); }
  // S wave (wide)
  if (t < 0.34) { const s = (t - 0.28) / 0.06; return -0.10 * Math.sin(s * Math.PI); }
  // ST segment
  if (t < 0.44) return 0;
  // T wave (may be discordant)
  if (t < 0.62) { const tw = (t - 0.44) / 0.18; return -0.15 * Math.sin(tw * Math.PI); }
  return 0;
}

// ================================================================
// RHYTHM DEFINITIONS
// ================================================================
const RHYTHMS = {
  nsr:       { name:'Normal Sinus Rhythm', rate:72, regular:true, wave:waveNSR, cat:'sa',
               chars:'Rate 60-100 ¬∑ Regular ¬∑ Upright P before each QRS ¬∑ PR 0.12-0.20s ¬∑ Narrow QRS < 0.12s',
               etiology:'Normal cardiac rhythm originating from the SA node.',
               mgmt:'No treatment needed if asymptomatic.' },
  sbrad:     { name:'Sinus Bradycardia', rate:48, regular:true, wave:waveNSR, cat:'sa',
               chars:'Rate < 60 ¬∑ Regular ¬∑ Normal P waves ¬∑ Normal PR ¬∑ Narrow QRS',
               etiology:'Intrinsic sinus node disease, increased vagal tone, hypothermia, hypoxia, hypothyroidism, beta blockers, calcium channel blockers, inferior MI.',
               mgmt:'If symptomatic: Atropine 0.5mg IV. Consider TCP if unresponsive to atropine. Dopamine or epinephrine infusion.' },
  stach:     { name:'Sinus Tachycardia', rate:130, regular:true, wave:waveNSR, cat:'sa',
               chars:'Rate 100-160 ¬∑ Regular ¬∑ Normal P waves (may merge with T) ¬∑ Normal PR ¬∑ Narrow QRS',
               etiology:'Exercise, fever, pain, anxiety, hypovolemia, hyperthyroidism, anemia, heart failure, PE, sympathomimetic drugs.',
               mgmt:'Treat the underlying cause. Do NOT cardiovert sinus tach ‚Äî it will not work and can be harmful.' },
  afib:      { name:'Atrial Fibrillation', rate:110, regular:false, wave:waveAFib, cat:'atrial',
               chars:'Irregularly irregular ¬∑ No distinct P waves ¬∑ Fibrillatory baseline ¬∑ Narrow QRS (usually) ¬∑ Variable ventricular rate',
               etiology:'Heavy alcohol, acute stress, HTN, CAD, valvular disease, HF, hyperthyroidism, PE, post-cardiac surgery.',
               mgmt:'If unstable: synchronized cardioversion. If stable: rate control with diltiazem, beta-blockers. Anticoagulation for stroke prevention.' },
  aflutter:  { name:'Atrial Flutter', rate:150, regular:true, wave:waveAFlutter, cat:'atrial',
               chars:'Sawtooth flutter waves ~300/min ¬∑ Typically 2:1 conduction (rate ~150) ¬∑ Regular ¬∑ Narrow QRS',
               etiology:'CAD, hypertensive heart disease, cardiomyopathy, hypoxia, HF, pericarditis, myocarditis.',
               mgmt:'If unstable: synchronized cardioversion 50-100J. If stable: rate control. Suspect when rate ‚âà 150 bpm.' },
  svt:       { name:'SVT (AVNRT/PSVT)', rate:188, regular:true, wave:waveSVT, cat:'atrial',
               chars:'Rate 150-250 ¬∑ Regular ¬∑ P waves absent or hidden in QRS ¬∑ Very narrow QRS ¬∑ Abrupt onset/offset',
               etiology:'Reentry circuit in AV node (AVNRT most common). May occur at any age. Common in young adults and women. Not commonly associated with structural heart disease.',
               mgmt:'Vagal maneuvers (Valsalva, carotid massage). Adenosine 6mg rapid IV push ‚Üí 12mg ‚Üí 12mg. If unstable: synchronized cardioversion 50-100J.' },
  pac:       { name:'Premature Atrial Complex', rate:75, regular:false, wave:waveNSR, cat:'atrial',
               chars:'Premature beat with abnormal P wave ¬∑ Followed by incomplete compensatory pause ¬∑ Narrow QRS ¬∑ Underlying rhythm usually sinus',
               etiology:'Catecholamines, caffeine, tobacco, alcohol, sympathomimetics, electrolyte imbalance, hypoxia, digitalis toxicity.',
               mgmt:'Usually benign. Remove precipitating cause. Frequent PACs may precede A-Fib, A-Flutter, or SVT.' },
  junctional:{ name:'Junctional Rhythm', rate:50, regular:true, wave:waveJunctional, cat:'junct',
               chars:'Rate 40-60 ¬∑ Regular ¬∑ Inverted P waves before/after QRS or absent ¬∑ Narrow QRS',
               etiology:'SA node failure, increased vagal tone, digitalis toxicity, inferior MI, post-cardiac surgery.',
               mgmt:'If symptomatic: Atropine. Consider pacing if unresponsive.' },
  accel_junct:{ name:'Accelerated Junctional', rate:80, regular:true, wave:waveJunctional, cat:'junct',
               chars:'Rate 60-100 ¬∑ Regular ¬∑ Inverted/absent P waves ¬∑ Narrow QRS ¬∑ Rate exceeds junctional escape but < SVT',
               etiology:'Digitalis toxicity, inferior MI, post-cardiac surgery, rheumatic fever.',
               mgmt:'If from digitalis toxicity: hold digitalis. Usually well-tolerated. Monitor.' },
  pvc:       { name:'Premature Ventricular Complex', rate:72, regular:false, wave:waveNSR, cat:'vent',
               chars:'Wide, bizarre QRS ‚â• 0.12s ¬∑ No preceding P wave ¬∑ Compensatory pause ¬∑ T wave opposite to QRS deflection',
               etiology:'MI, ischemia, hypoxia, acidosis, electrolyte imbalance, heart failure, stimulants, digitalis toxicity.',
               mgmt:'Unifocal, infrequent: monitor. Frequent (>6/min), multifocal, R-on-T, couplets, runs: treat underlying cause. Amiodarone or lidocaine if symptomatic.' },
  bigeminy:  { name:'PVC Bigeminy', rate:72, regular:false, wave:null, cat:'vent',
               chars:'Every other beat is a PVC ¬∑ Pattern: Sinus‚ÄìPVC‚ÄìSinus‚ÄìPVC ¬∑ Regular coupled pattern ¬∑ Wide bizarre PVC alternating with normal narrow QRS',
               etiology:'Digitalis toxicity (classic cause), hypokalemia, hypomagnesemia, MI/ischemia, heart failure, sympathomimetic drugs.',
               mgmt:'Identify and treat underlying cause. Hold digitalis if toxic. Correct K‚Å∫ and Mg¬≤‚Å∫. If symptomatic: Amiodarone 150mg IV over 10 min or Lidocaine 1-1.5mg/kg IV.' },
  trigeminy: { name:'PVC Trigeminy', rate:72, regular:false, wave:null, cat:'vent',
               chars:'Every third beat is a PVC ¬∑ Pattern: Sinus‚ÄìSinus‚ÄìPVC‚ÄìSinus‚ÄìSinus‚ÄìPVC ¬∑ Repeating grouped pattern ¬∑ Wide bizarre QRS every 3rd complex',
               etiology:'Same as bigeminy ‚Äî digitalis toxicity, electrolyte imbalance, ischemia, MI, heart failure.',
               mgmt:'Monitor, correct underlying cause. Treat if symptomatic. Less concerning than bigeminy but indicates irritable ventricular focus.' },
  pvc_couplet:{ name:'PVC Couplet (Paired PVCs)', rate:72, regular:false, wave:null, cat:'vent',
               chars:'Two consecutive PVCs back-to-back ¬∑ Same morphology (unifocal) ¬∑ Followed by compensatory pause ¬∑ More concerning than isolated ¬∑ 3+ consecutive PVCs = VT',
               etiology:'Increased myocardial irritability. Ischemia, MI, electrolyte imbalance, stimulants, digitalis toxicity. May precede sustained VT.',
               mgmt:'More aggressive than isolated PVCs. Amiodarone or lidocaine. Correct electrolytes. If progresses to 3+ beats = ventricular tachycardia.' },
  multifocal_pvc:{ name:'Multifocal PVCs', rate:72, regular:false, wave:null, cat:'vent',
               chars:'PVCs with ‚â• 2 different QRS morphologies ¬∑ Each shape = different ventricular focus ¬∑ Varying width and amplitude ¬∑ More dangerous than unifocal PVCs',
               etiology:'Severe myocardial irritability ‚Äî multiple ischemic foci, severe electrolyte derangement, advanced heart failure, digitalis toxicity, severe hypoxia.',
               mgmt:'More concerning than unifocal ‚Äî indicates widespread irritability. Aggressive treatment: O‚ÇÇ, correct electrolytes (K‚Å∫ > 4.0, Mg¬≤‚Å∫ > 2.0). Amiodarone preferred. Monitor for VT/VF.' },
  vtach:     { name:'Ventricular Tachycardia', rate:165, regular:true, wave:waveVTach, cat:'vent',
               chars:'Rate > 100 ¬∑ Regular ¬∑ Wide QRS ‚â• 0.12s ¬∑ No P waves ¬∑ AV dissociation ¬∑ Monomorphic or polymorphic',
               etiology:'MI, ischemia, cardiomyopathy, electrolyte imbalance, drug toxicity, long QT syndrome.',
               mgmt:'Pulseless: Defibrillation + CPR (treat as VF). With pulse + unstable: synchronized cardioversion. With pulse + stable: Amiodarone 150mg IV or procainamide.' },
  torsades:  { name:'Torsades de Pointes', rate:200, regular:true, wave:waveVTach, cat:'vent',
               chars:'Polymorphic VT ¬∑ "Twisting of the points" ¬∑ QRS amplitude waxes and wanes ¬∑ Associated with prolonged QT',
               etiology:'Prolonged QT interval (congenital or acquired), hypomagnesemia, hypokalemia, drug-induced (antiarrhythmics, antibiotics, antipsychotics).',
               mgmt:'Magnesium sulfate 1-2g IV. Overdrive pacing. Correct underlying cause. Isoproterenol if refractory. If pulseless: defibrillate.' },
  vfib:      { name:'Ventricular Fibrillation', rate:0, regular:false, wave:null, cat:'vent',
               chars:'Chaotic ¬∑ No organized QRS ¬∑ No identifiable P, QRS, or T ¬∑ Pulseless ¬∑ Immediate intervention required',
               etiology:'MI, ischemia, electrical shock, drowning, drug toxicity, untreated VT, R-on-T phenomenon.',
               mgmt:'Immediate defibrillation 120-200J biphasic. CPR. Epinephrine 1mg q3-5min. Amiodarone 300mg ‚Üí 150mg. Treat H\'s and T\'s.' },
  asystole:  { name:'Asystole', rate:0, regular:false, wave:null, cat:'vent',
               chars:'Flat line ¬∑ No electrical activity ¬∑ Confirm in 2 leads ¬∑ Check connections ¬∑ Final pathway of arrest',
               etiology:'End-stage of VF, PEA. Severe hypoxia, hyperkalemia, hypothermia, drug overdose.',
               mgmt:'CPR. Epinephrine 1mg q3-5min. Search for reversible causes (H\'s and T\'s). Do NOT defibrillate (not a shockable rhythm). Consider termination if no ROSC.' },
  '1avb':    { name:'First-Degree AV Block', rate:65, regular:true, wave:wave1AVB, cat:'block',
               chars:'PR interval > 0.20s ¬∑ Constant PR ¬∑ All P waves conducted ¬∑ Not a true block ‚Äî a delay ¬∑ Usually at AV node',
               etiology:'Increased vagal tone, AV nodal blocking drugs (beta blockers, CCBs, digitalis), inferior MI, aging.',
               mgmt:'Usually benign. No treatment needed. Monitor for progression. Identify and describe the underlying rhythm.' },
  'wenck':   { name:'2nd-Degree Type I (Wenckebach)', rate:60, regular:false, wave:null, cat:'block',
               chars:'Progressive PR lengthening ‚Üí dropped QRS ‚Üí cycle repeats ¬∑ Grouped beating ¬∑ Usually at AV node level',
               etiology:'Inferior MI, digitalis toxicity, increased vagal tone, myocarditis, post-cardiac surgery.',
               mgmt:'Usually transient. If symptomatic: Atropine 0.5mg IV. Consider TCP if atropine fails. Monitor for progression.' },
  'mobitz2':  { name:'2nd-Degree Type II (Mobitz)', rate:55, regular:false, wave:null, cat:'block',
               chars:'Constant PR for conducted beats ¬∑ Sudden dropped QRS ¬∑ Conduction ratios 2:1, 3:1 ¬∑ Usually below Bundle of His ¬∑ Wide QRS',
               etiology:'Anterior MI, degenerative conduction disease, post-cardiac surgery.',
               mgmt:'More serious than Type I. TCP (transcutaneous pacing). Prepare for transvenous pacing. Atropine usually ineffective for infranodal block. May progress to complete block.' },
  '3avb':    { name:'Third-Degree (Complete) Heart Block', rate:35, regular:true, wave:null, cat:'block',
               chars:'Complete AV dissociation ¬∑ P waves march independently of QRS ¬∑ Ventricular escape rhythm ¬∑ Rate depends on escape focus',
               etiology:'Inferior or anterior MI, degenerative conduction disease, drug toxicity, post-cardiac surgery.',
               mgmt:'Life-threatening. Immediate TCP. Dopamine or epinephrine infusion. Prepare for transvenous pacing. Atropine may help if junctional escape (narrow QRS).' },
  sinus_arr: { name:'Sinus Arrhythmia', rate:68, regular:false, wave:waveNSR, cat:'sa',
               chars:'Rate 60-100 ¬∑ Irregular (varies with respiration) ¬∑ Normal P waves ¬∑ Normal PR ¬∑ Narrow QRS ¬∑ R-R shortens on inspiration',
               etiology:'Normal physiologic variant, especially in young healthy individuals. Enhanced vagal tone. R-R intervals vary with respiratory cycle.',
               mgmt:'Normal variant ‚Äî no treatment required. Benign finding. Common in children and young adults.' },
  sinus_arrest:{ name:'Sinus Arrest / Pause', rate:60, regular:false, wave:null, cat:'sa',
               chars:'Underlying sinus rhythm ¬∑ Sudden pause with NO P-QRS-T ¬∑ Pause is NOT a multiple of P-P interval ¬∑ Escape beat may follow',
               etiology:'SA node failure to fire. Increased vagal tone, SA node disease, digitalis/beta-blocker/CCB toxicity, MI, hyperkalemia.',
               mgmt:'If symptomatic or prolonged: Atropine 0.5mg IV. TCP if unresponsive. Identify and treat underlying cause. May need permanent pacemaker.' },
  wap:       { name:'Wandering Atrial Pacemaker', rate:65, regular:false, wave:null, cat:'atrial',
               chars:'Rate ‚â§ 100 ¬∑ Slightly irregular ¬∑ At least 3 different P wave morphologies ¬∑ Varying PR intervals ¬∑ Narrow QRS',
               etiology:'Enhanced vagal tone, COPD, heart disease, digitalis use. Pacemaker site shifts between SA node, atria, and AV junction.',
               mgmt:'Usually benign. No treatment typically needed. Monitor. Treat underlying cause if symptomatic.' },
  mat:       { name:'Multifocal Atrial Tachycardia', rate:120, regular:false, wave:null, cat:'atrial',
               chars:'Rate > 100 ¬∑ Irregular ¬∑ At least 3 different P wave morphologies ¬∑ Varying PR intervals ¬∑ Varying P-P intervals ¬∑ Narrow QRS',
               etiology:'Severe COPD (most common), acute illness, hypoxia, HF, theophylline use, hypomagnesemia, hypokalemia.',
               mgmt:'Treat underlying cause (COPD exacerbation, hypoxia). Magnesium sulfate. Correct electrolytes. Verapamil may help. Do NOT cardiovert ‚Äî will not work. Rate control with calcium channel blockers if needed.' },
  junct_tach:{ name:'Junctional Tachycardia', rate:130, regular:true, wave:waveJunctTach, cat:'junct',
               chars:'Rate 100-180 ¬∑ Regular ¬∑ Absent or retrograde (inverted) P waves ¬∑ Narrow QRS ¬∑ AV junction rate exceeds upper limit',
               etiology:'Digitalis toxicity (most common cause), MI, post-cardiac surgery, myocarditis, catecholamines, hypoxia.',
               mgmt:'If digitalis toxicity: hold digitalis, give Digibind (digoxin-specific antibody fragments). If hemodynamically unstable: consider amiodarone or cardioversion. Treat underlying cause.' },
  idiovent:  { name:'Idioventricular Rhythm', rate:32, regular:true, wave:waveIdioventricular, cat:'vent',
               chars:'Rate 20-40 ¬∑ Regular ¬∑ No P waves ¬∑ Wide bizarre QRS ‚â• 0.12s ¬∑ Ventricular escape rhythm ¬∑ T wave opposite QRS',
               etiology:'Last-resort escape rhythm when SA node and AV junction fail. Complete heart block, dying heart, post-resuscitation.',
               mgmt:'Treat underlying cause. If hemodynamically unstable: Atropine, dopamine, epinephrine, TCP. Do NOT suppress with lidocaine/amiodarone ‚Äî it may be the only rhythm keeping the patient alive.' },
  aivr:      { name:'Accelerated Idioventricular (AIVR)', rate:72, regular:true, wave:waveAIVR, cat:'vent',
               chars:'Rate 40-100 ¬∑ Regular ¬∑ No P waves ¬∑ Wide QRS ‚â• 0.12s ¬∑ Ventricular focus fires faster than intrinsic rate ¬∑ Often "reperfusion rhythm"',
               etiology:'Reperfusion after MI (good sign with thrombolytics/PCI), digitalis toxicity, myocarditis, post-resuscitation, electrolyte imbalance.',
               mgmt:'Usually benign and self-limiting. Monitor closely. Often seen as a reperfusion marker after successful PCI/thrombolysis. Avoid suppressing ‚Äî rarely causes hemodynamic compromise. If unstable: Atropine to increase SA rate above ventricular focus.' },
  agonal:    { name:'Agonal Rhythm', rate:18, regular:false, wave:waveAgonal, cat:'vent',
               chars:'Rate < 20 ¬∑ Irregular ¬∑ Very wide bizarre QRS ¬∑ No P waves ¬∑ Dying heart rhythm ¬∑ Near-terminal',
               etiology:'End-stage cardiac event. Severe hypoxia, acidosis, hyperkalemia. Often seen as final rhythm before asystole.',
               mgmt:'Full cardiac arrest protocol. CPR, epinephrine, search for and treat reversible causes (H\'s and T\'s). This rhythm indicates severe myocardial compromise.' },
  paced:     { name:'Ventricular Paced Rhythm', rate:72, regular:true, wave:wavePaced, cat:'vent',
               chars:'Pacer spike before each QRS ¬∑ Wide QRS (paced morphology) ¬∑ Regular ¬∑ Rate set by pacer (usually 60-80) ¬∑ Underlying rhythm may be visible',
               etiology:'Artificial pacemaker implanted for symptomatic bradycardia, complete heart block, sick sinus syndrome, or other conduction disorders.',
               mgmt:'Verify capture (each spike followed by QRS). Verify sensing (pacer recognizes intrinsic beats). Document pacer settings. If failure to capture: increase output, reposition, check connections.' },
};

// Build ECG control buttons
function buildECGControls() {
  const order = ['nsr','sbrad','stach','sinus_arr','sinus_arrest','afib','aflutter','svt','pac','wap','mat','junctional','accel_junct','junct_tach','pvc','bigeminy','trigeminy','pvc_couplet','multifocal_pvc','vtach','torsades','vfib','asystole','idiovent','aivr','agonal','paced','1avb','wenck','mobitz2','3avb'];
  const container = document.getElementById('ecgControls');
  order.forEach(key => {
    const r = RHYTHMS[key];
    const btn = document.createElement('button');
    btn.className = 'ecg-btn' + (key === 'nsr' ? ' active' : '');
    btn.textContent = r.name
      .replace('First-Degree ','1¬∞ ')
      .replace('2nd-Degree Type I ','')
      .replace('2nd-Degree Type II ','')
      .replace('Third-Degree (Complete) Heart Block','3¬∞ AV Block')
      .replace('Ventricular Fibrillation','V-Fib')
      .replace('Ventricular Tachycardia','V-Tach')
      .replace('Premature Ventricular Complex','PVC')
      .replace('Atrial Fibrillation','A-Fib')
      .replace('Atrial Flutter','A-Flutter')
      .replace('(AVNRT/PSVT)','')
      .replace('Premature Atrial Complex','PAC')
      .replace('Accelerated Junctional','Accel Junct')
      .replace('Junctional Rhythm','Junctional')
      .replace('Junctional Tachycardia','Junct Tach')
      .replace('Torsades de Pointes','Torsades')
      .replace('Sinus Arrhythmia','Sinus Arrhy')
      .replace('Sinus Arrest / Pause','Sinus Arrest')
      .replace('Wandering Atrial Pacemaker','WAP')
      .replace('Multifocal Atrial Tachycardia','MAT')
      .replace('Idioventricular Rhythm','Idiovent')
      .replace('Accelerated Idioventricular (AIVR)','AIVR')
      .replace('Agonal Rhythm','Agonal')
      .replace('Ventricular Paced Rhythm','V-Paced')
      .replace('PVC Bigeminy','Bigeminy')
      .replace('PVC Trigeminy','Trigeminy')
      .replace('PVC Couplet (Paired PVCs)','PVC Couplet')
      .replace('Multifocal PVCs','Multifocal PVC')
      .trim();
    btn.onclick = () => {
      currentRhythm = key;
      ecgX = 0;
      document.querySelectorAll('#ecgControls .ecg-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      updateRhythmDisplay();
    };
    container.appendChild(btn);
  });
}

// ================================================================
// LIVE ECG MONITOR RENDERER
// ================================================================
let currentRhythm = 'nsr';
let ecgX = 0;
let ecgCanvas, ecgCtx;
let beatCounter = 0;
let wenckebachBeat = 0;

function updateRhythmDisplay() {
  const r = RHYTHMS[currentRhythm];
  document.getElementById('ecgRate').innerHTML = r.rate > 0 ? `${r.rate}<span>BPM</span>` : `---<span>BPM</span>`;
  document.getElementById('rhythmName').textContent = r.name + ' ‚Üó';
}

function initECG() {
  ecgCanvas = document.getElementById('ecgCanvas');
  ecgCtx = ecgCanvas.getContext('2d');
  resizeECGCanvas();
  requestAnimationFrame(drawECGFrame);
}

function resizeECGCanvas() {
  const parent = ecgCanvas.parentElement;
  ecgCanvas.width = parent.clientWidth;
  ecgCanvas.height = 280;
}

// Compute period in PIXELS for one cardiac cycle
// Canvas width = 6 seconds of ECG at 25mm/s paper speed
function getPeriod(rate, canvasWidth) {
  if (rate <= 0) return canvasWidth * 2;
  const pxPerSec = canvasWidth / 6; // 6-second strip
  const secPerBeat = 60 / rate;
  return pxPerSec * secPerBeat;
}

// Get waveform value at pixel position for the current rhythm
function getECGValue(xPos, rhythm, canvasWidth) {
  const r = RHYTHMS[rhythm];
  const period = getPeriod(r.rate, canvasWidth);

  if (rhythm === 'vfib') return waveVFib(xPos * 0.06);
  if (rhythm === 'asystole') return waveAsystole(xPos * 0.06);

  if (rhythm === 'torsades') {
    const secPerBeat = 60 / r.rate;
    const pxPerSec = canvasWidth / 6;
    const beatLen = pxPerSec * secPerBeat;
    const beatNum = Math.floor(xPos / beatLen);
    const t = (xPos % beatLen) / beatLen;
    return waveTorsades(t, beatNum);
  }

  if (rhythm === 'afib') {
    // Irregularly irregular: vary the R-R interval
    const basePeriod = period;
    const irregFactor = 0.65 + 0.70 * (0.5 + 0.5 * Math.sin(xPos * 0.007 + Math.sin(xPos * 0.003)));
    const irregPeriod = basePeriod * irregFactor;
    const t = (xPos % irregPeriod) / irregPeriod;
    return waveAFib(t, xPos * 0.06);
  }

  if (rhythm === 'aflutter') {
    const t = (xPos % period) / period;
    return waveAFlutter(t, xPos * 0.015);
  }

  if (rhythm === '3avb') {
    const t = (xPos % period) / period;
    return wave3AVB(t, xPos * 0.015, period * 0.015);
  }

  if (rhythm === 'pvc') {
    const cycleNum = Math.floor(xPos / period);
    const t = (xPos % period) / period;
    return cycleNum % 4 === 2 ? wavePVC(t) : waveNSR(t);
  }

  if (rhythm === 'bigeminy') {
    // Sinus‚ÄìPVC‚ÄìSinus‚ÄìPVC pattern: every other beat is a PVC
    const cycleNum = Math.floor(xPos / period);
    const t = (xPos % period) / period;
    return cycleNum % 2 === 1 ? wavePVC(t) : waveNSR(t);
  }

  if (rhythm === 'trigeminy') {
    // Sinus‚ÄìSinus‚ÄìPVC repeating
    const cycleNum = Math.floor(xPos / period);
    const t = (xPos % period) / period;
    return cycleNum % 3 === 2 ? wavePVC(t) : waveNSR(t);
  }

  if (rhythm === 'pvc_couplet') {
    // Normal sinus with paired PVCs: Sinus‚ÄìSinus‚ÄìPVC‚ÄìPVC‚Äìpause‚ÄìSinus‚ÄìSinus‚ÄìPVC‚ÄìPVC
    const groupPeriod = period * 5.5; // 2 sinus + 2 PVC + 1.5 comp pause
    const posInGroup = xPos % groupPeriod;
    if (posInGroup < period) {
      const t = posInGroup / period;
      return waveNSR(t);
    } else if (posInGroup < period * 2) {
      const t = (posInGroup - period) / period;
      return waveNSR(t);
    } else if (posInGroup < period * 2.8) {
      const t = (posInGroup - period * 2) / (period * 0.8);
      return wavePVC(t);
    } else if (posInGroup < period * 3.6) {
      const t = (posInGroup - period * 2.8) / (period * 0.8);
      return wavePVC(t);
    }
    return 0; // compensatory pause
  }

  if (rhythm === 'multifocal_pvc') {
    // Sinus rhythm with PVCs of varying morphologies interspersed
    const groupPeriod = period * 7;
    const posInGroup = xPos % groupPeriod;
    const beatIdx = Math.floor(posInGroup / period);
    const t = (posInGroup % period) / period;
    if (beatIdx === 1) return wavePVC(t);   // morphology 1 (inverted wide)
    if (beatIdx === 3) return wavePVC2(t);  // morphology 2 (upright wide)
    if (beatIdx === 5) return wavePVC3(t);  // morphology 3 (biphasic wide)
    if (beatIdx < 7) return waveNSR(t);
    return 0;
  }

  if (rhythm === 'pac') {
    const cycleNum = Math.floor(xPos / period);
    const t = (xPos % period) / period;
    return cycleNum % 5 === 3 ? waveNSR(t * 0.85) * 0.9 : waveNSR(t);
  }

  if (rhythm === 'wenck') {
    const groupPeriod = period * 4.3;
    const posInGroup = xPos % groupPeriod;
    const beatInGroup = Math.floor(posInGroup / (groupPeriod / 4));
    const t = (posInGroup % (groupPeriod / 4)) / (groupPeriod / 4);
    return waveWenck(t, beatInGroup);
  }

  if (rhythm === 'mobitz2') {
    const groupPeriod = period * 3;
    const posInGroup = xPos % groupPeriod;
    const beatInGroup = Math.floor(posInGroup / (groupPeriod / 3));
    const t = (posInGroup % (groupPeriod / 3)) / (groupPeriod / 3);
    if (beatInGroup === 2) {
      if (t > 0.05 && t < 0.15) { const p = (t - 0.05) / 0.10; return 0.12 * Math.sin(p * Math.PI); }
      return 0;
    }
    return waveNSR(t);
  }

  if (rhythm === 'sinus_arr') {
    // Sinus arrhythmia: R-R varies smoothly with breathing cycle
    // Pre-compute beat boundaries so each beat has a stable period
    const breathCyclePx = canvasWidth * 1.2; // one full breath cycle in pixels
    let beatStart = 0;
    let beatIdx = 0;
    while (beatStart < xPos + period * 2) {
      const breathPhase = (beatStart % breathCyclePx) / breathCyclePx;
      const rateMultiplier = 0.80 + 0.40 * Math.sin(breathPhase * 2 * Math.PI);
      const thisBeatPeriod = period * rateMultiplier;
      const beatEnd = beatStart + thisBeatPeriod;
      if (xPos >= beatStart && xPos < beatEnd) {
        const t = (xPos - beatStart) / thisBeatPeriod;
        return waveNSR(t);
      }
      beatStart = beatEnd;
      beatIdx++;
      if (beatIdx > 200) break; // safety
    }
    return 0;
  }

  if (rhythm === 'sinus_arrest') {
    // Normal sinus with a pause every 5th beat (beat 3 is missing)
    const groupPeriod = period * 6; // 5 beats + 1 pause worth of time
    const posInGroup = xPos % groupPeriod;
    const beatInGroup = Math.floor(posInGroup / period);
    const t = (posInGroup % period) / period;
    if (beatInGroup === 3) return 0; // The arrest ‚Äî flat line
    if (beatInGroup >= 5) return 0; // still in the pause
    return waveNSR(t);
  }

  if (rhythm === 'wap') {
    // Wandering Atrial Pacemaker: slightly irregular, varying P morphology
    let beatStart = 0, beatIdx = 0;
    while (beatStart < xPos + period * 2) {
      const rateMultiplier = 0.85 + 0.30 * Math.sin(beatIdx * 1.8);
      const thisBeatPeriod = period * rateMultiplier;
      const beatEnd = beatStart + thisBeatPeriod;
      if (xPos >= beatStart && xPos < beatEnd) {
        return waveWAP((xPos - beatStart) / thisBeatPeriod, beatIdx);
      }
      beatStart = beatEnd;
      beatIdx++;
      if (beatIdx > 200) break;
    }
    return 0;
  }

  if (rhythm === 'mat') {
    // MAT: irregular, multiple P morphologies, rate > 100
    let beatStart = 0, beatIdx = 0;
    const rrFactors = [0.75, 1.05, 0.85, 1.20, 0.90, 0.70, 1.10, 0.95, 1.15, 0.80];
    while (beatStart < xPos + period * 2) {
      const rateMultiplier = rrFactors[beatIdx % rrFactors.length];
      const thisBeatPeriod = period * rateMultiplier;
      const beatEnd = beatStart + thisBeatPeriod;
      if (xPos >= beatStart && xPos < beatEnd) {
        return waveMAT((xPos - beatStart) / thisBeatPeriod, beatIdx);
      }
      beatStart = beatEnd;
      beatIdx++;
      if (beatIdx > 200) break;
    }
    return 0;
  }

  if (rhythm === 'agonal') {
    // Agonal: very slow, irregular
    let beatStart = 0, beatIdx = 0;
    while (beatStart < xPos + period * 2) {
      const rateMultiplier = 0.7 + 0.6 * Math.abs(Math.sin(beatIdx * 2.1));
      const thisBeatPeriod = period * rateMultiplier;
      const beatEnd = beatStart + thisBeatPeriod;
      if (xPos >= beatStart && xPos < beatEnd) {
        return waveAgonal((xPos - beatStart) / thisBeatPeriod);
      }
      beatStart = beatEnd;
      beatIdx++;
      if (beatIdx > 200) break;
    }
    return 0;
  }

  // Default: use rhythm's wave function with correct period
  if (r.wave) {
    const t = (xPos % period) / period;
    return r.wave(t);
  }
  return 0;
}

function drawECGFrame() {
  const w = ecgCanvas.width, h = ecgCanvas.height;
  const mid = h * 0.48;
  const amp = h * 0.36;

  // 1. Draw ECG paper grid (clears canvas)
  drawECGPaper(ecgCtx, w, h);

  // 2. Draw waveform - sharp green trace
  ecgCtx.beginPath();
  ecgCtx.strokeStyle = '#00E676';
  ecgCtx.lineWidth = 2.2;
  ecgCtx.lineJoin = 'round';
  ecgCtx.lineCap = 'round';

  for (let px = 0; px < w; px++) {
    const xPos = ecgX + px;
    const y = getECGValue(xPos, currentRhythm, w);
    const py = mid - y * amp;
    if (px === 0) ecgCtx.moveTo(px, py);
    else ecgCtx.lineTo(px, py);
  }
  ecgCtx.stroke();

  // 3. Sweep cursor (eraser bar at the drawing head)
  const sweepPos = ecgX % w;
  // Dark eraser ahead of sweep
  ecgCtx.fillStyle = 'rgba(28,20,16,0.93)';
  ecgCtx.fillRect(sweepPos, 0, 60, h);
  // Green glow at leading edge
  const grad = ecgCtx.createLinearGradient(sweepPos - 4, 0, sweepPos + 8, 0);
  grad.addColorStop(0, 'transparent');
  grad.addColorStop(0.5, 'rgba(0,230,118,0.35)');
  grad.addColorStop(1, 'transparent');
  ecgCtx.fillStyle = grad;
  ecgCtx.fillRect(sweepPos - 4, 0, 12, h);

  ecgX += 1.5;
  requestAnimationFrame(drawECGFrame);
}

// ================================================================
// ECG COMPONENT VIEWER
// ================================================================
const compData = {
  p:  { color:'#FFD166', label:'P Wave', desc:'First positive deflection. Atrial depolarization. Duration < 0.12s. Upright in Lead II = sinus origin. Amplitude < 2.5mm. Absent in A-Fib, junctional, and ventricular rhythms. Inverted/retrograde in junctional rhythms.', range:[0.02,0.12], waveType:'nsr' },
  pr: { color:'#118AB2', label:'PR Interval', desc:'From P wave onset to QRS onset. Atrial depolarization + AV delay. Normal: 0.12‚Äì0.20s (3-5 small boxes). Prolonged > 0.20s = 1st degree AV block. Short < 0.12s = WPW syndrome or junctional origin. Absent if no P wave.', range:[0.02,0.20], waveType:'nsr' },
  qrs:{ color:'#00E676', label:'QRS Complex', desc:'Ventricular depolarization ‚Äî composed of Q, R, and S waves. Normal duration < 0.12s (< 3 small boxes). Wide ‚â• 0.12s indicates ventricular origin, bundle branch block, or accessory pathway (WPW). Amplitude and morphology help identify hypertrophy and infarction.', range:[0.20,0.29], waveType:'nsr' },
  st: { color:'#457B9D', label:'ST Segment', desc:'Period between end of ventricular depolarization and start of repolarization. Begins at J point, ends at T wave onset. Should be isoelectric (flat at baseline). Elevation ‚â• 1mm = acute myocardial injury (STEMI). Depression ‚â• 1mm = ischemia or reciprocal changes. Measured 0.04s (1mm) after J point.', range:[0.29,0.42], waveType:'nsr' },
  t:  { color:'#EF476F', label:'T Wave', desc:'Ventricular repolarization. Rounded and slightly asymmetric (gradual upstroke, steeper downstroke). Normally upright in Lead II. Tall peaked = hyperkalemia. Inverted = ischemia, strain, or BBB. Phase 3 of action potential. Contains the "vulnerable period" for R-on-T phenomenon.', range:[0.42,0.60], waveType:'nsr' },
  qt: { color:'#FF6B35', label:'QT Interval', desc:'Total ventricular depolarization + repolarization. QRS onset to T wave end. Normal: 0.36‚Äì0.44s. Must correct for HR ‚Üí QTc (Bazett formula: QTc = QT / ‚àöRR). Prolonged QTc > 0.46s (‚ôÄ) or > 0.45s (‚ôÇ) ‚Üí increased risk of Torsades de Pointes. Caused by drugs, electrolytes, congenital long QT syndrome.', range:[0.20,0.60], waveType:'nsr' },
  jwave:{ color:'#00BCD4', label:'J Wave (Osborn)', desc:'Small positive deflection at the J point ‚Äî the junction where the QRS complex meets the ST segment. Also called the Osborn wave. Classic finding in hypothermia (core temp < 32¬∞C / 90¬∞F). Amplitude increases as body temperature decreases. Also seen in hypercalcemia, Brugada syndrome, subarachnoid hemorrhage, and early repolarization (benign variant in young patients). Disappears with rewarming.', range:[0.28,0.34], waveType:'jwave' },
  delta:{ color:'#E040FB', label:'Delta Wave (WPW)', desc:'Slurred, slow upstroke at the beginning of the QRS complex caused by ventricular pre-excitation through an accessory pathway (Bundle of Kent) that bypasses the AV node. Hallmark of Wolff-Parkinson-White (WPW) syndrome. WPW triad: Short PR interval (< 0.12s) + Delta wave + Wide QRS (> 0.12s). Patients at risk for re-entrant SVT and rapid A-Fib with dangerously fast ventricular rates. Do NOT give AV nodal blockers (adenosine, verapamil, digoxin) in WPW with A-Fib ‚Äî may cause VF.', range:[0.16,0.26], waveType:'delta' }
};
let activeComp = 'p';

function drawCompWaveform() {
  const canvas = document.getElementById('ecgCompCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.parentElement.clientWidth;
  canvas.height = 220;
  const w = canvas.width, h = canvas.height;
  
  drawECGPaper(ctx, w, h);
  
  const mid = h * 0.48, amp = h * 0.36;
  const pxPerSec = w / 6;
  const period = pxPerSec * (60 / 72); // 72bpm NSR reference
  const comp = compData[activeComp];
  const offset = w * 0.08;
  
  // Pick waveform function based on waveType
  const waveFn = comp.waveType === 'jwave' ? waveJWave : comp.waveType === 'delta' ? waveDelta : waveNSR;
  
  // Highlight region
  const x1 = offset + comp.range[0] * period;
  const x2 = offset + comp.range[1] * period;
  ctx.fillStyle = comp.color + '20';
  ctx.fillRect(x1, 0, x2-x1, h);
  ctx.strokeStyle = comp.color + '50';
  ctx.lineWidth = 1.5;
  ctx.setLineDash([4,2]);
  ctx.beginPath(); ctx.moveTo(x1,0); ctx.lineTo(x1,h); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(x2,0); ctx.lineTo(x2,h); ctx.stroke();
  ctx.setLineDash([]);
  
  // Draw multiple complexes to fill canvas
  const numComplexes = Math.ceil(w / period) + 1;
  for (let c = 0; c < numComplexes; c++) {
    const ox = offset + c * period;
    ctx.beginPath();
    ctx.strokeStyle = c===0 ? '#00E676' : 'rgba(0,230,118,0.25)';
    ctx.lineWidth = c===0 ? 2.5 : 1.5;
    ctx.lineJoin = 'round';
    for (let px = 0; px < period; px++) {
      const t = px / period;
      const y = waveFn(t);
      const py = mid - y * amp;
      if (px===0) ctx.moveTo(ox+px, py); else ctx.lineTo(ox+px, py);
    }
    ctx.stroke();
    
    // Highlighted segment
    if (c===0) {
      ctx.beginPath();
      ctx.strokeStyle = comp.color;
      ctx.lineWidth = 3.5;
      const sp = Math.floor(comp.range[0] * period);
      const ep = Math.ceil(comp.range[1] * period);
      for (let px = sp; px <= ep; px++) {
        const t = px/period;
        const y = waveFn(t);
        const py = mid - y * amp;
        if (px===sp) ctx.moveTo(ox+px, py); else ctx.lineTo(ox+px, py);
      }
      ctx.stroke();
    }
  }
  
  // Label
  ctx.font = '600 13px "DM Sans"';
  ctx.fillStyle = comp.color;
  ctx.textAlign = 'center';
  ctx.fillText(comp.label, (x1+x2)/2, 18);
}

function showComp(key) {
  activeComp = key;
  const comp = compData[key];
  document.getElementById('compDetail').innerHTML = `<h4 style="color:${comp.color}">${comp.label}</h4><p>${comp.desc}</p>`;
  document.querySelectorAll('.comp-label').forEach(l => l.classList.remove('active'));
  const clicked = event.target.closest('.comp-label');
  if (clicked) clicked.classList.add('active');
  drawCompWaveform();
}

// ================================================================
// AXIS DEVIATION INTERACTIVE
// ================================================================
const axisData = {
  normal:  { angle:45, range:'‚àí30¬∞ to +90¬∞', title:'Normal Axis', color:'#00E676', leadI:'‚Üë Positive', leadAVF:'‚Üë Positive', iPos:true, avfPos:true },
  lad:     { angle:-55, range:'‚àí30¬∞ to ‚àí90¬∞', title:'Left Axis Deviation', color:'#FFB300', leadI:'‚Üë Positive', leadAVF:'‚Üì Negative', iPos:true, avfPos:false },
  rad:     { angle:130, range:'+90¬∞ to +180¬∞', title:'Right Axis Deviation', color:'#E040FB', leadI:'‚Üì Negative', leadAVF:'‚Üë Positive', iPos:false, avfPos:true },
  extreme: { angle:-130, range:'‚àí90¬∞ to ¬±180¬∞', title:'Extreme / Northwest', color:'#FF5252', leadI:'‚Üì Negative', leadAVF:'‚Üì Negative', iPos:false, avfPos:false }
};
let currentAxis = 'normal';

function drawAxisDiagram(type) {
  const canvas = document.getElementById('axisCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const size = 320;
  canvas.width = size; canvas.height = size;
  const cx = size/2, cy = size/2, r = size/2 - 30;
  const data = axisData[type];

  // Background
  ctx.fillStyle = '#1a1a2e';
  ctx.beginPath(); ctx.arc(cx, cy, r+25, 0, Math.PI*2); ctx.fill();

  // Quadrant shading
  const quadrants = [
    { start:-30, end:90, color:'rgba(0,230,118,0.06)', label:'Normal' },
    { start:-90, end:-30, color:'rgba(255,179,0,0.06)', label:'LAD' },
    { start:90, end:180, color:'rgba(224,64,251,0.06)', label:'RAD' },
    { start:-180, end:-90, color:'rgba(255,82,82,0.06)', label:'Extreme' }
  ];
  quadrants.forEach(q => {
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, q.start * Math.PI/180, q.end * Math.PI/180);
    ctx.closePath();
    ctx.fillStyle = q.color;
    ctx.fill();
  });

  // Highlight active quadrant
  const aq = quadrants.find(q => {
    if (type==='normal') return q.label==='Normal';
    if (type==='lad') return q.label==='LAD';
    if (type==='rad') return q.label==='RAD';
    return q.label==='Extreme';
  });
  if (aq) {
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, aq.start * Math.PI/180, aq.end * Math.PI/180);
    ctx.closePath();
    ctx.fillStyle = data.color + '18';
    ctx.fill();
    ctx.strokeStyle = data.color + '55';
    ctx.lineWidth = 1.5;
    ctx.stroke();
  }

  // Lead axes
  const leads = [
    { angle:0, label:'I (0¬∞)' },
    { angle:60, label:'II (+60¬∞)' },
    { angle:120, label:'III (+120¬∞)' },
    { angle:-150, label:'aVR (‚àí150¬∞)' },
    { angle:-30, label:'aVL (‚àí30¬∞)' },
    { angle:90, label:'aVF (+90¬∞)' }
  ];
  leads.forEach(l => {
    const rad = l.angle * Math.PI / 180;
    const x1 = cx + r * Math.cos(rad);
    const y1 = cy + r * Math.sin(rad);
    const x2 = cx - r * Math.cos(rad);
    const y2 = cy - r * Math.sin(rad);
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(255,255,255,0.12)';
    ctx.lineWidth = 0.8;
    ctx.moveTo(x2, y2);
    ctx.lineTo(x1, y1);
    ctx.stroke();
    // Lead label
    const lx = cx + (r+16) * Math.cos(rad);
    const ly = cy + (r+16) * Math.sin(rad);
    ctx.font = '600 8px "JetBrains Mono"';
    ctx.fillStyle = 'rgba(255,255,255,0.4)';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(l.label, lx, ly);
  });

  // Axis arrow
  const aRad = data.angle * Math.PI / 180;
  const ax = cx + (r - 10) * Math.cos(aRad);
  const ay = cy + (r - 10) * Math.sin(aRad);
  // Arrow body
  ctx.beginPath();
  ctx.moveTo(cx, cy);
  ctx.lineTo(ax, ay);
  ctx.strokeStyle = data.color;
  ctx.lineWidth = 3;
  ctx.stroke();
  // Arrow head
  const headLen = 12;
  const headAngle = Math.atan2(ay - cy, ax - cx);
  ctx.beginPath();
  ctx.moveTo(ax, ay);
  ctx.lineTo(ax - headLen * Math.cos(headAngle - 0.4), ay - headLen * Math.sin(headAngle - 0.4));
  ctx.moveTo(ax, ay);
  ctx.lineTo(ax - headLen * Math.cos(headAngle + 0.4), ay - headLen * Math.sin(headAngle + 0.4));
  ctx.strokeStyle = data.color;
  ctx.lineWidth = 2.5;
  ctx.stroke();
  // Center dot
  ctx.beginPath();
  ctx.arc(cx, cy, 4, 0, Math.PI*2);
  ctx.fillStyle = data.color;
  ctx.fill();

  // Degree markers around edge
  for (let deg = -180; deg < 180; deg += 30) {
    const dRad = deg * Math.PI / 180;
    const mx = cx + (r + 4) * Math.cos(dRad);
    const my = cy + (r + 4) * Math.sin(dRad);
    ctx.beginPath();
    ctx.arc(mx, my, 1.5, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(255,255,255,0.15)';
    ctx.fill();
  }
}

function setAxis(type) {
  currentAxis = type;
  const data = axisData[type];
  drawAxisDiagram(type);

  // Update info
  const titleEl = document.getElementById('axisResult')?.querySelector('.axis-result-title');
  const rangeEl = document.getElementById('axisResult')?.querySelector('.axis-result-range');
  if (titleEl) { titleEl.textContent = data.title; titleEl.style.color = data.color; }
  if (rangeEl) rangeEl.textContent = data.range;

  // Update Lead I / aVF display
  const liEl = document.getElementById('axisLeadI');
  const afEl = document.getElementById('axisLeadAVF');
  if (liEl) { liEl.textContent = data.leadI; liEl.className = 'axis-lead-val ' + (data.iPos ? 'pos' : 'neg'); }
  if (afEl) { afEl.textContent = data.leadAVF; afEl.className = 'axis-lead-val ' + (data.avfPos ? 'pos' : 'neg'); }

  // Update button active states
  document.querySelectorAll('.axis-btn').forEach(b => b.classList.remove('active'));
  const activeBtn = [...document.querySelectorAll('.axis-btn')].find(b => b.textContent.toLowerCase().includes(type === 'extreme' ? 'extreme' : type === 'lad' ? 'left' : type === 'rad' ? 'right' : 'normal'));
  if (activeBtn) activeBtn.classList.add('active');
}

// ================================================================
// 12-LEAD ECG INTERACTIVE
// ================================================================
let current12Lead = 'normal';

// Lead-specific waveform parameters: [pAmp, qAmp, rAmp, sAmp, stOffset, tAmp, prDur, qrsDur]
// pAmp: P wave amplitude, qAmp: Q depth, rAmp: R height, sAmp: S depth, stOffset: ST shift, tAmp: T wave
const leadProfiles = {
  normal: {
    info: ['Normal Sinus Rhythm', 'Normal axis. No ST elevation or depression. Normal R-wave progression V1‚ÜíV6 (R grows, S shrinks). All intervals normal.'],
    I:   [0.10, -0.04, 0.65, -0.05, 0, 0.20],
    II:  [0.12, -0.05, 0.90, -0.08, 0, 0.25],
    III: [0.06, -0.06, 0.45, -0.10, 0, 0.12],
    aVR: [-0.10, 0.04, -0.70, 0.05, 0, -0.18],
    aVL: [0.06, -0.02, 0.30, -0.04, 0, 0.10],
    aVF: [0.10, -0.06, 0.55, -0.08, 0, 0.18],
    V1:  [0.06, 0, 0.18, -0.65, 0, -0.08],
    V2:  [0.08, 0, 0.30, -0.55, 0, 0.15],
    V3:  [0.08, -0.03, 0.50, -0.40, 0, 0.22],
    V4:  [0.08, -0.04, 0.75, -0.20, 0, 0.25],
    V5:  [0.08, -0.03, 0.85, -0.10, 0, 0.22],
    V6:  [0.07, -0.02, 0.70, -0.05, 0, 0.18]
  },
  anterior: {
    info: ['Anterior STEMI', 'LAD occlusion. ST elevation V1‚ÄìV4. Reciprocal ST depression in II, III, aVF. Hyperacute T waves anterior. Loss of R-wave progression.'],
    I:   [0.10, -0.04, 0.60, -0.05, 0.02, 0.22],
    II:  [0.12, -0.05, 0.85, -0.08, -0.06, 0.10],
    III: [0.06, -0.06, 0.40, -0.10, -0.08, 0.05],
    aVR: [-0.10, 0.04, -0.70, 0.05, 0.04, -0.15],
    aVL: [0.06, -0.02, 0.32, -0.04, 0.03, 0.14],
    aVF: [0.10, -0.06, 0.50, -0.08, -0.07, 0.06],
    V1:  [0.06, 0, 0.12, -0.50, 0.20, 0.40],
    V2:  [0.08, 0, 0.15, -0.40, 0.28, 0.50],
    V3:  [0.08, -0.02, 0.25, -0.30, 0.25, 0.45],
    V4:  [0.08, -0.03, 0.40, -0.15, 0.18, 0.38],
    V5:  [0.08, -0.03, 0.80, -0.10, 0.04, 0.24],
    V6:  [0.07, -0.02, 0.68, -0.05, 0.02, 0.20]
  },
  inferior: {
    info: ['Inferior STEMI', 'RCA occlusion (85%) or LCx (15%). ST elevation II, III, aVF. Reciprocal ST depression I, aVL. Check V4R for RV involvement. Bradycardia common.'],
    I:   [0.10, -0.04, 0.60, -0.05, -0.06, 0.05],
    II:  [0.12, -0.05, 0.80, -0.08, 0.22, 0.45],
    III: [0.06, -0.06, 0.50, -0.10, 0.25, 0.48],
    aVR: [-0.10, 0.04, -0.70, 0.05, 0.03, -0.15],
    aVL: [0.06, -0.02, 0.28, -0.04, -0.10, -0.06],
    aVF: [0.10, -0.06, 0.60, -0.08, 0.20, 0.42],
    V1:  [0.06, 0, 0.18, -0.65, -0.02, -0.06],
    V2:  [0.08, 0, 0.30, -0.55, -0.02, 0.12],
    V3:  [0.08, -0.03, 0.50, -0.40, 0, 0.20],
    V4:  [0.08, -0.04, 0.75, -0.20, 0, 0.25],
    V5:  [0.08, -0.03, 0.82, -0.10, 0.02, 0.22],
    V6:  [0.07, -0.02, 0.68, -0.05, 0.02, 0.18]
  },
  lateral: {
    info: ['Lateral STEMI', 'LCx or diagonal branch occlusion. ST elevation I, aVL, V5, V6. Reciprocal ST depression II, III, aVF, V1-V3. Lateral wall involvement.'],
    I:   [0.10, -0.04, 0.60, -0.05, 0.18, 0.40],
    II:  [0.12, -0.05, 0.85, -0.08, -0.06, 0.08],
    III: [0.06, -0.06, 0.42, -0.10, -0.08, 0.04],
    aVR: [-0.10, 0.04, -0.70, 0.05, 0.03, -0.15],
    aVL: [0.06, -0.02, 0.35, -0.04, 0.20, 0.38],
    aVF: [0.10, -0.06, 0.50, -0.08, -0.07, 0.06],
    V1:  [0.06, 0, 0.18, -0.65, -0.04, -0.10],
    V2:  [0.08, 0, 0.28, -0.55, -0.04, 0.08],
    V3:  [0.08, -0.03, 0.48, -0.40, -0.02, 0.18],
    V4:  [0.08, -0.04, 0.72, -0.20, 0.04, 0.25],
    V5:  [0.08, -0.03, 0.80, -0.10, 0.16, 0.38],
    V6:  [0.07, -0.02, 0.70, -0.05, 0.18, 0.35]
  },
  posterior: {
    info: ['Posterior MI', 'PDA occlusion. No direct ST elevation on standard 12-lead ‚Äî look for mirror image. ST depression V1-V3 with tall R waves and upright T waves. Obtain V7-V9 for confirmation (ST elevation ‚â• 0.5mm).'],
    I:   [0.10, -0.04, 0.62, -0.05, 0, 0.18],
    II:  [0.12, -0.05, 0.85, -0.08, 0.04, 0.22],
    III: [0.06, -0.06, 0.48, -0.10, 0.05, 0.14],
    aVR: [-0.10, 0.04, -0.70, 0.05, 0, -0.18],
    aVL: [0.06, -0.02, 0.30, -0.04, 0, 0.10],
    aVF: [0.10, -0.06, 0.55, -0.08, 0.04, 0.18],
    V1:  [0.06, 0, 0.55, -0.20, -0.12, 0.25],
    V2:  [0.08, 0, 0.60, -0.15, -0.14, 0.30],
    V3:  [0.08, 0, 0.55, -0.12, -0.10, 0.25],
    V4:  [0.08, -0.04, 0.72, -0.18, -0.03, 0.22],
    V5:  [0.08, -0.03, 0.82, -0.10, 0, 0.22],
    V6:  [0.07, -0.02, 0.70, -0.05, 0, 0.18]
  },
  anteroseptal: {
    info: ['Anteroseptal STEMI', 'Proximal LAD occlusion. ST elevation V1-V3 (septal) and V3-V4 (anterior). Poor R-wave progression. Reciprocal depression II, III, aVF. High mortality ‚Äî large territory.'],
    I:   [0.10, -0.04, 0.58, -0.05, 0.02, 0.20],
    II:  [0.12, -0.05, 0.82, -0.08, -0.05, 0.10],
    III: [0.06, -0.06, 0.40, -0.10, -0.07, 0.05],
    aVR: [-0.10, 0.04, -0.68, 0.05, 0.05, -0.14],
    aVL: [0.06, -0.02, 0.32, -0.04, 0.04, 0.14],
    aVF: [0.10, -0.06, 0.48, -0.08, -0.06, 0.06],
    V1:  [0.06, 0, 0.10, -0.45, 0.25, 0.45],
    V2:  [0.08, 0, 0.12, -0.35, 0.30, 0.52],
    V3:  [0.08, -0.02, 0.22, -0.28, 0.22, 0.42],
    V4:  [0.08, -0.03, 0.38, -0.15, 0.15, 0.35],
    V5:  [0.08, -0.03, 0.78, -0.10, 0.03, 0.22],
    V6:  [0.07, -0.02, 0.68, -0.05, 0.01, 0.18]
  },
  rv_infarct: {
    info: ['Inferior + RV Infarct', 'Proximal RCA occlusion. ST elevation II, III, aVF (inferior) with V1 ST elevation suggesting RV involvement. Reciprocal depression I, aVL. DO NOT give NTG or diuretics ‚Äî preload dependent. Treat with fluid bolus.'],
    I:   [0.10, -0.04, 0.58, -0.05, -0.07, 0.04],
    II:  [0.12, -0.05, 0.78, -0.08, 0.22, 0.44],
    III: [0.06, -0.06, 0.52, -0.10, 0.26, 0.50],
    aVR: [-0.10, 0.04, -0.68, 0.05, 0.04, -0.14],
    aVL: [0.06, -0.02, 0.28, -0.04, -0.12, -0.08],
    aVF: [0.10, -0.06, 0.58, -0.08, 0.22, 0.44],
    V1:  [0.06, 0, 0.22, -0.55, 0.14, 0.30],
    V2:  [0.08, 0, 0.28, -0.50, 0.04, 0.15],
    V3:  [0.08, -0.03, 0.48, -0.38, 0, 0.20],
    V4:  [0.08, -0.04, 0.72, -0.20, 0, 0.24],
    V5:  [0.08, -0.03, 0.80, -0.10, 0, 0.22],
    V6:  [0.07, -0.02, 0.68, -0.05, 0, 0.18]
  },
  wellens: {
    info: ['Wellens Syndrome', 'Critical proximal LAD stenosis (pre-infarction pattern). Deep symmetric T-wave inversions V2-V3 (Type A, 75%) or biphasic T waves V2-V3 (Type B, 25%). Pain-FREE when ECG shows changes. Normal or minimally elevated troponin. This patient WILL infarct without cath ‚Äî do NOT stress test.'],
    highlights: { V1:'warn', V2:'warn', V3:'warn', V4:'warn' },
    I:   [0.10, -0.04, 0.65, -0.05, 0, 0.18],
    II:  [0.12, -0.05, 0.90, -0.08, 0, 0.22],
    III: [0.06, -0.06, 0.45, -0.10, 0, 0.12],
    aVR: [-0.10, 0.04, -0.70, 0.05, 0, -0.18],
    aVL: [0.06, -0.02, 0.30, -0.04, 0, 0.08],
    aVF: [0.10, -0.06, 0.55, -0.08, 0, 0.15],
    V1:  [0.06, 0, 0.18, -0.65, 0.01, -0.15],
    V2:  [0.08, 0, 0.30, -0.55, 0.02, -0.35],
    V3:  [0.08, -0.03, 0.50, -0.40, 0.01, -0.32],
    V4:  [0.08, -0.04, 0.75, -0.20, 0, -0.15],
    V5:  [0.08, -0.03, 0.85, -0.10, 0, 0.10],
    V6:  [0.07, -0.02, 0.70, -0.05, 0, 0.15]
  },
  hyperkalemia: {
    info: ['Hyperkalemia (K‚Å∫ > 6.5 mEq/L)', 'Tall peaked T waves (earliest sign), widened QRS, flattened/absent P waves, prolonged PR. Severe: sine wave pattern ‚Üí asystole. Life-threatening emergency. Treat: Calcium gluconate (membrane stabilizer), insulin + glucose, sodium bicarb, albuterol, kayexalate.'],
    highlights: { I:'warn', II:'warn', III:'warn', aVF:'warn', V1:'warn', V2:'warn', V3:'warn', V4:'warn', V5:'warn', V6:'warn' },
    qrsScale: 1.6,
    I:   [0.04, -0.06, 0.55, -0.08, 0.01, 0.42],
    II:  [0.04, -0.08, 0.72, -0.12, 0.02, 0.50],
    III: [0.02, -0.08, 0.38, -0.14, 0.01, 0.35],
    aVR: [-0.03, 0.06, -0.60, 0.08, -0.01, -0.40],
    aVL: [0.02, -0.04, 0.28, -0.06, 0, 0.22],
    aVF: [0.03, -0.08, 0.48, -0.12, 0.02, 0.38],
    V1:  [0.02, 0, 0.15, -0.52, 0.01, 0.35],
    V2:  [0.03, 0, 0.25, -0.42, 0.02, 0.48],
    V3:  [0.03, -0.04, 0.42, -0.35, 0.02, 0.52],
    V4:  [0.03, -0.06, 0.65, -0.22, 0.01, 0.48],
    V5:  [0.03, -0.05, 0.75, -0.12, 0.01, 0.42],
    V6:  [0.03, -0.04, 0.62, -0.08, 0, 0.35]
  },
  early_repol: {
    info: ['Benign Early Repolarization', 'Concave-up ("smiley face") ST elevation most prominent in V2‚ÄìV5 with J-point notching/slurring. Tall concordant T waves. NO reciprocal ST depression. Common in young males, athletes, and African Americans. Key STEMI mimic ‚Äî differentiate by: concavity, no reciprocal changes, no evolution, J-point notch, and clinical context.'],
    highlights: { V2:'warn', V3:'warn', V4:'warn', V5:'warn' },
    jNotch: true,
    I:   [0.10, -0.04, 0.65, -0.05, 0.04, 0.24],
    II:  [0.12, -0.05, 0.90, -0.08, 0.05, 0.28],
    III: [0.06, -0.06, 0.45, -0.10, 0.03, 0.16],
    aVR: [-0.10, 0.04, -0.70, 0.05, -0.02, -0.18],
    aVL: [0.06, -0.02, 0.30, -0.04, 0.02, 0.12],
    aVF: [0.10, -0.06, 0.55, -0.08, 0.04, 0.20],
    V1:  [0.06, 0, 0.18, -0.65, 0.04, 0.12],
    V2:  [0.08, 0, 0.32, -0.52, 0.10, 0.35],
    V3:  [0.08, -0.03, 0.55, -0.38, 0.12, 0.38],
    V4:  [0.08, -0.04, 0.78, -0.18, 0.10, 0.35],
    V5:  [0.08, -0.03, 0.85, -0.10, 0.07, 0.30],
    V6:  [0.07, -0.02, 0.70, -0.05, 0.04, 0.22]
  },
  rbbb: {
    info: ['Right Bundle Branch Block', 'QRS ‚â• 0.12s. RSR\' ("rabbit ears") in V1-V2 ‚Äî M-shaped. Wide slurred S wave in I, V5-V6. Secondary ST-T changes (ST depression, T inversion) in V1-V3 are expected repolarization abnormalities, NOT ischemia. "MaRRoW" mnemonic. Can be normal variant or pathological (PE, RV strain, ASD, anterior MI).'],
    highlights: { V1:'warn', V2:'warn' },
    qrsScale: 1.4,
    bbbType: 'rbbb',
    I:   [0.10, -0.04, 0.60, -0.20, 0, 0.15],
    II:  [0.12, -0.05, 0.85, -0.18, 0, 0.20],
    III: [0.06, -0.06, 0.40, -0.15, 0, 0.10],
    aVR: [-0.10, 0.04, -0.65, 0.12, 0, -0.15],
    aVL: [0.06, -0.02, 0.30, -0.16, 0, 0.08],
    aVF: [0.10, -0.06, 0.50, -0.16, 0, 0.14],
    V1:  [0.06, 0, 0.25, -0.45, -0.04, -0.18, 0.55],
    V2:  [0.08, 0, 0.30, -0.38, -0.03, -0.12, 0.35],
    V3:  [0.08, -0.03, 0.48, -0.30, -0.02, -0.05, 0.10],
    V4:  [0.08, -0.04, 0.72, -0.22, 0, 0.20],
    V5:  [0.08, -0.03, 0.82, -0.18, 0, 0.18],
    V6:  [0.07, -0.02, 0.68, -0.15, 0, 0.15]
  },
  lbbb: {
    info: ['Left Bundle Branch Block', 'QRS ‚â• 0.12s. Broad notched/slurred R wave (M-pattern) in I, aVL, V5-V6. Deep broad QS or rS (W-pattern) in V1. Absent septal Q waves. Discordant ST-T changes (ST/T opposite to QRS direction) are expected. "WiLLiaM" mnemonic. ALWAYS pathological ‚Äî HTN, cardiomyopathy, aortic valve disease. New LBBB + chest pain = STEMI equivalent ‚Üí cath lab.'],
    highlights: { V1:'warn', V2:'warn', V5:'warn', V6:'warn', I:'warn', aVL:'warn' },
    qrsScale: 1.5,
    bbbType: 'lbbb',
    I:   [0.10, 0, 0.75, -0.03, -0.06, -0.18],
    II:  [0.12, -0.03, 0.80, -0.05, -0.04, -0.15],
    III: [0.06, -0.05, 0.30, -0.12, 0.03, 0.10],
    aVR: [-0.10, 0.03, -0.72, 0.03, 0.04, 0.16],
    aVL: [0.06, 0, 0.55, -0.02, -0.05, -0.15],
    aVF: [0.10, -0.04, 0.48, -0.08, 0, 0.08],
    V1:  [0.06, -0.02, 0.05, -0.80, 0.08, 0.30],
    V2:  [0.08, -0.02, 0.08, -0.70, 0.06, 0.25],
    V3:  [0.08, -0.02, 0.25, -0.50, 0.02, 0.12],
    V4:  [0.08, 0, 0.60, -0.15, -0.03, -0.10],
    V5:  [0.08, 0, 0.85, -0.04, -0.06, -0.20],
    V6:  [0.07, 0, 0.72, -0.03, -0.05, -0.18]
  }
};

// Parameterized single-lead waveform generator
// params: [pAmp, qAmp, rAmp, sAmp, stOffset, tAmp]
// qrsScale: optional QRS width factor (1.0 = normal, 1.5 = wide)
function waveLead(t, params, qrsScale, jNotch, bbbType) {
  const [pAmp, qAmp, rAmp, sAmp, stOff, tAmp] = params;
  const rPrime = params[6] || 0; // 7th element: R' amplitude for RBBB
  const qs = qrsScale || 1.0;
  // P wave
  if (t < 0.02) return 0;
  if (t < 0.12) { const p = (t-0.02)/0.10; return pAmp * Math.sin(p*Math.PI); }
  // PR segment
  if (t < 0.20) return 0;

  // LBBB notched R: split R wave into two humps with a dip
  if (bbbType === 'lbbb' && rAmp > 0.3) {
    // Q wave (minimal or absent in LBBB lateral leads)
    const qEnd = 0.20 + 0.02 * qs;
    if (t < qEnd) { const q = (t-0.20)/(0.02*qs); return qAmp * Math.sin(q*Math.PI); }
    // Notched R: first hump
    const r1End = qEnd + 0.03 * qs;
    if (t < r1End) { const r = (t-qEnd)/(0.03*qs); return rAmp * 0.85 * Math.sin(r*Math.PI); }
    // Notch dip
    const notchEnd = r1End + 0.015 * qs;
    if (t < notchEnd) { const n = (t-r1End)/(0.015*qs); return rAmp * (0.85 - 0.25 * Math.sin(n*Math.PI)); }
    // Second hump
    const r2End = notchEnd + 0.03 * qs;
    if (t < r2End) { const r = (t-notchEnd)/(0.03*qs); return rAmp * Math.sin(r*Math.PI); }
    // S wave (minimal in lateral LBBB)
    const sEnd = r2End + 0.02 * qs;
    if (t < sEnd) { const s = (t-r2End)/(0.02*qs); return sAmp * Math.sin(s*Math.PI); }
    // ST + T (discordant)
    const jEnd2 = sEnd + 0.03;
    if (t < jEnd2) { const j = (t-sEnd)/0.03; return stOff * j; }
    const stEnd2 = jEnd2 + 0.10;
    if (t < stEnd2) return stOff;
    const tEnd2 = stEnd2 + 0.18;
    if (t < tEnd2) { const tw = (t-stEnd2)/0.18; return stOff*(1-tw) + tAmp * Math.sin(tw*Math.PI); }
    return 0;
  }

  // LBBB deep QS in V1: broad W-shaped downward deflection
  if (bbbType === 'lbbb' && sAmp < -0.4) {
    const qEnd = 0.20 + 0.02 * qs;
    if (t < qEnd) { const q = (t-0.20)/(0.02*qs); return qAmp * Math.sin(q*Math.PI); }
    // Small r (may be zero)
    const rEnd = qEnd + 0.02 * qs;
    if (t < rEnd) { const r = (t-qEnd)/(0.02*qs); return rAmp * Math.sin(r*Math.PI); }
    // Deep broad S (the dominant deflection)
    const s1End = rEnd + 0.03 * qs;
    if (t < s1End) { const s = (t-rEnd)/(0.03*qs); return sAmp * Math.sin(s*Math.PI); }
    // Brief return + second dip (W shape)
    const midEnd = s1End + 0.015 * qs;
    if (t < midEnd) { const m = (t-s1End)/(0.015*qs); return sAmp * 0.3 * (1 - Math.sin(m*Math.PI)); }
    // Second downward portion
    const s2End = midEnd + 0.025 * qs;
    if (t < s2End) { const s = (t-midEnd)/(0.025*qs); return sAmp * 0.5 * Math.sin(s*Math.PI); }
    // ST + T (discordant ‚Äî positive T with negative QRS)
    const jEnd3 = s2End + 0.03;
    if (t < jEnd3) { const j = (t-s2End)/0.03; return stOff * j; }
    const stEnd3 = jEnd3 + 0.10;
    if (t < stEnd3) return stOff;
    const tEnd3 = stEnd3 + 0.18;
    if (t < tEnd3) { const tw = (t-stEnd3)/0.18; return stOff*(1-tw) + tAmp * Math.sin(tw*Math.PI); }
    return 0;
  }

  // Standard Q-R-S (with optional R' for RBBB)
  // Q wave (scaled width)
  const qEnd = 0.20 + 0.02 * qs;
  if (t < qEnd) { const q = (t-0.20)/(0.02*qs); return qAmp * Math.sin(q*Math.PI); }
  // R wave (scaled width)
  const rEnd = qEnd + 0.04 * qs;
  if (t < rEnd) { const r = (t-qEnd)/(0.04*qs); return rAmp * Math.sin(r*Math.PI); }
  // S wave (scaled width)
  const sEnd = rEnd + 0.03 * qs;
  if (t < sEnd) { const s = (t-rEnd)/(0.03*qs); return sAmp * Math.sin(s*Math.PI); }
  // R' wave for RBBB (tall second R wave after S)
  const rpEnd = sEnd + (rPrime ? 0.035 * qs : 0);
  if (rPrime && t < rpEnd) { const rp = (t-sEnd)/(0.035*qs); return rPrime * Math.sin(rp*Math.PI); }
  // J-point notch (small upward bump at end of QRS, before ST segment)
  const baseEnd = rPrime ? rpEnd : sEnd;
  const jNotchEnd = baseEnd + (jNotch ? 0.025 : 0);
  if (jNotch && t < jNotchEnd) {
    const jn = (t - baseEnd) / 0.025;
    const notchAmp = Math.max(stOff * 0.7, 0.04);
    return notchAmp * Math.sin(jn * Math.PI);
  }
  // J point + ST segment
  const jBase = jNotch ? jNotchEnd : baseEnd;
  const jEnd = jBase + 0.03;
  if (t < jEnd) { const j = (t-jBase)/0.03; return stOff * j; }
  const stEnd = jEnd + 0.10;
  if (t < stEnd) return stOff;
  // T wave ‚Äî use peaked shape for large T amplitudes
  const tEnd = stEnd + 0.18;
  if (t < tEnd) {
    const tw = (t-stEnd)/0.18;
    if (Math.abs(tAmp) > 0.35) {
      // Peaked T wave (hyperkalemia, hyperacute)
      const peak = tAmp > 0 ? Math.pow(Math.sin(tw*Math.PI), 1.8) : -Math.pow(Math.sin(tw*Math.PI), 1.8);
      return stOff*(1-tw) + Math.abs(tAmp) * peak;
    }
    return stOff*(1-tw) + tAmp * Math.sin(tw*Math.PI);
  }
  return 0;
}

function draw12LeadSingle(canvasId, params, isSTElevation, isSTDepression, isWarn, qrsScale, jNotch, bbbType) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const parent = canvas.parentElement;
  const isRhythm = canvasId === 'tl-rhythm';
  
  // Robust sizing: use computed CSS dimensions
  const rect = canvas.getBoundingClientRect();
  canvas.width = Math.max(rect.width, 100);
  canvas.height = Math.max(rect.height, isRhythm ? 90 : 100);
  const w = canvas.width, h = canvas.height;
  
  // ECG paper background
  drawECGPaper(ctx, w, h);
  
  // Mark STE/STD/Warn borders on lead container
  if (!isRhythm) {
    parent.classList.remove('ste','std','twarn');
    if (isSTElevation) parent.classList.add('ste');
    if (isSTDepression) parent.classList.add('std');
    if (isWarn) parent.classList.add('twarn');
  }
  
  const mid = h * 0.48, amp = h * 0.40;
  const pxPerSec = w / (isRhythm ? 6 : 2.5);
  const period = pxPerSec * (60 / 75); // 75 bpm
  
  // Draw trace ‚Äî color by state
  const traceColor = isSTElevation ? '#FF5252' : isSTDepression ? '#448AFF' : isWarn ? '#FFB300' : '#00E676';
  ctx.beginPath();
  ctx.strokeStyle = traceColor;
  ctx.lineWidth = 1.8;
  ctx.lineJoin = 'round';
  
  for (let px = 0; px < w; px++) {
    const t = (px % period) / period;
    const val = waveLead(t, params, qrsScale, jNotch, bbbType);
    const py = mid - val * amp;
    if (px === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
  }
  ctx.stroke();
  
  // Draw ST offset highlight band if elevated or depressed
  if ((isSTElevation || isSTDepression) && !isRhythm) {
    const stOff = params[4];
    const stY = mid - stOff * amp;
    ctx.fillStyle = isSTElevation ? 'rgba(255,82,82,0.08)' : 'rgba(68,138,255,0.08)';
    const bandTop = Math.min(mid, stY);
    const bandH = Math.abs(stOff * amp);
    for (let beat = 0; beat < Math.ceil(w / period); beat++) {
      const bx = beat * period;
      const stStart = bx + period * 0.32;
      const stEnd = bx + period * 0.42;
      ctx.fillRect(stStart, bandTop, stEnd - stStart, bandH);
    }
  }
}

function draw12Lead() {
  const profile = leadProfiles[current12Lead];
  if (!profile) return;
  
  // Update info
  document.getElementById('tlInfoTitle').textContent = profile.info[0];
  document.getElementById('tlInfoDesc').textContent = profile.info[1];
  
  const leads = ['I','II','III','aVR','aVL','aVF','V1','V2','V3','V4','V5','V6'];
  const highlights = profile.highlights || {};
  const qrsScale = profile.qrsScale || 1.0;
  const jNotch = profile.jNotch || false;
  const bbbType = profile.bbbType || null;
  
  leads.forEach(lead => {
    const params = profile[lead];
    const stOff = params[4];
    const hl = highlights[lead];
    const isSTE = !hl && stOff >= 0.10;
    const isSTD = !hl && stOff <= -0.04;
    const isWarn = hl === 'warn';
    draw12LeadSingle('tl-' + lead, params, isSTE, isSTD, isWarn, qrsScale, jNotch, bbbType);
  });
  
  // Rhythm strip = Lead II, longer
  draw12LeadSingle('tl-rhythm', profile['II'], false, false, false, qrsScale, jNotch, bbbType);
  
  // Update button active states
  const btnMap = {normal:'Normal',anterior:'Anterior STEMI',inferior:'Inferior STEMI',lateral:'Lateral STEMI',posterior:'Posterior MI',anteroseptal:'Anteroseptal',rv_infarct:'RV Infarct',wellens:'Wellens',hyperkalemia:'Hyperkalemia',early_repol:'Early Repolarization',rbbb:'RBBB',lbbb:'LBBB'};
  document.querySelectorAll('.twelve-btn').forEach(b => {
    b.classList.toggle('active', b.textContent === btnMap[current12Lead]);
  });
}

function set12Lead(scenario) {
  current12Lead = scenario;
  draw12Lead();
}

// ================================================================
// HEART SOUNDS ‚Äî Web Audio API Synthesis
// ================================================================
let hsAudioCtx = null;
let hsPlaying = false;

function getAudioCtx() {
  if (!hsAudioCtx) hsAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return hsAudioCtx;
}

function synthHeartSound(type, startTime, ctx, dest) {
  // Each heart sound = filtered noise burst + low-frequency thump
  const sr = ctx.sampleRate;
  const params = {
    s1: { dur: 0.12, freq: 60, freq2: 45, noiseAmt: 0.25, amp: 0.8, attack: 0.008, decay: 0.11 },
    s2: { dur: 0.08, freq: 80, freq2: 65, noiseAmt: 0.30, amp: 0.65, attack: 0.005, decay: 0.07 },
    s3: { dur: 0.07, freq: 35, freq2: 28, noiseAmt: 0.12, amp: 0.30, attack: 0.01, decay: 0.06 },
    s4: { dur: 0.06, freq: 30, freq2: 25, noiseAmt: 0.10, amp: 0.25, attack: 0.008, decay: 0.05 }
  };
  const p = params[type];
  const len = Math.ceil(p.dur * sr);
  const buf = ctx.createBuffer(1, len, sr);
  const data = buf.getChannelData(0);
  
  for (let i = 0; i < len; i++) {
    const t = i / sr;
    const env = t < p.attack ? t / p.attack : Math.exp(-(t - p.attack) / (p.decay * 0.4));
    // Low thump (two sine components)
    const thump = Math.sin(2 * Math.PI * p.freq * t) * 0.6 + Math.sin(2 * Math.PI * p.freq2 * t) * 0.4;
    // Filtered noise component
    const noise = (Math.random() * 2 - 1) * p.noiseAmt;
    data[i] = (thump + noise) * env * p.amp;
  }
  
  const src = ctx.createBufferSource();
  src.buffer = buf;
  
  // Low-pass filter for realistic muffled sound
  const filter = ctx.createBiquadFilter();
  filter.type = 'lowpass';
  filter.frequency.value = type === 's2' ? 200 : 120;
  filter.Q.value = 0.7;
  
  const gain = ctx.createGain();
  gain.gain.value = 1.2;
  
  src.connect(filter);
  filter.connect(gain);
  gain.connect(dest);
  src.start(startTime);
  return p.dur;
}

function playHeartSound(type) {
  const ctx = getAudioCtx();
  if (ctx.state === 'suspended') ctx.resume();
  
  // Visual feedback
  document.querySelectorAll('.hs-card').forEach(c => c.classList.remove('playing'));
  const card = document.getElementById('hs-' + type);
  if (card) card.classList.add('playing');
  
  // Play sound twice with short gap
  synthHeartSound(type, ctx.currentTime + 0.05, ctx, ctx.destination);
  synthHeartSound(type, ctx.currentTime + 0.55, ctx, ctx.destination);
  
  // Draw waveform
  drawHSWaveform(type);
  
  setTimeout(() => { if (card) card.classList.remove('playing'); }, 1000);
}

function playHeartPattern(pattern) {
  const ctx = getAudioCtx();
  if (ctx.state === 'suspended') ctx.resume();
  if (hsPlaying) return;
  hsPlaying = true;
  
  const now = ctx.currentTime + 0.05;
  const beatInterval = 0.85; // ~72 bpm
  const beats = 4;
  
  // Highlight all cards involved
  document.querySelectorAll('.hs-card').forEach(c => c.classList.remove('playing'));
  
  for (let b = 0; b < beats; b++) {
    const beatStart = now + b * beatInterval;
    if (pattern === 'normal') {
      synthHeartSound('s1', beatStart, ctx, ctx.destination);
      synthHeartSound('s2', beatStart + 0.30, ctx, ctx.destination);
    } else if (pattern === 's3gallop') {
      synthHeartSound('s1', beatStart, ctx, ctx.destination);
      synthHeartSound('s2', beatStart + 0.28, ctx, ctx.destination);
      synthHeartSound('s3', beatStart + 0.48, ctx, ctx.destination);
    } else if (pattern === 's4gallop') {
      synthHeartSound('s4', beatStart, ctx, ctx.destination);
      synthHeartSound('s1', beatStart + 0.12, ctx, ctx.destination);
      synthHeartSound('s2', beatStart + 0.42, ctx, ctx.destination);
    } else if (pattern === 'summation') {
      synthHeartSound('s4', beatStart, ctx, ctx.destination);
      synthHeartSound('s1', beatStart + 0.12, ctx, ctx.destination);
      synthHeartSound('s2', beatStart + 0.42, ctx, ctx.destination);
      synthHeartSound('s3', beatStart + 0.60, ctx, ctx.destination);
    }
  }
  
  // Highlight relevant cards
  const cardMap = { normal: ['s1','s2'], s3gallop: ['s1','s2','s3'], s4gallop: ['s4','s1','s2'], summation: ['s1','s2','s3','s4'] };
  (cardMap[pattern] || []).forEach(t => {
    const c = document.getElementById('hs-' + t);
    if (c) c.classList.add('playing');
  });
  
  const totalTime = beats * beatInterval * 1000 + 400;
  setTimeout(() => {
    hsPlaying = false;
    document.querySelectorAll('.hs-card').forEach(c => c.classList.remove('playing'));
  }, totalTime);
}

function drawHSWaveform(type) {
  const canvas = document.getElementById('hsCanvas-' + type);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.parentElement.clientWidth - 40;
  canvas.height = 80;
  const w = canvas.width, h = canvas.height;
  
  // Background
  ctx.fillStyle = '#1C1410';
  ctx.fillRect(0, 0, w, h);
  
  // Grid lines
  ctx.strokeStyle = 'rgba(180,100,80,0.12)';
  ctx.lineWidth = 0.5;
  for (let y = 0; y < h; y += 10) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
  for (let x = 0; x < w; x += 10) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
  
  // Synthesize waveform data for display
  const params = {
    s1: { dur: 0.12, freq: 60, freq2: 45, noiseAmt: 0.15, amp: 0.8, attack: 0.008, decay: 0.11 },
    s2: { dur: 0.08, freq: 80, freq2: 65, noiseAmt: 0.18, amp: 0.65, attack: 0.005, decay: 0.07 },
    s3: { dur: 0.07, freq: 35, freq2: 28, noiseAmt: 0.08, amp: 0.30, attack: 0.01, decay: 0.06 },
    s4: { dur: 0.06, freq: 30, freq2: 25, noiseAmt: 0.06, amp: 0.25, attack: 0.008, decay: 0.05 }
  };
  const p = params[type];
  const colors = { s1: '#C8102E', s2: '#118AB2', s3: '#00E676', s4: '#FFD166' };
  
  // Draw two beats
  const mid = h / 2;
  const beatW = w / 2.5;
  const sampleRate = 4000;
  
  for (let beat = 0; beat < 2; beat++) {
    const ox = w * 0.12 + beat * beatW;
    const samples = Math.ceil(p.dur * sampleRate);
    const pxPerSample = Math.min(beatW * 0.6, 120) / samples;
    
    ctx.beginPath();
    ctx.strokeStyle = colors[type];
    ctx.lineWidth = 2;
    ctx.lineJoin = 'round';
    
    for (let i = 0; i < samples; i++) {
      const t = i / sampleRate;
      const env = t < p.attack ? t / p.attack : Math.exp(-(t - p.attack) / (p.decay * 0.4));
      const sig = (Math.sin(2*Math.PI*p.freq*t)*0.6 + Math.sin(2*Math.PI*p.freq2*t)*0.4) * env * p.amp;
      const px = ox + i * pxPerSample;
      const py = mid - sig * (h * 0.42);
      if (i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
    }
    ctx.stroke();
    
    // Label
    ctx.font = '600 10px "JetBrains Mono"';
    ctx.fillStyle = colors[type];
    ctx.textAlign = 'center';
    ctx.fillText(type.toUpperCase(), ox + samples * pxPerSample / 2, h - 6);
  }
  
  // Baseline
  ctx.strokeStyle = 'rgba(255,255,255,0.1)';
  ctx.lineWidth = 0.5;
  ctx.setLineDash([3,3]);
  ctx.beginPath(); ctx.moveTo(0, mid); ctx.lineTo(w, mid); ctx.stroke();
  ctx.setLineDash([]);
}

// Draw initial static waveforms on load
function initHSWaveforms() {
  ['s1','s2','s3','s4'].forEach(t => drawHSWaveform(t));
}

// ================================================================
// CONDUCTION ANIMATION ‚Äî Click any step or play all
// ================================================================
const conductionSteps = ['ts-sa','ts-inter','ts-av','ts-his','ts-purk'];
const conductionPositions = [{cx:130,cy:115},{cx:165,cy:170},{cx:200,cy:220},{cx:200,cy:260},{cx:200,cy:380}];
const conductionSvgIds = [
  ['cSA'],           // step 0: SA node
  ['cInter'],        // step 1: internodal
  ['cAV'],           // step 2: AV node
  ['cHis','cLBB','cRBB'], // step 3: His + bundle branches
  ['cPurk']          // step 4: Purkinje
];
const allConductionSvg = ['cSA','cInter','cAV','cHis','cLBB','cRBB','cPurk'];
let conductionAnimRunning = false;
let conductionAnimTimeout = null;

function resetConduction() {
  conductionAnimRunning = false;
  if (conductionAnimTimeout) { clearTimeout(conductionAnimTimeout); conductionAnimTimeout = null; }
  conductionSteps.forEach(s => document.getElementById(s).classList.remove('active'));
  allConductionSvg.forEach(id => {
    const el = document.getElementById(id);
    el.style.opacity = '0.2';
    el.style.transition = 'opacity 0.4s';
  });
  const dot = document.getElementById('impulseDot');
  dot.style.opacity = '0';
  dot.style.transition = 'none';
}

function lightUpStep(stepIdx) {
  const dot = document.getElementById('impulseDot');
  // Light up SVG elements for this step
  conductionSvgIds[stepIdx].forEach(id => {
    const el = document.getElementById(id);
    el.style.transition = 'opacity 0.5s ease';
    el.style.opacity = '1';
  });
  // Activate timeline label
  document.getElementById(conductionSteps[stepIdx]).classList.add('active');
  // Move impulse dot with smooth transition
  dot.style.transition = 'all 0.5s ease';
  dot.style.opacity = '1';
  dot.setAttribute('cx', conductionPositions[stepIdx].cx);
  dot.setAttribute('cy', conductionPositions[stepIdx].cy);
}

function animateSingleStep(stepIdx) {
  // If play-all is running, stop it
  if (conductionAnimRunning) {
    resetConduction();
    // Give a tick then light up clicked step
    setTimeout(() => lightUpStep(stepIdx), 50);
    return;
  }
  // Reset everything first, then animate only the clicked step
  conductionSteps.forEach(s => document.getElementById(s).classList.remove('active'));
  allConductionSvg.forEach(id => {
    document.getElementById(id).style.transition = 'opacity 0.35s';
    document.getElementById(id).style.opacity = '0.2';
  });
  const dot = document.getElementById('impulseDot');
  dot.style.transition = 'none';
  dot.style.opacity = '0';
  // Brief delay to let reset take effect visually
  setTimeout(() => lightUpStep(stepIdx), 80);
}

function startConductionAnim() {
  if (conductionAnimRunning) return;
  resetConduction();
  conductionAnimRunning = true;

  function animStep(step) {
    if (step >= conductionSteps.length || !conductionAnimRunning) {
      conductionAnimRunning = false;
      const dot = document.getElementById('impulseDot');
      setTimeout(() => { if (!conductionAnimRunning) dot.style.opacity = '0'; }, 1000);
      return;
    }
    lightUpStep(step);
    const delay = step === 2 ? 1200 : 700; // AV node delay is longer
    conductionAnimTimeout = setTimeout(() => animStep(step + 1), delay);
  }
  setTimeout(() => animStep(0), 100);
}

// ================================================================
// DYSRHYTHMIA GALLERY
// ================================================================
const galleryCards = {
  sa: ['nsr','sbrad','stach','sinus_arr','sinus_arrest'],
  atrial: ['pac','afib','aflutter','svt','wap','mat'],
  junct: ['junctional','accel_junct','junct_tach'],
  vent: ['pvc','bigeminy','trigeminy','pvc_couplet','multifocal_pvc','vtach','torsades','vfib','asystole','idiovent','aivr','agonal','paced'],
  block: ['1avb','wenck','mobitz2','3avb']
};

function drawStaticRhythm(ctx, w, h, key) {
  const r = RHYTHMS[key];
  drawECGPaper(ctx, w, h);
  
  const mid = h*0.48, amp = h*0.38;
  // Show ~3 seconds of rhythm
  const pxPerSec = w / 3;
  const period = r.rate > 0 ? pxPerSec * (60 / r.rate) : w;
  
  ctx.beginPath();
  ctx.strokeStyle = '#00E676';
  ctx.lineWidth = 1.8;
  ctx.lineJoin = 'round';
  
  for (let px = 0; px < w; px++) {
    let y = 0;
    const xVal = px;
    
    if (key === 'vfib') { y = waveVFib(xVal*0.08); }
    else if (key === 'asystole') { y = waveAsystole(xVal*0.08); }
    else if (key === 'torsades') {
      const beatLen = pxPerSec * (60/r.rate);
      const beat = Math.floor(xVal/beatLen);
      const t = (xVal%beatLen)/beatLen;
      y = waveTorsades(t, beat);
    } else if (key === 'afib') {
      const irregP = period*(0.65+0.70*(0.5+0.5*Math.sin(xVal*0.02)));
      const t = (xVal%irregP)/irregP;
      y = waveAFib(t, xVal*0.08);
    } else if (key === 'aflutter') {
      const t = (xVal%period)/period;
      y = waveAFlutter(t, xVal*0.02);
    } else if (key === '3avb') {
      const t = (xVal%period)/period;
      y = wave3AVB(t, xVal*0.02, period*0.02);
    } else if (key === 'pvc') {
      const cn = Math.floor(xVal/period);
      const t = (xVal%period)/period;
      y = cn%4===2 ? wavePVC(t) : waveNSR(t);
    } else if (key === 'bigeminy') {
      const cn = Math.floor(xVal/period);
      const t = (xVal%period)/period;
      y = cn%2===1 ? wavePVC(t) : waveNSR(t);
    } else if (key === 'trigeminy') {
      const cn = Math.floor(xVal/period);
      const t = (xVal%period)/period;
      y = cn%3===2 ? wavePVC(t) : waveNSR(t);
    } else if (key === 'pvc_couplet') {
      const gp = period*5.5;
      const pig = xVal%gp;
      if (pig < period) { y = waveNSR(pig/period); }
      else if (pig < period*2) { y = waveNSR((pig-period)/period); }
      else if (pig < period*2.8) { y = wavePVC((pig-period*2)/(period*0.8)); }
      else if (pig < period*3.6) { y = wavePVC((pig-period*2.8)/(period*0.8)); }
      else y = 0;
    } else if (key === 'multifocal_pvc') {
      const gp = period*7;
      const pig = xVal%gp;
      const bi = Math.floor(pig/period);
      const t = (pig%period)/period;
      if (bi===1) y = wavePVC(t);
      else if (bi===3) y = wavePVC2(t);
      else if (bi===5) y = wavePVC3(t);
      else if (bi<7) y = waveNSR(t);
      else y = 0;
    } else if (key === 'pac') {
      const cn = Math.floor(xVal/period);
      const t = (xVal%period)/period;
      y = cn%5===3 ? waveNSR(t*0.85)*0.9 : waveNSR(t);
    } else if (key === 'wenck') {
      const cp = period*4.3;
      const pos = xVal%cp;
      const bic = Math.floor(pos/(cp/4));
      const t = (pos%(cp/4))/(cp/4);
      y = waveWenck(t, bic);
    } else if (key === 'mobitz2') {
      const cp = period*3;
      const pos = xVal%cp;
      const bic = Math.floor(pos/(cp/3));
      const t = (pos%(cp/3))/(cp/3);
      if (bic===2) { if(t>0.05&&t<0.15){const p=(t-0.05)/0.10;y=0.12*Math.sin(p*Math.PI);}else y=0; }
      else y = waveNSR(t);
    } else if (key === 'sinus_arr') {
      const breathCyclePx = w * 1.2;
      let beatStart = 0, beatIdx = 0;
      while (beatStart < xVal + period * 2) {
        const breathPhase = (beatStart % breathCyclePx) / breathCyclePx;
        const rateMultiplier = 0.80 + 0.40 * Math.sin(breathPhase * 2 * Math.PI);
        const thisBeatPeriod = period * rateMultiplier;
        const beatEnd = beatStart + thisBeatPeriod;
        if (xVal >= beatStart && xVal < beatEnd) {
          y = waveNSR((xVal - beatStart) / thisBeatPeriod);
          break;
        }
        beatStart = beatEnd;
        beatIdx++;
        if (beatIdx > 200) break;
      }
    } else if (key === 'sinus_arrest') {
      const groupPeriod = period * 6;
      const posInGroup = xVal % groupPeriod;
      const beatInGroup = Math.floor(posInGroup / period);
      const t = (posInGroup % period) / period;
      if (beatInGroup === 3 || beatInGroup >= 5) y = 0;
      else y = waveNSR(t);
    } else if (key === 'wap') {
      let beatStart = 0, beatIdx = 0;
      while (beatStart < xVal + period * 2) {
        const rm = 0.85 + 0.30 * Math.sin(beatIdx * 1.8);
        const bp = period * rm, be = beatStart + bp;
        if (xVal >= beatStart && xVal < be) { y = waveWAP((xVal - beatStart) / bp, beatIdx); break; }
        beatStart = be; beatIdx++; if (beatIdx > 200) break;
      }
    } else if (key === 'mat') {
      let beatStart = 0, beatIdx = 0;
      const rrF = [0.75, 1.05, 0.85, 1.20, 0.90, 0.70, 1.10, 0.95, 1.15, 0.80];
      while (beatStart < xVal + period * 2) {
        const bp = period * rrF[beatIdx % rrF.length], be = beatStart + bp;
        if (xVal >= beatStart && xVal < be) { y = waveMAT((xVal - beatStart) / bp, beatIdx); break; }
        beatStart = be; beatIdx++; if (beatIdx > 200) break;
      }
    } else if (key === 'agonal') {
      let beatStart = 0, beatIdx = 0;
      while (beatStart < xVal + period * 2) {
        const rm = 0.7 + 0.6 * Math.abs(Math.sin(beatIdx * 2.1));
        const bp = period * rm, be = beatStart + bp;
        if (xVal >= beatStart && xVal < be) { y = waveAgonal((xVal - beatStart) / bp); break; }
        beatStart = be; beatIdx++; if (beatIdx > 200) break;
      }
    } else if (r.wave) {
      const t = (xVal%period)/period;
      y = r.wave(t);
    }
    
    const py = mid - y * amp;
    if (px===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  }
  ctx.stroke();
}

function buildGallery() {
  Object.entries(galleryCards).forEach(([cat, keys]) => {
    const container = document.getElementById(cat+'Gallery');
    if (!container) return;
    keys.forEach((key, idx) => {
      const r = RHYTHMS[key];
      if (!r) return;
      const badgeClass = cat==='sa'?'badge-sa':cat==='atrial'?'badge-atrial':cat==='junct'?'badge-junctional':cat==='vent'?'badge-ventricular':'badge-block';
      const catName = cat==='sa'?'SA Node':cat==='atrial'?'Atrial':cat==='junct'?'Junctional':cat==='vent'?'Ventricular':'AV Block';
      
      const div = document.createElement('div');
      div.className = 'rhythm-card';
      div.onclick = () => openRhythmModal(key);
      div.innerHTML = `
        <div class="rhythm-canvas-wrap ecg-paper-bg"><canvas id="gc-${cat}-${idx}" height="110"></canvas></div>
        <div class="rhythm-info">
          <h4>${r.name}</h4>
          <div class="rhythm-chars">${r.chars.split('¬∑').slice(0,3).join('¬∑')}</div>
          <span class="rhythm-badge ${badgeClass}">${catName}</span>
        </div>`;
      container.appendChild(div);
      
      setTimeout(() => {
        const canvas = document.getElementById(`gc-${cat}-${idx}`);
        if (!canvas) return;
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = 110;
        drawStaticRhythm(canvas.getContext('2d'), canvas.width, canvas.height, key);
      }, 150);
    });
  });
}

// ================================================================
// MODAL SYSTEM
// ================================================================
function openModal(id) {
  const body = document.getElementById('modalBody');
  body.innerHTML = getModalContent(id);
  document.getElementById('modalOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
  setTimeout(() => {
    document.querySelectorAll('.modal-rhythm-canvas').forEach(c => {
      c.width = c.parentElement.clientWidth;
      c.height = 140;
      const key = c.dataset.rhythm;
      if (key && RHYTHMS[key]) drawStaticRhythm(c.getContext('2d'), c.width, c.height, key);
    });
  }, 100);
}

function openRhythmModal(key) {
  const r = RHYTHMS[key];
  if (!r) return;
  const body = document.getElementById('modalBody');
  body.innerHTML = `
    <h2><span class="gradient">${r.name}</span></h2>
    <p class="modal-sub">Click the rhythm on the ECG monitor to view it live</p>
    <div class="ecg-paper-bg modal-rhythm-strip"><canvas class="modal-rhythm-canvas" data-rhythm="${key}" height="140"></canvas></div>
    <h3>üìã Characteristics</h3>
    <div class="modal-rhythm-chars">
      ${r.chars.split('¬∑').map(c => `<div class="char-item">‚Ä¢ ${c.trim()}</div>`).join('')}
    </div>
    <h3>üî¨ Etiology</h3>
    <p>${r.etiology}</p>
    <h3>üöë Management</h3>
    <div class="highlight-box red"><p style="margin:0">${r.mgmt}</p></div>
  `;
  document.getElementById('modalOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
  setTimeout(() => {
    document.querySelectorAll('.modal-rhythm-canvas').forEach(c => {
      c.width = c.parentElement.clientWidth;
      c.height = 140;
      drawStaticRhythm(c.getContext('2d'), c.width, c.height, key);
    });
  }, 100);
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
  document.body.style.overflow = '';
}

document.addEventListener('keydown', e => { if(e.key==='Escape') closeModal(); });

function getModalContent(id) {
  const M = {
    'risk-nonmod': `<h2><span class="gradient">Non-Modifiable Risk Factors</span></h2><p class="modal-sub">Factors that cannot be changed but must be assessed</p>
      <h3>Key Factors</h3><ul><li><strong>Advanced age</strong> ‚Äî Risk increases significantly with age</li><li><strong>Male sex</strong> ‚Äî Men have higher risk, especially before age 65</li><li><strong>Hereditary factors</strong> ‚Äî Family history of premature heart disease</li><li><strong>Ethnicity</strong> ‚Äî African Americans, Mexican Americans, American Indians, Native Hawaiians, and some Asian Americans have higher tendency for heart disease</li></ul>`,
    'risk-mod': `<h2><span class="gradient">Modifiable Risk Factors</span></h2><p class="modal-sub">Factors the patient can control to reduce cardiac risk</p>
      <h3>Lifestyle Modifications</h3><ul><li><strong>Smoking cessation</strong> ‚Äî or elimination of smoke exposure</li><li><strong>Blood pressure control</strong> ‚Äî Medical management of hypertension</li><li><strong>Diabetes management</strong> ‚Äî Tight glycemic control</li><li><strong>Cholesterol & lipid disorders</strong> ‚Äî Statins, diet modification</li><li><strong>Regular exercise</strong> ‚Äî At least 150 min/week moderate intensity</li><li><strong>Weight loss</strong> ‚Äî Maintain healthy BMI</li><li><strong>Dietary improvements</strong> ‚Äî Low sodium, heart-healthy diet</li></ul>`,
    'risk-prevent': `<h2><span class="gradient">Prevention Strategies</span></h2><p class="modal-sub">Pharmacologic and community-based prevention</p>
      <h3>Pharmacologic Prevention</h3><ul><li><strong>Statins</strong> ‚Äî Cholesterol reduction</li><li><strong>Aspirin</strong> ‚Äî Antiplatelet therapy</li><li><strong>Beta blockers</strong> ‚Äî Rate and BP control</li></ul>
      <h3>Community Education</h3><ul><li>Nutrition education programs</li><li>Smoking cessation and prevention (especially for children)</li><li>Diabetes and hypertension screening</li><li><strong>Teaching CPR and early AED use</strong> ‚Äî Critical to improve cardiac arrest outcomes</li></ul>`,
    'phys-cycle': `<h2><span class="gradient">The Cardiac Cycle</span></h2><p class="modal-sub">One complete heartbeat ‚Äî systole and diastole at ~70 bpm in resting adults (~0.8s per cycle)</p>
      <h3>Overview</h3>
      <p>The cardiac cycle represents all events from the beginning of one heartbeat to the beginning of the next. It includes changes in pressure, volume, heart sounds, valve positions, and electrical activity. Understanding the cardiac cycle is fundamental for interpreting hemodynamic data and understanding the pathophysiology of heart failure, valvular disease, and cardiac tamponade.</p>
      <h3>Systole (Ventricular Contraction) ‚Äî ~0.3s</h3>
      <ul><li><strong>Isovolumetric Contraction:</strong> All four valves are closed. Ventricular pressure rises rapidly but no blood is ejected ‚Äî volume remains constant at EDV (~120 mL). This phase generates the QRS complex on ECG. S‚ÇÅ heart sound occurs at onset (AV valve closure). Ventricular pressure must exceed aortic pressure (~80 mmHg) before semilunar valves open.</li>
      <li><strong>Rapid Ejection:</strong> Semilunar valves open. About 2/3 of stroke volume is ejected in first 1/3 of ejection period. Aortic pressure rises to ~120 mmHg. Maximal LV shortening occurs here.</li>
      <li><strong>Reduced Ejection:</strong> Rate of ejection slows. Ventricular and aortic pressures begin to decline. Remaining 1/3 of stroke volume is ejected. T wave begins on ECG (start of repolarization).</li></ul>
      <div class="highlight-box"><p style="margin:0"><strong>Stroke Volume:</strong> SV = EDV ‚àí ESV. Normal: ~70 mL (120 mL ‚àí 50 mL). <strong>Ejection Fraction (EF):</strong> EF = SV / EDV √ó 100. Normal = 55-70%. EF &lt; 40% = systolic heart failure (HFrEF). EF &gt; 50% with symptoms = diastolic heart failure (HFpEF).</p></div>
      <h3>Diastole (Ventricular Relaxation) ‚Äî ~0.5s</h3>
      <ul><li><strong>Isovolumetric Relaxation:</strong> All valves closed again. Ventricular pressure drops rapidly. S‚ÇÇ occurs (semilunar valve closure). Aortic notch (dicrotic notch) visible on arterial waveform ‚Äî brief rise in aortic pressure as blood bounces off closed valve. Volume remains at ESV (~50 mL).</li>
      <li><strong>Rapid Passive Filling:</strong> AV valves open when ventricular pressure drops below atrial pressure. Blood rushes from atria ‚Üí ventricles. Accounts for ~70% of ventricular filling. S‚ÇÉ may be heard here in volume-overloaded states (CHF).</li>
      <li><strong>Diastasis (Slow Filling):</strong> Continued slow filling as pressure gradient equalizes. Accounts for ~5% of filling. Shortened or eliminated during tachycardia.</li>
      <li><strong>Atrial Systole (Atrial Kick):</strong> P wave on ECG. Atria contract during final phase of diastole. Contributes 20-30% of ventricular filling (the "atrial kick"). Critical in patients with stiff ventricles. Loss of atrial kick in A-Fib can reduce CO by 20-30%. S‚ÇÑ may be heard here with stiff ventricles.</li></ul>
      <h3>Heart Sounds</h3>
      <ul><li><strong>S‚ÇÅ ("Lub"):</strong> Closure of AV valves (mitral + tricuspid). Marks onset of systole. Loud S‚ÇÅ heard in mitral stenosis, short PR interval.</li>
      <li><strong>S‚ÇÇ ("Dub"):</strong> Closure of semilunar valves (aortic + pulmonic). Marks onset of diastole. Physiologic splitting of S‚ÇÇ during inspiration (increased venous return delays pulmonic closure). Fixed splitting = ASD.</li>
      <li><strong>S‚ÇÉ (Ventricular Gallop):</strong> Low-pitched sound during rapid filling. Normal in children/young adults. Pathologic in adults &gt; 40 ‚Äî indicates volume overload, dilated ventricle, CHF. Creates "Ken-TU-cky" cadence.</li>
      <li><strong>S‚ÇÑ (Atrial Gallop):</strong> Sound just before S‚ÇÅ, during atrial contraction against a stiff (non-compliant) ventricle. Always pathologic. Indicates LVH, HTN, aortic stenosis, ischemia. Creates "Ten-ne-SSEE" cadence. Cannot have S‚ÇÑ in A-Fib (no organized atrial contraction).</li>
      <li><strong>Murmurs:</strong> Systolic murmurs heard between S‚ÇÅ-S‚ÇÇ (aortic stenosis, mitral regurgitation, VSD). Diastolic murmurs heard between S‚ÇÇ-S‚ÇÅ (aortic regurgitation, mitral stenosis ‚Äî almost always pathologic).</li></ul>
      <h3>Pressure-Volume Relationships</h3>
      <ul><li><strong>LV end-diastolic pressure (LVEDP):</strong> Indicator of preload. Elevated in CHF, fluid overload. Normal 4-12 mmHg.</li>
      <li><strong>Aortic pressure:</strong> Systolic ~120, diastolic ~80. Dicrotic notch marks aortic valve closure.</li>
      <li><strong>LA pressure:</strong> a-wave (atrial contraction), c-wave (AV valve bulging), v-wave (atrial filling during systole). Giant v-waves = mitral regurgitation.</li>
      <li><strong>Wiggers diagram:</strong> The gold standard visual showing simultaneous pressure, volume, ECG, and phonocardiogram tracings through the cardiac cycle.</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>EMS Critical Thinking:</strong> Coronary perfusion = Aortic diastolic pressure ‚àí LVEDP. Coronary arteries fill during DIASTOLE. Tachycardia (‚Üì diastolic time), hypotension (‚Üì diastolic pressure), and CHF (‚Üë LVEDP) all reduce coronary perfusion and can cause ischemia.</p></div>`,
    'phys-preload': `<h2><span class="gradient">Preload & Frank-Starling Law</span></h2><p class="modal-sub">The relationship between myocardial fiber stretch and contractile force</p>
      <div class="highlight-box gold"><p style="margin:0"><strong>Frank-Starling Law:</strong> The greater the stretch (preload) on myocardial fibers before contraction, the greater the force of contraction ‚Äî up to a physiologic limit. Beyond that limit, overstretched fibers lose actin-myosin overlap and contractile force decreases. This is the fundamental mechanism by which the heart adjusts output beat-to-beat.</p></div>
      <h3>Defining Preload</h3>
      <p>Preload is the degree of stretch on ventricular myocardial fibers at end-diastole, just before contraction. It is determined by the volume of blood in the ventricle (end-diastolic volume, EDV) and is closely related to end-diastolic pressure (EDP). Preload can be thought of as the "volume loading" of the heart.</p>
      <ul><li><strong>LV preload surrogate:</strong> PCWP (pulmonary capillary wedge pressure), normal 6-12 mmHg</li>
      <li><strong>RV preload surrogate:</strong> CVP (central venous pressure), normal 2-6 mmHg</li>
      <li><strong>End-Diastolic Volume (EDV):</strong> Volume in ventricle at end of diastole (~120 mL). Direct volumetric measure of preload</li></ul>
      <h3>Factors That Increase Preload</h3>
      <ul><li><strong>‚Üë Venous return:</strong> IV fluid administration, blood transfusion, leg elevation</li>
      <li><strong>‚Üë Blood volume:</strong> Renal retention (CHF, renal failure), excessive fluid intake</li>
      <li><strong>‚Üë Venous tone:</strong> Sympathetic stimulation ‚Üí venoconstriction ‚Üí more blood returns to heart</li>
      <li><strong>Supine position:</strong> Redistributes peripheral blood centrally</li>
      <li><strong>Negative intrathoracic pressure:</strong> Spontaneous breathing enhances venous return (thoracic pump)</li>
      <li><strong>Skeletal muscle pump:</strong> Leg movement squeezes veins ‚Üí pushes blood back to heart</li></ul>
      <h3>Factors That Decrease Preload</h3>
      <ul><li><strong>Hemorrhage / dehydration:</strong> ‚Üì blood volume = ‚Üì venous return</li>
      <li><strong>Venodilation:</strong> Nitroglycerin, morphine, calcium channel blockers, sepsis</li>
      <li><strong>Standing / upright position:</strong> Blood pools in lower extremities</li>
      <li><strong>Positive pressure ventilation:</strong> PPV/PEEP compresses thoracic veins ‚Üí ‚Üì venous return. Important consideration for intubated patients!</li>
      <li><strong>Cardiac tamponade / tension pneumo:</strong> External compression limits ventricular filling</li>
      <li><strong>Loss of atrial kick:</strong> A-Fib, junctional rhythms ‚Äî reduces EDV by 20-30%</li>
      <li><strong>Tachycardia:</strong> ‚Üì diastolic filling time ‚Üí ‚Üì EDV</li></ul>
      <h3>Starling Curve in Practice</h3>
      <ul><li><strong>Ascending limb:</strong> Normal heart. ‚Üë preload ‚Üí ‚Üë SV ‚Üí ‚Üë CO. This is where fluid resuscitation works ‚Äî adding volume increases output.</li>
      <li><strong>Plateau:</strong> Optimal filling. Further fluid adds minimal benefit. Heart is at peak performance.</li>
      <li><strong>Descending limb:</strong> Failing heart or volume overload. Further ‚Üë preload ‚Üí ‚Üì SV. Overstretched fibers lose contractile efficiency. This is where CHF patients live ‚Äî more fluid makes them worse.</li></ul>
      <h3>Clinical Applications for EMS</h3>
      <ul><li><strong>Hypovolemic shock:</strong> Patient on ascending limb ‚Üí fluid bolus appropriate ‚Üí ‚Üë preload ‚Üí ‚Üë CO ‚Üí ‚Üë BP</li>
      <li><strong>Cardiogenic pulmonary edema:</strong> Patient on descending limb ‚Üí NTG to ‚Üì preload ‚Üí ‚Üì pulmonary congestion ‚Üí improved gas exchange ‚Üí may actually ‚Üë CO by moving back toward plateau</li>
      <li><strong>RV infarct:</strong> Preload-dependent! RV needs volume to maintain output through damaged wall. NTG contraindicated (‚Üì preload ‚Üí hemodynamic collapse)</li>
      <li><strong>Tension pneumothorax:</strong> Obstructive ‚Üì preload. Needle decompression restores venous return ‚Üí ‚Üë preload ‚Üí ‚Üë CO</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>EMS Pearl:</strong> Assess preload clinically: JVD = ‚Üë RV preload (CHF, tamponade, tension pneumo). Flat neck veins when supine = ‚Üì preload (hypovolemia). Lung sounds: Crackles = fluid backed up from ‚Üë LV preload. Dry lungs + flat JVD = think hypovolemia.</p></div>`,
    'phys-afterload': `<h2><span class="gradient">Afterload & Contractility</span></h2><p class="modal-sub">The resistance the heart must overcome plus its intrinsic force generation</p>
      <h3>Afterload</h3>
      <p>Afterload is the resistance or pressure the ventricle must overcome to eject blood through the semilunar valve. For the LV, this is determined primarily by systemic vascular resistance (SVR) and aortic pressure. For the RV, it is pulmonary vascular resistance (PVR). Think of afterload as "how hard the heart has to push."</p>
      <ul><li><strong>SVR (Systemic Vascular Resistance):</strong> Primary determinant of LV afterload. Normal: 800-1200 dynes/sec/cm‚Åª‚Åµ. SVR = (MAP ‚àí CVP) / CO √ó 80</li>
      <li><strong>PVR (Pulmonary Vascular Resistance):</strong> Primary determinant of RV afterload. Much lower than SVR (explains why RV wall is thinner). PVR = (mPAP ‚àí PCWP) / CO √ó 80</li></ul>
      <h3>Factors That Increase Afterload</h3>
      <ul><li><strong>Hypertension:</strong> Chronic ‚Üë afterload ‚Üí compensatory LVH ‚Üí eventual decompensation ‚Üí CHF</li>
      <li><strong>Aortic stenosis:</strong> Narrowed valve = higher pressure needed to eject blood</li>
      <li><strong>Vasoconstriction:</strong> Catecholamines (epinephrine, norepinephrine), vasopressin, angiotensin II, cold exposure</li>
      <li><strong>Sympathomimetic drugs:</strong> High-dose dopamine, phenylephrine (pure alpha)</li>
      <li><strong>Polycythemia:</strong> ‚Üë blood viscosity = ‚Üë resistance</li>
      <li><strong>Aortic coarctation:</strong> Structural narrowing of aorta</li></ul>
      <h3>Factors That Decrease Afterload</h3>
      <ul><li><strong>Vasodilators:</strong> Nitroprusside (arteriolar + venous), NTG (primarily venous but some arteriolar at higher doses), ACE inhibitors, hydralazine</li>
      <li><strong>Sepsis:</strong> Pathologic vasodilation from inflammatory mediators ‚Üí ‚Üì‚Üì SVR. Distributive shock.</li>
      <li><strong>Neurogenic shock:</strong> Loss of sympathetic tone ‚Üí vasodilation ‚Üí ‚Üì SVR</li>
      <li><strong>Anaphylaxis:</strong> Histamine-mediated vasodilation ‚Üí ‚Üì SVR</li>
      <li><strong>IABP (Intra-Aortic Balloon Pump):</strong> Deflates during systole ‚Üí ‚Üì aortic pressure ‚Üí ‚Üì afterload (assists failing LV)</li></ul>
      <div class="highlight-box"><p style="margin:0"><strong>Law of Laplace:</strong> Wall Tension = (Pressure √ó Radius) / (2 √ó Wall Thickness). Dilated hearts (‚Üë radius) have higher wall tension ‚Üí higher myocardial O‚ÇÇ demand even at rest. Hypertrophied hearts (‚Üë wall thickness) have reduced wall tension per unit, which is initially compensatory but eventually causes diastolic dysfunction and subendocardial ischemia.</p></div>
      <h3>Myocardial Contractility (Inotropy)</h3>
      <p>Contractility is the intrinsic ability of the myocardium to generate force independent of both preload and afterload. It represents the strength of cardiac muscle contraction at any given fiber length.</p>
      <ul><li><strong>Positive inotropes (‚Üë contractility):</strong> Catecholamines (epinephrine, norepinephrine, dopamine, dobutamine), digitalis/digoxin (inhibits Na‚Å∫/K‚Å∫ ATPase ‚Üí ‚Üë intracellular Ca¬≤‚Å∫), milrinone (PDE-3 inhibitor ‚Äî "inodilator"), calcium chloride, glucagon (used in beta-blocker OD)</li>
      <li><strong>Negative inotropes (‚Üì contractility):</strong> Beta-blockers (propranolol, metoprolol, atenolol), calcium channel blockers (verapamil, diltiazem ‚Äî more than dihydropyridines), hypoxia, acidosis, myocardial ischemia/infarction, hyperkalemia, hypothermia, cardiomyopathy</li>
      <li><strong>Lusitropy (relaxation):</strong> Ability of myocardium to relax. Impaired lusitropy = diastolic dysfunction (HFpEF). The ventricle is stiff, can't relax, can't fill.</li></ul>
      <h3>Ejection Fraction (EF)</h3>
      <ul><li><strong>EF = SV / EDV √ó 100.</strong> Normal: 55-70%</li>
      <li><strong>HFrEF (Heart Failure with Reduced EF):</strong> EF &lt; 40%. Systolic failure. Weak pump. Dilated LV.</li>
      <li><strong>HFmrEF (Mid-Range):</strong> EF 40-49%. Borderline.</li>
      <li><strong>HFpEF (Preserved EF):</strong> EF ‚â• 50% but symptomatic. Diastolic failure. Stiff ventricle can't fill. Common in HTN, LVH, elderly women.</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>EMS Implications:</strong> In acute CHF: ‚Üì afterload with NTG ‚Üí makes it easier for the failing heart to eject ‚Üí ‚Üë CO ‚Üí ‚Üì pulmonary congestion. In cardiogenic shock: may need dobutamine (‚Üë inotropy) + careful vasopressor to maintain perfusion pressure without excessive ‚Üë afterload.</p></div>`,
    'phys-co': `<h2><span class="gradient">Cardiac Output & Hemodynamics</span></h2>
      <div class="formula">CO = SV √ó HR</div>
      <p style="text-align:center"><strong>Normal: ~5 L/min</strong> (70 mL √ó 72 bpm) ¬∑ Can increase to 20-25 L/min with exercise</p>
      <h3>Cardiac Output (CO)</h3>
      <p>The volume of blood pumped by one ventricle per minute. CO is the ultimate measure of cardiac pump function and is the primary determinant of oxygen delivery to tissues. Inadequate CO = inadequate perfusion = shock.</p>
      <ul><li><strong>Cardiac Index (CI):</strong> CI = CO / BSA (body surface area). Normal: 2.5-4.0 L/min/m¬≤. Allows comparison between patients of different body sizes. CI &lt; 2.2 = inadequate perfusion (cardiogenic shock territory).</li></ul>
      <h3>Stroke Volume Determinants</h3>
      <ul><li><strong>Preload:</strong> Volume loading (Frank-Starling law). ‚Üë preload ‚Üí ‚Üë SV (up to a point)</li>
      <li><strong>Afterload:</strong> Resistance to ejection. Inversely related to SV: ‚Üë afterload ‚Üí ‚Üì SV. The heart must work harder to eject against higher resistance.</li>
      <li><strong>Contractility (Inotropy):</strong> Intrinsic force generation. ‚Üë contractility ‚Üí ‚Üë SV at any given preload/afterload</li></ul>
      <h3>Heart Rate Determinants</h3>
      <ul><li><strong>Chronotropy:</strong> Rate of impulse formation. Sympathetic ‚Üë HR (positive chronotropy). Parasympathetic ‚Üì HR (negative chronotropy via vagus nerve)</li>
      <li><strong>Dromotropy:</strong> Speed of conduction through AV node. Beta-blockers and CCBs are negative dromotropes.</li>
      <li><strong>Bathmotropy:</strong> Excitability of cardiac tissue. Related to threshold potential and automaticity.</li>
      <li><strong>Optimal HR range:</strong> At very low HR (&lt;40): despite large SV, CO may be inadequate (CO = SV √ó HR ‚Üí small number). At very high HR (&gt;150): diastolic filling time so short ‚Üí ‚Üì SV ‚Üí CO actually ‚Üì despite ‚Üë rate. There is an optimal HR "sweet spot" for maximum CO.</li></ul>
      <h3>Blood Pressure & MAP</h3>
      <div class="formula">MAP = CO √ó SVR &nbsp;&nbsp;|&nbsp;&nbsp; MAP = DBP + ‚Öì(SBP ‚àí DBP)</div>
      <ul><li><strong>MAP:</strong> Mean Arterial Pressure. Driving pressure for organ perfusion. Normal: 70-105 mmHg. Goal in shock: ‚â• 65 mmHg. Critical organs (brain, kidneys, heart) autoregulate flow over MAP 60-150.</li>
      <li><strong>Pulse Pressure:</strong> SBP ‚àí DBP. Normal ~40 mmHg. Narrow (&lt;25) = ‚Üì SV (cardiogenic shock, tamponade, tension pneumo, severe hypovolemia). Wide (&gt;40) = aortic regurgitation, sepsis (‚Üì SVR), atherosclerosis.</li>
      <li><strong>SBP reflects:</strong> CO and large artery compliance. Isolated systolic HTN in elderly = stiff arteries.</li>
      <li><strong>DBP reflects:</strong> SVR and aortic valve competence. Low DBP with wide pulse pressure = think aortic regurgitation.</li></ul>
      <h3>Myocardial Oxygen Supply vs. Demand</h3>
      <p>The heart is the most oxygen-demanding organ. Understanding this balance is central to managing ACS and heart failure.</p>
      <ul><li><strong>O‚ÇÇ Supply:</strong> Coronary blood flow (diastolic BP, coronary patency) √ó arterial O‚ÇÇ content (SpO‚ÇÇ, Hgb). Supply ‚Üì by: hypotension, tachycardia (‚Üì diastolic time), coronary stenosis, anemia, hypoxia.</li>
      <li><strong>O‚ÇÇ Demand (MVO‚ÇÇ):</strong> Determined by heart rate, contractility, wall tension (preload √ó afterload). The "rate-pressure product" (HR √ó SBP) is a clinical estimate of MVO‚ÇÇ. Demand ‚Üë by: tachycardia, hypertension, increased contractility, increased wall stress.</li>
      <li><strong>Ischemia occurs when:</strong> Demand exceeds supply. EMS treatments aim to ‚Üì demand (beta-blockers, NTG, morphine, rest) and ‚Üë supply (O‚ÇÇ, PCI to open blocked artery, thrombolytics).</li></ul>
      <div class="highlight-box gold"><p style="margin:0"><strong>Clinical Equations to Know:</strong><br>CO = SV √ó HR &nbsp;|&nbsp; CI = CO / BSA &nbsp;|&nbsp; MAP = CO √ó SVR &nbsp;|&nbsp; SVR = (MAP ‚àí CVP) / CO √ó 80<br>MAP = DBP + ‚Öì(PP) &nbsp;|&nbsp; PP = SBP ‚àí DBP &nbsp;|&nbsp; CPP = Aortic Diastolic ‚àí LVEDP</p></div>`,
    'phys-ans': `<h2><span class="gradient">Autonomic Nervous System Control</span></h2><p class="modal-sub">Sympathetic and parasympathetic regulation of cardiac function</p>
      <p>The heart is innervated by both divisions of the autonomic nervous system. At rest, parasympathetic (vagal) tone dominates. During stress, sympathetic activation takes over. Understanding this system is critical for EMS because almost every cardiac drug works through these pathways.</p>
      <h3>Sympathetic ("Fight or Flight")</h3>
      <p>Origin: Thoracolumbar spinal cord (T1-L2) ‚Üí preganglionic fibers ‚Üí sympathetic chain ganglia ‚Üí postganglionic fibers ‚Üí heart, vasculature, adrenal medulla.</p>
      <ul><li><strong>Neurotransmitters:</strong> Norepinephrine (NE) at nerve terminals, Epinephrine (Epi) from adrenal medulla (80% Epi, 20% NE)</li>
      <li><strong>Alpha-1 receptors (blood vessels):</strong> Peripheral vasoconstriction ‚Üí ‚Üë SVR ‚Üí ‚Üë BP. Activated by NE, Epi, phenylephrine. Antagonized by phentolamine, prazosin.</li>
      <li><strong>Alpha-2 receptors (CNS/presynaptic):</strong> Central: ‚Üì sympathetic outflow. Clonidine acts here (‚Üì BP). Presynaptic: negative feedback ‚Üí ‚Üì NE release.</li>
      <li><strong>Beta-1 receptors (heart ‚Äî "1 heart"):</strong> ‚Üë HR (positive chronotropy), ‚Üë contractility (positive inotropy), ‚Üë conduction velocity (positive dromotropy), ‚Üë automaticity (positive bathmotropy). Activated by NE, Epi, dobutamine, isoproterenol.</li>
      <li><strong>Beta-2 receptors (lungs/vessels ‚Äî "2 lungs"):</strong> Bronchodilation, vasodilation in skeletal muscle. Activated by Epi (more than NE), albuterol, terbutaline.</li>
      <li><strong>Dopaminergic receptors (D1):</strong> Renal and mesenteric vasodilation. Low-dose dopamine (1-5 mcg/kg/min) targets these, though "renal-dose dopamine" has fallen out of favor.</li></ul>
      <h3>Parasympathetic ("Rest and Digest")</h3>
      <p>Origin: Brainstem ‚Üí Vagus nerve (CN X) ‚Üí directly innervates SA node, AV node, and atrial muscle. Minimal direct effect on ventricles.</p>
      <ul><li><strong>Neurotransmitter:</strong> Acetylcholine (ACh) at muscarinic receptors</li>
      <li><strong>Muscarinic (M2) receptors:</strong> ‚Üì HR (negative chronotropy), ‚Üì AV conduction velocity (negative dromotropy), minimal ‚Üì atrial contractility. Little effect on ventricular contractility.</li>
      <li><strong>Vagal tone:</strong> Dominant at rest. SA node intrinsic rate without autonomic input = ~100 bpm. Vagal tone brings resting rate to 60-80 bpm. This is why atropine (vagolytic) speeds the heart ‚Äî it removes the "brake."</li>
      <li><strong>Vagal maneuvers:</strong> Carotid sinus massage, Valsalva, cold water face immersion ‚Äî stimulate vagus ‚Üí ‚Üë ACh ‚Üí slow HR. Used to terminate SVT.</li></ul>
      <h3>Baroreceptor Reflex</h3>
      <p>Stretch receptors in the carotid sinus and aortic arch that detect changes in arterial pressure. This is the body's primary rapid-response mechanism for BP regulation.</p>
      <ul><li>‚Üë BP ‚Üí ‚Üë baroreceptor firing ‚Üí ‚Üë parasympathetic output + ‚Üì sympathetic output ‚Üí ‚Üì HR, ‚Üì contractility, ‚Üì SVR ‚Üí BP normalizes</li>
      <li>‚Üì BP ‚Üí ‚Üì baroreceptor firing ‚Üí ‚Üë sympathetic output + ‚Üì parasympathetic output ‚Üí ‚Üë HR, ‚Üë contractility, ‚Üë SVR ‚Üí BP rises</li>
      <li><strong>Carotid sinus hypersensitivity:</strong> Exaggerated vagal response to carotid pressure ‚Üí syncope. Common in elderly. Tight collar or head turning can trigger.</li></ul>
      <h3>Chemoreceptor Reflex</h3>
      <ul><li><strong>Peripheral (carotid/aortic bodies):</strong> Detect ‚Üì PaO‚ÇÇ, ‚Üë PaCO‚ÇÇ, ‚Üì pH ‚Üí stimulate sympathetic system ‚Üí ‚Üë HR, ‚Üë RR, ‚Üë SVR</li>
      <li><strong>Central (medulla):</strong> Primarily sensitive to CO‚ÇÇ/pH in CSF. Drive respiratory rate.</li></ul>
      <h3>Key Drug-Receptor Relationships for EMS</h3>
      <ul><li><strong>Atropine:</strong> Blocks muscarinic (ACh) receptors ‚Üí removes vagal brake ‚Üí ‚Üë HR. Used for symptomatic bradycardia.</li>
      <li><strong>Epinephrine:</strong> Alpha-1 + Beta-1 + Beta-2. Vasoconstriction + ‚Üë HR + ‚Üë contractility + bronchodilation. Drug of cardiac arrest and anaphylaxis.</li>
      <li><strong>Norepinephrine (Levophed):</strong> Strong Alpha-1 + Beta-1. Potent vasoconstriction + ‚Üë contractility. First-line vasopressor in septic shock.</li>
      <li><strong>Dopamine:</strong> Dose-dependent: low (D1: renal vasodilation), moderate (Beta-1: ‚Üë CO), high (Alpha-1: vasoconstriction)</li>
      <li><strong>Dobutamine:</strong> Primarily Beta-1 + some Beta-2. ‚Üë contractility without much vasoconstriction. Preferred in cardiogenic shock.</li>
      <li><strong>Metoprolol / Atenolol:</strong> Selective Beta-1 blockers ‚Üí ‚Üì HR, ‚Üì contractility, ‚Üì AV conduction</li>
      <li><strong>Adenosine:</strong> Slows/blocks AV node conduction ‚Üí terminates re-entrant SVT. Ultra-short half-life (6-10s).</li></ul>
      <div class="highlight-box"><p style="margin:0"><strong>Memory Aid:</strong> "Beta-1 = 1 heart, Beta-2 = 2 lungs." Alpha-1 = vessels constrict. Parasympathetic slows you down (rest & digest). Sympathetic speeds you up (fight or flight). Atropine removes the brake. Epinephrine pushes the accelerator.</p></div>`,
    'phys-electrolytes': `<h2><span class="gradient">Electrolytes & Cardiac Action Potential</span></h2><p class="modal-sub">Ions and electrical events that drive each heartbeat</p>
      <h3>Cardiac Action Potential (Working Myocytes ‚Äî 5 Phases)</h3>
      <p>Each heartbeat is an electrical event that triggers mechanical contraction. The action potential in cardiac muscle is unique because of its long plateau phase, which prevents tetanic contraction and provides an effective refractory period.</p>
      <ul><li><strong>Phase 0 ‚Äî Rapid Depolarization:</strong> Fast voltage-gated Na‚Å∫ channels open ‚Üí massive Na‚Å∫ influx ‚Üí membrane potential shoots from -90mV to +20mV. This is the upstroke. Speed of Phase 0 determines conduction velocity. Corresponds to QRS complex on ECG. Blocked by Class I antiarrhythmics (lidocaine, procainamide).</li>
      <li><strong>Phase 1 ‚Äî Early (Partial) Repolarization:</strong> Fast Na‚Å∫ channels inactivate. Transient K‚Å∫ efflux via Ito channels. Brief, small dip in membrane potential. Creates the "notch" seen in some action potential tracings.</li>
      <li><strong>Phase 2 ‚Äî Plateau:</strong> Ca¬≤‚Å∫ enters via slow L-type Ca¬≤‚Å∫ channels (inward), balanced by K‚Å∫ efflux (outward). Plateau maintains depolarization for ~200-300 ms ‚Üí sustained contraction. UNIQUE TO CARDIAC MUSCLE (skeletal muscle has no plateau). Absolute/effective refractory period ‚Äî cell CANNOT be restimulated regardless of stimulus strength. This prevents tetany. Ca¬≤‚Å∫ triggers sarcoplasmic reticulum Ca¬≤‚Å∫ release ‚Üí excitation-contraction coupling. Blocked by Class IV agents (verapamil, diltiazem).</li>
      <li><strong>Phase 3 ‚Äî Repolarization:</strong> L-type Ca¬≤‚Å∫ channels close. K‚Å∫ efflux continues via delayed rectifier K‚Å∫ channels ‚Üí cell returns to negative resting potential (~-90mV). Corresponds to T wave on ECG. Relative refractory period ("vulnerable period") ‚Äî cell CAN be depolarized by a strong enough stimulus, but response is abnormal. This is when R-on-T phenomenon occurs ‚Üí can trigger VF. Blocked by Class III agents (amiodarone, sotalol ‚Äî delay K‚Å∫ channels ‚Üí prolong repolarization ‚Üí prolong QT).</li>
      <li><strong>Phase 4 ‚Äî Resting Membrane Potential:</strong> Stable at ~-90mV in working myocytes. Na‚Å∫/K‚Å∫ ATPase pump (3 Na‚Å∫ out, 2 K‚Å∫ in) restores ion gradients. Cell is fully repolarized and ready for next stimulus.</li></ul>
      <h3>Pacemaker Cell Action Potential (SA/AV Node)</h3>
      <p>Pacemaker cells have NO stable Phase 4. Instead, they have spontaneous slow diastolic depolarization ‚Äî this is the basis of automaticity.</p>
      <ul><li><strong>Phase 4 (Spontaneous Depolarization):</strong> "Funny current" (If) ‚Äî slow Na‚Å∫ leak + T-type Ca¬≤‚Å∫ channels ‚Üí membrane slowly drifts from -60mV toward threshold. This is why the SA node fires automatically. Rate of Phase 4 determines heart rate.</li>
      <li><strong>Phase 0 in pacemaker cells:</strong> Slower upstroke via L-type Ca¬≤‚Å∫ channels (not fast Na‚Å∫ channels). This is why AV node conduction is slow ‚Äî by design.</li>
      <li><strong>No plateau (Phase 2):</strong> Pacemaker cells go directly from Phase 0 to Phase 3.</li>
      <li><strong>Sympathetic stimulation:</strong> ‚Üë If current ‚Üí steeper Phase 4 slope ‚Üí reaches threshold faster ‚Üí ‚Üë HR</li>
      <li><strong>Parasympathetic stimulation:</strong> ‚Üì If current + opens K‚Å∫ channels ‚Üí flatter Phase 4 slope + hyperpolarization ‚Üí ‚Üì HR</li></ul>
      <h3>Key Electrolytes in Cardiac Function</h3>
      <ul><li><strong>Sodium (Na‚Å∫):</strong> Normal 135-145 mEq/L. Primary ion for Phase 0 depolarization. Hyponatremia ‚Üí ‚Üì contractility, altered mental status, seizures. Hypernatremia ‚Üí dehydration, neurologic symptoms. In cardiac arrest: sodium bicarb may help in hyperkalemia, TCA overdose, prolonged arrest (acidosis).</li>
      <li><strong>Potassium (K‚Å∫):</strong> Normal 3.5-5.0 mEq/L. THE most important electrolyte for cardiac rhythm. <strong>Hyperkalemia (K‚Å∫ &gt; 5.5):</strong> Progression: Tall peaked T waves ‚Üí flattened P waves ‚Üí widened QRS ‚Üí sine wave pattern ‚Üí asystole/VF. Treatment: Calcium chloride/gluconate (membrane stabilizer), sodium bicarb, insulin+glucose, albuterol, kayexalate, dialysis. <strong>Hypokalemia (K‚Å∫ &lt; 3.5):</strong> Flattened T waves, prominent U waves (extra wave after T), ST depression, ‚Üë risk of VT/VF, Torsades. Potentiates digitalis toxicity.</li>
      <li><strong>Calcium (Ca¬≤‚Å∫):</strong> Normal ionized 4.5-5.5 mg/dL. Essential for Phase 2 plateau, excitation-contraction coupling, and vascular tone. <strong>Hypercalcemia:</strong> Shortened QT interval, widened QRS, AV blocks, cardiac arrest at extreme levels. <strong>Hypocalcemia:</strong> Prolonged QT interval ‚Üí ‚Üë risk of Torsades de Pointes. Trousseau's sign, Chvostek's sign (tetany). Treatment: IV calcium chloride (central line) or calcium gluconate.</li>
      <li><strong>Magnesium (Mg¬≤‚Å∫):</strong> Normal 1.5-2.5 mEq/L. Stabilizes cell membranes. Cofactor for Na‚Å∫/K‚Å∫ ATPase and many enzymatic processes. <strong>Hypomagnesemia:</strong> ‚Üë risk of Torsades de Pointes, refractory VF, refractory hypokalemia (can't correct K‚Å∫ without correcting Mg¬≤‚Å∫ first). Treatment: Magnesium sulfate 1-2g IV. Drug of choice for Torsades. Also used in eclampsia and severe asthma.</li></ul>
      <h3>Refractory Periods</h3>
      <ul><li><strong>Absolute Refractory Period (ARP):</strong> Phase 0 through most of Phase 3. Cell CANNOT be restimulated no matter how strong the stimulus. Prevents tetanic contraction of the heart.</li>
      <li><strong>Relative Refractory Period (RRP):</strong> Late Phase 3 to early Phase 4. Cell CAN respond to a supranormal stimulus, but produces abnormal depolarization. Corresponds to the T wave on ECG ‚Äî the "vulnerable period."</li>
      <li><strong>Supranormal Period:</strong> Brief window where a weaker-than-normal stimulus can cause depolarization. Clinically significant for R-on-T phenomenon.</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>Critical ECG-Electrolyte Correlations:</strong> Peaked T waves ‚Üí think hyperkalemia first. Prolonged QT ‚Üí think hypocalcemia, hypomagnesemia, or drugs. Flat T waves + U waves ‚Üí think hypokalemia. Shortened QT ‚Üí think hypercalcemia. Always check electrolytes in refractory arrest or bizarre rhythms.</p></div>`,
    'phys-coronary': `<h2><span class="gradient">Coronary Circulation</span></h2><p class="modal-sub">Blood supply to the myocardium ‚Äî understanding this system is essential for STEMI recognition and management</p>
      <h3>Overview</h3>
      <p>The coronary arteries originate from the aortic root, just above the aortic valve cusps (sinuses of Valsalva). The heart receives 5% of total cardiac output despite being &lt;1% of body weight, reflecting its extremely high metabolic demand. The myocardium extracts 70-80% of available oxygen from coronary blood (vs. ~25% for the body overall), leaving almost no oxygen reserve. This is why the heart is uniquely vulnerable to ischemia.</p>
      <h3>Left Coronary Artery (LCA)</h3>
      <ul><li><strong>Left Main Coronary Artery (LMCA):</strong> Short trunk (0.5-2 cm), bifurcates into LAD and LCx. Supplies &gt;2/3 of LV mass. Proximal LMCA occlusion = "widow maker" ‚Äî massive anterior + lateral STEMI, cardiogenic shock, often fatal. Some patients have a "trifurcation" with a ramus intermedius branch.</li>
      <li><strong>LAD (Left Anterior Descending):</strong> Courses in the anterior interventricular groove toward the apex. Supplies: anterior LV wall, anterior 2/3 of interventricular septum, apex, part of conduction system (bundle branches). Gives off diagonal branches (D1, D2) and septal perforators. Most commonly occluded coronary artery in MI. Occlusion ‚Üí ST elevation in V1-V4 (¬± V5-V6 if wraparound LAD) = anterior STEMI. Proximal LAD occlusion can cause LAF block or RBBB.</li>
      <li><strong>LCx (Left Circumflex):</strong> Courses in the left AV groove toward the posterior heart. Supplies: lateral LV wall, posterior LV wall (if left-dominant), SA node (~40%), left atrium. Gives off obtuse marginal branches (OM1, OM2). Occlusion ‚Üí ST elevation in leads I, aVL, V5-V6 = lateral STEMI. Posterior extension: ST depression V1-V3 (reciprocal) + tall R waves V1-V2. Use posterior leads V7-V9 to confirm.</li></ul>
      <h3>Right Coronary Artery (RCA)</h3>
      <ul><li>Courses in the right AV groove. Supplies: right atrium, right ventricle, inferior LV wall, posterior 1/3 of interventricular septum (in right-dominant hearts).</li>
      <li>Supplies SA node in ~60% of people and AV node in ~85-90% ‚Üí RCA occlusion often causes sinus bradycardia, junctional rhythm, 1st-degree AVB, or Wenckebach.</li>
      <li>Gives off acute marginal branches, posterior descending artery (PDA ‚Äî in right-dominant), and AV nodal branch.</li>
      <li>Occlusion ‚Üí ST elevation in leads II, III, aVF = inferior STEMI.</li>
      <li><strong>ALWAYS check right-sided leads (V4R) for RV infarct</strong> when inferior STEMI is identified. RV infarct = preload-dependent ‚Üí fluids needed, NTG absolutely contraindicated.</li></ul>
      <h3>Coronary Dominance</h3>
      <ul><li><strong>Right-dominant (~85%):</strong> RCA gives off PDA. Most common pattern.</li>
      <li><strong>Left-dominant (~8%):</strong> LCx gives off PDA. In this variant, LCx occlusion can cause inferior STEMI.</li>
      <li><strong>Co-dominant (~7%):</strong> Both RCA and LCx contribute to posterior circulation.</li></ul>
      <h3>Coronary Artery ‚Üí Lead ‚Üí Wall Correlation</h3>
      <ul><li><strong>LAD ‚Üí V1-V4 ‚Üí Anterior wall + septum</strong></li>
      <li><strong>LCx ‚Üí I, aVL, V5-V6 ‚Üí Lateral wall</strong></li>
      <li><strong>RCA ‚Üí II, III, aVF ‚Üí Inferior wall</strong></li>
      <li><strong>RCA/LCx ‚Üí V7-V9 (posterior leads) ‚Üí Posterior wall</strong> (reciprocal: ST depression + tall R in V1-V3)</li>
      <li><strong>RCA (proximal) ‚Üí V4R ‚Üí Right ventricle</strong></li>
      <li><strong>LAD (proximal) ‚Üí aVR ‚Üí Left main / proximal LAD</strong> (ST elevation in aVR with diffuse ST depression = left main or 3-vessel disease)</li></ul>
      <h3>Coronary Perfusion Principles</h3>
      <ul><li><strong>Coronary Perfusion Pressure (CPP):</strong> CPP = Aortic Diastolic Pressure ‚àí LVEDP. Coronary arteries fill primarily during diastole (except RV, which also fills during systole).</li>
      <li><strong>Autoregulation:</strong> Coronary arteries dilate/constrict to maintain constant flow over a range of pressures (MAP 60-140). Below MAP 60 ‚Üí flow becomes pressure-dependent ‚Üí ischemia.</li>
      <li><strong>Metabolic regulation:</strong> Adenosine is the primary metabolic vasodilator. ‚Üë Myocardial O‚ÇÇ demand ‚Üí ‚Üë adenosine ‚Üí coronary vasodilation ‚Üí ‚Üë flow. This mechanism fails when coronary artery is severely stenosed.</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>EMS Critical Rule:</strong> Inferior STEMI (II, III, aVF) ‚Üí always get V4R. If V4R shows ST elevation ‚Üí RV infarct confirmed ‚Üí give fluids, NO NTG, NO morphine (both ‚Üì preload ‚Üí hemodynamic collapse). Contiguous lead groups: Anterior V1-V4, Lateral I/aVL/V5-V6, Inferior II/III/aVF. Reciprocal changes confirm acute MI.</p></div>`,
    'phys-bp': `<h2><span class="gradient">Blood Pressure & Perfusion</span></h2><p class="modal-sub">Understanding hemodynamic parameters for field assessment</p>
      <div class="formula">BP = CO √ó SVR &nbsp;&nbsp;|&nbsp;&nbsp; CO = SV √ó HR</div>
      <h3>Blood Pressure Components</h3>
      <ul><li><strong>Systolic (SBP):</strong> Peak pressure during ventricular contraction. Reflects CO and arterial compliance. Normal ~120 mmHg. Isolated systolic HTN in elderly = ‚Üì arterial compliance (stiff arteries).</li>
      <li><strong>Diastolic (DBP):</strong> Minimum pressure during ventricular relaxation. Reflects SVR and aortic valve competence. Normal ~80 mmHg. Very low DBP (&lt;50) ‚Üí poor coronary perfusion.</li>
      <li><strong>Pulse Pressure (PP):</strong> SBP ‚àí DBP. Normal ~40 mmHg. Narrow (&lt;25) = reduced SV ‚Üí think tamponade, tension pneumo, cardiogenic shock, severe hypovolemia. Wide (&gt;40) = ‚Üë SV or ‚Üì SVR ‚Üí think sepsis, aortic regurgitation, thyrotoxicosis, AV fistula, severe anemia.</li>
      <li><strong>Mean Arterial Pressure (MAP):</strong> MAP = DBP + ‚Öì(PP). Or MAP = CO √ó SVR. Normal: 70-105 mmHg. Driving pressure for organ perfusion. MAP &lt; 65 = inadequate perfusion = clinical shock. Brain autoregulates over MAP 50-150 (50-170 in chronic HTN). Below this range ‚Üí cerebral ischemia.</li></ul>
      <h3>Orthostatic Hypotension</h3>
      <ul><li>SBP ‚Üì ‚â•20 mmHg or DBP ‚Üì ‚â•10 mmHg within 3 minutes of standing (or tilt)</li>
      <li>Causes: hypovolemia (dehydration, hemorrhage), medications (antihypertensives, diuretics, TCA), autonomic dysfunction (diabetes, Parkinson's)</li>
      <li>If positive: suspect volume depletion ‚Äî correlate with tachycardia, dry mucous membranes, flat JVD</li></ul>
      <h3>Shock Physiology ‚Äî Detailed</h3>
      <p>Shock = inadequate cellular perfusion resulting in impaired tissue oxygenation and anaerobic metabolism ‚Üí lactic acidosis ‚Üí organ failure ‚Üí death if untreated.</p>
      <ul><li><strong>Hypovolemic Shock:</strong> ‚Üì Preload ‚Üí ‚Üì SV ‚Üí ‚Üì CO. Compensatory: ‚Üë HR, ‚Üë SVR (cold/clammy). Causes: hemorrhage (trauma, GI bleed), dehydration, burns. Tx: volume replacement, blood products, stop bleeding.</li>
      <li><strong>Cardiogenic Shock:</strong> Pump failure ‚Üí ‚Üì Contractility ‚Üí ‚Üì SV ‚Üí ‚Üì CO. High SVR (compensatory vasoconstriction). Signs: hypotension, JVD, pulmonary edema, cold extremities. Causes: massive MI (‚â•40% of LV), end-stage CHF, myocarditis, dysrhythmia. Tx: inotropes (dobutamine), vasopressors if severe, IABP, emergent PCI/CABG.</li>
      <li><strong>Distributive Shock:</strong> ‚Üì‚Üì SVR ‚Üí vasodilation ‚Üí relative hypovolemia. CO initially normal/increased ‚Üí warm shock (warm, flushed, bounding pulses). Three types: (1) <strong>Septic:</strong> Infection ‚Üí inflammatory cytokines ‚Üí vasodilation + capillary leak. Most common cause of shock in ICU. Tx: antibiotics, fluids, norepinephrine. (2) <strong>Neurogenic:</strong> Spinal cord injury above T6 ‚Üí loss of sympathetic tone ‚Üí vasodilation + bradycardia. Warm, dry skin below level of injury. Tx: fluids, vasopressors (phenylephrine, norepinephrine), atropine for bradycardia. (3) <strong>Anaphylactic:</strong> IgE-mediated massive histamine release ‚Üí vasodilation + bronchospasm + angioedema. Tx: EPINEPHRINE IM (0.3-0.5 mg of 1:1000), fluids, diphenhydramine, steroids, albuterol.</li>
      <li><strong>Obstructive Shock:</strong> Mechanical obstruction to cardiac filling or ejection. Causes: (1) <strong>Cardiac tamponade:</strong> Fluid in pericardium compresses heart ‚Üí ‚Üì filling. Beck's Triad: hypotension, JVD, muffled heart sounds. Pulsus paradoxus &gt;10 mmHg. Tx: pericardiocentesis. (2) <strong>Tension pneumothorax:</strong> Pressure in pleural space ‚Üí mediastinal shift ‚Üí ‚Üì venous return. JVD, tracheal deviation, absent breath sounds, hypotension. Tx: needle decompression ‚Üí chest tube. (3) <strong>Massive PE:</strong> Clot obstructs pulmonary artery ‚Üí RV failure ‚Üí ‚Üì LV filling ‚Üí ‚Üì CO. Acute cor pulmonale. Tx: heparin, thrombolytics if massive, surgical embolectomy.</li></ul>
      <h3>Stages of Shock</h3>
      <ul><li><strong>Compensated (Stage I):</strong> Vital signs may be near normal. Compensatory mechanisms active: ‚Üë HR, ‚Üë SVR, ‚Üë RR. Subtle signs: anxiety, restlessness, tachycardia, mild tachypnea, delayed cap refill. BP may be maintained. CATCH IT HERE.</li>
      <li><strong>Decompensated (Stage II):</strong> Mechanisms failing. Hypotension develops. AMS, weak/thready pulses, cool/mottled skin, ‚Üì UOP (&lt;0.5 mL/kg/hr), metabolic acidosis (‚Üë lactate). Aggressive intervention needed NOW.</li>
      <li><strong>Irreversible (Stage III):</strong> Cellular death, multi-organ failure, refractory hypotension despite maximum therapy. DIC, ARDS, renal failure. High mortality.</li></ul>
      <div class="highlight-box"><p style="margin:0"><strong>Compensatory Mechanisms:</strong> Baroreceptor reflex (immediate, seconds), hormonal RAAS activation (minutes-hours: renin ‚Üí angiotensin II ‚Üí aldosterone ‚Üí Na‚Å∫/H‚ÇÇO retention), ADH release (water retention), catecholamine surge from adrenal medulla, transcapillary fluid shift (hours ‚Äî interstitial fluid moves into vasculature).</p></div>
      <div class="highlight-box red"><p style="margin:0"><strong>EMS Assessment Pearl:</strong> Don't wait for hypotension to recognize shock! Early signs: tachycardia out of proportion to situation, anxiety/restlessness, cool/moist skin, delayed cap refill &gt;2 sec, narrowing pulse pressure, lactate &gt;2 mmol/L (if POCT available). A "normal" BP with tachycardia = compensated shock until proven otherwise.</p></div>`,
    'phys-valves': `<h2><span class="gradient">Valvular Heart Disease</span></h2><p class="modal-sub">Stenosis restricts forward flow; regurgitation allows backward flow. Both overwork the heart.</p>
      <h3>General Principles</h3>
      <ul><li><strong>Stenosis:</strong> Valve doesn't open fully ‚Üí restriction of forward flow ‚Üí upstream pressure buildup ‚Üí chamber hypertrophy (pressure overload). Causes: calcification, rheumatic fever, congenital bicuspid valve.</li>
      <li><strong>Regurgitation (Insufficiency):</strong> Valve doesn't close fully ‚Üí backward flow ‚Üí volume overload ‚Üí chamber dilation. Causes: MI (papillary muscle dysfunction), endocarditis, connective tissue disease, annular dilation.</li>
      <li><strong>Systolic murmurs (heard between S‚ÇÅ-S‚ÇÇ):</strong> Aortic stenosis (crescendo-decrescendo, radiates to carotids), mitral regurgitation (holosystolic, radiates to axilla), VSD, tricuspid regurgitation.</li>
      <li><strong>Diastolic murmurs (heard between S‚ÇÇ-S‚ÇÅ):</strong> ALWAYS pathologic. Aortic regurgitation (decrescendo, best at left sternal border), mitral stenosis (low-pitched rumble, best at apex with bell).</li></ul>
      <h3>Aortic Stenosis (AS)</h3>
      <ul><li><strong>Pathophysiology:</strong> LV must generate higher pressure to overcome stenosed valve ‚Üí concentric LVH ‚Üí eventually diastolic dysfunction ‚Üí systolic failure</li>
      <li><strong>Classic Triad:</strong> Syncope (‚Üì cerebral perfusion), angina (‚Üë O‚ÇÇ demand from hypertrophied myocardium), dyspnea on exertion (heart failure)</li>
      <li><strong>EMS Significance:</strong> Avoid NTG and vasodilators ‚Üí can cause severe hypotension (fixed obstruction can't increase CO to compensate for ‚Üì SVR). Avoid aggressive fluid boluses in decompensated AS.</li></ul>
      <h3>Mitral Regurgitation (MR)</h3>
      <ul><li>Acute MR (from MI, chordae rupture): Sudden severe pulmonary edema, flash APE, hemodynamic collapse</li>
      <li>Chronic MR: LA and LV dilation, A-Fib common, gradually progressive CHF</li></ul>
      <h3>Mitral Stenosis (MS)</h3>
      <ul><li>Usually from rheumatic heart disease. ‚Üë LA pressure ‚Üí pulmonary congestion ‚Üí pulmonary HTN ‚Üí RV failure</li>
      <li>High risk for A-Fib (enlarged LA) and thromboembolism (stroke)</li></ul>
      <div class="highlight-box"><p style="margin:0"><strong>EMS Pearl:</strong> A new murmur in a patient with chest pain = worry about acute MI with papillary muscle rupture (MR) or VSD. This is a surgical emergency. Suspect if patient with MI suddenly decompensates with new holosystolic murmur.</p></div>`,
    'phys-markers': `<h2><span class="gradient">Cardiac Biomarkers</span></h2><p class="modal-sub">Lab values that help diagnose and risk-stratify cardiac emergencies</p>
      <h3>Troponin (cTnI / cTnT)</h3>
      <ul><li><strong>What it measures:</strong> Structural proteins specific to cardiac myocytes. Released when myocardial cells are damaged (necrosis). The gold standard biomarker for MI diagnosis.</li>
      <li><strong>Timing:</strong> Begins to rise 2-4 hours after symptom onset. Peaks at 12-24 hours. Remains elevated 7-14 days. High-sensitivity troponin (hs-cTn) can detect within 1-3 hours.</li>
      <li><strong>Clinical significance:</strong> Any elevation above 99th percentile + clinical context (symptoms, ECG changes) = acute MI (Type 1). Can also be elevated in: PE, sepsis, CHF, myocarditis, renal failure, tachyarrhythmias (Type 2 MI ‚Äî demand ischemia).</li>
      <li><strong>Serial troponins:</strong> Rising pattern (delta) with clinical symptoms confirms acute MI. Stable elevation may indicate chronic elevation (renal failure).</li></ul>
      <h3>CK-MB (Creatine Kinase-MB)</h3>
      <ul><li>Less specific than troponin. Rises 4-6 hrs, peaks 12-24 hrs, normalizes 48-72 hrs.</li>
      <li>Useful for detecting re-infarction (troponin stays elevated too long to detect a second event).</li>
      <li>Largely replaced by troponin for initial MI diagnosis.</li></ul>
      <h3>BNP / NT-proBNP (B-Type Natriuretic Peptide)</h3>
      <ul><li><strong>What it measures:</strong> Hormone released by ventricular myocytes in response to wall stretch (volume/pressure overload).</li>
      <li><strong>Clinical use:</strong> Differentiating cardiac vs. pulmonary causes of dyspnea. BNP &gt; 400 pg/mL (or NT-proBNP &gt; 900) strongly suggests CHF. BNP &lt; 100 makes CHF very unlikely.</li>
      <li><strong>Limitations:</strong> Elevated in renal failure, sepsis, PE, age. Obesity falsely lowers BNP. AF increases it.</li></ul>
      <h3>Lactate</h3>
      <ul><li>Marker of anaerobic metabolism ‚Üí tissue hypoperfusion ‚Üí shock. Normal &lt; 2 mmol/L.</li>
      <li>Lactate 2-4 = intermediate risk. Lactate &gt; 4 = high risk, aggressive resuscitation needed.</li>
      <li>Serial lactate clearance (&gt;10% per hour) = positive prognostic indicator ‚Äî patient is responding to treatment.</li></ul>
      <h3>D-Dimer</h3>
      <ul><li>Fibrin degradation product. Highly sensitive but not specific. Useful for RULING OUT PE/DVT (negative predictive value).</li>
      <li>Elevated in: PE, DVT, DIC, MI, infection, post-surgery, pregnancy, cancer ‚Äî many things.</li></ul>
      <div class="highlight-box gold"><p style="margin:0"><strong>STEMI Decision:</strong> Don't wait for troponin to make STEMI decisions! ECG is the definitive tool for STEMI recognition. Troponin may be negative on initial draw (too early). If ST elevation in contiguous leads + symptoms ‚Üí activate cath lab immediately. Time is muscle.</p></div>`,
    'phys-pacing': `<h2><span class="gradient">Automaticity & Pacing Hierarchy</span></h2><p class="modal-sub">The heart's built-in backup system for impulse generation</p>
      <h3>Automaticity</h3>
      <p>Automaticity is the ability of cardiac cells to spontaneously depolarize and generate an action potential without external stimulation. This is due to spontaneous Phase 4 depolarization in pacemaker cells. Multiple sites in the heart have automaticity, forming a hierarchical backup system.</p>
      <h3>Normal Pacing Hierarchy</h3>
      <ul><li><strong>SA Node (Primary Pacemaker):</strong> Intrinsic rate 60-100 bpm. Fastest Phase 4 depolarization ‚Üí reaches threshold first ‚Üí controls heart rate under normal conditions. Located in right atrium near SVC.</li>
      <li><strong>AV Junction (Secondary/Backup):</strong> Intrinsic rate 40-60 bpm. Takes over if SA node fails or slows. Produces junctional rhythm (narrow QRS, absent/retrograde P waves). Includes AV node and Bundle of His.</li>
      <li><strong>Ventricular (Tertiary/Last Resort):</strong> Intrinsic rate 20-40 bpm. Purkinje fibers take over if both SA and AV junction fail. Produces idioventricular rhythm (wide QRS, no P waves). Unreliable ‚Äî often the last rhythm before asystole.</li></ul>
      <h3>Overdrive Suppression</h3>
      <p>The fastest pacemaker "suppresses" slower pacemakers. The SA node fires at 70 bpm ‚Üí AV junction and Purkinje fibers are constantly being depolarized by this faster rate ‚Üí they never reach their own threshold ‚Üí they stay silent. If the SA node fails, there's a pause before the next pacemaker "warms up" and takes over (the escape interval).</p>
      <h3>Enhanced Automaticity</h3>
      <ul><li>Non-pacemaker cells (working myocytes) can develop abnormal automaticity under pathologic conditions</li>
      <li>Causes: ischemia, hypoxia, electrolyte imbalance, catecholamines, digitalis toxicity</li>
      <li>Results in: ectopic beats (PACs, PVCs), ectopic tachycardias, increased risk of VT/VF</li></ul>
      <h3>Triggered Activity</h3>
      <ul><li><strong>Early Afterdepolarizations (EADs):</strong> Abnormal depolarization during Phase 2 or 3 (before full repolarization). Occurs with prolonged QT (drugs, hypokalemia, hypomagnesemia). Mechanism of Torsades de Pointes.</li>
      <li><strong>Delayed Afterdepolarizations (DADs):</strong> Abnormal depolarization during Phase 4 (after full repolarization). Occurs with intracellular Ca¬≤‚Å∫ overload (digitalis toxicity, catecholamines). Mechanism of digitalis-toxic arrhythmias.</li></ul>
      <h3>Re-Entry</h3>
      <p>Most common mechanism of sustained tachyarrhythmias. Requires: (1) two functionally distinct pathways, (2) unidirectional block in one pathway, (3) slow conduction in the other allowing recovery of the blocked pathway. The impulse circles continuously. Examples: AVNRT (SVT), AVRT (WPW), atrial flutter, VT around scar tissue.</p>
      <div class="highlight-box"><p style="margin:0"><strong>Clinical Application:</strong> When you see a slow rhythm (bradycardia), ask: WHERE is the pacemaker? SA node rhythm (P waves present, normal morphology) = sinus bradycardia. No P waves + narrow QRS = junctional escape. No P waves + wide QRS = ventricular escape (most dangerous ‚Äî may be the only thing keeping the patient alive ‚Üí do NOT suppress with antiarrhythmics).</p></div>`,
    'step1': `<h2><span class="gradient">Step 1: Analyze the Rate</span></h2>
      <h3>Methods</h3><ul><li><strong>6-Second Count:</strong> Count R waves in 6 seconds (30 large boxes), multiply by 10</li><li><strong>Triplicate (Rule of 300s):</strong> 300 √∑ (# large boxes between R-R) = rate</li><li><strong>R-R Method:</strong> 1500 √∑ (# small boxes between R-R) = rate</li></ul>
      <div class="highlight-box"><p style="margin:0"><strong>Brady &lt; 60</strong> ¬∑ <strong>Normal 60-100</strong> ¬∑ <strong>Tachy &gt; 100</strong></p></div>`,
    'step2': `<h2><span class="gradient">Step 2: Analyze the Rhythm</span></h2>
      <ul><li>Compare R-R intervals across the entire strip</li><li><strong>Regular:</strong> R-R intervals consistent throughout</li><li><strong>Regularly Irregular:</strong> Repeating pattern (e.g., Wenckebach, sinus arrhythmia)</li><li><strong>Irregularly Irregular:</strong> No pattern whatsoever (hallmark of A-Fib)</li></ul>`,
    'step3': `<h2><span class="gradient">Step 3: Analyze the QRS Complex</span></h2>
      <ul><li>Are QRS complexes present and uniform?</li><li><strong>Narrow QRS (&lt; 0.12s / 3 small boxes):</strong> Supraventricular origin ‚Äî impulse travels normally through ventricles</li><li><strong>Wide QRS (‚â• 0.12s):</strong> Ventricular origin OR aberrant conduction (BBB, WPW)</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>Clinical Pearl:</strong> Wide complex tachycardia ‚Äî treat as VT until proven otherwise.</p></div>`,
    'step4': `<h2><span class="gradient">Step 4: Analyze P Waves</span></h2>
      <h3>5 Components to Observe</h3><ul><li>Are P waves present?</li><li>Are P waves occurring at regular intervals?</li><li>Is there one P wave for each QRS complex?</li><li>Are P waves upright or inverted?</li><li>Do all P waves look alike?</li></ul>
      <div class="highlight-box"><p style="margin:0"><strong>To be called "sinus rhythm":</strong> 1:1 P:QRS ratio + upright P in Lead II + consistent morphology</p></div>`,
    'step5': `<h2><span class="gradient">Step 5: Analyze PR Interval</span></h2>
      <ul><li>Normal: <strong>0.12‚Äì0.20 seconds</strong> (3-5 small boxes)</li><li>Consistent? ‚Äî Same PR throughout = normal conduction</li><li>Prolonged (&gt; 0.20s)? ‚Äî First-degree AV block</li><li>Progressively lengthening? ‚Äî Wenckebach (Type I)</li><li>Short (&lt; 0.12s)? ‚Äî Junctional rhythm or WPW syndrome</li><li>Variable? ‚Äî May indicate wandering pacemaker or 3rd-degree block</li></ul>`,
    'block-1st': `<h2><span class="gradient">First-Degree AV Block</span></h2><div class="ecg-paper-bg modal-rhythm-strip"><canvas class="modal-rhythm-canvas" data-rhythm="1avb" height="140"></canvas></div>
      <div class="highlight-box gold"><p style="margin:0"><strong>Not a true block ‚Äî it's a delay.</strong> PR &gt; 0.20s but constant. All P waves are conducted.</p></div>
      <h3>Characteristics</h3><ul><li>PR interval prolonged (&gt; 0.20s / 5 small boxes) but constant</li><li>1:1 P:QRS relationship maintained</li><li>Usually occurs at the AV node level</li><li>Not a rhythm itself ‚Äî superimposed on another rhythm</li></ul><h3>Management</h3><p>Usually benign. No treatment needed. Monitor for progression.</p>`,
    'block-2nd1': `<h2><span class="gradient">Second-Degree Type I (Wenckebach)</span></h2><div class="ecg-paper-bg modal-rhythm-strip"><canvas class="modal-rhythm-canvas" data-rhythm="wenck" height="140"></canvas></div>
      <div class="highlight-box gold"><p style="margin:0"><strong>PR progressively lengthens ‚Üí dropped QRS ‚Üí cycle repeats</strong></p></div>
      <h3>Characteristics</h3><ul><li>Progressive PR lengthening until a beat is dropped</li><li>Grouped beating pattern</li><li>Usually at AV node level</li><li>R-R intervals shorten before the dropped beat</li></ul><h3>Management</h3><p>Usually transient. If symptomatic: Atropine 0.5mg IV. TCP if atropine fails.</p>`,
    'block-2nd2': `<h2><span class="gradient">Second-Degree Type II (Mobitz)</span></h2><div class="ecg-paper-bg modal-rhythm-strip"><canvas class="modal-rhythm-canvas" data-rhythm="mobitz2" height="140"></canvas></div>
      <div class="highlight-box red"><p style="margin:0"><strong>More dangerous than Type I.</strong> Constant PR for conducted beats, then sudden dropped QRS. Usually below Bundle of His.</p></div>
      <h3>Characteristics</h3><ul><li>PR interval constant for all conducted beats</li><li>Sudden non-conducted P wave (dropped QRS)</li><li>Conduction ratios: 2:1, 3:1, 4:1</li><li>QRS often wide (infranodal)</li></ul><h3>Management</h3><p>TCP indicated. Prepare for transvenous pacing. Atropine usually ineffective. May progress to complete block.</p>`,
    'block-3rd': `<h2><span class="gradient">Third-Degree (Complete) Heart Block</span></h2><div class="ecg-paper-bg modal-rhythm-strip"><canvas class="modal-rhythm-canvas" data-rhythm="3avb" height="140"></canvas></div>
      <div class="highlight-box red"><p style="margin:0"><strong>Complete AV dissociation.</strong> No atrial impulses reach the ventricles. P waves march independently of QRS complexes.</p></div>
      <h3>Characteristics</h3><ul><li>P waves and QRS complexes are completely independent</li><li>Atrial rate &gt; ventricular rate</li><li>Ventricular escape: junctional (40-60, narrow) or ventricular (20-40, wide)</li></ul><h3>Management</h3><p>Life-threatening. Immediate TCP. Dopamine or epinephrine infusion. Prepare for transvenous pacing.</p>`,
    'acs-patho': `<h2><span class="gradient">ACS Pathophysiology</span></h2><p class="modal-sub">Understanding the complete cascade from stable plaque to myocardial necrosis</p>
      <h3>Stage 1 ‚Äî Endothelial Injury & Atherosclerosis</h3>
      <ul><li>Begins with injury to the vascular endothelium (hypertension, smoking, diabetes, hyperlipidemia, turbulent flow)</li>
      <li>Lipids (LDL cholesterol) infiltrate the intimal layer and become oxidized</li>
      <li>Macrophages engulf oxidized LDL ‚Üí become "foam cells" ‚Üí form fatty streaks</li>
      <li>Over years, smooth muscle cells migrate and proliferate, forming a fibrous cap over the lipid core</li>
      <li>Result: <strong>Stable atherosclerotic plaque</strong> that progressively narrows the lumen</li></ul>
      <h3>Stage 2 ‚Äî Plaque Rupture / Erosion</h3>
      <ul><li>Vulnerable plaques have thin fibrous caps, large lipid cores, and active inflammation</li>
      <li>Physical or hemodynamic stress causes the cap to rupture, exposing thrombogenic lipid core to blood</li>
      <li>Platelet adhesion ‚Üí activation ‚Üí aggregation at the site of rupture</li>
      <li>Coagulation cascade activates ‚Üí thrombin generation ‚Üí fibrin mesh stabilizes the clot</li>
      <li><strong>Complete occlusion = STEMI</strong> (transmural ischemia). <strong>Partial occlusion = NSTEMI/Unstable Angina</strong></li></ul>
      <h3>Stage 3 ‚Äî Ischemia ‚Üí Injury ‚Üí Infarction</h3>
      <ul><li><strong>Ischemia (minutes):</strong> O‚ÇÇ supply < O‚ÇÇ demand. Reversible. Subendocardial. ECG: T-wave changes, ST depression</li>
      <li><strong>Injury (minutes to hours):</strong> Prolonged ischemia ‚Üí cellular damage begins. Partially reversible with reperfusion. ECG: ST elevation (STEMI)</li>
      <li><strong>Infarction (hours):</strong> Irreversible necrosis. Troponin release. ECG: Pathological Q waves develop. Scar tissue replaces muscle</li>
      <li><strong>"Time is Muscle":</strong> ~1.9 million myocytes die per minute of occlusion. Early reperfusion = more myocardial salvage</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>Wavefront Phenomenon:</strong> Necrosis begins at the subendocardium (most vulnerable to ischemia due to highest O‚ÇÇ demand and most distal blood supply) and spreads like a wavefront toward the epicardium over 4-6 hours. This is why door-to-balloon time matters.</p></div>`,

    'acs-spectrum': `<h2><span class="gradient">The ACS Spectrum</span></h2><p class="modal-sub">Three conditions sharing the same pathology ‚Äî differentiated by ECG and biomarkers</p>
      <h3>Unstable Angina (UA)</h3>
      <ul><li>Partial coronary occlusion with transient ischemia</li>
      <li>Chest pain at rest, new-onset, or crescendo pattern (increasing frequency/severity)</li>
      <li>ECG: May show ST depression, T-wave inversion, or be normal</li>
      <li>Troponin: <strong>Negative</strong> (no myocardial necrosis)</li>
      <li>Differentiating feature: Chest pain not relieved by rest or NTG within 15 minutes</li></ul>
      <h3>NSTEMI (Non-ST Elevation MI)</h3>
      <ul><li>Partial or intermittent coronary occlusion with subendocardial necrosis</li>
      <li>ECG: ST depression ‚â• 0.5mm, T-wave inversion ‚â• 2mm, or non-diagnostic. <strong>No ST elevation</strong></li>
      <li>Troponin: <strong>Positive</strong> (myocardial necrosis confirmed)</li>
      <li>Treatment: Anticoagulation, antiplatelets, risk stratification, early invasive strategy within 24-72 hours</li></ul>
      <h3>STEMI (ST Elevation MI)</h3>
      <ul><li><strong>Complete coronary occlusion</strong> with transmural ischemia/infarction</li>
      <li>ECG: ST elevation ‚â• 1mm in 2+ contiguous limb leads OR ‚â• 2mm in 2+ contiguous precordial leads</li>
      <li>Troponin: Positive (but don't wait for results ‚Äî diagnose by ECG)</li>
      <li>Treatment: <strong>Emergent reperfusion</strong> ‚Äî PCI (door-to-balloon < 90 min) or fibrinolytics (door-to-needle < 30 min)</li></ul>
      <div class="highlight-box gold"><p style="margin:0"><strong>STEMI Equivalents:</strong> New LBBB with ACS symptoms, de Winter T waves (upsloping ST depression + tall peaked T waves in precordial leads = proximal LAD occlusion), Wellens syndrome (deep T-wave inversions V2-V3 = critical LAD stenosis), and posterior MI (ST depression V1-V3 with tall R waves).</p></div>`,

    'acs-signs': `<h2><span class="gradient">ACS Signs & Symptoms</span></h2><p class="modal-sub">Recognition of both classic and atypical presentations</p>
      <h3>Classic Presentation</h3>
      <ul><li><strong>Chest pain/pressure:</strong> Substernal, crushing, squeezing, "elephant sitting on chest." Duration > 15-20 minutes (unlike stable angina)</li>
      <li><strong>Radiation:</strong> Left arm (most common), jaw, neck, shoulder, back, epigastrium</li>
      <li><strong>Diaphoresis:</strong> Cold, clammy, profuse sweating ‚Äî highly specific for AMI</li>
      <li><strong>Dyspnea:</strong> From LV dysfunction, pulmonary congestion, or anxiety</li>
      <li><strong>Nausea/Vomiting:</strong> Especially with inferior MI (vagal stimulation)</li>
      <li><strong>Sense of impending doom:</strong> Patient feels like they are dying ‚Äî take this seriously</li>
      <li><strong>Weakness/Fatigue:</strong> Sudden onset, unable to perform normal activities</li>
      <li><strong>Pallor:</strong> Ashen, gray appearance from sympathetic activation</li></ul>
      <h3>Atypical Presentations ‚Äî "Silent MI"</h3>
      <ul><li><strong>Women:</strong> More likely to present with fatigue, dyspnea, back/jaw pain, nausea, dizziness rather than classic chest pain. May report indigestion or flu-like symptoms</li>
      <li><strong>Elderly (>75):</strong> May present with altered mental status, syncope, weakness, or dyspnea without any chest pain. AMS may be only symptom</li>
      <li><strong>Diabetics:</strong> Autonomic neuropathy blunts pain perception. May present with unexplained diaphoresis, weakness, or dyspnea only</li>
      <li><strong>Post-surgical/intubated patients:</strong> Cannot report symptoms; watch for hemodynamic changes, new dysrhythmias, ST changes on monitor</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>EMS Pearl:</strong> Treat all chest pain as AMI until proven otherwise. Up to 30% of MIs present atypically. Maintain high index of suspicion in women, elderly, and diabetics. If in doubt, get a 12-lead.</p></div>
      <h3>Associated Assessment Findings</h3>
      <ul><li>Vital signs: Tachycardia (sympathetic), bradycardia (inferior MI/vagal), hypertension (sympathetic) or hypotension (cardiogenic shock)</li>
      <li>JVD: Suggests RV involvement or CHF</li>
      <li>Lung sounds: Crackles/rales = pulmonary edema from LV failure</li>
      <li>New heart murmur: Papillary muscle dysfunction or VSD</li>
      <li>Peripheral edema: Chronic right heart failure</li></ul>`,

    'acs-12lead': `<h2><span class="gradient">12-Lead ECG & STEMI Recognition</span></h2><p class="modal-sub">The single most important diagnostic tool in the field for ACS</p>
      <h3>ECG Changes in ACS Evolution</h3>
      <ul><li><strong>Hyperacute T waves:</strong> Earliest sign (minutes). Tall, broad, peaked T waves. Often missed ‚Äî occurs before ST elevation</li>
      <li><strong>ST elevation:</strong> Acute injury. Indicates transmural ischemia. The hallmark of STEMI</li>
      <li><strong>ST depression:</strong> Subendocardial ischemia (NSTEMI) or reciprocal changes opposite the area of injury</li>
      <li><strong>T-wave inversion:</strong> Ischemia or early infarction. Deep symmetric inversions = concerning</li>
      <li><strong>Pathological Q waves:</strong> Myocardial necrosis (hours to days). Width > 0.04s or depth > 1/3 of R wave amplitude. Indicates completed infarction</li></ul>
      <h3>STEMI Criteria</h3>
      <div class="highlight-box gold"><p style="margin:0"><strong>ST Elevation:</strong> ‚â• 1mm (0.1mV) in 2 or more contiguous limb leads, OR ‚â• 2mm (0.2mV) in 2 or more contiguous precordial leads (V1-V6). Measured at the J point relative to the TP segment (or PR segment).</p></div>
      <h3>Contiguous Lead Groups</h3>
      <ul><li><strong>Septal:</strong> V1, V2 ‚Äî LAD</li>
      <li><strong>Anterior:</strong> V3, V4 ‚Äî LAD</li>
      <li><strong>Lateral:</strong> V5, V6, I, aVL ‚Äî LCx</li>
      <li><strong>Inferior:</strong> II, III, aVF ‚Äî RCA (85%) or LCx (15%)</li>
      <li><strong>Right ventricular:</strong> V4R (right-sided leads) ‚Äî Proximal RCA</li>
      <li><strong>Posterior:</strong> V7, V8, V9 ‚Äî Posterior descending artery (PDA)</li></ul>
      <h3>Reciprocal Changes</h3>
      <ul><li>ST depression in leads opposite to the area of ST elevation ‚Äî <strong>confirms the STEMI diagnosis</strong></li>
      <li>Inferior STEMI ‚Üí reciprocal depression in I, aVL</li>
      <li>Anterior STEMI ‚Üí reciprocal depression in II, III, aVF</li>
      <li>Presence of reciprocal changes increases specificity for acute MI</li></ul>
      <h3>Special Lead Placements</h3>
      <ul><li><strong>Right-sided ECG (V3R‚ÄìV6R):</strong> Obtain with EVERY inferior STEMI. V4R is most sensitive for RV infarct. ST elevation ‚â• 1mm in V4R = RV involvement. Contraindication to NTG and volume depletion</li>
      <li><strong>Posterior ECG (V7‚ÄìV9):</strong> Obtain when ST depression in V1-V3 without clear anterior cause. ST elevation ‚â• 0.5mm in V7-V9 = posterior STEMI</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>Critical Rule:</strong> A normal 12-lead does NOT rule out ACS. Only ~50% of AMIs present with diagnostic ST changes on the initial ECG. Serial ECGs every 15 minutes if clinical suspicion is high.</p></div>`,

    'acs-territory': `<h2><span class="gradient">Infarct Territories</span></h2><p class="modal-sub">Matching leads to walls, arteries, and expected complications</p>
      <h3>Anterior Wall MI</h3>
      <ul><li><strong>Leads:</strong> V1‚ÄìV4 (septal-anterior)</li>
      <li><strong>Artery:</strong> LAD (Left Anterior Descending) ‚Äî "widow maker"</li>
      <li><strong>Affected:</strong> Anterior wall LV, anterior septum, apex, bundle branches</li>
      <li><strong>Complications:</strong> CHF, cardiogenic shock (large area of LV), VF/VT, BBB (RBBB or LAFB), ventricular aneurysm, free wall rupture, VSD</li>
      <li><strong>Highest mortality</strong> of all STEMI locations due to large territory</li></ul>
      <h3>Inferior Wall MI</h3>
      <ul><li><strong>Leads:</strong> II, III, aVF</li>
      <li><strong>Artery:</strong> RCA (85%) or LCx (15%)</li>
      <li><strong>Affected:</strong> Inferior wall LV, SA node, AV node</li>
      <li><strong>Complications:</strong> Sinus bradycardia (SA node ischemia), AV blocks (1st, 2nd Type I, 3rd degree), RV infarction (check V4R), hypotension, papillary muscle rupture ‚Üí acute mitral regurgitation</li>
      <li><strong>Always obtain right-sided leads</strong> with inferior STEMI</li></ul>
      <h3>Lateral Wall MI</h3>
      <ul><li><strong>Leads:</strong> I, aVL, V5, V6</li>
      <li><strong>Artery:</strong> LCx (Left Circumflex) or diagonal branches of LAD</li>
      <li><strong>Affected:</strong> Lateral wall LV</li>
      <li><strong>Complications:</strong> Often presents with anterolateral or inferolateral pattern. Isolated lateral MI less common</li></ul>
      <h3>Posterior Wall MI</h3>
      <ul><li><strong>Standard leads:</strong> ST depression V1-V3 (reciprocal), tall R waves V1-V2, upright T waves V1-V2</li>
      <li><strong>Posterior leads (V7-V9):</strong> ST elevation ‚â• 0.5mm confirms</li>
      <li><strong>Artery:</strong> PDA (posterior descending artery), from RCA or LCx</li>
      <li><strong>Often missed:</strong> Must suspect when V1-V3 show "mirror image" of STEMI</li></ul>
      <h3>Right Ventricular MI</h3>
      <ul><li><strong>Lead:</strong> V4R (ST elevation ‚â• 1mm)</li>
      <li><strong>Artery:</strong> Proximal RCA</li>
      <li><strong>Complications:</strong> Preload-dependent ‚Äî hypotension, JVD, clear lungs ("triad"). <strong>Do NOT give NTG or diuretics</strong> (reduce preload ‚Üí cardiovascular collapse). Treat with fluid bolus (250-500mL NS)</li></ul>
      <div class="highlight-box"><p style="margin:0"><strong>Quick Reference:</strong> Inferior = II, III, aVF (RCA). Anterior = V1-V4 (LAD). Lateral = I, aVL, V5-V6 (LCx). Posterior = mirror V1-V3 (PDA). RV = V4R (proximal RCA).</p></div>`,

    'acs-mgmt': `<h2><span class="gradient">ACS EMS Management</span></h2><p class="modal-sub">Time-critical interventions from first patient contact through cath lab arrival</p>
      <h3>Immediate Assessment (First 5 Minutes)</h3>
      <ul><li>Primary survey ‚Äî ABC, vital signs, SpO‚ÇÇ, level of consciousness</li>
      <li><strong>12-lead ECG:</strong> Obtain within 5 minutes of patient contact. If STEMI identified ‚Üí activate cath lab immediately</li>
      <li>IV access ‚Äî large bore (18g or larger) √ó 2 if possible</li>
      <li>Cardiac monitor ‚Äî continuous monitoring for dysrhythmias</li>
      <li>Focused history: OPQRST for chest pain, SAMPLE, cardiac risk factors, medication list (especially anticoagulants, PDE5 inhibitors)</li></ul>
      <h3>Pharmacological Management</h3>
      <ul><li><strong>Aspirin 324mg PO (chewed):</strong> Irreversible COX-1 inhibition ‚Üí blocks thromboxane A‚ÇÇ ‚Üí inhibits platelet aggregation. Give ASAP unless true allergy. Single most impactful prehospital drug for ACS ‚Äî 23% mortality reduction</li>
      <li><strong>Nitroglycerin 0.4mg SL:</strong> Venodilation ‚Üí ‚Üì preload ‚Üí ‚Üì myocardial O‚ÇÇ demand. Coronary vasodilation ‚Üí ‚Üë collateral flow. May repeat √ó 3 every 3-5 min. <strong>Contraindications:</strong> SBP < 90, HR < 50 or > 100, RV infarct, PDE5 inhibitor use within 24-48 hours</li>
      <li><strong>Oxygen:</strong> Only if SpO‚ÇÇ < 94% or respiratory distress. Routine O‚ÇÇ in normoxic patients may worsen outcomes (AVOID trial). Hyperoxia causes coronary vasoconstriction</li>
      <li><strong>Analgesics:</strong> Fentanyl 25-50mcg IV (preferred ‚Äî less hypotension, less emesis) or Morphine 2-4mg IV (use cautiously ‚Äî CRUSADE registry showed association with higher mortality). Titrate to pain relief</li>
      <li><strong>Anticoagulation:</strong> Heparin 60 U/kg IV bolus (max 4000U) per protocol, or Enoxaparin 0.5mg/kg IV for STEMI</li></ul>
      <h3>STEMI-Specific Actions</h3>
      <ul><li><strong>Cath lab activation:</strong> Transmit 12-lead ECG to receiving facility. Target first medical contact-to-balloon < 90 minutes</li>
      <li><strong>Transport decision:</strong> PCI-capable center preferred. If > 120 min transport to PCI ‚Üí consider fibrinolytics (tenecteplase, alteplase, reteplase)</li>
      <li><strong>Fibrinolytic checklist:</strong> Screen for absolute contraindications (active internal bleeding, suspected aortic dissection, recent head trauma/stroke < 3 months, intracranial neoplasm, known bleeding disorder)</li>
      <li><strong>Serial 12-leads:</strong> Repeat every 15 minutes. Monitor for reperfusion (resolution of ST elevation, reperfusion dysrhythmias like AIVR, pain resolution)</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>Do NOT delay transport for interventions.</strong> Aspirin and 12-lead are the two most critical prehospital actions. Everything else can happen en route. The cath lab saves lives ‚Äî get there fast.</p></div>
      <h3>Special Considerations</h3>
      <ul><li><strong>RV Infarct:</strong> No NTG, no diuretics, no morphine. Volume loading with NS 250-500mL boluses</li>
      <li><strong>Cocaine-induced:</strong> No beta-blockers (unopposed alpha stimulation ‚Üí coronary vasospasm). Use benzodiazepines, NTG, calcium channel blockers</li>
      <li><strong>New-onset LBBB + ACS symptoms:</strong> Treat as STEMI equivalent. Use Sgarbossa criteria for diagnosis</li>
      <li><strong>Arrest during STEMI:</strong> Consider transport with mechanical CPR for cath lab PCI during arrest</li></ul>`,

    'acs-complications': `<h2><span class="gradient">Complications of Acute MI</span></h2><p class="modal-sub">What can go wrong after myocardial infarction ‚Äî early and late</p>
      <h3>Dysrhythmias (Most Common Complication)</h3>
      <ul><li><strong>PVCs:</strong> Very common post-MI. Isolated PVCs typically benign. Concern: R-on-T phenomenon ‚Üí VF</li>
      <li><strong>VT/VF:</strong> Leading cause of death in the first hour. Primary VF (within 24h) ‚Äî electrical instability. Late VF (after 24h) ‚Äî scarring, worse prognosis</li>
      <li><strong>Sinus bradycardia:</strong> Common with inferior MI (vagal). Usually responsive to atropine</li>
      <li><strong>AV blocks:</strong> Inferior MI ‚Üí Type I (usually transient). Anterior MI ‚Üí Type II or complete block (often permanent, needs pacer)</li>
      <li><strong>Accelerated idioventricular rhythm (AIVR):</strong> "Reperfusion rhythm" ‚Äî actually a good sign after PCI/thrombolytics</li></ul>
      <h3>Pump Failure</h3>
      <ul><li><strong>Acute heart failure:</strong> LV dysfunction ‚Üí pulmonary edema. Killip classification I-IV</li>
      <li><strong>Cardiogenic shock:</strong> Killip Class IV. > 40% LV damage. Mortality 50-80% without revascularization</li>
      <li><strong>RV failure:</strong> Hypotension, JVD, clear lungs. Preload dependent. Treat with fluids, avoid vasodilators</li></ul>
      <h3>Mechanical Complications (Days 2-14)</h3>
      <ul><li><strong>Papillary muscle rupture:</strong> Acute severe mitral regurgitation. Sudden pulmonary edema, new loud systolic murmur. Most common with inferior MI (posteromedial papillary muscle has single blood supply from PDA)</li>
      <li><strong>Ventricular septal rupture:</strong> New harsh holosystolic murmur. Sudden hemodynamic deterioration. Occurs at border of infarcted and viable tissue</li>
      <li><strong>Free wall rupture:</strong> Catastrophic ‚Äî cardiac tamponade, PEA, death within minutes. Risk factors: first MI, anterior wall, age > 60, female</li>
      <li><strong>Ventricular aneurysm:</strong> Thinned, scarred wall that bulges during systole. Persistent ST elevation weeks after MI. Risk of thrombus formation and VT</li></ul>
      <h3>Other Complications</h3>
      <ul><li><strong>Pericarditis (Dressler Syndrome):</strong> Autoimmune-mediated. Occurs 2-10 weeks post-MI. Fever, pleuritic chest pain, friction rub. Treat with NSAIDs, colchicine. Avoid anticoagulants (hemorrhagic pericarditis risk)</li>
      <li><strong>Mural thrombus:</strong> Forms on akinetic or dyskinetic wall segments (especially anterior/apical). Risk of systemic embolization ‚Üí stroke. Anticoagulate</li>
      <li><strong>Reinfarction/stent thrombosis:</strong> Recurrent chest pain, re-elevation of ST segments. Emergency re-catheterization</li></ul>
      <div class="highlight-box"><p style="margin:0"><strong>Killip Classification:</strong> I = No CHF signs. II = Rales, S‚ÇÉ, JVD. III = Frank pulmonary edema. IV = Cardiogenic shock. Mortality increases dramatically with each class.</p></div>`,

    'acs-mimics': `<h2><span class="gradient">ACS Mimics & Differentials</span></h2><p class="modal-sub">Not all chest pain is ACS ‚Äî but don't miss the ones that can also kill</p>
      <h3>Life-Threatening Differentials ("The Big 6")</h3>
      <ul><li><strong>Aortic Dissection:</strong> Sudden "tearing/ripping" pain radiating to back. BP differential between arms > 20mmHg. Unequal pulses. Do NOT give anticoagulants or fibrinolytics</li>
      <li><strong>Pulmonary Embolism:</strong> Sudden dyspnea, pleuritic chest pain, tachycardia. Risk factors: DVT, immobilization, surgery, OCP use. S1Q3T3 on ECG (only 20% of cases)</li>
      <li><strong>Tension Pneumothorax:</strong> Acute dyspnea, unilateral absent breath sounds, tracheal deviation, JVD, hypotension. Needle decompression immediately</li>
      <li><strong>Cardiac Tamponade:</strong> Beck's triad, pulsus paradoxus, electrical alternans</li>
      <li><strong>Esophageal Rupture (Boerhaave):</strong> After forceful vomiting. Subcutaneous emphysema, mediastinal air</li>
      <li><strong>Acute Pericarditis:</strong> Sharp, pleuritic, positional (worse supine, better leaning forward). Diffuse ST elevation with PR depression. Friction rub</li></ul>
      <h3>Non-Life-Threatening Mimics</h3>
      <ul><li><strong>GERD / Esophageal Spasm:</strong> Burning, may respond to antacids, positional. Can mimic ACS almost exactly. NTG may actually relieve esophageal spasm (complicating diagnosis)</li>
      <li><strong>Musculoskeletal (Costochondritis):</strong> Reproducible with palpation, pleuritic, positional. But note: 5-7% of patients with reproducible chest wall tenderness DO have ACS</li>
      <li><strong>Anxiety / Panic Attack:</strong> Chest tightness, dyspnea, paresthesias, hyperventilation. Diagnosis of exclusion ‚Äî always rule out ACS first</li>
      <li><strong>Cholecystitis / Biliary colic:</strong> RUQ pain radiating to right shoulder. May mimic inferior MI</li>
      <li><strong>Pulmonary:</strong> Pneumonia (fever, productive cough), pleuritis (pleuritic), asthma (wheezing)</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>Golden Rule:</strong> In the field, treat as ACS until proven otherwise. A 12-lead ECG and aspirin are low-risk, high-yield interventions. Never assume "it's just anxiety" or "it's just GERD" without a 12-lead and thorough assessment. Let the ED rule it out.</p></div>`,

    'emerg-hf': `<h2><span class="gradient">Heart Failure & Acute Pulmonary Edema</span></h2><p class="modal-sub">When the heart can no longer meet the body's metabolic demands</p>
      <h3>Left Heart Failure (LHF)</h3>
      <ul><li><strong>Pathophysiology:</strong> LV unable to adequately pump blood forward ‚Üí blood backs up into pulmonary vasculature ‚Üí ‚Üë pulmonary capillary pressure ‚Üí fluid leaks into alveoli (pulmonary edema)</li>
      <li><strong>Signs/Symptoms:</strong> Dyspnea (especially on exertion), orthopnea, paroxysmal nocturnal dyspnea (PND), crackles/rales (bilateral, dependent), pink frothy sputum (severe), tachycardia, S‚ÇÉ gallop, diaphoresis, anxiety</li>
      <li><strong>Key distinction:</strong> HFrEF (EF < 40%, systolic failure, "wet and cold") vs. HFpEF (EF > 50%, diastolic failure, stiff ventricle cannot relax/fill properly, "wet and warm")</li></ul>
      <h3>Right Heart Failure (RHF)</h3>
      <ul><li><strong>Pathophysiology:</strong> RV unable to pump blood forward ‚Üí blood backs up into systemic venous circulation</li>
      <li><strong>Signs/Symptoms:</strong> JVD, peripheral edema (dependent ‚Äî ankles, sacrum), hepatomegaly (liver congestion), ascites, weight gain</li>
      <li><strong>Most common cause:</strong> Left heart failure (LHF ‚Üí pulmonary HTN ‚Üí RHF). Also from COPD (cor pulmonale), PE, RV infarct</li></ul>
      <h3>NYHA Functional Classification</h3>
      <ul><li><strong>Class I:</strong> No limitation of physical activity. Ordinary activity causes no symptoms</li>
      <li><strong>Class II:</strong> Slight limitation. Comfortable at rest. Ordinary activity causes fatigue, dyspnea</li>
      <li><strong>Class III:</strong> Marked limitation. Comfortable only at rest. Less than ordinary activity causes symptoms</li>
      <li><strong>Class IV:</strong> Unable to carry on any activity without discomfort. Symptoms at rest</li></ul>
      <h3>Acute Pulmonary Edema ‚Äî EMS Management</h3>
      <ul><li><strong>Position:</strong> Sitting upright with legs dependent (‚Üì venous return to heart)</li>
      <li><strong>CPAP/BiPAP (NIPPV):</strong> First-line treatment. 5-10 cm H‚ÇÇO. Splints open alveoli, ‚Üì preload, ‚Üì afterload, ‚Üì work of breathing. Reduces intubation rates by 50% and mortality by 40%</li>
      <li><strong>Nitroglycerin:</strong> SL 0.4mg or IV drip (start 10-20 mcg/min, titrate). Venodilation ‚Üí ‚Üì preload ‚Üí ‚Üì pulmonary congestion. Can use aggressively in acute CHF (high-dose NTG strategy)</li>
      <li><strong>Oxygen:</strong> Target SpO‚ÇÇ > 94%. Use with CPAP/BiPAP</li>
      <li><strong>Furosemide (Lasix):</strong> 40-80mg IV. Venodilation within minutes (before diuretic effect). Reduces preload</li>
      <li><strong>Morphine:</strong> 2-4mg IV ‚Äî use cautiously. ‚Üì Preload, ‚Üì anxiety. Some evidence of harm; many protocols have removed it</li>
      <li><strong>If SBP < 90 (cardiogenic shock):</strong> CPAP, vasopressors (dopamine/norepinephrine), defer NTG and diuretics</li></ul>
      <div class="highlight-box gold"><p style="margin:0"><strong>EMS Pearl:</strong> CPAP is the game-changer for acute pulmonary edema. If you have one intervention, make it CPAP. NTG drip + CPAP is the gold standard combination for acute decompensated heart failure with adequate BP.</p></div>`,

    'emerg-shock': `<h2><span class="gradient">Cardiogenic Shock</span></h2><p class="modal-sub">The most severe form of pump failure ‚Äî mortality 40-50% even with aggressive treatment</p>
      <h3>Definition & Pathophysiology</h3>
      <ul><li>Cardiac output is so severely reduced that tissue perfusion is critically inadequate despite adequate intravascular volume</li>
      <li>SBP < 90 mmHg (or > 30 mmHg drop from baseline) sustained for > 30 minutes</li>
      <li>Cardiac index < 2.2 L/min/m¬≤ with adequate preload (PCWP > 15 mmHg)</li>
      <li><strong>Downward spiral:</strong> ‚Üì CO ‚Üí ‚Üì coronary perfusion ‚Üí more ischemia ‚Üí further ‚Üì contractility ‚Üí further ‚Üì CO</li></ul>
      <h3>Clinical Presentation</h3>
      <ul><li>Profound hypotension unresponsive to fluids</li>
      <li>Tachycardia (compensatory), weak thready pulse</li>
      <li>Cold, clammy, mottled skin (peripheral vasoconstriction)</li>
      <li>Altered mental status (cerebral hypoperfusion)</li>
      <li>Oliguria/anuria (renal hypoperfusion)</li>
      <li>Pulmonary edema (LV backup) ‚Äî crackles, dyspnea, pink frothy sputum</li>
      <li>JVD (if biventricular failure or RV involvement)</li></ul>
      <h3>Causes</h3>
      <ul><li><strong>AMI (most common ‚Äî 80%):</strong> Usually > 40% LV mass infarcted. Anterior MI highest risk</li>
      <li>Acute valvular failure (papillary muscle rupture, acute MR, acute AR)</li>
      <li>Ventricular septal rupture, free wall rupture</li>
      <li>Myocarditis, Takotsubo cardiomyopathy</li>
      <li>End-stage cardiomyopathy decompensation</li></ul>
      <h3>EMS & Emergency Management</h3>
      <ul><li><strong>Airway:</strong> Early intubation if severe respiratory failure. CPAP/BiPAP if mentating</li>
      <li><strong>Vasopressors:</strong> Norepinephrine (first-line per SOAP II trial) ‚Äî vasopressor + mild inotrope. Dopamine 5-20 mcg/kg/min ‚Äî inotrope + vasopressor at higher doses. Dobutamine 2-20 mcg/kg/min ‚Äî pure inotrope (‚Üë contractility, ‚Üì afterload; requires adequate BP)</li>
      <li><strong>Emergent reperfusion:</strong> PCI is the definitive treatment if caused by AMI. Early cath lab activation</li>
      <li><strong>Mechanical support:</strong> Intra-Aortic Balloon Pump (IABP) ‚Äî counterpulsation ‚Üë coronary perfusion during diastole, ‚Üì afterload during systole. Impella, ECMO in refractory cases</li>
      <li><strong>Avoid:</strong> Excessive fluids (already volume overloaded), beta-blockers (‚Üì contractility further)</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>Key Differentiation:</strong> Cardiogenic shock = cold + wet (poor perfusion + congestion). Hypovolemic shock = cold + dry. Distributive shock = warm + dry or warm + wet. Always assess skin temperature, moisture, JVD, and lung sounds.</p></div>`,

    'emerg-tamp': `<h2><span class="gradient">Cardiac Tamponade</span></h2><p class="modal-sub">Fluid accumulation in the pericardial sac compressing the heart</p>
      <h3>Pathophysiology</h3>
      <ul><li>Normal pericardial space contains 15-50 mL of serous fluid</li>
      <li>Rapid accumulation of even 100-200 mL can cause tamponade (acute). Slow accumulation may tolerate > 1L (chronic)</li>
      <li>External pressure compresses the thin-walled chambers first (RA ‚Üí RV) ‚Üí ‚Üì filling ‚Üí ‚Üì stroke volume ‚Üí ‚Üì cardiac output</li>
      <li>Compensatory tachycardia initially maintains CO, then decompensates ‚Üí obstructive shock</li></ul>
      <h3>Beck's Triad (Classic ‚Äî present in only ~30%)</h3>
      <ul><li><strong>1. Hypotension</strong> (‚Üì CO ‚Üí ‚Üì BP) ‚Äî may be absent early</li>
      <li><strong>2. JVD</strong> (‚Üë venous pressure from impaired filling) ‚Äî earliest sign</li>
      <li><strong>3. Muffled/distant heart sounds</strong> (fluid dampens sound transmission)</li></ul>
      <h3>Other Clinical Findings</h3>
      <ul><li><strong>Pulsus paradoxus:</strong> > 10 mmHg drop in SBP during inspiration (exaggeration of normal physiology). Highly sensitive. Measure with BP cuff ‚Äî note pressure at first Korotkoff sound (expiration only) vs. heard throughout respiratory cycle</li>
      <li><strong>Tachycardia:</strong> Compensatory ‚Äî often the first vital sign change</li>
      <li><strong>Electrical alternans on ECG:</strong> Alternating QRS amplitude (heart swinging in fluid). Highly specific but not always present</li>
      <li><strong>Low-voltage QRS:</strong> Fluid dampens electrical signal</li>
      <li><strong>Kussmaul sign:</strong> JVD worsens with inspiration (paradoxical)</li></ul>
      <h3>Causes</h3>
      <ul><li><strong>Trauma:</strong> Penetrating (knife/GSW ‚Äî especially stab wounds to "cardiac box"). Blunt deceleration</li>
      <li><strong>Medical:</strong> Pericarditis, malignancy (lung, breast, lymphoma), uremia (renal failure), post-MI (free wall rupture), post-cardiac surgery, aortic dissection into pericardium</li></ul>
      <h3>Management</h3>
      <ul><li><strong>Prehospital:</strong> Rapid transport. IV fluid bolus (500mL-1L NS) to ‚Üë preload ‚Üí temporarily ‚Üë filling pressures. Avoid vasodilators (NTG, morphine). Monitor for PEA arrest</li>
      <li><strong>Definitive:</strong> Pericardiocentesis (needle aspiration ‚Äî even 20-30mL removal can dramatically improve hemodynamics). Pericardial window (surgical). Thoracotomy if traumatic</li></ul>
      <div class="highlight-box"><p style="margin:0"><strong>EMS Pearl:</strong> In the setting of penetrating trauma to the anterior chest with PEA arrest ‚Üí think tamponade. JVD + hypotension + clear lungs = tamponade until proven otherwise. Fluid bolus is the bridge to the OR.</p></div>`,

    'emerg-dissect': `<h2><span class="gradient">Aortic Dissection</span></h2><p class="modal-sub">Tearing of the aortic wall ‚Äî catastrophic if missed</p>
      <h3>Pathophysiology</h3>
      <ul><li>Tear in the tunica intima allows blood to enter the media ‚Üí creates a false lumen</li>
      <li>The dissection flap can propagate proximally or distally, occluding branch arteries</li>
      <li>Can extend into coronary arteries (‚Üí MI), carotid arteries (‚Üí stroke), renal arteries (‚Üí renal failure), or mesenteric arteries (‚Üí bowel ischemia)</li>
      <li>Risk factors: Hypertension (#1), Marfan syndrome, bicuspid aortic valve, coarctation, cocaine use, pregnancy, connective tissue disorders</li></ul>
      <h3>Stanford Classification</h3>
      <ul><li><strong>Type A (60%):</strong> Involves the ascending aorta (regardless of origin). Surgical emergency. Mortality increases 1-2% per hour without surgery</li>
      <li><strong>Type B (40%):</strong> Involves descending aorta only (distal to left subclavian). Medical management (BP and HR control) unless complicated</li></ul>
      <h3>Clinical Presentation</h3>
      <ul><li><strong>Pain:</strong> Sudden onset, maximum intensity at onset ("worst pain of my life"), "tearing" or "ripping" quality. Anterior chest (Type A), interscapular back (Type B). May migrate as dissection extends</li>
      <li><strong>BP differential:</strong> > 20 mmHg difference between arms (dissection flap compromises subclavian)</li>
      <li><strong>Pulse deficits:</strong> Unequal radial or femoral pulses</li>
      <li><strong>Aortic regurgitation:</strong> New diastolic murmur (Type A ‚Äî extends to aortic root)</li>
      <li><strong>Neurologic deficits:</strong> Stroke symptoms if carotid involved</li>
      <li><strong>Often hypertensive</strong> at presentation (despite looking "shocky")</li></ul>
      <h3>Management</h3>
      <ul><li><strong>Two large-bore IVs</strong> ‚Äî anticipate hemodynamic collapse</li>
      <li><strong>Heart rate control:</strong> Target HR < 60 bpm. Esmolol drip (first-line), labetalol. Beta-blockers BEFORE vasodilators (prevent reflex tachycardia)</li>
      <li><strong>BP control:</strong> Target SBP 100-120 mmHg. Reduces aortic wall shear stress</li>
      <li><strong>Pain control:</strong> Aggressive. Pain drives tachycardia and hypertension</li>
      <li><strong>Do NOT give:</strong> Fibrinolytics, anticoagulants, antiplatelet agents. Can be catastrophic if MI is mimicking dissection</li>
      <li><strong>Transport:</strong> Rapid to facility with cardiothoracic surgery capability</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>Critical Pearl:</strong> Aortic dissection can mimic AMI (if dissection extends into coronary ostia, usually RCA ‚Üí inferior STEMI pattern). If you give tPA for "STEMI" and it's actually a dissection ‚Üí patient dies. Always consider dissection in the differential. Red flags: tearing pain, maximal at onset, BP differential, pulse deficits, wide mediastinum on CXR.</p></div>`,

    'emerg-htn': `<h2><span class="gradient">Hypertensive Crisis</span></h2><p class="modal-sub">When blood pressure becomes immediately life-threatening</p>
      <h3>Hypertensive Urgency</h3>
      <ul><li>SBP > 180 and/or DBP > 120 mmHg <strong>WITHOUT</strong> evidence of end-organ damage</li>
      <li>Patient may be asymptomatic or have headache, anxiety, epistaxis</li>
      <li>Goal: Gradual BP reduction over 24-48 hours with oral medications</li>
      <li>Does NOT require emergency IV medications</li></ul>
      <h3>Hypertensive Emergency</h3>
      <ul><li>SBP > 180 and/or DBP > 120 mmHg <strong>WITH</strong> evidence of acute end-organ damage:</li>
      <li><strong>Brain:</strong> Hypertensive encephalopathy (headache, AMS, seizures, visual changes), ischemic stroke, hemorrhagic stroke</li>
      <li><strong>Heart:</strong> Acute MI, acute heart failure/pulmonary edema, aortic dissection</li>
      <li><strong>Kidneys:</strong> Acute kidney injury (‚Üë creatinine, hematuria, oliguria)</li>
      <li><strong>Eyes:</strong> Papilledema, retinal hemorrhages, hypertensive retinopathy</li>
      <li><strong>Vascular:</strong> Aortic dissection, eclampsia (pregnancy-related)</li></ul>
      <h3>Management Principles</h3>
      <ul><li><strong>Goal:</strong> Reduce MAP by no more than 25% in the first hour, then gradually to 160/100 over next 2-6 hours</li>
      <li><strong>Why controlled reduction?</strong> Chronically hypertensive patients have shifted cerebral autoregulation curve. Rapid drops ‚Üí watershed infarction, stroke, MI</li>
      <li><strong>IV Agents:</strong> Nicardipine drip (5-15 mg/hr), Labetalol (10-20mg IV push, then drip), Nitroprusside (0.25-10 mcg/kg/min ‚Äî ICU only, cyanide toxicity risk), Esmolol (for dissection)</li>
      <li><strong>Special situations:</strong> Eclampsia ‚Üí Magnesium sulfate + Labetalol or Hydralazine. Aortic dissection ‚Üí Esmolol (rate before pressure). Cocaine ‚Üí Benzodiazepines first, NO beta-blockers</li></ul>
      <div class="highlight-box gold"><p style="margin:0"><strong>EMS Pearl:</strong> Don't chase numbers. Look for end-organ damage (AMS, chest pain, dyspnea, focal neuro deficits, visual changes). A patient with SBP 200 but no symptoms is urgency (transport, monitor). SBP 200 with pulmonary edema or stroke symptoms is emergency (treat aggressively en route).</p></div>`,

    'emerg-pe': `<h2><span class="gradient">Pulmonary Embolism</span></h2><p class="modal-sub">Blood clot obstructing pulmonary vasculature ‚Äî a great masquerader</p>
      <h3>Pathophysiology</h3>
      <ul><li>Most commonly from DVT (deep vein thrombosis) in the lower extremities or pelvis</li>
      <li>Clot travels through RV ‚Üí lodges in pulmonary arteries</li>
      <li>Obstruction ‚Üí ‚Üë pulmonary vascular resistance ‚Üí ‚Üë RV afterload ‚Üí RV dilation and failure ‚Üí ‚Üì LV filling ‚Üí ‚Üì CO ‚Üí cardiovascular collapse</li>
      <li><strong>Virchow's Triad:</strong> Stasis (immobilization), Endothelial injury (surgery, trauma), Hypercoagulability (malignancy, OCP, pregnancy, clotting disorders)</li></ul>
      <h3>Clinical Presentation</h3>
      <ul><li><strong>Dyspnea:</strong> Sudden onset, most common symptom (73%). Often out of proportion to exam findings</li>
      <li><strong>Pleuritic chest pain:</strong> Sharp, worsens with breathing (66%)</li>
      <li><strong>Tachycardia and tachypnea:</strong> Often the earliest vital sign changes</li>
      <li><strong>Hypotension:</strong> Indicates massive PE with hemodynamic compromise</li>
      <li><strong>Unilateral leg swelling:</strong> Suggests concurrent DVT (only present in ~30%)</li>
      <li><strong>SpO‚ÇÇ:</strong> May be normal (especially submassive) or significantly low</li>
      <li><strong>Syncope:</strong> Suggests massive PE. Post-syncopal hypotension = ominous</li></ul>
      <h3>ECG Findings</h3>
      <ul><li><strong>S1Q3T3:</strong> Deep S in Lead I, Q wave in III, inverted T in III ‚Äî classic but only present in 20%</li>
      <li><strong>Right heart strain:</strong> Right axis deviation, RBBB (new), T-wave inversions V1-V4</li>
      <li><strong>Sinus tachycardia:</strong> Most common ECG finding (40%)</li>
      <li><strong>A-fib:</strong> New-onset atrial fibrillation from RV dilation</li></ul>
      <h3>Classification & Management</h3>
      <ul><li><strong>Massive PE:</strong> Hypotension (SBP < 90) or cardiac arrest. Mortality > 50%. Treatment: systemic thrombolytics (tPA 100mg IV or tenecteplase), heparin, surgical embolectomy</li>
      <li><strong>Submassive PE:</strong> Normotensive but RV dysfunction on echo. Heparin anticoagulation, consider thrombolytics if deteriorating</li>
      <li><strong>Low-risk PE:</strong> Hemodynamically stable, no RV dysfunction. Anticoagulation (heparin ‚Üí warfarin/DOAC)</li>
      <li><strong>PEA arrest suspected PE:</strong> Push-dose tPA (50mg IV bolus) during CPR. Continue CPR for ‚â• 60-90 minutes after thrombolytics</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>EMS Pearl:</strong> Think PE when: sudden dyspnea + clear lungs + normal CXR + pleuritic chest pain + recent immobilization/surgery/DVT risk. The classic triad (dyspnea, pleuritic pain, hemoptysis) is present in < 20% of cases. High index of suspicion is key.</p></div>`,

    'emerg-pericarditis': `<h2><span class="gradient">Acute Pericarditis</span></h2><p class="modal-sub">Inflammation of the pericardial sac ‚Äî the great STEMI mimic</p>
      <h3>Pathophysiology</h3>
      <ul><li>Inflammation of the visceral and parietal pericardium</li>
      <li><strong>Causes:</strong> Viral (Coxsackie B, Echo ‚Äî most common), bacterial, post-MI (Dressler syndrome 2-10 weeks), uremia (renal failure), autoimmune (lupus, RA), malignancy, post-cardiac surgery, trauma, radiation</li></ul>
      <h3>Clinical Presentation</h3>
      <ul><li><strong>Chest pain:</strong> Sharp, pleuritic (worse with inspiration), positional (worse supine, improved leaning forward). Sudden onset. May radiate to trapezius ridge (unique to pericarditis)</li>
      <li><strong>Pericardial friction rub:</strong> High-pitched scratchy sound. Best heard with diaphragm at LLSB with patient leaning forward. Has up to 3 components (atrial, ventricular systolic, ventricular diastolic). Pathognomonic but evanescent</li>
      <li><strong>Low-grade fever:</strong> Especially viral pericarditis</li>
      <li><strong>Dyspnea:</strong> If significant effusion develops</li></ul>
      <h3>ECG ‚Äî 4 Stages</h3>
      <ul><li><strong>Stage 1 (acute):</strong> Diffuse ST elevation (concave up, "smiley face") in nearly ALL leads (not territory-specific). PR depression (especially in II, aVF, V4-V6). PR elevation in aVR. This is the key differentiator from STEMI</li>
      <li><strong>Stage 2:</strong> ST segments normalize, T waves flatten</li>
      <li><strong>Stage 3:</strong> Diffuse T-wave inversions</li>
      <li><strong>Stage 4:</strong> ECG normalizes</li></ul>
      <h3>Pericarditis vs. STEMI</h3>
      <ul><li><strong>Pericarditis:</strong> Diffuse ST elevation (all leads), concave-up ("smiley"), PR depression, no reciprocal changes, no Q waves</li>
      <li><strong>STEMI:</strong> Focal ST elevation (territory-specific), convex-up ("frowny"/"tombstone"), reciprocal ST depression, Q waves develop</li></ul>
      <div class="highlight-box gold"><p style="margin:0"><strong>Critical Distinction:</strong> If you're unsure whether diffuse ST elevation is pericarditis or STEMI, treat as STEMI and transport to PCI center. Let the cardiologist sort it out. It's safer to cath a pericarditis patient than to miss a STEMI.</p></div>`,

    'emerg-syncope': `<h2><span class="gradient">Cardiac Syncope</span></h2><p class="modal-sub">When the heart causes sudden loss of consciousness ‚Äî highest risk of sudden death</p>
      <h3>Why Cardiac Syncope Matters</h3>
      <ul><li>Cardiac syncope carries 1-year mortality of 18-33% (vs. 0-12% for non-cardiac causes)</li>
      <li>May be the only warning before sudden cardiac death</li>
      <li>Two main mechanisms: structural/obstructive disease or dysrhythmia</li></ul>
      <h3>Dysrhythmic Causes</h3>
      <ul><li><strong>Bradydysrhythmias:</strong> Sick sinus syndrome, high-grade AV blocks (Mobitz II, 3rd degree), pacemaker malfunction</li>
      <li><strong>Tachydysrhythmias:</strong> VT, SVT (if very rapid), Torsades de Pointes, WPW with rapid A-Fib</li>
      <li><strong>Brugada Syndrome:</strong> Coved ST elevation in V1-V3, RBBB pattern. Risk of fatal VF, especially during rest/sleep. Family history of sudden death</li>
      <li><strong>Long QT Syndrome:</strong> QTc > 0.47s. Risk of Torsades de Pointes. Congenital or drug-induced. Triggers: exercise (LQT1), auditory stimuli (LQT2), sleep (LQT3)</li></ul>
      <h3>Structural/Obstructive Causes</h3>
      <ul><li><strong>HOCM (Hypertrophic Obstructive Cardiomyopathy):</strong> #1 cause of sudden cardiac death in young athletes. Thickened septum obstructs LVOT during exertion. Systolic murmur that increases with Valsalva/standing</li>
      <li><strong>Aortic Stenosis:</strong> Fixed obstruction to LV outflow. Exertional syncope. Harsh crescendo-decrescendo systolic murmur</li>
      <li><strong>Massive PE:</strong> Acute RV failure ‚Üí ‚Üì CO ‚Üí syncope</li>
      <li><strong>Cardiac Tamponade:</strong> Impaired filling ‚Üí ‚Üì CO</li>
      <li><strong>Atrial myxoma:</strong> Tumor obstructs mitral valve intermittently (positional symptoms)</li></ul>
      <h3>EMS Assessment</h3>
      <ul><li>12-lead ECG on every syncopal patient ‚Äî look for long QT, Brugada pattern, WPW (delta wave), heart blocks, VT</li>
      <li>Exertional syncope = cardiac until proven otherwise (especially in young athletes)</li>
      <li>Family history of sudden death in young relatives = red flag</li>
      <li>Syncopal episode without prodrome (no lightheadedness, nausea) = likely cardiac</li>
      <li>Monitor continuously during transport ‚Äî may have recurrent episodes</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>High-Risk Features Requiring Immediate Evaluation:</strong> Syncope during exertion, while supine, or without prodrome. Family history of sudden death < 50 years. Known heart disease. Abnormal ECG. New chest pain or dyspnea before event.</p></div>`,
    'resus-cpr': `<h2><span class="gradient">High-Quality CPR</span></h2><div class="formula">Rate: 100-120/min ¬∑ Depth: ‚â• 2 inches ¬∑ Full recoil ¬∑ Minimize interruptions</div>
      <ul><li>Use CPR feedback device</li><li>Avoid excessive ventilation</li><li>Maintain high chest compression fraction (CCF)</li><li>Switch compressors every 2 minutes</li></ul>`,
    'resus-defib': `<h2><span class="gradient">Defibrillation</span></h2><ul><li>Most common initial rhythm in sudden cardiac arrest: <strong>VF</strong></li><li>Most effective treatment: electrical defibrillation</li><li>Probability of success decreases rapidly over time</li><li>VF converts to asystole within minutes</li><li>Biphasic: 120-200J (follow device). Monophasic: 360J.</li></ul>`,
    'resus-cardio': `<h2><span class="gradient">Synchronized Cardioversion</span></h2><ul><li>For unstable tachycardias other than VF and pulseless VT</li><li>Delivers shock ~10ms after peak of R wave</li><li>Avoids vulnerable period (R-on-T phenomenon)</li><li>Initial energies: Narrow regular 50-100J ¬∑ Narrow irregular 120-200J ¬∑ Wide regular 100J ¬∑ Wide irregular = defibrillation</li></ul>`,
    'resus-pea': `<h2><span class="gradient">PEA & Asystole</span></h2><h3>Non-Shockable Rhythms</h3>
      <ul><li><strong>PEA:</strong> Organized electrical activity without a pulse. Search for reversible causes.</li><li><strong>Pseudo-PEA:</strong> PEA with mechanical cardiac activity on ultrasound ‚Äî more amenable to resuscitation.</li><li><strong>Asystole:</strong> No electrical activity. Confirm in 2 leads. Check connections.</li></ul>
      <h3>H's and T's</h3><ul><li><strong>H's:</strong> Hypovolemia, Hypoxia, Hydrogen (acidosis), Hypo/Hyperkalemia, Hypothermia</li><li><strong>T's:</strong> Tension pneumothorax, Tamponade, Toxins, Thrombosis (PE), Thrombosis (MI)</li></ul>`,
    'resus-pit': `<h2><span class="gradient">Pit Crew CPR</span></h2><ul><li>Team-based approach with designated roles</li><li>Compressor, Airway, IV/IO/Meds, Monitor/Defib, Team Leader</li><li>Seamless role rotation every 2 minutes</li><li>Minimize interruptions in compressions</li><li>Real-time quality feedback</li></ul>`,
    'resus-rosc': `<h2><span class="gradient">Post-ROSC Care</span></h2><ul><li>Optimize ventilation and oxygenation (target SpO‚ÇÇ 94-99%)</li><li>12-lead ECG ‚Äî cath lab activation for STEMI</li><li>Targeted temperature management (TTM)</li><li>Hemodynamic support (vasopressors if needed)</li><li>Treat underlying cause</li><li>Rapid transport to appropriate facility</li></ul>`,
    'tl-systematic': `<h2><span class="gradient">Systematic 10-Step 12-Lead Interpretation</span></h2><p class="modal-sub">Always use the same systematic approach every time ‚Äî missing findings kills patients.</p><h3>Step 1 ‚Äî Confirm Patient &amp; Technical Quality</h3><p>Verify correct patient, date/time, proper lead placement. Check for artifact, wandering baseline, 60-Hz interference.</p><h3>Step 2 ‚Äî Rate</h3><p><strong>Regular rhythm:</strong> 300 √∑ (# large boxes between R-R). Memorize: 300, 150, 100, 75, 60, 50.<br><strong>Irregular rhythm:</strong> Count QRS in 6 seconds √ó 10.</p><h3>Step 3 ‚Äî Rhythm</h3><p>Regular vs. irregular? Regularly irregular (Wenckebach) vs. irregularly irregular (A-Fib)? P waves present/upright in II = sinus. 1:1 P:QRS relationship?</p><h3>Step 4 ‚Äî Axis</h3><p><strong>Quick method:</strong> Lead I + aVF. Both ‚Üë = Normal. I‚Üë aVF‚Üì = LAD. I‚Üì aVF‚Üë = RAD. Both ‚Üì = Extreme.<br>LAD causes: LAFB, LVH, inferior MI, LBBB. RAD causes: RVH, LPFB, PE, COPD.</p><h3>Step 5 ‚Äî P Waves</h3><p>Peaked &gt;2.5mm in II = RAE (P pulmonale). Broad &gt;0.12s or notched = LAE (P mitrale). Biphasic in V1 with deep terminal negative = LAE.</p><h3>Step 6 ‚Äî PR Interval</h3><p>Normal 0.12‚Äì0.20s. Short &lt;0.12s: WPW, junctional. Long &gt;0.20s: 1¬∞ AV block. Variable: 2¬∞ blocks.</p><h3>Step 7 ‚Äî QRS Complex</h3><p>Normal &lt;0.12s. Wide ‚â•0.12s ‚Üí BBB, ventricular origin, hyperkalemia, WPW. RBBB = RSR' in V1. LBBB = broad notched R in V5-V6. Q waves &gt;0.04s or &gt;‚ÖìR = old MI.</p><h3>Step 8 ‚Äî ST Segment</h3><p><strong>Elevation:</strong> STEMI (convex), pericarditis (concave), BER (concave + J-notch), LVH strain, Brugada.<br><strong>Depression:</strong> Ischemia, reciprocal, digoxin, posterior MI mirror, hypokalemia.</p><h3>Step 9 ‚Äî T Waves</h3><p>Normal: upright I, II, V3-V6. Inverted aVR always. Deep symmetric inversions ‚Üí ischemia (Wellens). Hyperacute tall broad ‚Üí earliest MI sign. Peaked symmetric ‚Üí hyperkalemia.</p><h3>Step 10 ‚Äî QT Interval</h3><p>QTc = QT / ‚àö(R-R). Normal &lt;0.44s men, &lt;0.46s women. Prolonged ‚Üí Torsades risk.</p><h3>Clinical Integration</h3><p>Correlate with clinical picture. Compare with prior ECGs. Normal ECG does NOT rule out ACS. Serial ECGs every 15 min in suspected ACS.</p>`,
    'tl-leads': `<h2><span class="gradient">Lead Placement &amp; Cardiac Views</span></h2><p class="modal-sub">What each lead "sees" ‚Äî understanding the heart's electrical perspectives</p><h3>Limb Leads (Frontal Plane)</h3><p><strong>Lead I:</strong> RA(‚àí) to LA(+), axis 0¬∞. <strong>Lead II:</strong> RA(‚àí) to LL(+), axis +60¬∞ ‚Äî best for P waves. <strong>Lead III:</strong> LA(‚àí) to LL(+), axis +120¬∞.</p><h3>Augmented Leads</h3><p><strong>aVR:</strong> ‚àí150¬∞, normally all negative. Elevation ‚Üí left main/3-vessel disease. <strong>aVL:</strong> ‚àí30¬∞, high lateral view. <strong>aVF:</strong> +90¬∞, inferior view.</p><h3>Precordial Leads (Horizontal Plane)</h3><p><strong>V1:</strong> 4th ICS, R sternal border (RV/septum). <strong>V2:</strong> 4th ICS, L sternal border. <strong>V3:</strong> Between V2-V4. <strong>V4:</strong> 5th ICS, midclavicular (transition zone). <strong>V5:</strong> 5th ICS, anterior axillary. <strong>V6:</strong> 5th ICS, midaxillary.</p><h3>Territory Mapping</h3><p><strong>Septal:</strong> V1-V2. <strong>Anterior:</strong> V3-V4 (LAD). <strong>Lateral:</strong> I, aVL, V5-V6 (LCx). <strong>Inferior:</strong> II, III, aVF (RCA 85%). <strong>Posterior:</strong> V7-V9. <strong>RV:</strong> V4R.</p><h3>R-Wave Progression</h3><p>R wave grows V1‚ÜíV6, S wave shrinks. Transition (R=S) at V3-V4. Poor progression: anterior MI, LBBB, COPD. Early transition (tall R by V2): RVH, posterior MI, WPW.</p><h3>Additional Leads</h3><p><strong>Right-sided (V4R):</strong> Obtain with every inferior STEMI. ‚â•1mm STE = RV infarct ‚Üí NO NTG, give fluids.<br><strong>Posterior (V7-V9):</strong> Obtain when V1-V3 depression. STE ‚â•0.5mm = posterior STEMI.</p>`,
    'tl-axis': `<h2><span class="gradient">Cardiac Axis Deviation</span></h2><p class="modal-sub">The average direction of ventricular depolarization in the frontal plane</p><h3>The Hexaxial Reference System</h3><p>6 frontal leads divide the plane into 30¬∞ segments: I=0¬∞, II=+60¬∞, III=+120¬∞, aVR=‚àí150¬∞, aVL=‚àí30¬∞, aVF=+90¬∞.</p><h3>Quick 2-Lead Method</h3><p>‚úÖ <strong>Normal (‚àí30¬∞ to +90¬∞):</strong> I‚Üë and aVF‚Üë.<br>‚¨ÖÔ∏è <strong>LAD (‚àí30¬∞ to ‚àí90¬∞):</strong> I‚Üë and aVF‚Üì.<br>‚û°Ô∏è <strong>RAD (+90¬∞ to +180¬∞):</strong> I‚Üì and aVF‚Üë.<br>‚ò†Ô∏è <strong>Extreme (‚àí90¬∞ to ¬±180¬∞):</strong> I‚Üì and aVF‚Üì ‚Äî always pathological.</p><h3>Left Axis Deviation Causes</h3><p><strong>LAFB</strong> (most common) ‚Äî thin fascicle, single blood supply. Also: LVH, inferior MI, LBBB, WPW, pregnancy/obesity.</p><h3>Right Axis Deviation Causes</h3><p><strong>RVH, PE, COPD</strong>/cor pulmonale, lateral MI, <strong>LPFB</strong> (diagnosis of exclusion). Normal in children/young adults.</p><h3>Extreme Axis</h3><p>VT, ventricular paced, severe hyperkalemia, lead reversal (always check!).</p><h3>Fascicular Blocks</h3><p><strong>LAFB + RBBB = Bifascicular block.</strong> If PR also prolonged ‚Üí "trifascicular pattern" ‚Üí high risk for complete block.<br><strong>LPFB + RBBB</strong> = less common, higher risk (LPFB harder to injure ‚Üí extensive disease).</p>`,
    'tl-intervals': `<h2><span class="gradient">Intervals &amp; Segments</span></h2><p class="modal-sub">Timing is everything ‚Äî milliseconds separate normal from lethal</p><h3>PR Interval (0.12‚Äì0.20s)</h3><p><strong>Prolonged &gt;0.20s:</strong> 1¬∞ AV block, drugs (Œ≤-blockers, CCBs, digoxin), inferior MI.<br><strong>Short &lt;0.12s:</strong> WPW (+delta wave), junctional rhythm.<br><strong>Variable:</strong> 2¬∞ AV blocks, WAP.</p><h3>QRS Duration (&lt;0.12s)</h3><p><strong>Wide ‚â•0.12s:</strong> BBB, ventricular origin, WPW, hyperkalemia, drug toxicity (TCAs, cocaine).<br><strong>Borderline 0.10-0.12s:</strong> Incomplete BBB, hemiblocks, IVCD.</p><h3>QT Interval (QTc &lt;0.44s men / &lt;0.46s women)</h3><p><strong>Quick check:</strong> QT &lt; half R-R = likely normal. <strong>Bazett:</strong> QTc = QT/‚àöRR.<br><strong>Prolonged &gt;0.50s:</strong> High risk TdP. Causes: Class IA/III drugs, antipsychotics, macrolides, fluoroquinolones, methadone, ‚ÜìK‚Å∫, ‚ÜìMg¬≤‚Å∫, ‚ÜìCa¬≤‚Å∫, congenital LQTS.<br><strong>Short &lt;0.36s:</strong> Hypercalcemia, digoxin.</p><h3>ST Segment</h3><p>Measured from J-point (QRS end) to T wave start. Should be isoelectric. Use TP segment as true baseline. J-point elevation/depression defines STEMI criteria.</p><h3>U Wave</h3><p>After T wave, same direction. Prominent U waves: <strong>hypokalemia</strong> (classic), bradycardia, LVH. Inverted U: ischemia.</p>`,
    'tl-rbbb': `<h2><span class="gradient">Right Bundle Branch Block</span></h2><p class="modal-sub">MaRRoW ‚Äî the mnemonic that saves lives</p><h3>Pathophysiology</h3><p>RBB blocked ‚Üí LV depolarizes first (normal) ‚Üí impulse crosses septum slowly ‚Üí RV depolarizes late ‚Üí terminal R' in V1.</p><h3>ECG Criteria ‚Äî "MaRRoW"</h3><p><strong>M</strong>-shaped RSR' in <strong>R</strong>ight leads (V1-V2). "Rabbit ears."<br><strong>W</strong>ide slurred S in lateral leads (I, aVL, V5-V6).<br>QRS ‚â•0.12s (complete). 0.10-0.12s = incomplete RBBB.<br>Secondary ST-T changes in V1-V3 = expected, NOT ischemia.</p><h3>Clinical Significance</h3><p><strong>Can be normal</strong> in healthy people. Pathological: RV strain, PE, ASD, anterior MI, myocarditis.<br><strong>RBBB + LAFB = Bifascicular block.</strong> + Prolonged PR ‚Üí trifascicular pattern ‚Üí risk of complete block.</p><h3>MI Interpretation</h3><p>Unlike LBBB, STEMI can usually be diagnosed with RBBB ‚Äî initial depolarization is normal. ST changes in limb leads remain interpretable.</p>`,
    'tl-lbbb': `<h2><span class="gradient">Left Bundle Branch Block</span></h2><p class="modal-sub">WiLLiaM ‚Äî always pathological, always significant</p><h3>Pathophysiology</h3><p>LBB blocked ‚Üí RV depolarizes first ‚Üí impulse crosses septum slowly ‚Üí LV depolarizes late ‚Üí massive leftward vector ‚Üí broad notched R laterally.</p><h3>ECG Criteria ‚Äî "WiLLiaM"</h3><p><strong>W</strong>-pattern in V1 (deep broad QS or rS).<br><strong>M</strong>-pattern (broad notched R) in <strong>L</strong>ateral leads (I, aVL, V5-V6).<br>QRS ‚â•0.12s. No septal Q in I/V5-V6. ST-T discordant = expected.</p><h3>Always Pathological</h3><p>HTN heart disease (most common), ischemic/dilated cardiomyopathy, aortic valve disease, myocarditis.<br><strong>New LBBB + ACS symptoms = STEMI equivalent ‚Üí activate cath lab.</strong></p><h3>Sgarbossa Criteria ‚Äî Finding MI in LBBB</h3><p><strong>Concordant STE ‚â•1mm</strong> (5 pts, most specific).<br><strong>Concordant STD ‚â•1mm in V1-V3</strong> (3 pts).<br><strong>Discordant STE ‚â•5mm</strong> (2 pts). Modified Smith: STE/S &gt; 0.25.<br>Score ‚â•3 = acute MI in LBBB.</p>`,
    'tl-lvh': `<h2><span class="gradient">Left Ventricular Hypertrophy</span></h2><p class="modal-sub">High voltage + strain pattern = chronic pressure or volume overload</p><h3>Voltage Criteria</h3><p><strong>Sokolow-Lyon:</strong> S(V1) + R(V5 or V6) ‚â• 35mm. Simple, widely used.<br><strong>Cornell:</strong> R(aVL) + S(V3) &gt; 28mm (men) / &gt; 20mm (women).<br><strong>aVL alone:</strong> R &gt; 11mm. Quick screen.<br>Sensitivity only 20-50%. Echo = gold standard.</p><h3>LV Strain Pattern</h3><p>Downsloping ST depression + asymmetric T inversion in lateral leads (I, aVL, V5-V6). ST-T bows upward (convex) ‚Üí inverted T. This is repolarization abnormality, not ischemia (but ischemia can coexist).</p><h3>Associated Findings</h3><p>LAD, LAE (P mitrale), increased QRS duration (&lt;0.12s unless LBBB). Prominent U waves.</p><h3>Clinical Significance</h3><p>Independent risk factor for SCD, heart failure, stroke. Most common cause: chronic HTN. Strain pattern = worse prognosis than voltage alone.</p>`,
    'tl-rvh': `<h2><span class="gradient">Right Ventricular Hypertrophy</span></h2><p class="modal-sub">When the right side dominates ‚Äî pulmonary hypertension, cor pulmonale</p><h3>ECG Criteria</h3><p><strong>Tall R in V1:</strong> R &gt; S (R/S ratio &gt; 1) ‚Äî hallmark. <strong>RAD &gt; +100¬∞.</strong><br><strong>RV strain:</strong> ST depression + T inversion V1-V3.<br><strong>RAE:</strong> Peaked P &gt; 2.5mm in II (P pulmonale). Deep persistent S in V5-V6.</p><h3>Differential for Tall R in V1</h3><p>RBBB (RSR'), posterior MI (mirror of post Q), WPW (delta wave), HCM (septal hypertrophy), normal variant.</p><h3>Causes</h3><p><strong>Chronic:</strong> Pulmonary HTN, COPD/cor pulmonale, mitral stenosis, congenital heart disease.<br><strong>Acute:</strong> Massive PE (RV dilation + strain pattern).</p>`,
    'tl-wpw': `<h2><span class="gradient">WPW Syndrome</span></h2><p class="modal-sub">Accessory pathway ‚Äî delta wave, short PR, wide QRS. Fatal A-Fib risk.</p><h3>Classic ECG Triad</h3><p><strong>1. Short PR &lt;0.12s</strong> ‚Äî bypasses AV nodal delay.<br><strong>2. Delta wave</strong> ‚Äî slurred QRS upstroke (slow myocyte-to-myocyte conduction).<br><strong>3. Wide QRS &gt;0.10s</strong> ‚Äî delta wave adds time to QRS onset.</p><h3>Types</h3><p><strong>Type A</strong> (left pathway): Positive delta + tall R in V1 (mimics RBBB/RVH).<br><strong>Type B</strong> (right pathway): Negative delta in V1 (mimics LBBB).</p><h3>‚ò†Ô∏è WPW + Atrial Fibrillation</h3><p>Accessory pathway has NO rate-limiting ‚Üí conducts 300+ bpm ‚Üí extremely rapid irregular wide-complex tachycardia ‚Üí VF ‚Üí death.<br><strong>DO NOT give AV nodal blockers</strong> (adenosine, Œ≤-blockers, CCBs, digoxin) ‚Üí forces ALL conduction down pathway ‚Üí death.<br><strong>Treatment:</strong> Stable: procainamide/ibutilide. Unstable: cardioversion. Definitive: catheter ablation.</p><h3>AVRT Types</h3><p><strong>Orthodromic (95%):</strong> Down AV node ‚Üí up pathway. Narrow QRS. Delta disappears.<br><strong>Antidromic (5%):</strong> Down pathway ‚Üí up AV node. Wide QRS. Looks like VT.</p>`,
    'tl-brugada': `<h2><span class="gradient">Brugada Syndrome</span></h2><p class="modal-sub">Coved ST in V1-V3 ‚Äî genetic channelopathy causing sudden death at rest</p><h3>Type 1 (Diagnostic)</h3><p>Coved ST elevation ‚â•2mm in V1-V3 + negative T wave. Downsloping pattern. Only Type 1 is diagnostic.</p><h3>Type 2 (Saddleback)</h3><p>Saddleback ST, J-point ‚â•2mm, positive/biphasic T. Not diagnostic alone ‚Üí provocative testing needed.</p><h3>Clinical Features</h3><p>8-10√ó more common in men. Southeast Asian prevalence. Average sudden death age: 41.<br><strong>Triggers:</strong> Rest/sleep, fever (ALWAYS get ECG), large meals, alcohol, cocaine.<br>Presentation: nocturnal syncope, cardiac arrest, family hx sudden death.</p><h3>Management</h3><p><strong>ICD</strong> = only proven prevention of sudden death. Quinidine for electrical storms. Isoproterenol for acute VT storm.<br><strong>Avoid:</strong> Class IC drugs, Œ≤-blockers, TCAs, lithium, fever.</p>`,
    'tl-longqt': `<h2><span class="gradient">Long QT Syndrome</span></h2><p class="modal-sub">Prolonged repolarization ‚Üí Torsades de Pointes ‚Üí VF ‚Üí sudden death</p><h3>QTc Thresholds</h3><p>Normal: &lt;0.44s (M) / &lt;0.46s (F). Prolonged: &gt;0.46s/0.48s. High risk: &gt;0.50s. Critical: &gt;0.60s.</p><h3>Congenital LQTS</h3><p><strong>LQT1</strong> (KCNQ1, 40-55%): Exercise trigger (swimming). Broad T. Œ≤-blockers effective.<br><strong>LQT2</strong> (HERG, 30-45%): Auditory/emotional triggers. Notched T. Œ≤-blockers partial.<br><strong>LQT3</strong> (SCN5A, 5-10%): Rest/sleep trigger. Late peaked T. Most lethal per event. Mexiletine may help.</p><h3>Acquired LQTS (Most Common Overall)</h3><p><strong>Drugs:</strong> Class IA/III antiarrhythmics, sotalol, haloperidol, fluoroquinolones, macrolides, methadone, TCAs, ondansetron.<br><strong>Electrolytes:</strong> ‚ÜìK‚Å∫, ‚ÜìMg¬≤‚Å∫, ‚ÜìCa¬≤‚Å∫.</p><h3>Torsades Treatment</h3><p><strong>Magnesium 1-2g IV</strong> (first-line). Overdrive pacing. Isoproterenol. Remove cause.<br><strong>AVOID amiodarone</strong> ‚Äî prolongs QT further.</p>`,
    'tl-stpatterns': `<h2><span class="gradient">ST Segment Patterns</span></h2><p class="modal-sub">Where you find the emergencies ‚Äî elevation and depression differentials</p><h3>ST Elevation Differential</h3><p><strong>1. STEMI:</strong> Convex ("tombstone"). Territorial. Reciprocal depression. Evolves ‚Üí Q waves.<br><strong>2. Pericarditis:</strong> Concave ("smiley"). Diffuse. PR depression. No reciprocal. No Q waves.<br><strong>3. BER:</strong> Concave + J-notch. V2-V5. Tall T waves. No reciprocal. Stable.<br><strong>4. LVH strain:</strong> STE in V1-V3 (where QRS negative). High voltage.<br><strong>5. Brugada:</strong> Coved STE V1-V3 with RBBB morphology.<br><strong>6. LV Aneurysm:</strong> Persistent STE weeks post-MI + Q waves.</p><h3>ST Depression Patterns</h3><p><strong>1. Subendocardial ischemia:</strong> Horizontal/downsloping ‚â•0.5mm. Most specific.<br><strong>2. Reciprocal:</strong> Opposite STEMI territory. Confirms diagnosis.<br><strong>3. Digoxin effect:</strong> "Salvador Dali mustache" scooped depression.<br><strong>4. Posterior MI:</strong> Depression V1-V3 + tall R + upright T = mirror image.<br><strong>5. Hypokalemia:</strong> Depression + flat T + U waves.<br><strong>6. Rate-related:</strong> Upsloping during tachy, normalizes with rate control.</p>`,
    'tl-peri-vs-stemi': `<h2><span class="gradient">Pericarditis vs. STEMI</span></h2><p class="modal-sub">The critical differential ‚Äî misdiagnosis in either direction can be fatal</p><h3>ST Morphology</h3><p><strong>Pericarditis:</strong> Concave up ("smiley ‚å£").<br><strong>STEMI:</strong> Convex up ("frowny ‚å¢") or "tombstone."</p><h3>Distribution</h3><p><strong>Pericarditis:</strong> DIFFUSE ‚Äî nearly all leads.<br><strong>STEMI:</strong> TERRITORIAL ‚Äî contiguous lead groups only.</p><h3>Reciprocal Changes</h3><p><strong>Pericarditis:</strong> NONE (except aVR). <strong>Strongest differentiator.</strong><br><strong>STEMI:</strong> Present in opposite leads.</p><h3>PR Segment</h3><p><strong>Pericarditis:</strong> PR DEPRESSION (specific). PR elevation in aVR.<br><strong>STEMI:</strong> PR usually normal.</p><h3>Q Waves</h3><p><strong>Pericarditis:</strong> Never develops Q waves.<br><strong>STEMI:</strong> Q waves develop over hours-days.</p><h3>Clinical Clues</h3><p><strong>Pericarditis:</strong> Sharp/pleuritic, positional (worse flat, better leaning forward), friction rub, young + viral illness, trapezius radiation.<br><strong>STEMI:</strong> Crushing/pressure, not positional, arm/jaw radiation, diaphoresis, risk factors.</p><h3>The Golden Rule</h3><div class="highlight-box red"><p style="margin:0"><strong>If you cannot tell the difference, treat as STEMI.</strong> Safer to cath a pericarditis patient than to miss a STEMI.</p></div><p><strong>Spodick's Sign:</strong> TP segment downsloping in pericarditis (~80%). Another differentiating tool.</p>`,
    'tl-electrolytes': `<h2><span class="gradient">Electrolyte Effects on ECG</span></h2><p class="modal-sub">Potassium, calcium, magnesium ‚Äî ECG manifestations and emergent treatment</p><h3>Hyperkalemia (K‚Å∫ &gt; 5.5) ‚Äî Life-Threatening</h3><p><strong>Mild (5.5-6.5):</strong> Tall peaked T waves (earliest sign). Shortened QT.<br><strong>Moderate (6.5-7.5):</strong> Absent P waves, prolonged PR, QRS widening.<br><strong>Severe (7.5-8.5):</strong> Markedly wide QRS, bizarre morphology mimicking VT.<br><strong>Critical (&gt;8.5):</strong> Sine wave ‚Üí VF ‚Üí asystole ‚Üí death.</p><p><strong>Treatment:</strong> 1) Ca gluconate (stabilize membrane, 1-3 min). 2) Insulin 10U + D50 (shift K in, 15-30 min). 3) NaHCO3 (shift). 4) Albuterol neb (shift). 5) Kayexalate (remove). 6) Hemodialysis (definitive).</p><h3>Hypokalemia (K‚Å∫ &lt; 3.5)</h3><p>Flat T ‚Üí ST depression ‚Üí Prominent U waves (hallmark) ‚Üí T-U fusion (mimics long QT) ‚Üí PVCs, VT, TdP.<br>KCl replacement IV max 10-20 mEq/hr. Always replace Mg simultaneously.</p><h3>Hypercalcemia</h3><p>Shortened QT (ST obliterated). Severe: Osborn waves, wide QRS, heart block, arrest.</p><h3>Hypocalcemia</h3><p>Prolonged QT (elongated ST segment, normal T morphology). TdP risk.</p><h3>Hypomagnesemia</h3><p>Subtle: prolonged PR/QT, flat T, U waves. Clinically: causes refractory hypoK and TdP.<br><strong>Always replace Mg in TdP and refractory hypokalemia.</strong></p>`,
  };
  return M[id] || `<h2>Content</h2><p>Detailed content for this topic.</p>`;
}

// ================================================================
// TABS
// ================================================================
function showTab(tabId, btn) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  if (btn) btn.classList.add('active');
}

// ================================================================
// HEART INTERACTIVITY
// ================================================================
document.querySelectorAll('.heart-chamber').forEach(el => {
  el.addEventListener('click', () => {
    const target = el.dataset.chamber;
    document.querySelectorAll('.info-item').forEach(i => i.classList.remove('active'));
    const item = document.querySelector(`.info-item[data-target="${target}"]`);
    if (item) { item.classList.add('active'); item.scrollIntoView({behavior:'smooth',block:'nearest'}); }
  });
});
document.querySelectorAll('.info-item').forEach(el => {
  el.addEventListener('click', () => {
    document.querySelectorAll('.info-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
  });
});

// ================================================================
// SCROLL & NAV
// ================================================================
const observer = new IntersectionObserver(entries => {
  entries.forEach(e => { if(e.isIntersecting) e.target.classList.add('visible'); });
}, {threshold:0.08});
document.querySelectorAll('section, .fade-up').forEach(el => observer.observe(el));

window.addEventListener('scroll', () => {
  const scrolled = window.scrollY / (document.documentElement.scrollHeight - window.innerHeight);
  document.getElementById('progressBar').style.width = (scrolled*100)+'%';
  const sections = document.querySelectorAll('section[id]');
  let current = '';
  sections.forEach(s => { if(window.scrollY >= s.offsetTop - 200) current = s.id; });
  document.querySelectorAll('.nav-link').forEach(l => {
    l.classList.toggle('active', l.getAttribute('href') === '#'+current);
  });
});

// ================================================================
// HERO ECG
// ================================================================
function drawHeroEcg() {
  const canvas = document.getElementById('heroEcgCanvas');
  if (!canvas) return;
  canvas.width = canvas.parentElement.clientWidth;
  canvas.height = 100;
  const ctx = canvas.getContext('2d');
  drawECGPaper(ctx, canvas.width, canvas.height);
  const w=canvas.width, h=canvas.height, mid=h*0.5, amp=h*0.35;
  const pxPerSec = w / 6;
  const period = pxPerSec * (60 / 72); // 72 bpm NSR
  ctx.beginPath();
  ctx.strokeStyle = '#00E676';
  ctx.lineWidth = 2;
  ctx.lineJoin = 'round';
  for (let px=0;px<w;px++) {
    const t = (px%period)/period;
    const y = waveNSR(t);
    const py = mid - y*amp;
    if(px===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  }
  ctx.stroke();
}

// ================================================================
// COMPREHENSIVE ASSESSMENT ‚Äî 100 Questions, 6 Types
// ================================================================
// ================================================================
// COMPREHENSIVE ASSESSMENT ‚Äî 100 Questions, 6 Types
// Types: mc (multiple choice), multi (select all), fill (fill-in),
//        match (matching), order (sequence), nested (multi-part)
// ================================================================
const quizQuestions = [
// ‚îÄ‚îÄ SA NODE & SINUS RHYTHMS (1-10) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{ id:1, type:'mc', q:'What is the intrinsic firing rate of the SA node?', sub:'Primary cardiac pacemaker.',
  options:['20‚Äì40 bpm','40‚Äì60 bpm','60‚Äì100 bpm','100‚Äì150 bpm'], answer:2,
  explain:'SA node fires at 60-100 bpm. AV junction backup: 40-60. Ventricular escape: 20-40.' },

{ id:2, type:'mc', q:'Identify this rhythm:', sub:'Analyze rate, regularity, and P waves.', rhythm:'sbrad',
  options:['Junctional Rhythm','Sinus Bradycardia','Third-Degree Block','Idioventricular Rhythm'], answer:1,
  explain:'Regular rhythm with upright P waves before each QRS, rate < 60 bpm = Sinus Bradycardia.' },

{ id:3, type:'fill', q:'The normal PR interval range is _____ to _____ seconds.', sub:'Measured from P wave onset to QRS onset.',
  answer:'0.12-0.20', accept:['0.12-0.20','0.12 to 0.20','.12-.20','.12 to .20','0.12-0.2','0.12 - 0.20'],
  explain:'Normal PR: 0.12‚Äì0.20s. Prolonged (>0.20s) = 1¬∞ AV block. Short (<0.12s) = WPW or junctional.' },

{ id:4, type:'mc', q:'Identify this rhythm:', sub:'Note the R-R interval variation.', rhythm:'sinus_arr',
  options:['Atrial Fibrillation','Wandering Atrial Pacemaker','Sinus Arrhythmia','Multifocal Atrial Tachycardia'], answer:2,
  explain:'Normal P waves, normal PR, but R-R varies cyclically with respiration. Common in young adults ‚Äî benign.' },

{ id:5, type:'multi', q:'Which of the following are causes of sinus bradycardia? (Select ALL that apply)', sub:'',
  options:['Inferior MI','Hypoxia','Increased vagal tone','Beta-blocker use','Hypovolemia','Athletic conditioning'],
  answer:[0,2,3,5],
  explain:'Inferior MI (vagal), increased vagal tone, beta-blockers, and athletic training all cause sinus bradycardia. Hypoxia and hypovolemia typically cause tachycardia.' },

{ id:6, type:'fill', q:'Normal QRS duration is less than _____ seconds.', sub:'Measured from Q wave onset to S wave termination.',
  answer:'0.12', accept:['0.12','.12','0.12s','.12s','0.12 seconds'],
  explain:'Normal QRS < 0.12s. Wide QRS ‚â• 0.12s indicates ventricular origin or bundle branch block.' },

{ id:7, type:'mc', q:'Identify this rhythm:', sub:'Sudden cessation of electrical activity from SA node.', rhythm:'sinus_arrest',
  options:['Sinus Bradycardia','Sinus Arrhythmia','Sinus Arrest / Pause','Second-Degree AV Block'], answer:2,
  explain:'Normal sinus rhythm interrupted by sudden flat-line pause. SA node fails to fire. Underlying rhythm resumes.' },

{ id:8, type:'order', q:'Place the cardiac pacemaker sites in order from FASTEST to SLOWEST intrinsic rate:', sub:'Pacemaker hierarchy.',
  items:['SA Node (60-100)','AV Junction (40-60)','Bundle of His (20-40)','Purkinje Fibers (15-40)'],
  answer:[0,1,2,3],
  explain:'Overdrive suppression: fastest pacemaker controls the heart. SA node ‚Üí AV junction ‚Üí His/Purkinje.' },

{ id:9, type:'mc', q:'Which electrolyte imbalance produces tall, peaked T waves on ECG?', sub:'Life-threatening emergency.',
  options:['Hypokalemia','Hyperkalemia','Hypocalcemia','Hypomagnesemia'], answer:1,
  explain:'Hyperkalemia ‚Üí tall peaked T waves ‚Üí widened QRS ‚Üí sine wave ‚Üí asystole. Treat with calcium gluconate.' },

{ id:10, type:'fill', q:'The normal QT interval corrected for heart rate (QTc) should be less than _____ seconds.', sub:'Prolonged QTc risks Torsades de Pointes.',
  answer:'0.44', accept:['0.44','.44','0.44s','0.440','0.45','.45','0.46','.46'],
  explain:'QTc > 0.44-0.46s is prolonged. Risk increases for Torsades de Pointes. Causes: drugs, electrolytes, congenital.' },

// ‚îÄ‚îÄ ATRIAL RHYTHMS (11-20) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{ id:11, type:'mc', q:'Identify this rhythm:', sub:'Irregularly irregular with no discernible P waves.', rhythm:'afib',
  options:['Sinus Arrhythmia','Atrial Flutter','Atrial Fibrillation','Multifocal Atrial Tachycardia'], answer:2,
  explain:'Irregularly irregular rhythm, fibrillatory baseline, no organized P waves = A-Fib. Most common sustained dysrhythmia.' },

{ id:12, type:'mc', q:'Identify this rhythm:', sub:'Note the sawtooth baseline pattern.', rhythm:'aflutter',
  options:['Atrial Fibrillation','SVT','Atrial Flutter','Sinus Tachycardia'], answer:2,
  explain:'Sawtooth flutter waves at ~300/min, typically 2:1 block ‚Üí ventricular rate ~150 bpm.' },

{ id:13, type:'multi', q:'Which are complications of uncontrolled atrial fibrillation? (Select ALL)', sub:'',
  options:['Stroke from atrial thrombus','Decreased cardiac output','Tachycardia-induced cardiomyopathy','Increased ejection fraction','Heart failure'],
  answer:[0,1,2,4],
  explain:'A-Fib ‚Üí stasis in atria ‚Üí clot ‚Üí stroke. Loss of atrial kick ‚ÜìCO by 20-30%. Persistent rapid rate ‚Üí cardiomyopathy and CHF.' },

{ id:14, type:'mc', q:'First-line treatment for stable SVT after failed vagal maneuvers:', sub:'Rapid IV push required.',
  options:['Amiodarone 150mg IV','Adenosine 6mg rapid IVP','Verapamil 5mg slow IVP','Lidocaine 1mg/kg IV'], answer:1,
  explain:'Adenosine 6mg rapid IVP ‚Üí 12mg ‚Üí 12mg. Must be given as rapid push followed by saline flush due to 6-second half-life.' },

{ id:15, type:'fill', q:'The classic atrial flutter rate is approximately _____ beats per minute.', sub:'Before AV conduction ratio.',
  answer:'300', accept:['300','~300','300 bpm','approximately 300'],
  explain:'Atrial flutter: atrial rate ~300/min. With typical 2:1 block ‚Üí ventricular rate ~150. Suspect flutter when rate ‚âà150.' },

{ id:16, type:'mc', q:'Identify this rhythm:', sub:'Multiple P-wave morphologies, irregular rhythm.', rhythm:'wap',
  options:['Multifocal Atrial Tachycardia','Wandering Atrial Pacemaker','Atrial Fibrillation','Sinus Arrhythmia'], answer:1,
  explain:'‚â•3 different P wave morphologies, rate ‚â§ 100 = WAP. If rate > 100 with same findings = MAT.' },

{ id:17, type:'match', q:'Match each rhythm to its defining characteristic:', sub:'',
  pairs:[
    ['Atrial Fibrillation','Irregularly irregular, no P waves'],
    ['Atrial Flutter','Sawtooth pattern ~300/min'],
    ['SVT (AVNRT)','Regular, rate 150-250, no visible P waves'],
    ['WAP','‚â•3 P morphologies, rate ‚â§ 100']
  ],
  explain:'Each atrial rhythm has distinctive features enabling rapid identification.' },

{ id:18, type:'mc', q:'Identify this rhythm:', sub:'Rate 150-250, regular, narrow QRS, abrupt onset.', rhythm:'svt',
  options:['Sinus Tachycardia','Atrial Fibrillation','SVT (AVNRT/PSVT)','Ventricular Tachycardia'], answer:2,
  explain:'Regular narrow-complex tachycardia 150-250, P waves hidden in QRS, abrupt onset/offset = SVT.' },

{ id:19, type:'multi', q:'Vagal maneuvers for SVT include which of the following? (Select ALL)', sub:'',
  options:['Valsalva maneuver','Carotid sinus massage','Applying ice to face (diving reflex)','Precordial thump','Bearing down'],
  answer:[0,1,2,4],
  explain:'Valsalva, carotid massage, diving reflex (ice to face), and bearing down all increase vagal tone. Precordial thump is not a vagal maneuver.' },

{ id:20, type:'mc', q:'Identify this rhythm:', sub:'Multiple P-wave morphologies with irregular rate > 100.', rhythm:'mat',
  options:['Atrial Fibrillation','Sinus Tachycardia','Multifocal Atrial Tachycardia','Atrial Flutter'], answer:2,
  explain:'‚â•3 different P wave morphologies, rate > 100, irregular = MAT. Common in COPD and critically ill patients.' },

// ‚îÄ‚îÄ JUNCTIONAL RHYTHMS (21-25) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{ id:21, type:'mc', q:'Identify this rhythm:', sub:'Narrow QRS, rate 40-60, absent or inverted P waves.', rhythm:'junctional',
  options:['Sinus Bradycardia','Junctional Escape Rhythm','Idioventricular Rhythm','First-Degree AV Block'], answer:1,
  explain:'AV junction takes over as pacemaker. Rate 40-60, narrow QRS, P waves absent, inverted before/after QRS, or hidden.' },

{ id:22, type:'fill', q:'The intrinsic rate of the AV junction is _____ to _____ bpm.', sub:'Backup pacemaker.',
  answer:'40-60', accept:['40-60','40 to 60','40-60 bpm','40 - 60'],
  explain:'AV junction: 40-60 bpm. Fires when SA node fails or is slower. Accelerated junctional: 60-100.' },

{ id:23, type:'mc', q:'In a junctional rhythm, where can P waves be found?', sub:'Retrograde atrial activation.',
  options:['Always upright before QRS','Inverted before QRS, inverted after QRS, or absent','Always absent','Always upright after QRS'], answer:1,
  explain:'Retrograde conduction may produce inverted P waves before QRS, after QRS, or P waves may be absent (hidden in QRS).' },

{ id:24, type:'mc', q:'Accelerated junctional rhythm has a rate of:', sub:'Faster than inherent junctional rate.',
  options:['20-40 bpm','40-60 bpm','60-100 bpm','100-180 bpm'], answer:2,
  explain:'Accelerated junctional: 60-100 bpm. Junctional escape: 40-60. Junctional tachycardia: 100-180.' },

{ id:25, type:'mc', q:'Identify this rhythm:', sub:'Narrow QRS, rate 120-160, no visible P waves.', rhythm:'junct_tach',
  options:['Sinus Tachycardia','SVT','Junctional Tachycardia','Atrial Flutter'], answer:2,
  explain:'Rate 100-180, narrow QRS, retrograde or absent P waves, regular = Junctional Tachycardia. Can be caused by digitalis toxicity.' },

// ‚îÄ‚îÄ VENTRICULAR RHYTHMS (26-40) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{ id:26, type:'mc', q:'Identify this lethal rhythm:', sub:'Chaotic, no organized complexes.', rhythm:'vfib',
  options:['Ventricular Tachycardia','Torsades de Pointes','Ventricular Fibrillation','Artifact'], answer:2,
  explain:'Chaotic disorganized ventricular activity. No QRS, no pulse. Immediate defibrillation required.' },

{ id:27, type:'mc', q:'Identify this rhythm:', sub:'Wide QRS, rate > 100, regular.', rhythm:'vtach',
  options:['SVT with aberrancy','Ventricular Tachycardia','Accelerated Idioventricular','Atrial Flutter'], answer:1,
  explain:'Wide-complex (‚â•0.12s), regular, rate > 100, no P waves = VT. With pulse: cardioversion/amiodarone. Pulseless: defib.' },

{ id:28, type:'mc', q:'Identify this rhythm:', sub:'Undulating axis, polymorphic.', rhythm:'torsades',
  options:['Ventricular Fibrillation','Monomorphic VT','Torsades de Pointes','Atrial Fibrillation with WPW'], answer:2,
  explain:'Polymorphic VT with "twisting of the points" ‚Äî QRS axis rotates around baseline. Associated with prolonged QT. Treat with Magnesium 1-2g IV.' },

{ id:29, type:'fill', q:'The first treatment for Torsades de Pointes is _____ sulfate 1-2g IV.', sub:'',
  answer:'magnesium', accept:['magnesium','mag','Magnesium','MgSO4','mag sulfate','magnesium sulfate'],
  explain:'Magnesium sulfate 1-2g IV over 5-60 min is first-line for Torsades. Also: overdrive pacing, isoproterenol. Avoid amiodarone (prolongs QT further).' },

{ id:30, type:'mc', q:'Identify this rhythm:', sub:'Wide QRS, very slow, no P waves.', rhythm:'idiovent',
  options:['Complete Heart Block','Idioventricular Rhythm','Sinus Bradycardia','Junctional Escape'], answer:1,
  explain:'Ventricular escape rhythm at 20-40 bpm. Wide bizarre QRS, no P waves. Last resort pacemaker ‚Äî do NOT suppress.' },

{ id:31, type:'mc', q:'Identify this rhythm:', sub:'Wide QRS, rate 40-100, seen after reperfusion.', rhythm:'aivr',
  options:['Ventricular Tachycardia','Accelerated Idioventricular Rhythm','Junctional Tachycardia','3rd Degree Block'], answer:1,
  explain:'AIVR: rate 40-100, wide QRS. Classic reperfusion marker after PCI or thrombolytics. Usually benign ‚Äî monitor, do not treat.' },

{ id:32, type:'multi', q:'Which ventricular rhythms are shockable? (Select ALL)', sub:'AHA cardiac arrest algorithm.',
  options:['Ventricular Fibrillation','Pulseless VT','Asystole','PEA','Torsades de Pointes (pulseless)'],
  answer:[0,1,4],
  explain:'VF, pulseless VT, and pulseless Torsades are shockable. Asystole and PEA are non-shockable ‚Äî give epinephrine, search for reversible causes.' },

{ id:33, type:'mc', q:'Identify this pattern:', sub:'Every other beat is wide and bizarre.', rhythm:'bigeminy',
  options:['Atrial Bigeminy','PVC Bigeminy','SVT','Ventricular Couplet'], answer:1,
  explain:'Sinus‚ÄìPVC‚ÄìSinus‚ÄìPVC pattern = ventricular bigeminy. Classic cause: digitalis toxicity.' },

{ id:34, type:'mc', q:'Identify this pattern:', sub:'Every 3rd beat is a PVC.', rhythm:'trigeminy',
  options:['PVC Bigeminy','PVC Couplet','PVC Trigeminy','Multifocal PVC'], answer:2,
  explain:'Sinus‚ÄìSinus‚ÄìPVC repeating pattern = trigeminy. Indicates irritable ventricular focus.' },

{ id:35, type:'mc', q:'How many consecutive PVCs constitute ventricular tachycardia?', sub:'',
  options:['2 or more','3 or more','5 or more','10 or more'], answer:1,
  explain:'3 or more consecutive PVCs at rate > 100 = ventricular tachycardia. 2 consecutive = couplet.' },

{ id:36, type:'mc', q:'Identify this pattern:', sub:'PVCs of different shapes intermixed.', rhythm:'multifocal_pvc',
  options:['Unifocal PVCs','PVC Bigeminy','Multifocal PVCs','Artifact'], answer:2,
  explain:'‚â•2 different QRS morphologies = PVCs originating from different ventricular foci. More dangerous than unifocal ‚Äî indicates widespread irritability.' },

{ id:37, type:'order', q:'Place these ventricular rhythms in order from LEAST to MOST dangerous:', sub:'',
  items:['Isolated unifocal PVC','PVC Bigeminy','Multifocal PVCs / Couplets','Sustained monomorphic VT','Ventricular Fibrillation'],
  answer:[0,1,2,3,4],
  explain:'Isolated PVC ‚Üí patterned PVCs ‚Üí multifocal/couplets ‚Üí VT ‚Üí VF represents escalating lethality and myocardial irritability.' },

{ id:38, type:'fill', q:'Defibrillation energy for a biphasic defibrillator is typically _____ to _____ joules.', sub:'Initial shock for VF/pulseless VT.',
  answer:'120-200', accept:['120-200','120 to 200','120-200J','120-200 joules'],
  explain:'Biphasic: 120-200J (follow manufacturer). Monophasic: 360J. For synchronized cardioversion, energies are lower.' },

{ id:39, type:'mc', q:'R-on-T phenomenon can trigger which lethal rhythm?', sub:'PVC landing on the vulnerable period.',
  options:['Asystole','Atrial Fibrillation','Ventricular Fibrillation','Complete Heart Block'], answer:2,
  explain:'A PVC during the relative refractory period (T wave downslope) can trigger VF. This is the R-on-T phenomenon.' },

{ id:40, type:'mc', q:'Identify this rhythm:', sub:'Pacer spike preceding each wide QRS.', rhythm:'paced',
  options:['Bundle Branch Block','Ventricular Paced Rhythm','Artifact','WPW'], answer:1,
  explain:'Vertical pacing spike followed by wide QRS = ventricular paced rhythm. Assess for capture (spike ‚Üí QRS) and sensing.' },

// ‚îÄ‚îÄ AV BLOCKS (41-50) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{ id:41, type:'mc', q:'Identify this rhythm:', sub:'Regular rhythm with prolonged PR interval.', rhythm:'1avb',
  options:['Normal Sinus Rhythm','First-Degree AV Block','Second-Degree Type I','Junctional Rhythm'], answer:1,
  explain:'PR interval > 0.20s but constant. All P waves conduct. Not a true block ‚Äî a delay.' },

{ id:42, type:'mc', q:'Identify this rhythm:', sub:'PR interval progressively lengthens then a QRS is dropped.', rhythm:'wenck',
  options:['First-Degree AV Block','Mobitz Type II','Wenckebach (Type I)','Third-Degree Block'], answer:2,
  explain:'Progressive PR prolongation until a P wave fails to conduct = Wenckebach / Mobitz Type I. Usually at level of AV node.' },

{ id:43, type:'mc', q:'Identify this rhythm:', sub:'Constant PR interval with sudden dropped QRS.', rhythm:'mobitz2',
  options:['Wenckebach','Mobitz Type II','Complete Heart Block','Sinus Arrest'], answer:1,
  explain:'Constant PR then sudden non-conducted P wave. Infranodal (below AV node, at bundle level). High risk of progression to complete block.' },

{ id:44, type:'mc', q:'Identify this rhythm:', sub:'P waves and QRS complexes march independently.', rhythm:'3avb',
  options:['Second-Degree Type I','Second-Degree Type II','Third-Degree AV Block','Sinus Arrest'], answer:2,
  explain:'Complete AV dissociation. Atrial and ventricular rhythms independent. Escape rhythm maintains perfusion.' },

{ id:45, type:'match', q:'Match each AV block to its key ECG feature:', sub:'',
  pairs:[
    ['1st Degree','Constant prolonged PR > 0.20s, all P waves conduct'],
    ['2nd Degree Type I','Progressive PR lengthening ‚Üí dropped QRS'],
    ['2nd Degree Type II','Constant PR with sudden dropped QRS'],
    ['3rd Degree','P waves march independently of QRS']
  ],
  explain:'Pattern recognition: 1st = long PR. Wenckebach = longer-longer-drop. Mobitz II = constant-constant-DROP. 3rd = no relationship.' },

{ id:46, type:'multi', q:'Which AV blocks may require transcutaneous pacing? (Select ALL)', sub:'',
  options:['First-Degree AV Block','Second-Degree Type I (asymptomatic)','Second-Degree Type II','Third-Degree (Complete)','Second-Degree Type I (symptomatic)'],
  answer:[2,3,4],
  explain:'Mobitz II and 3rd degree always need pacing consideration. Symptomatic Wenckebach may also need pacing. 1st degree and asymptomatic Wenckebach: observe.' },

{ id:47, type:'fill', q:'The drug of choice for symptomatic bradycardia is _____ 1mg IV.', sub:'Per AHA ACLS algorithm.',
  answer:'atropine', accept:['atropine','Atropine','atropine sulfate'],
  explain:'Atropine 1mg IV every 3-5 min (max 3mg). Blocks vagal (parasympathetic) tone ‚Üí increases HR. If atropine fails ‚Üí transcutaneous pacing.' },

{ id:48, type:'mc', q:'Mobitz Type II occurs at what anatomical level?', sub:'Location determines prognosis.',
  options:['SA node','AV node','Bundle of His / bundle branches','Purkinje fibers'], answer:2,
  explain:'Mobitz II = infranodal block (Bundle of His or bundle branches). Worse prognosis than Type I. Higher risk of complete block and hemodynamic collapse.' },

{ id:49, type:'mc', q:'In third-degree AV block, the ventricular escape rate depends on:', sub:'',
  options:['Atrial rate','Location of escape pacemaker','Blood pressure','Patient age'], answer:1,
  explain:'Junctional escape (40-60, narrow QRS) = better prognosis. Ventricular escape (20-40, wide QRS) = worse prognosis. Location determines rate and width.' },

{ id:50, type:'order', q:'Arrange the AV blocks from LEAST to MOST severe:', sub:'',
  items:['First-Degree AV Block','Second-Degree Type I (Wenckebach)','Second-Degree Type II (Mobitz)','Third-Degree (Complete)'],
  answer:[0,1,2,3],
  explain:'1st ‚Üí delay only. Type I ‚Üí usually benign, AV node level. Type II ‚Üí infranodal, dangerous. 3rd ‚Üí complete dissociation, pacing often needed.' },

// ‚îÄ‚îÄ ECG INTERPRETATION (51-60) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{ id:51, type:'match', q:'Match each ECG wave/segment to what it represents:', sub:'',
  pairs:[
    ['P wave','Atrial depolarization'],
    ['QRS complex','Ventricular depolarization'],
    ['T wave','Ventricular repolarization'],
    ['PR interval','Impulse travel: atria ‚Üí AV node ‚Üí Bundle of His'],
    ['ST segment','Early ventricular repolarization (ischemia indicator)']
  ],
  explain:'P = atria depolarize. QRS = ventricles depolarize. T = ventricles repolarize. PR = conduction time. ST = injury current.' },

{ id:52, type:'fill', q:'ST elevation in leads II, III, and aVF indicates a(n) _____ wall MI.', sub:'Which coronary artery territory?',
  answer:'inferior', accept:['inferior','Inferior','inferior wall'],
  explain:'II, III, aVF = inferior territory = RCA (85%) or LCx (15%). Always check V4R for RV involvement.' },

{ id:53, type:'fill', q:'ST elevation in V1‚ÄìV4 indicates a(n) _____ wall MI.', sub:'Which artery is typically occluded?',
  answer:'anterior', accept:['anterior','Anterior','anterior wall','anteroseptal'],
  explain:'V1-V4 = anterior/anteroseptal = LAD occlusion ("widow maker"). Largest infarct territory, highest mortality.' },

{ id:54, type:'multi', q:'Which ECG findings are associated with right ventricular MI? (Select ALL)', sub:'',
  options:['ST elevation in V4R','JVD with clear lungs','Hypotension with inferior STEMI','ST depression in V1-V3','Bradycardia'],
  answer:[0,1,2,4],
  explain:'RV infarct: V4R STE, JVD + clear lungs + hypotension (RV triad). Often with inferior STEMI. Brady from SA/AV node ischemia. V1-V3 depression suggests posterior MI.' },

{ id:55, type:'mc', q:'Reciprocal changes on a 12-lead ECG refer to:', sub:'',
  options:['ST elevation in all leads','ST depression opposite the area of injury','Q waves in contiguous leads','Tall T waves in precordial leads'], answer:1,
  explain:'Reciprocal ST depression appears in leads opposite the injury. Confirms STEMI diagnosis and increases specificity.' },

{ id:56, type:'fill', q:'The Wellens syndrome pattern involves deep T-wave inversions in leads V2-V3 and indicates critical _____ stenosis.', sub:'STEMI equivalent ‚Äî do NOT stress test.',
  answer:'LAD', accept:['LAD','lad','left anterior descending','Left Anterior Descending','proximal LAD'],
  explain:'Wellens = critical proximal LAD stenosis. Patient is pain-free when ECG shows changes. Will infarct without cath.' },

{ id:57, type:'mc', q:'De Winter T waves (upsloping ST depression with tall peaked T waves in V1-V6) indicate:', sub:'STEMI equivalent.',
  options:['Hyperkalemia','Benign early repolarization','Proximal LAD occlusion','Pericarditis'], answer:2,
  explain:'De Winter pattern is a STEMI equivalent = proximal LAD occlusion. Present in ~2% of LAD occlusions instead of classic STE.' },

{ id:58, type:'mc', q:'New left bundle branch block (LBBB) in the setting of ACS symptoms should be treated as:', sub:'',
  options:['Benign finding ‚Äî observe','STEMI equivalent ‚Äî activate cath lab','Non-STEMI ‚Äî medical management','Artifact ‚Äî repeat ECG'], answer:1,
  explain:'New LBBB + ACS symptoms = STEMI equivalent. Activate cath lab. Use Sgarbossa criteria to evaluate for MI in existing LBBB.' },

{ id:59, type:'match', q:'Match each infarct territory to its ECG leads:', sub:'',
  pairs:[
    ['Anterior','V1‚ÄìV4'],
    ['Inferior','II, III, aVF'],
    ['Lateral','I, aVL, V5, V6'],
    ['Posterior','V7‚ÄìV9 (mirror in V1‚ÄìV3)']
  ],
  explain:'Ant=V1-V4 (LAD). Inf=II/III/aVF (RCA). Lat=I/aVL/V5-V6 (LCx). Post=V7-V9 (PDA).' },

{ id:60, type:'mc', q:'ST depression in V1-V3 with tall R waves and upright T waves suggests:', sub:'Often missed on standard 12-lead.',
  options:['Anterior STEMI','Posterior MI','Hyperkalemia','Bundle Branch Block'], answer:1,
  explain:'Mirror image of posterior STEMI. Obtain V7-V9 posterior leads. ST elevation ‚â• 0.5mm confirms posterior MI.' },

// ‚îÄ‚îÄ ACS & MANAGEMENT (61-75) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{ id:61, type:'order', q:'Place the ACS pathophysiology in correct sequence:', sub:'',
  items:['Endothelial injury','Lipid infiltration & plaque formation','Plaque rupture','Platelet aggregation & thrombus','Myocardial ischemia','Myocardial infarction'],
  answer:[0,1,2,3,4,5],
  explain:'Atherosclerosis is a progressive disease. Endothelial damage ‚Üí plaque builds ‚Üí ruptures ‚Üí clot forms ‚Üí occludes vessel ‚Üí ischemia ‚Üí necrosis.' },

{ id:62, type:'fill', q:'The door-to-balloon time goal for STEMI patients is less than _____ minutes.', sub:'Time is muscle.',
  answer:'90', accept:['90','90 minutes','<90','90 min'],
  explain:'PCI goal: < 90 min from first medical contact to balloon inflation. If transport > 120 min to PCI ‚Üí consider fibrinolytics.' },

{ id:63, type:'mc', q:'Which single prehospital medication has the greatest mortality reduction in ACS?', sub:'23% mortality reduction.',
  options:['Nitroglycerin','Morphine','Aspirin','Heparin'], answer:2,
  explain:'Aspirin 324mg PO chewed. Irreversible COX-1 inhibition blocks thromboxane A‚ÇÇ ‚Üí inhibits platelets. 23% mortality reduction in ISIS-2 trial.' },

{ id:64, type:'multi', q:'Nitroglycerin is CONTRAINDICATED in which situations? (Select ALL)', sub:'',
  options:['SBP < 90 mmHg','Right ventricular infarct','PDE5 inhibitor use within 24-48 hours','Heart rate > 100','Inferior STEMI with RV involvement'],
  answer:[0,1,2,4],
  explain:'NTG contraindicated with hypotension, RV infarct (preload dependent), and recent PDE5 inhibitors (sildenafil, tadalafil ‚Üí severe hypotension). Tachycardia alone is not a contraindication.' },

{ id:65, type:'mc', q:'A patient with inferior STEMI develops hypotension, JVD, and clear lungs. You should:', sub:'RV infarct management.',
  options:['Give nitroglycerin and elevate legs','Give furosemide IV','Administer 250-500mL NS fluid bolus','Start dopamine immediately'], answer:2,
  explain:'RV infarct triad: hypotension + JVD + clear lungs. Preload dependent ‚Äî fluid challenge first. NO NTG, NO diuretics.' },

{ id:66, type:'fill', q:'A patient with cocaine-induced chest pain should NOT receive _____ blockers.', sub:'Risk of unopposed alpha stimulation.',
  answer:'beta', accept:['beta','Beta','Œ≤','beta-blockers','beta blockers'],
  explain:'Beta-blockers in cocaine chest pain ‚Üí unopposed alpha stimulation ‚Üí coronary vasospasm ‚Üí worsened ischemia. Use benzodiazepines, NTG, calcium channel blockers.' },

{ id:67, type:'nested', q:'A 62-year-old male presents with crushing substernal chest pain radiating to his left arm. He is diaphoretic and nauseous.', sub:'Multi-part clinical scenario.',
  parts:[
    { q:'Your FIRST action should be:', options:['Start an IV','Obtain 12-lead ECG','Administer morphine','Apply defibrillator pads'], answer:1,
      explain:'12-lead ECG within 5 minutes of patient contact is the priority. It guides all subsequent treatment decisions.' },
    { q:'The 12-lead shows ST elevation in V1-V4. This represents:', options:['Inferior STEMI','Lateral STEMI','Anterior STEMI','Posterior MI'], answer:2,
      explain:'V1-V4 = anterior territory = LAD occlusion.' },
    { q:'You should immediately:', options:['Give fibrinolytics','Activate the cath lab','Administer amiodarone','Perform cardioversion'], answer:1,
      explain:'STEMI identified ‚Üí immediate cath lab activation for PCI. Target first medical contact to balloon < 90 minutes.' }
  ]},

{ id:68, type:'mc', q:'The AVOID trial demonstrated that routine high-flow oxygen in normoxic MI patients:', sub:'Evidence-based practice change.',
  options:['Improves outcomes','Has no effect','May worsen outcomes','Reduces infarct size'], answer:2,
  explain:'AVOID trial: hyperoxia causes coronary vasoconstriction and may increase infarct size. Only give O‚ÇÇ if SpO‚ÇÇ < 94%.' },

{ id:69, type:'match', q:'Match each ACS type to its troponin and ECG findings:', sub:'',
  pairs:[
    ['Unstable Angina','Troponin negative, ST depression or normal ECG'],
    ['NSTEMI','Troponin positive, ST depression or T-wave inversion'],
    ['STEMI','Troponin positive, ST elevation in contiguous leads']
  ],
  explain:'UA = ischemia without necrosis. NSTEMI = necrosis without transmural injury. STEMI = transmural injury requiring emergent reperfusion.' },

{ id:70, type:'multi', q:'Absolute contraindications to fibrinolytic therapy include: (Select ALL)', sub:'',
  options:['Active internal bleeding','Suspected aortic dissection','Ischemic stroke within 3 months','Age > 75 years','Intracranial neoplasm'],
  answer:[0,1,2,4],
  explain:'Absolute: active bleeding, suspected dissection, recent stroke/head trauma, intracranial neoplasm, known bleeding disorder. Age > 75 is relative, not absolute.' },

{ id:71, type:'mc', q:'Approximately how many myocytes die per minute during a coronary occlusion?', sub:'Why time is muscle.',
  options:['100,000','500,000','1.9 million','10 million'], answer:2,
  explain:'~1.9 million myocytes/minute. The wavefront of necrosis spreads from subendocardium ‚Üí epicardium over 4-6 hours.' },

{ id:72, type:'fill', q:'The classic triad of aortic dissection presentation includes tearing pain, BP differential between arms, and unequal _____.', sub:'Key physical exam findings.',
  answer:'pulses', accept:['pulses','Pulses','pulse deficits','radial pulses'],
  explain:'Dissection flap can compromise branch arteries ‚Üí unequal pulses, BP differential > 20mmHg, tearing/ripping pain maximal at onset.' },

{ id:73, type:'mc', q:'Killip Class IV heart failure after MI is defined as:', sub:'Prognostic classification.',
  options:['No signs of CHF','Rales and S‚ÇÉ gallop','Frank pulmonary edema','Cardiogenic shock'], answer:3,
  explain:'Killip I = no CHF. II = rales/S‚ÇÉ. III = pulmonary edema. IV = cardiogenic shock. Mortality rises dramatically with each class.' },

{ id:74, type:'mc', q:'A new holosystolic murmur 3 days after anterior MI most likely indicates:', sub:'Mechanical complication.',
  options:['Pericarditis','Ventricular septal rupture','Aortic stenosis','Mitral valve prolapse'], answer:1,
  explain:'New murmur days post-MI ‚Üí mechanical complication. Harsh holosystolic murmur = VSD. Blowing murmur = papillary muscle rupture (MR).' },

{ id:75, type:'mc', q:'Dressler syndrome occurs how long after MI?', sub:'Autoimmune complication.',
  options:['Within 6 hours','24-48 hours','2-10 weeks','6-12 months'], answer:2,
  explain:'Dressler syndrome: autoimmune pericarditis 2-10 weeks post-MI. Fever, pleuritic chest pain, friction rub. Treat with NSAIDs, colchicine.' },

// ‚îÄ‚îÄ CARDIAC PHYSIOLOGY (76-85) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{ id:76, type:'fill', q:'Cardiac output (CO) equals stroke volume (SV) multiplied by _____.', sub:'Fundamental hemodynamic equation.',
  answer:'heart rate', accept:['heart rate','HR','Heart Rate','heart rate (HR)','hr'],
  explain:'CO = SV √ó HR. Normal CO ‚âà 5 L/min. Three determinants of SV: preload, afterload, contractility.' },

{ id:77, type:'fill', q:'Mean arterial pressure (MAP) equals cardiac output multiplied by _____.', sub:'',
  answer:'SVR', accept:['SVR','svr','systemic vascular resistance','Systemic Vascular Resistance','peripheral resistance'],
  explain:'MAP = CO √ó SVR. Also calculated as MAP = DBP + ‚Öì(SBP - DBP). Normal MAP: 70-105 mmHg.' },

{ id:78, type:'mc', q:'The Frank-Starling law states that:', sub:'Fundamental cardiac physiology.',
  options:['Increased afterload increases CO','Increased preload increases stroke volume up to a point','Heart rate is the primary determinant of CO','Contractility is independent of fiber stretch'], answer:1,
  explain:'Greater stretch (preload/EDV) ‚Üí stronger contraction ‚Üí greater SV. But on the descending limb (overstretched/failing heart), more preload = less output.' },

{ id:79, type:'match', q:'Match each determinant to its definition:', sub:'',
  pairs:[
    ['Preload','End-diastolic volume / ventricular stretch'],
    ['Afterload','Resistance the ventricle must overcome to eject'],
    ['Contractility','Intrinsic strength of myocardial contraction'],
    ['Chronotropy','Heart rate']
  ],
  explain:'Preload = volume/stretch. Afterload = resistance (SVR). Contractility = squeeze force (inotropy). Chronotropy = rate.' },

{ id:80, type:'multi', q:'Which are positive inotropes (increase contractility)? (Select ALL)', sub:'',
  options:['Epinephrine','Dobutamine','Metoprolol','Digoxin','Calcium','Verapamil'],
  answer:[0,1,3,4],
  explain:'Epi, dobutamine, digoxin, and calcium increase contractility. Metoprolol (beta-blocker) and verapamil (CCB) are negative inotropes.' },

{ id:81, type:'mc', q:'Which receptor, when stimulated, increases heart rate and contractility?', sub:'Autonomic pharmacology.',
  options:['Alpha-1','Beta-1','Beta-2','Muscarinic'], answer:1,
  explain:'Beta-1 = heart (rate ‚Üë, contractility ‚Üë, conduction ‚Üë). Beta-2 = lungs (bronchodilation) and vessels (vasodilation). Alpha-1 = vasoconstriction.' },

{ id:82, type:'fill', q:'Normal ejection fraction is _____% to _____%.', sub:'Percentage of EDV ejected per beat.',
  answer:'55-70', accept:['55-70','55 to 70','55-70%','55%-70%','55 - 70'],
  explain:'EF = SV/EDV √ó 100. Normal 55-70%. EF < 40% = HFrEF (systolic heart failure). EF > 50% with symptoms = HFpEF.' },

{ id:83, type:'mc', q:'Coronary artery perfusion occurs primarily during which phase?', sub:'Critical concept for tachycardia management.',
  options:['Systole','Diastole','Isovolumetric contraction','Atrial kick'], answer:1,
  explain:'Coronary perfusion during diastole. Myocardial compression during systole occludes coronary vessels. Tachycardia shortens diastole ‚Üí ‚Üì coronary perfusion ‚Üí ischemia.' },

{ id:84, type:'mc', q:'Atropine works by blocking which receptor?', sub:'Parasympathetic antagonist.',
  options:['Beta-1 adrenergic','Alpha-1 adrenergic','Muscarinic (cholinergic)','Nicotinic'], answer:2,
  explain:'Atropine blocks ACh at muscarinic receptors ‚Üí removes vagal brake ‚Üí HR increases. Does NOT work below the AV node ‚Äî won\'t help Mobitz II or infranodal blocks.' },

{ id:85, type:'order', q:'Arrange the phases of the cardiac action potential in order (Phase 0 through Phase 4):', sub:'Ventricular myocyte.',
  items:['Phase 0: Rapid depolarization (Na‚Å∫ influx)','Phase 1: Early repolarization (K‚Å∫ efflux)','Phase 2: Plateau (Ca¬≤‚Å∫ in, K‚Å∫ out)','Phase 3: Repolarization (K‚Å∫ efflux)','Phase 4: Resting membrane potential'],
  answer:[0,1,2,3,4],
  explain:'Phase 0 = Na‚Å∫ rush in (QRS). Phase 1 = brief K‚Å∫ out. Phase 2 = Ca¬≤‚Å∫ in balances K‚Å∫ out (plateau, absolute refractory). Phase 3 = K‚Å∫ out (T wave). Phase 4 = resting -90mV.' },

// ‚îÄ‚îÄ CARDIAC EMERGENCIES (86-95) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{ id:86, type:'match', q:'Match each type of shock to its hemodynamic profile:', sub:'',
  pairs:[
    ['Cardiogenic','‚ÜìCO, ‚ÜëSVR, ‚ÜëPCWP (cold & wet)'],
    ['Hypovolemic','‚ÜìCO, ‚ÜëSVR, ‚ÜìPCWP (cold & dry)'],
    ['Distributive (septic)','‚ÜëCO initially, ‚Üì‚ÜìSVR (warm & dry)'],
    ['Obstructive (tamponade)','‚ÜìCO, ‚ÜëSVR, ‚ÜëCVP (JVD + hypotension)']
  ],
  explain:'Cold/warm = peripheral perfusion. Wet/dry = pulmonary congestion. Skin temperature and lung/JVD assessment differentiate shock types.' },

{ id:87, type:'fill', q:'Beck\'s Triad for cardiac tamponade includes JVD, muffled heart sounds, and _____.', sub:'',
  answer:'hypotension', accept:['hypotension','Hypotension','low blood pressure','low BP','decreased BP'],
  explain:'Beck\'s Triad: JVD + muffled sounds + hypotension. Also: pulsus paradoxus > 10mmHg, tachycardia, electrical alternans.' },

{ id:88, type:'mc', q:'CPAP for acute pulmonary edema works by:', sub:'Mechanism of action.',
  options:['Increasing tidal volume','Splinting alveoli open and reducing preload','Increasing heart rate','Bronchodilation'], answer:1,
  explain:'CPAP: positive pressure ‚Üí splints alveoli open, ‚Üì preload (‚Üì venous return), ‚Üì afterload, ‚Üì work of breathing. Reduces intubation by 50%, mortality by 40%.' },

{ id:89, type:'mc', q:'First-line vasopressor for cardiogenic shock per the SOAP II trial:', sub:'',
  options:['Dopamine','Dobutamine','Norepinephrine','Epinephrine'], answer:2,
  explain:'SOAP II trial: norepinephrine associated with fewer dysrhythmias and lower mortality than dopamine in cardiogenic shock.' },

{ id:90, type:'nested', q:'A 45-year-old female presents with sudden-onset tearing chest pain radiating to her back. BP: 210/120 right arm, 170/100 left arm.', sub:'Multi-part emergency scenario.',
  parts:[
    { q:'The most likely diagnosis is:', options:['Anterior STEMI','Pulmonary embolism','Aortic dissection','Tension pneumothorax'], answer:2,
      explain:'Tearing pain, maximal at onset, BP differential > 20mmHg = classic aortic dissection presentation.' },
    { q:'Which medication class should be given FIRST?', options:['Fibrinolytics','Beta-blockers (rate before pressure)','ACE inhibitors','Aspirin'], answer:1,
      explain:'Beta-blocker first (esmolol) to reduce HR < 60 and wall shear stress. Then vasodilators if needed. Rate BEFORE pressure.' },
    { q:'Which of these would be MOST DANGEROUS to administer?', options:['Fentanyl','Normal saline','tPA (fibrinolytic)','Esmolol'], answer:2,
      explain:'Fibrinolytics in aortic dissection = catastrophic hemorrhage and death. This is why dissection must be considered in the differential of chest pain before giving tPA for presumed STEMI.' }
  ]},

{ id:91, type:'mc', q:'The S1Q3T3 pattern on ECG suggests:', sub:'Classic but only present in ~20% of cases.',
  options:['Anterior MI','Pulmonary embolism','Hyperkalemia','Pericarditis'], answer:1,
  explain:'Deep S in I, Q wave in III, inverted T in III = right heart strain from PE. But sinus tachycardia is the most common ECG finding in PE (40%).' },

{ id:92, type:'multi', q:'Which are features of acute pericarditis on ECG? (Select ALL)', sub:'The STEMI mimic.',
  options:['Diffuse ST elevation (concave up)','PR depression','Reciprocal ST depression','ST elevation in aVR','No pathological Q waves'],
  answer:[0,1,4],
  explain:'Pericarditis: diffuse concave-up STE, PR depression, no reciprocal changes, no Q waves. aVR shows PR elevation (not ST elevation). Key difference from STEMI: diffuse, not territorial.' },

{ id:93, type:'fill', q:'Pulsus paradoxus is defined as a drop in systolic BP greater than _____ mmHg during inspiration.', sub:'Key tamponade finding.',
  answer:'10', accept:['10','10 mmHg','10mmHg','>10'],
  explain:'Normal variation < 10mmHg. Pulsus paradoxus > 10mmHg = exaggerated drop during inspiration. Tamponade, severe asthma, tension pneumo.' },

{ id:94, type:'mc', q:'In hypertensive emergency, MAP should be reduced by no more than what percentage in the first hour?', sub:'Controlled reduction.',
  options:['10%','25%','50%','Normalize completely'], answer:1,
  explain:'Reduce MAP by max 25% in the first hour, then gradually toward 160/100 over 2-6 hours. Rapid drops ‚Üí watershed infarction from shifted autoregulation curve.' },

{ id:95, type:'mc', q:'The #1 cause of sudden cardiac death in young athletes is:', sub:'',
  options:['Coronary artery disease','Hypertrophic cardiomyopathy (HOCM)','Long QT syndrome','Myocarditis'], answer:1,
  explain:'HOCM: thickened septum obstructs LVOT during exertion. Systolic murmur increases with Valsalva/standing. Pre-participation screening saves lives.' },

// ‚îÄ‚îÄ RESUSCITATION & H/T (96-100) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{ id:96, type:'order', q:'Arrange the BLS/ACLS chain of survival in correct order:', sub:'',
  items:['Early recognition & 911 activation','Early high-quality CPR','Early defibrillation','Advanced resuscitation (ACLS)','Post-cardiac arrest care'],
  answer:[0,1,2,3,4],
  explain:'Each link in the chain must be strong. Early CPR doubles/triples survival. Early defib in VF increases survival dramatically.' },

{ id:97, type:'match', q:'Match each H/T reversible cause to its treatment:', sub:'H\'s and T\'s of cardiac arrest.',
  pairs:[
    ['Hypovolemia','Volume resuscitation (blood, crystalloid)'],
    ['Tension pneumothorax','Needle decompression ‚Üí chest tube'],
    ['Cardiac tamponade','Pericardiocentesis'],
    ['Hyperkalemia','Calcium, insulin/glucose, bicarb, albuterol'],
    ['Hypothermia','Active rewarming, continued resuscitation']
  ],
  explain:'Identifying and treating reversible causes is the key to PEA/asystole management. CPR + epi buys time while you find and fix the cause.' },

{ id:98, type:'multi', q:'Components of high-quality CPR include: (Select ALL)', sub:'AHA guidelines.',
  options:['Rate 100-120 compressions/min','Depth at least 2 inches','Full chest recoil between compressions','Minimize interruptions (CCF > 80%)','Compress at rate of 60-80/min','Excessive ventilation to hyperventilate'],
  answer:[0,1,2,3],
  explain:'100-120/min, ‚â•2 inches depth, full recoil, minimize interruptions, avoid hyperventilation (causes ‚Üë intrathoracic pressure ‚Üí ‚Üì venous return ‚Üí ‚Üì CO).' },

{ id:99, type:'nested', q:'You arrive to find a 58-year-old male unresponsive, pulseless, not breathing. The monitor shows ventricular fibrillation.', sub:'Cardiac arrest scenario.',
  parts:[
    { q:'Your immediate action is:', options:['Start IV and give epinephrine','Intubate the patient','Defibrillate immediately','Give amiodarone 300mg IV'], answer:2,
      explain:'VF = shockable rhythm. Defibrillate immediately. Every minute without defib decreases survival by 7-10%.' },
    { q:'After 2 minutes of CPR and a second shock, VF persists. You should now:', options:['Give epinephrine 1mg IV/IO','Give amiodarone 300mg IV/IO','Give epinephrine 1mg IV/IO and continue CPR','Give atropine 1mg IV'], answer:2,
      explain:'After 2nd shock: Epinephrine 1mg IV/IO, continue CPR. Epinephrine every 3-5 min. Amiodarone given after 3rd shock.' },
    { q:'After the 3rd shock, which antiarrhythmic is given?', options:['Lidocaine 1mg/kg','Amiodarone 300mg IV/IO','Magnesium 2g IV','Procainamide 20mg/min'], answer:1,
      explain:'Amiodarone 300mg IV/IO after 3rd shock, then 150mg for subsequent refractory VF. Alternative: Lidocaine 1-1.5mg/kg.' }
  ]},

{ id:100, type:'fill', q:'Epinephrine in cardiac arrest is given at a dose of _____ mg IV/IO every 3-5 minutes.', sub:'Standard ACLS vasopressor dosing.',
  answer:'1', accept:['1','1mg','1 mg','one','1.0'],
  explain:'Epinephrine 1mg (1:10,000 for IV) every 3-5 minutes. Alpha effects ‚Üí vasoconstriction ‚Üí ‚Üë coronary and cerebral perfusion pressure during CPR.' }
];

let quizIdx=0, quizScore=0, quizAnswered=new Set(), shuffledOrder=null;
let studentInfo = { name:'', id:'', startTime:null, endTime:null };

function buildQuiz(){
  // Show registration form first
  const c = document.getElementById('quizContainer');
  c.innerHTML = `<div class="quiz-question-card quiz-reg">
    <div class="quiz-reg-title">üìã Assessment Registration</div>
    <div class="quiz-reg-sub">Enter your information below to begin the comprehensive cardiology assessment. A PDF certificate will be generated upon completion.</div>
    <div class="quiz-reg-field">
      <label class="quiz-reg-label">Full Name</label>
      <input type="text" class="quiz-reg-input" id="regName" placeholder="e.g. Jane Doe" oninput="checkRegReady()">
    </div>
    <div class="quiz-reg-field">
      <label class="quiz-reg-label">Student ID</label>
      <input type="text" class="quiz-reg-input" id="regId" placeholder="e.g. STU-20260001" oninput="checkRegReady()">
    </div>
    <button class="quiz-reg-start" id="regStartBtn" disabled onclick="startAssessment()">Begin Assessment</button>
    <div class="quiz-reg-info">
      <div class="quiz-reg-stat">üìù <span>100</span> Questions</div>
      <div class="quiz-reg-stat">üéØ <span>6</span> Question Types</div>
      <div class="quiz-reg-stat">üèÜ <span>70%</span> to Pass</div>
    </div>
  </div>`;
  setTimeout(()=>document.getElementById('regName')?.focus(),100);
}

function checkRegReady(){
  const name = document.getElementById('regName').value.trim();
  const id = document.getElementById('regId').value.trim();
  document.getElementById('regStartBtn').disabled = !(name.length>=2 && id.length>=1);
}

function startAssessment(){
  studentInfo.name = document.getElementById('regName').value.trim();
  studentInfo.id = document.getElementById('regId').value.trim();
  studentInfo.startTime = new Date();
  // Shuffle questions
  shuffledOrder = quizQuestions.map((_,i)=>i);
  for(let i=shuffledOrder.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1));[shuffledOrder[i],shuffledOrder[j]]=[shuffledOrder[j],shuffledOrder[i]]; }
  quizIdx=0; quizScore=0; quizAnswered=new Set();
  renderQuestion();
}

function getQ(){ return quizQuestions[shuffledOrder[quizIdx]]; }

function renderQuestion(){
  const c = document.getElementById('quizContainer');
  const total = quizQuestions.length;
  if(quizIdx >= total){
    studentInfo.endTime = new Date();
    const pct = Math.round((quizScore/total)*100);
    const grade = pct>=90?'A':pct>=80?'B':pct>=70?'C':pct>=60?'D':'F';
    const passed = pct >= 70;
    const msg = pct>=90?'Outstanding! You have excellent mastery of cardiology concepts.':pct>=80?'Great job! Review the topics you missed for even stronger knowledge.':pct>=70?'Good work. Focus on the areas where you struggled.':pct>=60?'You passed, but significant review is recommended before clinical application.':'Keep studying. Review all sections thoroughly and retake the assessment.';
    const elapsed = Math.round((studentInfo.endTime - studentInfo.startTime)/60000);
    c.innerHTML = `<div class="quiz-question-card quiz-score">
      <div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.3rem;font-family:'JetBrains Mono',monospace">${studentInfo.name} ¬∑ ${studentInfo.id}</div>
      <div class="big-num" style="color:${passed?'var(--ecg-green)':'var(--warning)'}">${pct}%</div>
      <div style="font-size:2rem;margin:0.3rem 0;font-weight:800;color:${passed?'var(--ecg-green)':'var(--warning)'}">Grade: ${grade}</div>
      <p style="font-size:1.05rem;margin:0.6rem 0">${quizScore} of ${total} correct ¬∑ ${elapsed} min</p>
      <p style="color:var(--text-secondary);max-width:400px;margin:0 auto">${msg}</p>
      ${passed?`<button class="cert-btn" onclick="generateCertificate()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 15l-3 3m0 0l-3-3m3 3V3m12 9a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        Download Certificate (PDF)
      </button>`:`<p style="color:var(--text-muted);font-size:0.8rem;margin-top:0.8rem">Score 70% or higher to receive a certificate.</p>`}
      <div style="margin-top:1rem"><button class="ecg-btn" onclick="buildQuiz()">Retake Assessment</button></div>
    </div>`;
    return;
  }
  const q = getQ();
  const progress = Array.from({length:Math.min(total,50)},(_,i)=>{
    const segSize = Math.ceil(total/50);
    const segIdx = Math.floor(i*total/50);
    const cls = segIdx<quizIdx?'done':segIdx===quizIdx?'current':'';
    return `<div class="quiz-dot ${cls}"></div>`;
  }).join('');

  let html = `<div class="quiz-question-card">
    <div class="quiz-progress">${progress}</div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.4rem">
      <span style="font-size:0.72rem;color:var(--text-muted)">${studentInfo.name} ¬∑ Q${quizIdx+1}/${total}</span>
      <span style="font-size:0.72rem;color:var(--ecg-green)">${quizScore} correct</span>
    </div>
    <div class="quiz-type-badge">${getTypeBadge(q.type)}</div>
    <div class="quiz-q">${q.q}</div>
    <div class="quiz-q-sub">${q.sub||''}</div>`;

  if(q.rhythm) html += `<div class="ecg-paper-bg" style="margin-bottom:1rem"><canvas id="quizRC" height="110"></canvas></div>`;

  html += renderQuestionBody(q);
  html += `<div class="quiz-feedback" id="quizFb"></div>
    <button class="quiz-next" id="quizNext" onclick="quizIdx++;renderQuestion()">Next ‚Üí</button>
  </div>`;

  c.innerHTML = html;

  if(q.rhythm) setTimeout(()=>{
    const cv=document.getElementById('quizRC');
    if(!cv)return;
    cv.width=cv.parentElement.clientWidth;
    cv.height=110;
    drawStaticRhythm(cv.getContext('2d'),cv.width,cv.height,q.rhythm);
  },80);

  // Init matching drag/drop
  if(q.type==='match') initMatchDrag();
  // Init order drag/drop
  if(q.type==='order') initOrderDrag();
  // Init nested
  if(q.type==='nested') window._nestedState = { answered:0, correct:0, total:q.parts.length };
}

function getTypeBadge(type){
  const map = {
    mc:'Multiple Choice', multi:'Select All That Apply', fill:'Fill in the Blank',
    match:'Matching', order:'Sequence / Order', nested:'Clinical Scenario'
  };
  const colors = {
    mc:'var(--ecg-green)', multi:'var(--bundle-his)', fill:'var(--accent-gold)',
    match:'var(--purkinje)', order:'#E040FB', nested:'var(--cardiac-red)'
  };
  return `<span style="font-size:0.65rem;font-weight:700;padding:0.15rem 0.5rem;border-radius:4px;background:${colors[type]}22;color:${colors[type]};border:1px solid ${colors[type]}44;letter-spacing:0.5px;font-family:'JetBrains Mono',monospace">${map[type]||type}</span>`;
}

function renderQuestionBody(q){
  switch(q.type){
    case 'mc': return renderMC(q);
    case 'multi': return renderMulti(q);
    case 'fill': return renderFill(q);
    case 'match': return renderMatch(q);
    case 'order': return renderOrder(q);
    case 'nested': return renderNested(q);
    default: return renderMC(q);
  }
}

// ‚îÄ‚îÄ MULTIPLE CHOICE ‚îÄ‚îÄ
function renderMC(q){
  return `<div class="quiz-options">${q.options.map((o,i)=>`<button class="quiz-opt" onclick="checkMC(${i})">${o}</button>`).join('')}</div>`;
}
function checkMC(idx){
  const q=getQ();
  const opts=document.querySelectorAll('.quiz-opt');
  opts.forEach((o,i)=>{o.style.pointerEvents='none';if(i===q.answer)o.classList.add('correct');if(i===idx&&idx!==q.answer)o.classList.add('wrong');});
  showFeedback(idx===q.answer, q.explain);
}

// ‚îÄ‚îÄ SELECT ALL (MULTI) ‚îÄ‚îÄ
function renderMulti(q){
  return `<div class="quiz-options">${q.options.map((o,i)=>`<button class="quiz-opt multi-opt" data-idx="${i}" onclick="toggleMulti(this)">${o}</button>`).join('')}</div>
  <button class="quiz-submit-btn" onclick="checkMulti()">Submit Answer</button>`;
}
function toggleMulti(el){ el.classList.toggle('selected'); }
function checkMulti(){
  const q=getQ();
  const selected = [...document.querySelectorAll('.multi-opt.selected')].map(e=>parseInt(e.dataset.idx));
  const correct = q.answer;
  const isCorrect = selected.length===correct.length && selected.every(s=>correct.includes(s));
  document.querySelectorAll('.multi-opt').forEach((o,i)=>{
    o.style.pointerEvents='none';
    if(correct.includes(i)) o.classList.add('correct');
    if(selected.includes(i)&&!correct.includes(i)) o.classList.add('wrong');
  });
  document.querySelector('.quiz-submit-btn').style.display='none';
  showFeedback(isCorrect, q.explain);
}

// ‚îÄ‚îÄ FILL IN THE BLANK ‚îÄ‚îÄ
function renderFill(q){
  return `<div class="quiz-fill-wrap">
    <input type="text" class="quiz-fill-input" id="quizFillInput" placeholder="Type your answer..." onkeydown="if(event.key==='Enter')checkFill()">
    <button class="quiz-submit-btn" onclick="checkFill()">Submit</button>
  </div>`;
}
function checkFill(){
  const q=getQ();
  const input=document.getElementById('quizFillInput');
  const val=input.value.trim().toLowerCase();
  const isCorrect = q.accept.some(a=>val===a.toLowerCase());
  input.disabled=true;
  input.style.borderColor=isCorrect?'var(--ecg-green)':'var(--arterial)';
  input.style.background=isCorrect?'rgba(6,214,160,0.1)':'rgba(230,57,70,0.1)';
  document.querySelector('.quiz-submit-btn').style.display='none';
  if(!isCorrect){
    const ansBox=document.createElement('div');
    ansBox.style.cssText='margin-top:0.5rem;padding:0.5rem;background:rgba(6,214,160,0.08);border:1px solid var(--ecg-green);border-radius:6px;font-size:0.85rem;color:var(--ecg-green)';
    ansBox.textContent='Correct answer: '+q.answer;
    input.parentElement.appendChild(ansBox);
  }
  showFeedback(isCorrect, q.explain);
}

// ‚îÄ‚îÄ MATCHING ‚îÄ‚îÄ
function renderMatch(q){
  const shuffledRight = q.pairs.map((_,i)=>i);
  for(let i=shuffledRight.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[shuffledRight[i],shuffledRight[j]]=[shuffledRight[j],shuffledRight[i]];}
  window._matchState = { pairs:q.pairs, shuffledRight, connections:{} };
  let html = `<div class="match-container"><div class="match-left">`;
  q.pairs.forEach((p,i)=>{
    html+=`<div class="match-item match-left-item" data-idx="${i}" draggable="false">${p[0]}</div>`;
  });
  html+=`</div><div class="match-right">`;
  shuffledRight.forEach((ri)=>{
    html+=`<div class="match-item match-right-item" data-idx="${ri}" id="matchR${ri}"><div class="match-drop-zone" data-target="${ri}"></div><span>${q.pairs[ri][1]}</span></div>`;
  });
  html+=`</div></div>
  <p style="font-size:0.7rem;color:var(--text-muted);text-align:center;margin-top:0.4rem">Select a left item then click its match on the right</p>
  <button class="quiz-submit-btn" onclick="checkMatch()">Submit Matches</button>`;
  return html;
}
function initMatchDrag(){
  let selectedLeft=null;
  document.querySelectorAll('.match-left-item').forEach(el=>{
    el.onclick=()=>{
      document.querySelectorAll('.match-left-item').forEach(e=>e.classList.remove('selected'));
      el.classList.add('selected');
      selectedLeft=parseInt(el.dataset.idx);
    };
  });
  document.querySelectorAll('.match-right-item').forEach(el=>{
    el.onclick=()=>{
      if(selectedLeft===null) return;
      const rightIdx=parseInt(el.dataset.idx);
      // Remove previous connections to this right item
      Object.keys(window._matchState.connections).forEach(k=>{
        if(window._matchState.connections[k]===rightIdx) delete window._matchState.connections[k];
      });
      window._matchState.connections[selectedLeft]=rightIdx;
      // Visual feedback
      document.querySelectorAll('.match-left-item').forEach(e=>e.classList.remove('selected','matched'));
      document.querySelectorAll('.match-right-item').forEach(e=>e.classList.remove('matched'));
      Object.entries(window._matchState.connections).forEach(([l,r])=>{
        document.querySelector(`.match-left-item[data-idx="${l}"]`).classList.add('matched');
        document.querySelector(`.match-right-item[data-idx="${r}"]`).classList.add('matched');
      });
      selectedLeft=null;
    };
  });
}
function checkMatch(){
  const q=getQ();
  const conn=window._matchState.connections;
  let correctCount=0;
  q.pairs.forEach((p,i)=>{
    const leftEl=document.querySelector(`.match-left-item[data-idx="${i}"]`);
    const isCorrect=conn[i]===i;
    leftEl.classList.remove('matched');
    leftEl.classList.add(isCorrect?'correct':'wrong');
    if(conn[i]!==undefined){
      const rightEl=document.querySelector(`.match-right-item[data-idx="${conn[i]}"]`);
      rightEl.classList.remove('matched');
      rightEl.classList.add(isCorrect?'correct':'wrong');
    }
    if(isCorrect) correctCount++;
  });
  document.querySelectorAll('.match-item').forEach(e=>e.style.pointerEvents='none');
  document.querySelector('.quiz-submit-btn').style.display='none';
  const allCorrect = correctCount===q.pairs.length;
  showFeedback(allCorrect, (allCorrect?'':`${correctCount}/${q.pairs.length} correct. `)+q.explain);
}

// ‚îÄ‚îÄ ORDER / SEQUENCE ‚îÄ‚îÄ
function renderOrder(q){
  const shuffled=q.items.map((_,i)=>i);
  for(let i=shuffled.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[shuffled[i],shuffled[j]]=[shuffled[j],shuffled[i]];}
  window._orderState = { items:q.items, current:shuffled };
  let html=`<div class="order-list" id="orderList">`;
  shuffled.forEach((origIdx,pos)=>{
    html+=`<div class="order-item" data-orig="${origIdx}" data-pos="${pos}">
      <span class="order-handle">‚ò∞</span>
      <span class="order-num">${pos+1}</span>
      <span>${q.items[origIdx]}</span>
      <span class="order-arrows"><button onclick="moveOrder(${pos},-1)">‚ñ≤</button><button onclick="moveOrder(${pos},1)">‚ñº</button></span>
    </div>`;
  });
  html+=`</div>
  <p style="font-size:0.7rem;color:var(--text-muted);text-align:center;margin-top:0.4rem">Use arrows to reorder items</p>
  <button class="quiz-submit-btn" onclick="checkOrder()">Submit Order</button>`;
  return html;
}
function moveOrder(pos, dir){
  const st=window._orderState;
  const newPos=pos+dir;
  if(newPos<0||newPos>=st.current.length) return;
  [st.current[pos],st.current[newPos]]=[st.current[newPos],st.current[pos]];
  // Re-render list
  const list=document.getElementById('orderList');
  list.innerHTML='';
  st.current.forEach((origIdx,p)=>{
    const div=document.createElement('div');
    div.className='order-item';
    div.dataset.orig=origIdx;
    div.dataset.pos=p;
    div.innerHTML=`<span class="order-handle">‚ò∞</span><span class="order-num">${p+1}</span><span>${st.items[origIdx]}</span><span class="order-arrows"><button onclick="moveOrder(${p},-1)">‚ñ≤</button><button onclick="moveOrder(${p},1)">‚ñº</button></span>`;
    list.appendChild(div);
  });
}
function initOrderDrag(){}
function checkOrder(){
  const q=getQ();
  const st=window._orderState;
  const isCorrect=st.current.every((origIdx,pos)=>origIdx===q.answer[pos]);
  document.querySelectorAll('.order-item').forEach((el,i)=>{
    el.style.pointerEvents='none';
    const origIdx=st.current[i];
    el.classList.add(origIdx===q.answer[i]?'correct':'wrong');
  });
  document.querySelectorAll('.order-arrows button').forEach(b=>b.disabled=true);
  document.querySelector('.quiz-submit-btn').style.display='none';
  showFeedback(isCorrect, q.explain);
}

// ‚îÄ‚îÄ NESTED (MULTI-PART) ‚îÄ‚îÄ
function renderNested(q){
  let html=`<div class="nested-parts" id="nestedParts">`;
  q.parts.forEach((part,i)=>{
    html+=`<div class="nested-part" id="nestedPart${i}" style="${i>0?'opacity:0.4;pointer-events:none':''}">
      <div class="nested-part-label">Part ${String.fromCharCode(65+i)}</div>
      <div class="quiz-q" style="font-size:0.92rem">${part.q}</div>
      <div class="quiz-options">${part.options.map((o,j)=>`<button class="quiz-opt nested-opt" data-part="${i}" data-idx="${j}" onclick="checkNested(${i},${j})">${o}</button>`).join('')}</div>
      <div class="quiz-feedback nested-fb" id="nestedFb${i}"></div>
    </div>`;
  });
  html+=`</div>`;
  return html;
}
function checkNested(partIdx, ansIdx){
  const q=getQ();
  const part=q.parts[partIdx];
  const ns=window._nestedState;
  const opts=document.querySelectorAll(`[data-part="${partIdx}"]`);
  opts.forEach((o,i)=>{o.style.pointerEvents='none';if(i===part.answer)o.classList.add('correct');if(i===ansIdx&&ansIdx!==part.answer)o.classList.add('wrong');});
  const fb=document.getElementById('nestedFb'+partIdx);
  const correct=ansIdx===part.answer;
  if(correct) ns.correct++;
  fb.style.background=correct?'rgba(6,214,160,0.1)':'rgba(230,57,70,0.1)';
  fb.style.color=correct?'var(--ecg-green)':'var(--arterial)';
  fb.innerHTML=(correct?'‚úì ':'‚úó ')+part.explain;
  fb.classList.add('show');
  ns.answered++;
  // Unlock next part
  if(partIdx+1<q.parts.length){
    const next=document.getElementById('nestedPart'+(partIdx+1));
    next.style.opacity='1';next.style.pointerEvents='auto';
  }
  // All parts done
  if(ns.answered>=ns.total){
    const allCorrect=ns.correct===ns.total;
    if(allCorrect) quizScore++;
    const mainFb=document.getElementById('quizFb');
    mainFb.style.background=allCorrect?'rgba(6,214,160,0.1)':'rgba(230,57,70,0.1)';
    mainFb.style.color=allCorrect?'var(--ecg-green)':'var(--arterial)';
    mainFb.innerHTML=`${ns.correct}/${ns.total} parts correct. ${allCorrect?'Perfect!':'Review the explanations above.'}`;
    mainFb.classList.add('show');
    document.getElementById('quizNext').classList.add('show');
  }
}

// ‚îÄ‚îÄ FEEDBACK HELPER ‚îÄ‚îÄ
function showFeedback(correct, explain){
  if(correct) quizScore++;
  const fb=document.getElementById('quizFb');
  fb.style.background=correct?'rgba(6,214,160,0.1)':'rgba(230,57,70,0.1)';
  fb.style.color=correct?'var(--ecg-green)':'var(--arterial)';
  fb.innerHTML=(correct?'‚úì Correct! ':'‚úó Incorrect. ')+explain;
  fb.classList.add('show');
  document.getElementById('quizNext').classList.add('show');
}

// ‚îÄ‚îÄ PDF CERTIFICATE GENERATION ‚îÄ‚îÄ
function generateCertificate(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'landscape', unit:'mm', format:'letter' });
  const W = 279.4, H = 215.9; // letter landscape mm
  const total = quizQuestions.length;
  const pct = Math.round((quizScore/total)*100);
  const grade = pct>=90?'A':pct>=80?'B':pct>=70?'C':pct>=60?'D':'F';
  const elapsed = Math.round((studentInfo.endTime - studentInfo.startTime)/60000);
  const dateStr = studentInfo.endTime.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});

  // ‚îÄ‚îÄ Background
  doc.setFillColor(26,26,46); // dark navy
  doc.rect(0,0,W,H,'F');

  // ‚îÄ‚îÄ Outer border (gold double-line)
  doc.setDrawColor(201,168,76); // gold
  doc.setLineWidth(1.2);
  doc.rect(8,8,W-16,H-16);
  doc.setLineWidth(0.4);
  doc.rect(11,11,W-22,H-22);

  // ‚îÄ‚îÄ Corner ornaments
  const cornerSize = 12;
  const corners = [[14,14],[W-14,14],[14,H-14],[W-14,H-14]];
  doc.setDrawColor(201,168,76);
  doc.setLineWidth(0.6);
  corners.forEach(([cx,cy])=>{
    const dx = cx < W/2 ? 1 : -1;
    const dy = cy < H/2 ? 1 : -1;
    doc.line(cx, cy, cx + cornerSize*dx, cy);
    doc.line(cx, cy, cx, cy + cornerSize*dy);
    doc.line(cx + cornerSize*dx*0.3, cy + cornerSize*dy*0.3, cx + cornerSize*dx, cy + cornerSize*dy*0.3);
    doc.line(cx + cornerSize*dx*0.3, cy + cornerSize*dy*0.3, cx + cornerSize*dx*0.3, cy + cornerSize*dy);
  });

  // ‚îÄ‚îÄ Decorative line top
  const cx = W/2;
  doc.setDrawColor(201,168,76);
  doc.setLineWidth(0.5);
  doc.line(cx-60, 32, cx+60, 32);
  doc.line(cx-40, 34, cx+40, 34);

  // ‚îÄ‚îÄ Institution header
  doc.setTextColor(201,168,76);
  doc.setFont('helvetica','bold');
  doc.setFontSize(10);
  doc.text('PAUL D. CAMP COMMUNITY COLLEGE', cx, 26, {align:'center'});
  doc.setFontSize(7.5);
  doc.setFont('helvetica','normal');
  doc.setTextColor(160,160,180);
  doc.text('Emergency Medical Services Program', cx, 30, {align:'center'});

  // ‚îÄ‚îÄ Title
  doc.setTextColor(255,255,255);
  doc.setFont('helvetica','bold');
  doc.setFontSize(28);
  doc.text('Certificate of Completion', cx, 50, {align:'center'});

  // ‚îÄ‚îÄ Decorative line below title
  doc.setDrawColor(201,168,76);
  doc.setLineWidth(0.5);
  doc.line(cx-55, 54, cx+55, 54);

  // ‚îÄ‚îÄ "This certifies that"
  doc.setFont('helvetica','normal');
  doc.setFontSize(11);
  doc.setTextColor(180,180,200);
  doc.text('This certifies that', cx, 65, {align:'center'});

  // ‚îÄ‚îÄ Student Name (large)
  doc.setFont('helvetica','bold');
  doc.setFontSize(26);
  doc.setTextColor(0,230,118); // ecg green
  doc.text(studentInfo.name, cx, 78, {align:'center'});

  // ‚îÄ‚îÄ Underline name
  const nameWidth = doc.getTextWidth(studentInfo.name);
  doc.setDrawColor(0,230,118);
  doc.setLineWidth(0.3);
  doc.line(cx - nameWidth/2 - 5, 80, cx + nameWidth/2 + 5, 80);

  // ‚îÄ‚îÄ Student ID
  doc.setFont('helvetica','normal');
  doc.setFontSize(9);
  doc.setTextColor(140,140,160);
  doc.text('Student ID: ' + studentInfo.id, cx, 86, {align:'center'});

  // ‚îÄ‚îÄ "has successfully completed"
  doc.setFontSize(11);
  doc.setTextColor(180,180,200);
  doc.text('has successfully completed the', cx, 96, {align:'center'});

  // ‚îÄ‚îÄ Course title
  doc.setFont('helvetica','bold');
  doc.setFontSize(16);
  doc.setTextColor(255,255,255);
  doc.text('Cardiology Interactive ‚Äî Comprehensive Assessment', cx, 106, {align:'center'});

  doc.setFont('helvetica','normal');
  doc.setFontSize(9);
  doc.setTextColor(140,140,160);
  doc.text("Sanders' Paramedic Textbook Interactive Edition", cx, 112, {align:'center'});

  // ‚îÄ‚îÄ Score box
  const boxW = 150, boxH = 32, boxX = cx - boxW/2, boxY = 120;
  doc.setFillColor(35,35,60);
  doc.setDrawColor(201,168,76);
  doc.setLineWidth(0.5);
  doc.roundedRect(boxX, boxY, boxW, boxH, 3, 3, 'FD');

  // Score details inside box
  doc.setFont('helvetica','bold');
  doc.setFontSize(22);
  doc.setTextColor(0,230,118);
  doc.text(pct + '%', boxX + 25, boxY + 14, {align:'center'});
  
  doc.setFontSize(10);
  doc.setTextColor(201,168,76);
  doc.text('Grade: ' + grade, boxX + 25, boxY + 22, {align:'center'});

  // Divider in box
  doc.setDrawColor(80,80,100);
  doc.setLineWidth(0.3);
  doc.line(boxX + 50, boxY + 5, boxX + 50, boxY + boxH - 5);

  doc.setFont('helvetica','normal');
  doc.setFontSize(8.5);
  doc.setTextColor(180,180,200);
  doc.text(quizScore + ' of ' + total + ' questions correct', boxX + 100, boxY + 10, {align:'center'});
  doc.text('Duration: ' + elapsed + ' minutes', boxX + 100, boxY + 17, {align:'center'});
  doc.text('Date: ' + dateStr, boxX + 100, boxY + 24, {align:'center'});

  // ‚îÄ‚îÄ Assessment details
  doc.setFontSize(7.5);
  doc.setTextColor(120,120,140);
  doc.text('Assessment includes: Multiple Choice ¬∑ Select All ¬∑ Fill-in-the-Blank ¬∑ Matching ¬∑ Sequencing ¬∑ Clinical Scenarios', cx, boxY + boxH + 8, {align:'center'});
  doc.text('Topics: ECG Interpretation ¬∑ Dysrhythmias ¬∑ AV Blocks ¬∑ ACS/STEMI ¬∑ Cardiac Pharmacology ¬∑ Cardiac Emergencies ¬∑ ACLS', cx, boxY + boxH + 14, {align:'center'});

  // ‚îÄ‚îÄ Signature lines
  const sigY = 178;
  doc.setDrawColor(201,168,76);
  doc.setLineWidth(0.3);
  // Left signature
  doc.line(35, sigY, 115, sigY);
  doc.setFont('helvetica','normal');
  doc.setFontSize(8);
  doc.setTextColor(160,160,180);
  doc.text('Program Director', 75, sigY + 5, {align:'center'});
  doc.setFont('helvetica','bold');
  doc.setFontSize(9);
  doc.setTextColor(201,168,76);
  doc.text('CAMP EMS Program', 75, sigY + 10, {align:'center'});
  
  // Right signature
  doc.line(W-115, sigY, W-35, sigY);
  doc.setFont('helvetica','normal');
  doc.setFontSize(8);
  doc.setTextColor(160,160,180);
  doc.text('Date of Completion', W-75, sigY + 5, {align:'center'});
  doc.setFont('helvetica','bold');
  doc.setFontSize(9);
  doc.setTextColor(201,168,76);
  doc.text(dateStr, W-75, sigY + 10, {align:'center'});

  // ‚îÄ‚îÄ Bottom decorative line
  doc.setDrawColor(201,168,76);
  doc.setLineWidth(0.5);
  doc.line(cx-40, 196, cx+40, 196);
  doc.line(cx-55, 198, cx+55, 198);

  // ‚îÄ‚îÄ Footer
  doc.setFont('helvetica','normal');
  doc.setFontSize(6.5);
  doc.setTextColor(100,100,120);
  doc.text('Paul D. Camp Community College ¬∑ Suffolk, Virginia ¬∑ Emergency Medical Services Program', cx, 204, {align:'center'});
  doc.text('Certificate ID: CAMP-EMS-' + studentInfo.id + '-' + Date.now().toString(36).toUpperCase(), cx, 208, {align:'center'});

  // ‚îÄ‚îÄ ECG trace decoration (subtle)
  doc.setDrawColor(0,230,118);
  doc.setLineWidth(0.2);
  const ecgY = 194;
  let ex = 15;
  // Draw a small ECG-like trace
  for(let beat=0; beat<8; beat++){
    const bx = ex + beat*32;
    doc.line(bx, ecgY, bx+8, ecgY); // baseline
    doc.line(bx+8, ecgY, bx+9, ecgY-1); // P
    doc.line(bx+9, ecgY-1, bx+10, ecgY); // P down
    doc.line(bx+10, ecgY, bx+12, ecgY); // PR
    doc.line(bx+12, ecgY, bx+13, ecgY+2); // Q
    doc.line(bx+13, ecgY+2, bx+15, ecgY-6); // R
    doc.line(bx+15, ecgY-6, bx+17, ecgY+3); // S
    doc.line(bx+17, ecgY+3, bx+19, ecgY); // return
    doc.line(bx+19, ecgY, bx+23, ecgY); // ST
    doc.line(bx+23, ecgY, bx+26, ecgY-2); // T up
    doc.line(bx+26, ecgY-2, bx+29, ecgY); // T down
    doc.line(bx+29, ecgY, bx+32, ecgY); // baseline
  }

  // Save
  const filename = 'CAMP_EMS_Certificate_' + studentInfo.name.replace(/\s+/g,'_') + '_' + studentInfo.id + '.pdf';
  doc.save(filename);
}

// ================================================================
// INIT
// ================================================================
window.addEventListener('load', () => {
  buildECGControls();
  initECG();
  drawCompWaveform();
  initHSWaveforms();
  drawAxisDiagram('normal');
  draw12Lead();
  buildGallery();
  buildQuiz();
  drawHeroEcg();
  setTimeout(startConductionAnim, 1000);
});
window.addEventListener('resize', () => {
  resizeECGCanvas();
  drawCompWaveform();
  initHSWaveforms();
  drawAxisDiagram(currentAxis);
  draw12Lead();
  drawHeroEcg();
});
</script>
</body>
</html>
