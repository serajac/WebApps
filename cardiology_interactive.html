<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chapter 21 ‚Äî Cardiology | Interactive EMS Education</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700&family=Playfair+Display:wght@700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --cardiac-red:#C8102E;--arterial:#E63946;--venous:#457B9D;--oxy-red:#FF4D6D;
  --deoxy-blue:#1D3557;--ecg-green:#00FF88;--bg-dark:#0A0E17;--bg-card:#111827;
  --bg-surface:#1A2332;--text-primary:#F1F5F9;--text-secondary:#94A3B8;
  --text-muted:#64748B;--accent-gold:#FFD166;--sa-node:#FFD166;--av-node:#06D6A0;
  --bundle-his:#118AB2;--purkinje:#EF476F;--warning:#FF6B35;--success:#06D6A0;
  --ecg-paper:#1C1410;--ecg-grid-sm:rgba(180,100,80,0.18);--ecg-grid-lg:rgba(180,100,80,0.38);
  --ecg-grid-6s:rgba(200,120,90,0.55);
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{font-family:'DM Sans',sans-serif;background:var(--bg-dark);color:var(--text-primary);overflow-x:hidden;line-height:1.7;}

/* NAV */
.nav{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(10,14,23,0.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(200,16,46,0.15);padding:0 2rem;display:flex;align-items:center;justify-content:space-between;height:60px;}
.nav-brand{font-family:'Playfair Display',serif;font-weight:800;font-size:1.05rem;background:linear-gradient(135deg,var(--cardiac-red),var(--oxy-red));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.nav-links{display:flex;gap:0.2rem;overflow-x:auto;scrollbar-width:none;max-width:72vw;}
.nav-links::-webkit-scrollbar{display:none;}
.nav-link{padding:0.35rem 0.7rem;border-radius:6px;font-size:0.72rem;font-weight:500;color:var(--text-secondary);cursor:pointer;white-space:nowrap;transition:all 0.2s;text-decoration:none;border:1px solid transparent;}
.nav-link:hover,.nav-link.active{color:var(--text-primary);background:rgba(200,16,46,0.12);border-color:rgba(200,16,46,0.25);}
.progress-bar{position:fixed;top:60px;left:0;height:3px;background:linear-gradient(90deg,var(--cardiac-red),var(--oxy-red),var(--ecg-green));z-index:99;transition:width 0.3s;}

/* SECTIONS */
section{min-height:100vh;padding:90px 2rem 4rem;max-width:1200px;margin:0 auto;opacity:0;transform:translateY(30px);transition:all 0.8s cubic-bezier(0.16,1,0.3,1);}
section.visible{opacity:1;transform:translateY(0);}
.section-label{font-size:0.68rem;text-transform:uppercase;letter-spacing:3px;color:var(--cardiac-red);font-weight:700;margin-bottom:0.4rem;}
.section-title{font-family:'Playfair Display',serif;font-size:clamp(2rem,5vw,3.2rem);font-weight:900;line-height:1.15;margin-bottom:1.2rem;}
.section-title .gradient{background:linear-gradient(135deg,var(--cardiac-red),var(--oxy-red),var(--accent-gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.section-subtitle{font-size:1.05rem;color:var(--text-secondary);max-width:700px;margin-bottom:2rem;}

/* CARDS */
.card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.15rem;}
.card{background:var(--bg-card);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:1.5rem;transition:all 0.3s;position:relative;overflow:hidden;cursor:pointer;}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--cardiac-red),var(--oxy-red));opacity:0;transition:opacity 0.3s;}
.card:hover{transform:translateY(-3px);border-color:rgba(200,16,46,0.2);}
.card:hover::before{opacity:1;}
.card-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.15rem;margin-bottom:0.8rem;}
.card h3{font-size:1rem;font-weight:700;margin-bottom:0.4rem;}
.card p{font-size:0.85rem;color:var(--text-secondary);line-height:1.6;}

/* ===== ECG PAPER BACKGROUND (realistic) ===== */
.ecg-paper-bg{
  position:relative;
  background:var(--ecg-paper);
  border-radius:12px;overflow:hidden;
  border:2px solid rgba(180,100,80,0.25);
}
.ecg-paper-bg canvas{display:block;position:relative;z-index:2;}
.ecg-paper-grid{
  position:absolute;inset:0;z-index:1;
  /* We draw the grid in JS for accuracy */
}

/* ECG MONITOR FRAME */
.ecg-monitor{margin:2rem 0;position:relative;}
.ecg-monitor-header{display:flex;justify-content:space-between;align-items:center;padding:0.75rem 1.25rem;background:rgba(28,20,16,0.95);border:2px solid rgba(180,100,80,0.25);border-bottom:none;border-radius:12px 12px 0 0;}
.ecg-monitor-header .lead-label{font-family:'JetBrains Mono',monospace;font-size:0.8rem;color:rgba(180,100,80,0.7);}
.ecg-monitor-header .rate-display{font-family:'JetBrains Mono',monospace;font-size:2.2rem;font-weight:600;color:var(--ecg-green);line-height:1;}
.ecg-monitor-header .rate-display span{font-size:0.7rem;color:var(--text-muted);display:block;}
.ecg-monitor-header .rhythm-name{font-family:'JetBrains Mono',monospace;font-size:0.85rem;color:var(--ecg-green);text-align:right;}
.ecg-paper-bg.monitor-body{border-radius:0 0 12px 12px;border-top:none;}

.ecg-controls{display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:1rem;align-items:center;}
.ecg-btn{padding:0.45rem 0.85rem;border-radius:7px;font-size:0.78rem;font-weight:600;border:1px solid rgba(255,255,255,0.1);background:var(--bg-surface);color:var(--text-primary);cursor:pointer;transition:all 0.2s;font-family:'DM Sans',sans-serif;}
.ecg-btn:hover{border-color:var(--ecg-green);color:var(--ecg-green);}
.ecg-btn.active{background:rgba(6,214,160,0.15);border-color:var(--ecg-green);color:var(--ecg-green);}

/* 6-second markers */
.ecg-6s-markers{display:flex;justify-content:space-around;padding:0.3rem 1rem;font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:rgba(180,100,80,0.6);}

/* ===== MODAL / POPUP ===== */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:500;display:none;align-items:center;justify-content:center;padding:1.5rem;backdrop-filter:blur(6px);opacity:0;transition:opacity 0.3s;}
.modal-overlay.open{display:flex;opacity:1;}
.modal{background:var(--bg-card);border:1px solid rgba(200,16,46,0.2);border-radius:20px;max-width:900px;width:100%;max-height:88vh;overflow-y:auto;position:relative;animation:modalIn 0.35s cubic-bezier(0.16,1,0.3,1);}
@keyframes modalIn{from{opacity:0;transform:translateY(20px) scale(0.97);}to{opacity:1;transform:translateY(0) scale(1);}}
.modal-close{position:sticky;top:0;right:0;float:right;z-index:10;width:42px;height:42px;border-radius:50%;border:1px solid rgba(255,255,255,0.1);background:var(--bg-dark);color:var(--text-primary);font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;margin:1rem 1rem 0 0;transition:all 0.2s;}
.modal-close:hover{background:var(--cardiac-red);border-color:var(--cardiac-red);}
.modal-body{padding:0 2.5rem 2.5rem;}
.modal-body h2{font-family:'Playfair Display',serif;font-size:2rem;font-weight:900;margin-bottom:0.3rem;}
.modal-body h2 .gradient{background:linear-gradient(135deg,var(--cardiac-red),var(--oxy-red));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.modal-body .modal-sub{font-size:0.9rem;color:var(--text-muted);margin-bottom:1.5rem;}
.modal-body h3{font-size:1.15rem;font-weight:700;margin:1.5rem 0 0.5rem;color:var(--accent-gold);}
.modal-body p,.modal-body li{font-size:0.95rem;color:var(--text-secondary);line-height:1.75;margin-bottom:0.5rem;}
.modal-body ul{padding-left:1.2rem;}
.modal-body .highlight-box{background:rgba(6,214,160,0.08);border-left:3px solid var(--ecg-green);padding:1rem 1.25rem;border-radius:0 10px 10px 0;margin:1rem 0;}
.modal-body .highlight-box.red{background:rgba(200,16,46,0.08);border-left-color:var(--cardiac-red);}
.modal-body .highlight-box.gold{background:rgba(255,209,102,0.08);border-left-color:var(--accent-gold);}
.modal-body .formula{font-family:'JetBrains Mono',monospace;font-size:1.3rem;color:var(--ecg-green);text-align:center;padding:1rem;background:rgba(6,214,160,0.06);border-radius:10px;margin:1rem 0;}
.modal-body .ecg-paper-bg{margin:1rem 0;}

/* Rhythm card in modal */
.modal-rhythm-strip{margin:1rem 0;}
.modal-rhythm-chars{display:grid;grid-template-columns:1fr 1fr;gap:0.5rem 1.5rem;margin:1rem 0;}
.modal-rhythm-chars .char-item{font-size:0.9rem;color:var(--text-secondary);}
.modal-rhythm-chars .char-item strong{color:var(--text-primary);}

/* ===== HERO ===== */
.hero{min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;position:relative;padding-top:60px;}
.hero-bg{position:absolute;inset:0;background:radial-gradient(ellipse at 50% 30%,rgba(200,16,46,0.12) 0%,transparent 60%),radial-gradient(ellipse at 80% 70%,rgba(69,123,157,0.08) 0%,transparent 50%);}
.hero-content{position:relative;z-index:1;}
.hero-chapter{font-size:0.72rem;text-transform:uppercase;letter-spacing:4px;color:var(--cardiac-red);margin-bottom:0.8rem;font-weight:700;}
.hero h1{font-family:'Playfair Display',serif;font-size:clamp(3rem,8vw,5.5rem);font-weight:900;line-height:1.05;margin-bottom:1.2rem;}
.hero h1 .red{background:linear-gradient(135deg,var(--cardiac-red),var(--oxy-red));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.hero-sub{font-size:1.1rem;color:var(--text-secondary);max-width:600px;margin:0 auto 2rem;}
@keyframes heroHeartbeat{0%,100%{transform:scale(1);}10%{transform:scale(1.15);}20%{transform:scale(1);}30%{transform:scale(1.1);}40%{transform:scale(1);}}
.hero-heart{font-size:3rem;margin-bottom:0.8rem;display:inline-block;animation:heroHeartbeat 1.5s ease-in-out infinite;}
.hero-stats{display:flex;gap:3rem;justify-content:center;flex-wrap:wrap;}
.hero-stat .num{font-family:'JetBrains Mono',monospace;font-size:2rem;font-weight:700;color:var(--ecg-green);}
.hero-stat .lbl{font-size:0.72rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;}
/* Hero ECG strip */
.hero-ecg-wrap{margin-top:2.5rem;width:min(90vw,800px);}

/* ===== HEART SVG ===== */
.heart-container{display:flex;flex-wrap:wrap;gap:2.5rem;align-items:center;justify-content:center;margin:1.5rem 0;}
.heart-svg-wrap{flex:1;min-width:320px;max-width:460px;}
.heart-info{flex:1;min-width:280px;}
.heart-info .info-item{padding:0.9rem 1.1rem;border-radius:10px;margin-bottom:0.6rem;cursor:pointer;border:1px solid rgba(255,255,255,0.05);transition:all 0.3s;}
.heart-info .info-item:hover,.heart-info .info-item.active{background:var(--bg-surface);border-color:rgba(200,16,46,0.3);}
.info-item .label{font-size:0.65rem;text-transform:uppercase;letter-spacing:2px;color:var(--text-muted);margin-bottom:0.2rem;}
.info-item .title{font-weight:700;font-size:0.9rem;margin-bottom:0.15rem;}
.info-item .desc{font-size:0.8rem;color:var(--text-secondary);}
#heartSvg{width:100%;height:auto;}
.heart-chamber{transition:all 0.4s;cursor:pointer;}
.heart-chamber:hover{filter:brightness(1.3);}
@keyframes heartbeat{0%,100%{transform:scale(1);}15%{transform:scale(1.04);}30%{transform:scale(0.98);}45%{transform:scale(1.02);}}
.heart-beating{animation:heartbeat 0.86s ease-in-out infinite;transform-origin:center;}
@keyframes pulseRing{0%{r:8;opacity:0.8;}100%{r:25;opacity:0;}}
.pulse-ring{animation:pulseRing 0.86s ease-out infinite;}

/* Conduction */
.conduction-visual{display:flex;flex-wrap:wrap;gap:2rem;align-items:flex-start;margin:2rem 0;}
.conduction-svg-wrap{flex:1.2;min-width:320px;}
.conduction-timeline{flex:1;min-width:260px;}
.timeline-step{display:flex;gap:1rem;margin-bottom:1.3rem;opacity:0.3;transition:all 0.5s;padding:0.5rem;border-radius:8px;}
.timeline-step:hover{opacity:0.7;background:rgba(255,255,255,0.03);transform:translateX(4px);}
.timeline-step.active{opacity:1;background:rgba(255,255,255,0.04);transform:translateX(6px);}
.formula{text-align:center;font:700 1.2rem 'JetBrains Mono',monospace;color:var(--ecg-green);background:rgba(0,230,118,0.08);border:1px solid rgba(0,230,118,0.15);padding:0.6rem 1rem;border-radius:8px;margin:0.8rem 0;}
.step-dot{width:14px;height:14px;border-radius:50%;flex-shrink:0;margin-top:4px;position:relative;}
.step-dot::after{content:'';position:absolute;top:14px;left:50%;width:2px;height:36px;transform:translateX(-50%);background:rgba(255,255,255,0.08);}
.timeline-step:last-child .step-dot::after{display:none;}
.step-content h4{font-size:0.85rem;font-weight:700;margin-bottom:0.15rem;}
.step-content p{font-size:0.78rem;color:var(--text-secondary);}
.step-content .rate{font-family:'JetBrains Mono',monospace;font-size:0.72rem;color:var(--accent-gold);}

/* ECG Component viewer */
.ecg-components{position:relative;margin:2rem 0;background:var(--bg-card);border-radius:14px;padding:1.75rem;border:1px solid rgba(255,255,255,0.06);}
.ecg-comp-labels{display:flex;flex-wrap:wrap;gap:0.4rem;margin-top:1rem;justify-content:center;}
.comp-label{padding:0.35rem 0.8rem;border-radius:18px;font-size:0.75rem;font-weight:600;cursor:pointer;border:2px solid transparent;transition:all 0.3s;background:var(--bg-surface);}
.comp-label:hover,.comp-label.active{transform:scale(1.05);}
.comp-detail{text-align:center;margin-top:1rem;min-height:50px;}
.comp-detail h4{font-size:1rem;margin-bottom:0.2rem;}
.comp-detail p{font-size:0.85rem;color:var(--text-secondary);max-width:600px;margin:0 auto;}

/* Dysrhythmia Gallery */
.rhythm-gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(310px,1fr));gap:1.15rem;margin:1.5rem 0;}
.rhythm-card{background:var(--bg-card);border-radius:14px;border:1px solid rgba(255,255,255,0.06);overflow:hidden;transition:all 0.3s;cursor:pointer;}
.rhythm-card:hover{border-color:rgba(6,214,160,0.3);transform:translateY(-3px);}
.rhythm-canvas-wrap{padding:0.75rem;border-bottom:1px solid rgba(255,255,255,0.04);}
.rhythm-info{padding:1.1rem 1.25rem;}
.rhythm-info h4{font-size:0.92rem;margin-bottom:0.25rem;}
.rhythm-info .rhythm-chars{font-size:0.78rem;color:var(--text-secondary);margin-bottom:0.4rem;}
.rhythm-badge{display:inline-block;padding:0.15rem 0.5rem;border-radius:5px;font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;}
.badge-sa{background:rgba(255,209,102,0.15);color:var(--sa-node);}
.badge-atrial{background:rgba(6,214,160,0.15);color:var(--av-node);}
.badge-junctional{background:rgba(17,138,178,0.15);color:var(--bundle-his);}
.badge-ventricular{background:rgba(239,71,111,0.15);color:var(--purkinje);}
.badge-block{background:rgba(255,107,53,0.15);color:var(--warning);}

/* Tabs */
.tab-bar{display:flex;gap:0.2rem;margin-bottom:1.5rem;border-bottom:1px solid rgba(255,255,255,0.06);overflow-x:auto;scrollbar-width:none;}
.tab-bar::-webkit-scrollbar{display:none;}
.tab-btn{padding:0.65rem 1.1rem;font-size:0.82rem;font-weight:600;border:none;background:none;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:all 0.3s;font-family:'DM Sans',sans-serif;}
.tab-btn:hover{color:var(--text-secondary);}
.tab-btn.active{color:var(--text-primary);border-bottom-color:var(--cardiac-red);}
.tab-content{display:none;}
.tab-content.active{display:block;animation:fadeIn 0.4s;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

/* Key grid */
.key-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:0.9rem;margin:1.2rem 0;}
.key-item{padding:1.1rem;border-radius:11px;background:var(--bg-card);border:1px solid rgba(255,255,255,0.06);cursor:pointer;transition:all 0.3s;}
.key-item:hover{border-color:rgba(200,16,46,0.2);transform:translateY(-2px);}
.key-item h4{font-size:0.88rem;margin-bottom:0.25rem;}
.key-item p{font-size:0.8rem;color:var(--text-secondary);}
.key-item .highlight{font-family:'JetBrains Mono',monospace;color:var(--ecg-green);font-weight:600;}

/* Pathway */
.pathway{display:flex;flex-direction:column;gap:0;margin:1.5rem 0;position:relative;}
.pathway::before{content:'';position:absolute;left:24px;top:0;bottom:0;width:2px;background:rgba(200,16,46,0.2);}
.pathway-step{display:flex;gap:1.1rem;position:relative;padding:1rem 0;}
.pathway-num{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1rem;flex-shrink:0;background:var(--bg-card);border:2px solid var(--cardiac-red);color:var(--cardiac-red);z-index:1;}
.pathway-content{background:var(--bg-card);border-radius:12px;padding:1.1rem 1.3rem;flex:1;border:1px solid rgba(255,255,255,0.06);}
.pathway-content h4{font-size:0.95rem;margin-bottom:0.3rem;}
.pathway-content p{font-size:0.82rem;color:var(--text-secondary);}

/* Quiz */
.quiz-container{max-width:700px;margin:2rem auto;}
.quiz-question-card{background:var(--bg-card);border-radius:14px;padding:1.75rem;border:1px solid rgba(255,255,255,0.06);}
.quiz-progress{display:flex;gap:3px;margin-bottom:1.2rem;}
.quiz-dot{flex:1;height:4px;border-radius:2px;background:rgba(255,255,255,0.08);transition:background 0.3s;}
.quiz-dot.done{background:var(--ecg-green);}
.quiz-dot.current{background:var(--accent-gold);}
.quiz-q{font-size:1.05rem;font-weight:700;margin-bottom:0.35rem;}
.quiz-q-sub{font-size:0.82rem;color:var(--text-secondary);margin-bottom:1.2rem;}
.quiz-options{display:flex;flex-direction:column;gap:0.5rem;}
.quiz-opt{padding:0.75rem 1rem;border-radius:9px;border:1px solid rgba(255,255,255,0.08);background:var(--bg-surface);cursor:pointer;font-size:0.88rem;font-weight:500;transition:all 0.25s;font-family:'DM Sans',sans-serif;color:var(--text-primary);text-align:left;}
.quiz-opt:hover{border-color:rgba(255,255,255,0.2);}
.quiz-opt.correct{border-color:var(--ecg-green);background:rgba(6,214,160,0.12);}
.quiz-opt.wrong{border-color:var(--arterial);background:rgba(230,57,70,0.12);}
.quiz-feedback{margin-top:0.8rem;padding:0.9rem;border-radius:9px;font-size:0.85rem;display:none;}
.quiz-feedback.show{display:block;}
.quiz-next{margin-top:0.8rem;padding:0.5rem 1.2rem;background:var(--cardiac-red);border:none;color:white;border-radius:7px;cursor:pointer;font-weight:600;font-size:0.82rem;font-family:'DM Sans',sans-serif;display:none;}
.quiz-next.show{display:inline-block;}
.quiz-score{text-align:center;padding:2.5rem 1.5rem;}
.quiz-score .big-num{font-family:'Playfair Display',serif;font-size:3.5rem;font-weight:900;}

.fade-up{opacity:0;transform:translateY(18px);transition:all 0.6s cubic-bezier(0.16,1,0.3,1);}
.fade-up.visible{opacity:1;transform:translateY(0);}

@media(max-width:768px){
  section{padding:80px 1.1rem 2.5rem;}
  .nav{padding:0 0.8rem;}
  .nav-links{max-width:55vw;}
  .heart-container,.conduction-visual{flex-direction:column;}
  .hero-stats{gap:1.5rem;}
  .modal-body{padding:0 1.5rem 1.5rem;}
  .modal-body h2{font-size:1.5rem;}
  .modal{max-height:92vh;}
}
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav">
  <div class="nav-brand">‚ô• Ch.21 Cardiology</div>
  <div class="nav-links">
    <a class="nav-link active" href="#hero">Home</a>
    <a class="nav-link" href="#anatomy">Anatomy</a>
    <a class="nav-link" href="#conduction">Conduction</a>
    <a class="nav-link" href="#ecg">ECG Monitor</a>
    <a class="nav-link" href="#ecg-components">Waveforms</a>
    <a class="nav-link" href="#rhythms">Dysrhythmias</a>
    <a class="nav-link" href="#blocks">AV Blocks</a>
    <a class="nav-link" href="#acs">ACS</a>
    <a class="nav-link" href="#emergencies">Emergencies</a>
    <a class="nav-link" href="#resuscitation">Resuscitation</a>
    <a class="nav-link" href="#quiz">Quiz</a>
  </div>
</nav>
<div class="progress-bar" id="progressBar"></div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<!-- HERO -->
<section class="hero" id="hero">
  <div class="hero-bg"></div>
  <div class="hero-content">
    <div class="hero-heart">ü´Ä</div>
    <div class="hero-chapter">Chapter 21 ‚Äî Sanders' Paramedic Textbook</div>
    <h1><span class="red">Cardiology</span></h1>
    <p class="hero-sub">Interactive cardiac anatomy, electrophysiology, ECG interpretation, dysrhythmia recognition, and emergency cardiac care for EMS professionals.</p>
    <div class="hero-stats">
      <div class="hero-stat"><div class="num">236</div><div class="lbl">Topics Covered</div></div>
      <div class="hero-stat"><div class="num">27</div><div class="lbl">ECG Rhythms</div></div>
      <div class="hero-stat"><div class="num">10</div><div class="lbl">Quiz Questions</div></div>
    </div>
    <div class="hero-ecg-wrap">
      <div class="ecg-paper-bg" style="margin-top:1rem">
        <canvas id="heroEcgCanvas" height="100"></canvas>
      </div>
    </div>
  </div>
</section>

<!-- 1. RISK FACTORS -->
<section id="risk">
  <div class="section-label">Section 01</div>
  <div class="section-title">Risk Factors & <span class="gradient">Prevention</span></div>
  <p class="section-subtitle">CAD with sudden death remains a major cause of morbidity and mortality. Click any card to expand.</p>
  <div class="card-grid">
    <div class="card fade-up" onclick="openModal('risk-nonmod')"><div class="card-icon" style="background:rgba(239,71,111,0.12);color:var(--purkinje)">‚ö†Ô∏è</div><h3>Non-Modifiable Risk Factors</h3><p>Advanced age, male sex, hereditary factors, ethnicity.</p></div>
    <div class="card fade-up" onclick="openModal('risk-mod')"><div class="card-icon" style="background:rgba(6,214,160,0.12);color:var(--ecg-green)">‚úÖ</div><h3>Modifiable Risk Factors</h3><p>Smoking, BP, diabetes, cholesterol, exercise, weight, diet.</p></div>
    <div class="card fade-up" onclick="openModal('risk-prevent')"><div class="card-icon" style="background:rgba(255,209,102,0.12);color:var(--accent-gold)">üíä</div><h3>Prevention Strategies</h3><p>Statins, aspirin, beta blockers, lifestyle changes, community education.</p></div>
  </div>
</section>

<!-- 2. ANATOMY -->
<section id="anatomy">
  <div class="section-label">Section 02</div>
  <div class="section-title">Anatomy of the <span class="gradient">Heart</span></div>
  <p class="section-subtitle">Click each structure on the heart or the labels to explore.</p>
  <div class="heart-container">
    <div class="heart-svg-wrap">
      <svg id="heartSvg" viewBox="0 0 500 480" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <radialGradient id="raGrad" cx="50%" cy="50%"><stop offset="0%" stop-color="#6B3A3A"/><stop offset="100%" stop-color="#3D1F1F"/></radialGradient>
          <radialGradient id="rvGrad" cx="50%" cy="50%"><stop offset="0%" stop-color="#2B4A6B"/><stop offset="100%" stop-color="#1A2F45"/></radialGradient>
          <radialGradient id="laGrad" cx="50%" cy="50%"><stop offset="0%" stop-color="#8B3A3A"/><stop offset="100%" stop-color="#5A2222"/></radialGradient>
          <radialGradient id="lvGrad" cx="50%" cy="50%"><stop offset="0%" stop-color="#C8102E"/><stop offset="100%" stop-color="#7A0A1C"/></radialGradient>
          <filter id="glow"><feGaussianBlur stdDeviation="3" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        </defs>
        <g class="heart-beating">
          <path d="M250,60 C250,60 220,30 190,50 C160,70 180,110 210,130" fill="none" stroke="#C8102E" stroke-width="14" stroke-linecap="round" opacity="0.7"/>
          <path d="M250,60 C250,60 280,20 320,40 C350,55 340,100 310,120" fill="none" stroke="#C8102E" stroke-width="14" stroke-linecap="round" opacity="0.7"/>
          <path d="M150,50 C150,50 155,90 160,130" fill="none" stroke="#457B9D" stroke-width="12" stroke-linecap="round" opacity="0.6"/>
          <path d="M270,80 C290,60 330,50 350,65" fill="none" stroke="#457B9D" stroke-width="8" stroke-linecap="round" opacity="0.5"/>
          <path d="M230,80 C210,55 170,45 150,55" fill="none" stroke="#E63946" stroke-width="8" stroke-linecap="round" opacity="0.5"/>
          <path d="M250,100 C160,100 100,160 100,240 C100,340 180,420 250,450 C320,420 400,340 400,240 C400,160 340,100 250,100Z" fill="#2A1520" stroke="rgba(200,16,46,0.3)" stroke-width="2"/>
          <line x1="250" y1="120" x2="250" y2="430" stroke="rgba(255,255,255,0.15)" stroke-width="3"/>
          <path class="heart-chamber" data-chamber="ra" d="M145,135 C145,135 120,160 120,200 C120,230 140,250 170,250 L245,250 L245,135 C220,135 180,130 145,135Z" fill="url(#raGrad)" opacity="0.9"/>
          <path class="heart-chamber" data-chamber="la" d="M355,135 C355,135 380,160 380,200 C380,230 360,250 330,250 L255,250 L255,135 C280,135 320,130 355,135Z" fill="url(#laGrad)" opacity="0.9"/>
          <path class="heart-chamber" data-chamber="rv" d="M120,260 C110,300 120,360 160,400 C190,430 220,440 245,445 L245,260 Z" fill="url(#rvGrad)" opacity="0.9"/>
          <path class="heart-chamber" data-chamber="lv" d="M380,260 C390,300 380,360 340,400 C310,430 280,440 255,445 L255,260 Z" fill="url(#lvGrad)" opacity="0.9"/>
          <ellipse cx="210" cy="252" rx="30" ry="6" fill="rgba(255,255,255,0.2)" class="heart-chamber" data-chamber="tv"/>
          <ellipse cx="290" cy="252" rx="30" ry="6" fill="rgba(255,255,255,0.25)" class="heart-chamber" data-chamber="mv"/>
          <text x="175" y="200" fill="rgba(255,255,255,0.7)" font-size="13" font-weight="700" font-family="DM Sans" text-anchor="middle">RA</text>
          <text x="325" y="200" fill="rgba(255,255,255,0.7)" font-size="13" font-weight="700" font-family="DM Sans" text-anchor="middle">LA</text>
          <text x="185" y="350" fill="rgba(255,255,255,0.7)" font-size="13" font-weight="700" font-family="DM Sans" text-anchor="middle">RV</text>
          <text x="325" y="350" fill="rgba(255,255,255,0.7)" font-size="13" font-weight="700" font-family="DM Sans" text-anchor="middle">LV</text>
          <circle cx="165" cy="145" r="8" fill="var(--sa-node)" filter="url(#glow)" class="heart-chamber" data-chamber="sa"/>
          <circle cx="165" cy="145" r="8" fill="var(--sa-node)" class="pulse-ring" opacity="0.5"/>
          <text x="165" y="132" fill="var(--sa-node)" font-size="9" font-weight="700" font-family="DM Sans" text-anchor="middle">SA</text>
          <circle cx="250" cy="245" r="7" fill="var(--av-node)" filter="url(#glow)" class="heart-chamber" data-chamber="av"/>
          <text x="250" y="235" fill="var(--av-node)" font-size="9" font-weight="700" font-family="DM Sans" text-anchor="middle">AV</text>
          <path d="M270,110 C290,150 310,200 300,260 C290,310 270,350 260,400" fill="none" stroke="rgba(200,16,46,0.4)" stroke-width="2.5" stroke-dasharray="4,3"/>
          <path d="M230,110 C210,150 190,200 200,260 C210,310 230,350 240,400" fill="none" stroke="rgba(200,16,46,0.4)" stroke-width="2.5" stroke-dasharray="4,3"/>
        </g>
      </svg>
    </div>
    <div class="heart-info" id="heartInfo">
      <div class="info-item active" data-target="ra"><div class="label">Chamber</div><div class="title">Right Atrium (RA)</div><div class="desc">Receives deoxygenated venous blood from SVC, IVC, and coronary sinus.</div></div>
      <div class="info-item" data-target="rv"><div class="label">Chamber</div><div class="title">Right Ventricle (RV)</div><div class="desc">Low-pressure pump. Sends blood to lungs via pulmonary artery.</div></div>
      <div class="info-item" data-target="la"><div class="label">Chamber</div><div class="title">Left Atrium (LA)</div><div class="desc">Receives oxygenated blood from lungs via four pulmonary veins.</div></div>
      <div class="info-item" data-target="lv"><div class="label">Chamber</div><div class="title">Left Ventricle (LV)</div><div class="desc">High-pressure pump. Thickest wall. Pumps to body via aorta. CO = SV √ó HR.</div></div>
      <div class="info-item" data-target="sa"><div class="label">Conduction</div><div class="title">SA Node ‚Äî The Pacemaker</div><div class="desc">Chief pacemaker 60-100 bpm. Medial to SVC opening.</div></div>
      <div class="info-item" data-target="av"><div class="label">Conduction</div><div class="title">AV Node ‚Äî The Gatekeeper</div><div class="desc">Delays impulse ~0.12s. Backup rate 40-60 bpm.</div></div>
    </div>
  </div>
</section>

<!-- 3. PHYSIOLOGY -->
<section id="physiology">
  <div class="section-label">Section 03</div>
  <div class="section-title">Cardiac <span class="gradient">Physiology</span></div>
  <p class="section-subtitle">Click any card to open a detailed popup with complete explanations and clinical pearls.</p>
  <div class="card-grid">
    <div class="card fade-up" onclick="openModal('phys-cycle')"><div class="card-icon" style="background:rgba(200,16,46,0.12);color:var(--cardiac-red)">üîÑ</div><h3>Cardiac Cycle</h3><p>Systole, diastole, heart sounds, pressure changes, phases.</p></div>
    <div class="card fade-up" onclick="openModal('phys-preload')"><div class="card-icon" style="background:rgba(255,209,102,0.12);color:var(--accent-gold)">üìà</div><h3>Preload & Starling's Law</h3><p>End-diastolic volume, venous return, fiber stretch.</p></div>
    <div class="card fade-up" onclick="openModal('phys-afterload')"><div class="card-icon" style="background:rgba(69,123,157,0.12);color:var(--venous)">üéØ</div><h3>Afterload & Contractility</h3><p>SVR, wall tension, inotropy, ejection fraction.</p></div>
    <div class="card fade-up" onclick="openModal('phys-co')"><div class="card-icon" style="background:rgba(239,71,111,0.12);color:var(--purkinje)">üìä</div><h3>Cardiac Output & MAP</h3><p>CO = SV √ó HR. MAP = CO √ó SVR. Blood pressure determinants.</p></div>
    <div class="card fade-up" onclick="openModal('phys-ans')"><div class="card-icon" style="background:rgba(17,138,178,0.12);color:var(--bundle-his)">‚ö°</div><h3>ANS Control</h3><p>Sympathetic vs. Parasympathetic. Receptors. Baroreceptors.</p></div>
    <div class="card fade-up" onclick="openModal('phys-electrolytes')"><div class="card-icon" style="background:rgba(6,214,160,0.12);color:var(--ecg-green)">üß™</div><h3>Electrolytes & Action Potential</h3><p>Na‚Å∫, K‚Å∫, Ca¬≤‚Å∫, Mg¬≤‚Å∫. Phases 0-4. Depolarization, repolarization.</p></div>
    <div class="card fade-up" onclick="openModal('phys-coronary')"><div class="card-icon" style="background:rgba(200,16,46,0.12);color:var(--cardiac-red)">ü´Ä</div><h3>Coronary Circulation</h3><p>RCA, LCA, LAD, circumflex. Supply territories. Collateral flow.</p></div>
    <div class="card fade-up" onclick="openModal('phys-bp')"><div class="card-icon" style="background:rgba(255,107,53,0.12);color:var(--warning)">üíâ</div><h3>Blood Pressure & Perfusion</h3><p>Systolic, diastolic, pulse pressure. Baroreceptor reflex. Shock physiology.</p></div>
  </div>
</section>

<!-- 4. CONDUCTION -->
<section id="conduction">
  <div class="section-label">Section 04</div>
  <div class="section-title">Electrical <span class="gradient">Conduction System</span></div>
  <p class="section-subtitle">Click each label to animate one step at a time, or Play All for the full sequence.</p>
  <div class="conduction-visual">
    <div class="conduction-svg-wrap">
      <svg id="conductionSvg" viewBox="0 0 400 500" xmlns="http://www.w3.org/2000/svg">
        <path d="M200,80 C130,80 70,130 70,200 C70,300 140,380 200,410 C260,380 330,300 330,200 C330,130 270,80 200,80Z" fill="#1A1020" stroke="rgba(200,16,46,0.2)" stroke-width="1.5"/>
        <line x1="200" y1="95" x2="200" y2="395" stroke="rgba(255,255,255,0.08)" stroke-width="2"/>
        <circle id="cSA" cx="130" cy="115" r="12" fill="var(--sa-node)" opacity="0.3"/>
        <text x="130" y="100" fill="var(--sa-node)" font-size="10" font-weight="700" text-anchor="middle" font-family="DM Sans">SA Node</text>
        <path id="cInter" d="M130,127 C150,150 170,180 200,210" fill="none" stroke="var(--sa-node)" stroke-width="3" opacity="0.2" stroke-dasharray="4,3"/>
        <circle id="cAV" cx="200" cy="220" r="10" fill="var(--av-node)" opacity="0.3"/>
        <text x="200" y="208" fill="var(--av-node)" font-size="10" font-weight="700" text-anchor="middle" font-family="DM Sans">AV Node</text>
        <line id="cHis" x1="200" y1="232" x2="200" y2="280" stroke="var(--bundle-his)" stroke-width="3" opacity="0.2"/>
        <text x="215" y="260" fill="var(--bundle-his)" font-size="9" font-weight="600" font-family="DM Sans">Bundle of His</text>
        <path id="cLBB" d="M200,280 C220,300 250,330 270,370" fill="none" stroke="var(--bundle-his)" stroke-width="2.5" opacity="0.2"/>
        <path id="cRBB" d="M200,280 C180,300 150,330 130,370" fill="none" stroke="var(--bundle-his)" stroke-width="2.5" opacity="0.2"/>
        <text x="100" y="355" fill="var(--bundle-his)" font-size="8" font-family="DM Sans">RBB</text>
        <text x="282" y="355" fill="var(--bundle-his)" font-size="8" font-family="DM Sans">LBB</text>
        <g id="cPurk" opacity="0.2">
          <path d="M130,370 C120,380 110,390 105,395" fill="none" stroke="var(--purkinje)" stroke-width="1.5"/>
          <path d="M130,370 C135,385 140,395 145,400" fill="none" stroke="var(--purkinje)" stroke-width="1.5"/>
          <path d="M270,370 C280,380 290,390 295,395" fill="none" stroke="var(--purkinje)" stroke-width="1.5"/>
          <path d="M270,370 C265,385 260,395 255,400" fill="none" stroke="var(--purkinje)" stroke-width="1.5"/>
        </g>
        <text x="200" y="420" fill="var(--purkinje)" font-size="9" font-weight="600" text-anchor="middle" font-family="DM Sans">Purkinje Fibers</text>
        <circle id="impulseDot" cx="130" cy="115" r="6" fill="white" filter="url(#glow)" opacity="0"/>
      </svg>
      <div style="display:flex;gap:0.4rem;justify-content:center;margin-top:0.6rem;flex-wrap:wrap">
        <button class="ecg-btn" onclick="startConductionAnim()" style="background:rgba(6,214,160,0.15);border-color:var(--ecg-green);color:var(--ecg-green)">‚ñ∂ Play All</button>
        <button class="ecg-btn" onclick="resetConduction()">‚Ü∫ Reset</button>
      </div>
    </div>
    <div class="conduction-timeline" id="conductionTimeline">
      <div class="timeline-step" id="ts-sa" onclick="animateSingleStep(0)" style="cursor:pointer">
        <div class="step-dot" style="background:var(--sa-node)"></div>
        <div class="step-content"><h4>‚ë† SA Node Fires</h4><p>Chief pacemaker of the heart. Located in the right atrium near the SVC opening. Generates impulse that initiates each heartbeat. Contains specialized autorhythmic cells with fastest intrinsic rate.</p><div class="rate">Intrinsic rate: 60‚Äì100 bpm</div></div>
      </div>
      <div class="timeline-step" id="ts-inter" onclick="animateSingleStep(1)" style="cursor:pointer">
        <div class="step-dot" style="background:var(--sa-node)"></div>
        <div class="step-content"><h4>‚ë° Atrial Depolarization</h4><p>Impulse spreads across both atria via internodal pathways (anterior, middle, posterior) and Bachmann's bundle to the left atrium. Atrial contraction produces the <strong>P wave</strong> on ECG. "Atrial kick" contributes ~20-30% of ventricular filling.</p><div class="rate">ECG: P wave (< 0.12s, < 2.5mm)</div></div>
      </div>
      <div class="timeline-step" id="ts-av" onclick="animateSingleStep(2)" style="cursor:pointer">
        <div class="step-dot" style="background:var(--av-node)"></div>
        <div class="step-content"><h4>‚ë¢ AV Node Delay</h4><p>AV node is the "gatekeeper" ‚Äî deliberately slows conduction ~0.05s to allow complete atrial emptying before ventricular contraction. This is the only normal pathway between atria and ventricles. Receives dual autonomic innervation.</p><div class="rate">Backup pacemaker: 40‚Äì60 bpm</div></div>
      </div>
      <div class="timeline-step" id="ts-his" onclick="animateSingleStep(3)" style="cursor:pointer">
        <div class="step-dot" style="background:var(--bundle-his)"></div>
        <div class="step-content"><h4>‚ë£ Bundle of His ‚Üí Bundle Branches</h4><p>Bundle of His penetrates the fibrous skeleton and divides into the Right Bundle Branch (RBB) and Left Bundle Branch (LBB). The LBB further subdivides into anterior and posterior fascicles. Block in either branch = Bundle Branch Block (BBB) with characteristic wide QRS.</p><div class="rate">ECG: PR interval 0.12‚Äì0.20s</div></div>
      </div>
      <div class="timeline-step" id="ts-purk" onclick="animateSingleStep(4)" style="cursor:pointer">
        <div class="step-dot" style="background:var(--purkinje)"></div>
        <div class="step-content"><h4>‚ë§ Purkinje Fibers</h4><p>Fastest-conducting fibers in the heart (~4m/s). Spread throughout ventricular myocardium from endocardium to epicardium, causing simultaneous ventricular contraction from apex to base. Produces the <strong>QRS complex</strong> on ECG. Ventricular repolarization follows as the <strong>T wave</strong>.</p><div class="rate">Escape pacemaker: 20‚Äì40 bpm</div></div>
      </div>
    </div>
  </div>
</section>

<!-- 5. ECG MONITOR -->
<section id="ecg">
  <div class="section-label">Section 05</div>
  <div class="section-title">Live ECG <span class="gradient">Monitor</span></div>
  <p class="section-subtitle">Real ECG paper background with countable grid squares. Select any rhythm ‚Äî click rhythm name to open detailed popup.</p>
  <div class="ecg-monitor">
    <div class="ecg-monitor-header">
      <div><div class="lead-label">LEAD II ¬∑ 25mm/s ¬∑ 10mm/mV</div></div>
      <div style="text-align:center"><div class="rhythm-name" id="rhythmName" style="cursor:pointer" onclick="openRhythmModal(currentRhythm)">Normal Sinus Rhythm ‚Üó</div></div>
      <div style="text-align:right"><div class="rate-display" id="ecgRate">72<span>BPM</span></div></div>
    </div>
    <div class="ecg-paper-bg monitor-body">
      <canvas id="ecgCanvas" height="280"></canvas>
    </div>
    <div class="ecg-6s-markers"><span>|‚Üê 1s ‚Üí|</span><span>|‚Üê 2s ‚Üí|</span><span>|‚Üê 3s ‚Üí|</span><span>|‚Üê 4s ‚Üí|</span><span>|‚Üê 5s ‚Üí|</span><span>|‚Üê 6s ‚Üí|</span></div>
    <div class="ecg-controls" id="ecgControls"></div>
  </div>
</section>

<!-- 6. ECG COMPONENTS -->
<section id="ecg-components">
  <div class="section-label">Section 06</div>
  <div class="section-title">ECG <span class="gradient">Waveform Components</span></div>
  <p class="section-subtitle">Click each component to highlight and learn its clinical significance.</p>
  <div class="ecg-components">
    <div class="ecg-paper-bg"><canvas id="ecgCompCanvas" height="220"></canvas></div>
    <div class="ecg-comp-labels">
      <div class="comp-label active" style="border-color:var(--sa-node);color:var(--sa-node)" onclick="showComp('p')">P Wave</div>
      <div class="comp-label" style="border-color:var(--bundle-his);color:var(--bundle-his)" onclick="showComp('pr')">PR Interval</div>
      <div class="comp-label" style="border-color:var(--ecg-green);color:var(--ecg-green)" onclick="showComp('qrs')">QRS Complex</div>
      <div class="comp-label" style="border-color:var(--venous);color:var(--venous)" onclick="showComp('st')">ST Segment</div>
      <div class="comp-label" style="border-color:var(--purkinje);color:var(--purkinje)" onclick="showComp('t')">T Wave</div>
      <div class="comp-label" style="border-color:var(--warning);color:var(--warning)" onclick="showComp('qt')">QT Interval</div>
      <div class="comp-label" style="border-color:#00BCD4;color:#00BCD4" onclick="showComp('jwave')">J Wave (Osborn)</div>
      <div class="comp-label" style="border-color:#E040FB;color:#E040FB" onclick="showComp('delta')">Delta Wave (WPW)</div>
    </div>
    <div class="comp-detail" id="compDetail"><h4 style="color:var(--sa-node)">P Wave</h4><p>First positive deflection. Atrial depolarization. Duration &lt; 0.12s. Should be upright in Lead II for sinus origin.</p></div>
  </div>
</section>

<!-- 7. 5-STEP ANALYSIS -->
<section id="rhythm-analysis">
  <div class="section-label">Section 07</div>
  <div class="section-title">5-Step <span class="gradient">Rhythm Analysis</span></div>
  <p class="section-subtitle">Click each step for the detailed popup explanation.</p>
  <div class="card-grid">
    <div class="card fade-up" onclick="openModal('step1')"><div class="card-icon" style="background:rgba(200,16,46,0.12);color:var(--cardiac-red);font-weight:800;font-family:'JetBrains Mono'">1</div><h3>Analyze the Rate</h3><p>6-second count, triplicate, or R-R method.</p></div>
    <div class="card fade-up" onclick="openModal('step2')"><div class="card-icon" style="background:rgba(255,209,102,0.12);color:var(--accent-gold);font-weight:800;font-family:'JetBrains Mono'">2</div><h3>Analyze the Rhythm</h3><p>Regular, regularly irregular, or irregularly irregular?</p></div>
    <div class="card fade-up" onclick="openModal('step3')"><div class="card-icon" style="background:rgba(6,214,160,0.12);color:var(--ecg-green);font-weight:800;font-family:'JetBrains Mono'">3</div><h3>Analyze QRS</h3><p>Narrow (&lt;0.12s) or wide (‚â•0.12s)?</p></div>
    <div class="card fade-up" onclick="openModal('step4')"><div class="card-icon" style="background:rgba(17,138,178,0.12);color:var(--bundle-his);font-weight:800;font-family:'JetBrains Mono'">4</div><h3>Analyze P Waves</h3><p>Present? Upright? 1:1 with QRS?</p></div>
    <div class="card fade-up" onclick="openModal('step5')"><div class="card-icon" style="background:rgba(239,71,111,0.12);color:var(--purkinje);font-weight:800;font-family:'JetBrains Mono'">5</div><h3>Analyze PR Interval</h3><p>Normal 0.12-0.20s? Consistent? Lengthening?</p></div>
  </div>
</section>

<!-- 8. DYSRHYTHMIAS -->
<section id="rhythms">
  <div class="section-label">Section 08</div>
  <div class="section-title">Dysrhythmia <span class="gradient">Recognition Gallery</span></div>
  <p class="section-subtitle">Click any rhythm card to open a detailed popup with full characteristics, etiology, and management.</p>
  <div class="tab-bar">
    <button class="tab-btn active" onclick="showTab('sa-tab',this)">SA Node</button>
    <button class="tab-btn" onclick="showTab('atrial-tab',this)">Atrial</button>
    <button class="tab-btn" onclick="showTab('junct-tab',this)">Junctional</button>
    <button class="tab-btn" onclick="showTab('vent-tab',this)">Ventricular</button>
    <button class="tab-btn" onclick="showTab('block-tab',this)">AV Blocks</button>
  </div>
  <div class="tab-content active" id="sa-tab"><div class="rhythm-gallery" id="saGallery"></div></div>
  <div class="tab-content" id="atrial-tab"><div class="rhythm-gallery" id="atrialGallery"></div></div>
  <div class="tab-content" id="junct-tab"><div class="rhythm-gallery" id="junctGallery"></div></div>
  <div class="tab-content" id="vent-tab"><div class="rhythm-gallery" id="ventGallery"></div></div>
  <div class="tab-content" id="block-tab"><div class="rhythm-gallery" id="blockGallery"></div></div>
</section>

<!-- 9. AV BLOCKS (summary) -->
<section id="blocks">
  <div class="section-label">Section 09</div>
  <div class="section-title">AV <span class="gradient">Conduction Blocks</span></div>
  <p class="section-subtitle">Click each block type for the detailed popup with rhythm strip.</p>
  <div class="card-grid">
    <div class="card fade-up" onclick="openModal('block-1st')"><div class="card-icon" style="background:rgba(255,209,102,0.12);color:var(--accent-gold)">1¬∞</div><h3>First-Degree AV Block</h3><p>Not a true block ‚Äî delay. PR &gt; 0.20s but constant.</p></div>
    <div class="card fade-up" onclick="openModal('block-2nd1')"><div class="card-icon" style="background:rgba(255,107,53,0.12);color:var(--warning)">2¬∞I</div><h3>Second-Degree Type I</h3><p>Wenckebach. Progressive PR lengthening ‚Üí dropped QRS.</p></div>
    <div class="card fade-up" onclick="openModal('block-2nd2')"><div class="card-icon" style="background:rgba(239,71,111,0.12);color:var(--purkinje)">2¬∞II</div><h3>Second-Degree Type II</h3><p>Mobitz. Constant PR then sudden drop. Below Bundle of His.</p></div>
    <div class="card fade-up" onclick="openModal('block-3rd')"><div class="card-icon" style="background:rgba(200,16,46,0.2);color:var(--cardiac-red)">3¬∞</div><h3>Third-Degree (Complete)</h3><p>Complete AV dissociation. P waves independent of QRS.</p></div>
  </div>
</section>

<!-- 10. ACS -->
<section id="acs">
  <div class="section-label">Section 10</div>
  <div class="section-title">Acute Coronary <span class="gradient">Syndromes</span></div>
  <p class="section-subtitle">Most common cause of sudden cardiac death. Click any card for comprehensive clinical detail.</p>
  <div class="card-grid">
    <div class="card fade-up" onclick="openModal('acs-patho')"><div class="card-icon" style="background:rgba(200,16,46,0.12);color:var(--cardiac-red)">ü´Ä</div><h3>Pathophysiology</h3><p>Atherosclerosis ‚Üí plaque rupture ‚Üí thrombosis ‚Üí ischemia ‚Üí injury ‚Üí infarction cascade.</p></div>
    <div class="card fade-up" onclick="openModal('acs-spectrum')"><div class="card-icon" style="background:rgba(239,71,111,0.12);color:var(--purkinje)">üìã</div><h3>ACS Spectrum</h3><p>Unstable angina vs. NSTEMI vs. STEMI. Troponin and ECG differentiation.</p></div>
    <div class="card fade-up" onclick="openModal('acs-signs')"><div class="card-icon" style="background:rgba(255,209,102,0.12);color:var(--accent-gold)">‚ö†Ô∏è</div><h3>Signs & Symptoms</h3><p>Classic vs. atypical presentations. Women, elderly, diabetic differences.</p></div>
    <div class="card fade-up" onclick="openModal('acs-12lead')"><div class="card-icon" style="background:rgba(6,214,160,0.12);color:var(--ecg-green)">üìä</div><h3>12-Lead ECG & STEMI</h3><p>ST elevation, reciprocal changes, right-sided & posterior leads.</p></div>
    <div class="card fade-up" onclick="openModal('acs-territory')"><div class="card-icon" style="background:rgba(17,138,178,0.12);color:var(--bundle-his)">üó∫Ô∏è</div><h3>Infarct Territories</h3><p>Anterior, inferior, lateral, posterior, RV. Artery-lead-wall correlations.</p></div>
    <div class="card fade-up" onclick="openModal('acs-mgmt')"><div class="card-icon" style="background:rgba(69,123,157,0.12);color:var(--venous)">üöë</div><h3>EMS Management</h3><p>Aspirin, NTG, anticoagulants, early PCI activation, fibrinolytics.</p></div>
    <div class="card fade-up" onclick="openModal('acs-complications')"><div class="card-icon" style="background:rgba(255,107,53,0.12);color:var(--warning)">üí•</div><h3>Complications of AMI</h3><p>Dysrhythmias, CHF, cardiogenic shock, mechanical rupture, Dressler syndrome.</p></div>
    <div class="card fade-up" onclick="openModal('acs-mimics')"><div class="card-icon" style="background:rgba(200,16,46,0.12);color:var(--cardiac-red)">üîç</div><h3>ACS Mimics & Differentials</h3><p>PE, dissection, pericarditis, GERD, pneumothorax ‚Äî what else causes chest pain?</p></div>
  </div>
</section>

<!-- 11. EMERGENCIES -->
<section id="emergencies">
  <div class="section-label">Section 11</div>
  <div class="section-title">Cardiac <span class="gradient">Emergencies</span></div>
  <p class="section-subtitle">Life-threatening conditions requiring immediate recognition and intervention. Click for detailed management.</p>
  <div class="card-grid">
    <div class="card fade-up" onclick="openModal('emerg-hf')"><div class="card-icon" style="background:rgba(69,123,157,0.12);color:var(--venous)">ü´Å</div><h3>Heart Failure & Pulmonary Edema</h3><p>Left vs. right failure, NYHA classes, acute decompensation, CPAP/BiPAP.</p></div>
    <div class="card fade-up" onclick="openModal('emerg-shock')"><div class="card-icon" style="background:rgba(200,16,46,0.12);color:var(--cardiac-red)">üíî</div><h3>Cardiogenic Shock</h3><p>Extreme pump failure. Swan-Ganz findings, vasopressor selection, IABP.</p></div>
    <div class="card fade-up" onclick="openModal('emerg-tamp')"><div class="card-icon" style="background:rgba(255,209,102,0.12);color:var(--accent-gold)">ü´Ä</div><h3>Cardiac Tamponade</h3><p>Beck's Triad, pulsus paradoxus, electrical alternans, pericardiocentesis.</p></div>
    <div class="card fade-up" onclick="openModal('emerg-dissect')"><div class="card-icon" style="background:rgba(239,71,111,0.12);color:var(--purkinje)">ü©∏</div><h3>Aortic Dissection</h3><p>Stanford/DeBakey classification, tearing pain, BP differentials, management.</p></div>
    <div class="card fade-up" onclick="openModal('emerg-htn')"><div class="card-icon" style="background:rgba(255,107,53,0.12);color:var(--warning)">üìà</div><h3>Hypertensive Crisis</h3><p>Urgency vs. emergency, end-organ damage targets, controlled BP reduction.</p></div>
    <div class="card fade-up" onclick="openModal('emerg-pe')"><div class="card-icon" style="background:rgba(17,138,178,0.12);color:var(--bundle-his)">ü´Å</div><h3>Pulmonary Embolism</h3><p>DVT origin, right heart strain, S1Q3T3, massive vs. submassive, tPA.</p></div>
    <div class="card fade-up" onclick="openModal('emerg-pericarditis')"><div class="card-icon" style="background:rgba(6,214,160,0.12);color:var(--ecg-green)">üî•</div><h3>Acute Pericarditis</h3><p>Diffuse ST elevation, PR depression, pleuritic pain, friction rub.</p></div>
    <div class="card fade-up" onclick="openModal('emerg-syncope')"><div class="card-icon" style="background:rgba(200,16,46,0.12);color:var(--cardiac-red)">üí´</div><h3>Cardiac Syncope</h3><p>Structural vs. dysrhythmic causes, risk stratification, Brugada, HOCM, long QT.</p></div>
  </div>
</section>

<!-- 12. RESUSCITATION -->
<section id="resuscitation">
  <div class="section-label">Section 12</div>
  <div class="section-title">Cardiac Arrest & <span class="gradient">Resuscitation</span></div>
  <div class="key-grid">
    <div class="key-item fade-up" onclick="openModal('resus-cpr')"><h4>ü´Å High-Quality CPR</h4><p>Rate: <span class="highlight">100‚Äì120/min</span>. Depth: <span class="highlight">‚â•2 inches</span>.</p></div>
    <div class="key-item fade-up" onclick="openModal('resus-defib')"><h4>‚ö° Defibrillation</h4><p>Most common initial rhythm: <span class="highlight">VF</span>.</p></div>
    <div class="key-item fade-up" onclick="openModal('resus-cardio')"><h4>üîÑ Synchronized Cardioversion</h4><p>Unstable tachycardias (not VF/pVT).</p></div>
    <div class="key-item fade-up" onclick="openModal('resus-pea')"><h4>üè• PEA & Asystole</h4><p>H's and T's. Pseudo-PEA.</p></div>
    <div class="key-item fade-up" onclick="openModal('resus-pit')"><h4>üë• Pit Crew CPR</h4><p>Team roles. 2-min rotations.</p></div>
    <div class="key-item fade-up" onclick="openModal('resus-rosc')"><h4>üîã Post-ROSC Care</h4><p>TTM, 12-lead, hemodynamic support.</p></div>
  </div>
</section>

<!-- 13. QUIZ -->
<section id="quiz">
  <div class="section-label">Section 13</div>
  <div class="section-title">Test Your <span class="gradient">Knowledge</span></div>
  <p class="section-subtitle">Identify rhythms and answer cardiology questions with instant feedback.</p>
  <div class="quiz-container" id="quizContainer"></div>
</section>

<div style="text-align:center;padding:2.5rem 1rem 3rem;color:var(--text-muted);font-size:0.78rem">
  <div style="font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--text-secondary);margin-bottom:0.4rem">Chapter 21 ‚Äî Cardiology</div>
  Sanders' Paramedic Textbook ¬∑ Interactive Edition ¬∑ Paul D. Camp Community College EMS Program
</div>

<script>
// ================================================================
// ECG PAPER GRID DRAWING ‚Äî Realistic salmon-pink ECG paper
// ================================================================
function drawECGPaper(ctx, w, h) {
  // Background
  ctx.fillStyle = '#1C1410';
  ctx.fillRect(0, 0, w, h);
  
  // Small grid (1mm = ~4px at 25mm/s scale)
  const sm = Math.round(w / 150); // ~4px per small square
  const smSize = Math.max(sm, 3);
  
  ctx.strokeStyle = 'rgba(180,100,80,0.18)';
  ctx.lineWidth = 0.5;
  for (let x = 0; x < w; x += smSize) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke();
  }
  for (let y = 0; y < h; y += smSize) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
  }
  
  // Large grid (5mm = 5 small squares)
  const lgSize = smSize * 5;
  ctx.strokeStyle = 'rgba(180,100,80,0.40)';
  ctx.lineWidth = 1;
  for (let x = 0; x < w; x += lgSize) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke();
  }
  for (let y = 0; y < h; y += lgSize) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
  }
  
  // 6-second markers (every 30 large squares = 6 seconds at 25mm/s, but we scale)
  const sixSec = lgSize * 5; // 5 large boxes = 1 second
  ctx.strokeStyle = 'rgba(200,120,90,0.55)';
  ctx.lineWidth = 1.5;
  for (let x = 0; x < w; x += sixSec) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, 6); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x, h-6); ctx.lineTo(x, h); ctx.stroke();
  }
  
  return { smSize, lgSize };
}

// ================================================================
// CLINICALLY ACCURATE ECG WAVEFORM GENERATORS
// ================================================================
// Each generator takes a phase 0-1 within one cardiac cycle and returns amplitude -1 to 1

function waveNSR(t) {
  // Normal sinus: P wave, flat PR, narrow QRS (Q,R,S), flat ST, T wave
  if (t < 0.02) return 0; // baseline
  if (t < 0.12) { // P wave: smooth dome
    const p = (t - 0.02) / 0.10;
    return 0.12 * Math.sin(p * Math.PI);
  }
  if (t < 0.20) return 0; // PR segment (isoelectric)
  if (t < 0.22) { // Q wave: small downward
    const q = (t - 0.20) / 0.02;
    return -0.08 * Math.sin(q * Math.PI);
  }
  if (t < 0.26) { // R wave: tall sharp upward
    const r = (t - 0.22) / 0.04;
    return -0.08 + 1.08 * Math.sin(r * Math.PI);
  }
  if (t < 0.29) { // S wave: small downward
    const s = (t - 0.26) / 0.03;
    return -0.12 * Math.sin(s * Math.PI);
  }
  if (t < 0.42) return 0; // ST segment (isoelectric)
  if (t < 0.60) { // T wave: rounded asymmetric
    const tw = (t - 0.42) / 0.18;
    return 0.22 * Math.sin(tw * Math.PI) * (1 - 0.3 * tw);
  }
  return 0; // TP segment
}

function waveAFib(t, x) {
  // A-Fib: no P waves, fibrillatory baseline, irregular R-R handled by caller
  const fib = 0.035 * (Math.sin(x*1.7) + Math.sin(x*2.9+1) + 0.7*Math.sin(x*4.3+2));
  if (t < 0.18) return fib;
  if (t < 0.20) { const q = (t-0.18)/0.02; return fib - 0.06 * Math.sin(q*Math.PI); }
  if (t < 0.24) { const r = (t-0.20)/0.04; return fib + 0.85 * Math.sin(r*Math.PI); }
  if (t < 0.27) { const s = (t-0.24)/0.03; return fib - 0.10 * Math.sin(s*Math.PI); }
  if (t < 0.40) return fib;
  if (t < 0.55) { const tw = (t-0.40)/0.15; return fib + 0.18 * Math.sin(tw*Math.PI); }
  return fib;
}

function waveAFlutter(t, x) {
  // A-Flutter: sawtooth flutter waves ~300/min with 2:1-4:1 block
  // Draw sawtooth pattern continuously, then superimpose narrow QRS every cycle
  const flutterFreq = 4.2; // relative to ventricular rate
  const ft = (x * flutterFreq) % 1;
  const flutter = 0.15 * (ft < 0.6 ? -ft/0.6 : (ft-0.6)/0.4 - 1);
  
  if (t > 0.22 && t < 0.24) return flutter + 0.05;
  if (t > 0.24 && t < 0.28) { const r=(t-0.24)/0.04; return flutter + 0.80 * Math.sin(r*Math.PI); }
  if (t > 0.28 && t < 0.31) { const s=(t-0.28)/0.03; return flutter - 0.08 * Math.sin(s*Math.PI); }
  return flutter;
}

function waveSVT(t) {
  // SVT/PSVT: Rate 150-220, regular, NARROW QRS, P waves hidden in/near QRS
  // No visible P waves, very narrow QRS, short R-R
  if (t < 0.15) return 0;
  if (t < 0.17) { const q=(t-0.15)/0.02; return -0.05*Math.sin(q*Math.PI); }
  if (t < 0.21) { const r=(t-0.17)/0.04; return 0.85*Math.sin(r*Math.PI); } // tall narrow R
  if (t < 0.24) { const s=(t-0.21)/0.03; return -0.08*Math.sin(s*Math.PI); }
  if (t < 0.35) return 0;
  if (t < 0.52) { const tw=(t-0.35)/0.17; return 0.15*Math.sin(tw*Math.PI); } // small T, may merge with next cycle
  return 0;
}

function waveVTach(t) {
  // V-Tach: wide QRS ‚â•0.12s, monomorphic, sinusoidal appearance, no P waves
  if (t < 0.05) return 0;
  if (t < 0.45) { // Wide sinusoidal QRS
    const q = (t-0.05)/0.40;
    return 0.85 * Math.sin(q * Math.PI) * (1 + 0.15*Math.sin(q*Math.PI*2));
  }
  if (t < 0.55) { // negative deflection
    const s = (t-0.45)/0.10;
    return -0.35 * Math.sin(s * Math.PI);
  }
  return 0.02 * Math.sin(t*20); // slight wobble baseline
}

function waveVFib(x) {
  // V-Fib: completely chaotic, no organized complexes
  return 0.5 * (
    0.4*Math.sin(x*0.31+1.2) +
    0.3*Math.sin(x*0.73+0.5) +
    0.25*Math.sin(x*1.17+2.8) +
    0.2*Math.sin(x*1.91+0.3) +
    0.15*Math.sin(x*2.83+1.7) +
    0.1*Math.sin(x*4.1)
  );
}

function waveAsystole(x) {
  return 0.008 * Math.sin(x*0.03) + 0.003*(Math.random()-0.5);
}

function waveTorsades(t, beatNum) {
  // Torsades: wide QRS that changes amplitude (spindle), twisting around baseline
  const amplitude = 0.3 + 0.6 * Math.abs(Math.sin(beatNum * 0.35));
  if (t < 0.05) return 0;
  if (t < 0.50) {
    const q = (t-0.05)/0.45;
    const polarity = Math.sin(beatNum * 0.35) > 0 ? 1 : -1;
    return polarity * amplitude * Math.sin(q * Math.PI);
  }
  return 0;
}

function wavePVC(t) {
  // PVC: wide, bizarre QRS, no preceding P wave, compensatory pause after
  if (t < 0.05) return 0;
  if (t < 0.20) { const r=(t-0.05)/0.15; return -0.75*Math.sin(r*Math.PI); }
  if (t < 0.35) { const s=(t-0.20)/0.15; return 0.45*Math.sin(s*Math.PI); }
  if (t < 0.50) { const tw=(t-0.35)/0.15; return -0.20*Math.sin(tw*Math.PI); }
  return 0;
}

function wave1AVB(t) {
  // 1st degree: same as NSR but PR > 0.20s (longer flat segment before QRS)
  if (t < 0.02) return 0;
  if (t < 0.10) { const p=(t-0.02)/0.08; return 0.12*Math.sin(p*Math.PI); }
  if (t < 0.26) return 0; // prolonged PR
  if (t < 0.28) { const q=(t-0.26)/0.02; return -0.06*Math.sin(q*Math.PI); }
  if (t < 0.32) { const r=(t-0.28)/0.04; return 0.90*Math.sin(r*Math.PI); }
  if (t < 0.35) { const s=(t-0.32)/0.03; return -0.10*Math.sin(s*Math.PI); }
  if (t < 0.48) return 0;
  if (t < 0.64) { const tw=(t-0.48)/0.16; return 0.20*Math.sin(tw*Math.PI); }
  return 0;
}

function wave3AVB(t, x, period) {
  // 3rd degree: P waves march independently, ventricular escape rhythm
  // P waves at atrial rate (~75bpm), QRS at ventricular rate (~35bpm)
  const pPeriod = period * 0.47;
  const pt = ((x % pPeriod) / pPeriod);
  let pWave = 0;
  if (pt > 0.05 && pt < 0.18) pWave = 0.12 * Math.sin((pt-0.05)/0.13 * Math.PI);
  
  // Ventricular escape (wide QRS)
  if (t > 0.12 && t < 0.16) { const q=(t-0.12)/0.04; return pWave - 0.06*Math.sin(q*Math.PI); }
  if (t > 0.16 && t < 0.24) { const r=(t-0.16)/0.08; return pWave + 0.65*Math.sin(r*Math.PI); }
  if (t > 0.24 && t < 0.30) { const s=(t-0.24)/0.06; return pWave - 0.15*Math.sin(s*Math.PI); }
  if (t > 0.45 && t < 0.65) { const tw=(t-0.45)/0.20; return pWave + 0.18*Math.sin(tw*Math.PI); }
  return pWave;
}

function waveWenck(t, beatInCycle) {
  // Wenckebach: PR progressively lengthens then drops
  // beatInCycle: 0,1,2 = conducted with increasing PR; 3 = dropped
  if (beatInCycle >= 3) {
    // dropped beat - only P wave, no QRS
    if (t > 0.05 && t < 0.15) { const p=(t-0.05)/0.10; return 0.12*Math.sin(p*Math.PI); }
    return 0;
  }
  const prDelay = 0.04 * beatInCycle; // increasing delay
  if (t < 0.02) return 0;
  if (t < 0.10) { const p=(t-0.02)/0.08; return 0.12*Math.sin(p*Math.PI); }
  const qrsStart = 0.20 + prDelay;
  if (t < qrsStart) return 0;
  if (t < qrsStart+0.02) { const q=(t-qrsStart)/0.02; return -0.06*Math.sin(q*Math.PI); }
  if (t < qrsStart+0.06) { const r=(t-qrsStart-0.02)/0.04; return 0.85*Math.sin(r*Math.PI); }
  if (t < qrsStart+0.09) { const s=(t-qrsStart-0.06)/0.03; return -0.10*Math.sin(s*Math.PI); }
  const tStart = qrsStart + 0.20;
  if (t > tStart && t < tStart+0.15) { const tw=(t-tStart)/0.15; return 0.18*Math.sin(tw*Math.PI); }
  return 0;
}

function waveJunctional(t) {
  // Junctional: no preceding P wave (or inverted after QRS), narrow QRS, rate 40-60
  if (t < 0.18) return 0;
  if (t < 0.20) { const q=(t-0.18)/0.02; return -0.06*Math.sin(q*Math.PI); }
  if (t < 0.24) { const r=(t-0.20)/0.04; return 0.90*Math.sin(r*Math.PI); }
  if (t < 0.27) { const s=(t-0.24)/0.03; return -0.10*Math.sin(s*Math.PI); }
  // Retrograde P wave (inverted) right after QRS
  if (t > 0.28 && t < 0.35) { const rp=(t-0.28)/0.07; return -0.08*Math.sin(rp*Math.PI); }
  if (t < 0.48) return 0;
  if (t < 0.62) { const tw=(t-0.48)/0.14; return 0.20*Math.sin(tw*Math.PI); }
  return 0;
}

function waveSinusArrhythmia(t, xPos) {
  // Same as NSR but R-R varies with "breathing" cycle
  return waveNSR(t);
}

function waveSinusArrest(t, beatNum) {
  // Normal sinus with one dropped beat (no P, no QRS ‚Äî flat line)
  if (beatNum % 5 === 3) return 0; // dropped beat
  return waveNSR(t);
}

function waveWAP(t, beatNum) {
  // Wandering Atrial Pacemaker: at least 3 different P wave morphologies, rate ‚â§ 100
  const pMorphs = [0.12, 0.08, -0.06, 0.10, -0.04]; // varying P amplitudes
  const pAmp = pMorphs[beatNum % 5];
  if (t < 0.02) return 0;
  if (t < 0.12) { const p = (t - 0.02) / 0.10; return pAmp * Math.sin(p * Math.PI); }
  if (t < 0.20) return 0;
  if (t < 0.22) { const q = (t - 0.20) / 0.02; return -0.08 * Math.sin(q * Math.PI); }
  if (t < 0.26) { const r = (t - 0.22) / 0.04; return 0.95 * Math.sin(r * Math.PI); }
  if (t < 0.29) { const s = (t - 0.26) / 0.03; return -0.12 * Math.sin(s * Math.PI); }
  if (t < 0.42) return 0;
  if (t < 0.60) { const tw = (t - 0.42) / 0.18; return 0.20 * Math.sin(tw * Math.PI); }
  return 0;
}

function waveMAT(t, beatNum) {
  // Multifocal Atrial Tachycardia: ‚â•3 P morphs, irregular, rate > 100
  const pMorphs = [0.14, -0.08, 0.06, 0.11, -0.10];
  const pAmp = pMorphs[beatNum % 5];
  const prVar = [0, 0.02, 0.01, 0.03, 0]; // varying PR intervals
  const pr = prVar[beatNum % 5];
  if (t < 0.02) return 0;
  if (t < 0.10) { const p = (t - 0.02) / 0.08; return pAmp * Math.sin(p * Math.PI); }
  const qrsStart = 0.18 + pr;
  if (t < qrsStart) return 0;
  if (t < qrsStart + 0.02) { const q = (t - qrsStart) / 0.02; return -0.06 * Math.sin(q * Math.PI); }
  if (t < qrsStart + 0.06) { const r = (t - qrsStart - 0.02) / 0.04; return 0.85 * Math.sin(r * Math.PI); }
  if (t < qrsStart + 0.09) { const s = (t - qrsStart - 0.06) / 0.03; return -0.10 * Math.sin(s * Math.PI); }
  const tStart = qrsStart + 0.18;
  if (t > tStart && t < tStart + 0.14) { const tw = (t - tStart) / 0.14; return 0.16 * Math.sin(tw * Math.PI); }
  return 0;
}

function waveJunctTach(t) {
  // Junctional Tachycardia: rate 100-180, narrow QRS, no visible P or retrograde P
  if (t < 0.14) return 0;
  if (t < 0.16) { const q = (t - 0.14) / 0.02; return -0.05 * Math.sin(q * Math.PI); }
  if (t < 0.20) { const r = (t - 0.16) / 0.04; return 0.88 * Math.sin(r * Math.PI); }
  if (t < 0.23) { const s = (t - 0.20) / 0.03; return -0.10 * Math.sin(s * Math.PI); }
  if (t > 0.24 && t < 0.30) { const rp = (t - 0.24) / 0.06; return -0.06 * Math.sin(rp * Math.PI); }
  if (t < 0.42) return 0;
  if (t < 0.56) { const tw = (t - 0.42) / 0.14; return 0.16 * Math.sin(tw * Math.PI); }
  return 0;
}

function waveIdioventricular(t) {
  // Idioventricular Rhythm: wide QRS (ventricular escape), rate 20-40, no P waves
  if (t < 0.05) return 0;
  if (t < 0.14) { const r = (t - 0.05) / 0.09; return -0.25 * Math.sin(r * Math.PI); }
  if (t < 0.28) { const r2 = (t - 0.14) / 0.14; return 0.70 * Math.sin(r2 * Math.PI); }
  if (t < 0.38) { const s = (t - 0.28) / 0.10; return -0.30 * Math.sin(s * Math.PI); }
  if (t < 0.55) return 0;
  if (t < 0.72) { const tw = (t - 0.55) / 0.17; return -0.22 * Math.sin(tw * Math.PI); }
  return 0;
}

function waveAIVR(t) {
  // Accelerated Idioventricular Rhythm: same wide morphology, rate 40-100
  if (t < 0.05) return 0;
  if (t < 0.13) { const r = (t - 0.05) / 0.08; return -0.20 * Math.sin(r * Math.PI); }
  if (t < 0.26) { const r2 = (t - 0.13) / 0.13; return 0.65 * Math.sin(r2 * Math.PI); }
  if (t < 0.35) { const s = (t - 0.26) / 0.09; return -0.25 * Math.sin(s * Math.PI); }
  if (t < 0.50) return 0;
  if (t < 0.66) { const tw = (t - 0.50) / 0.16; return -0.18 * Math.sin(tw * Math.PI); }
  return 0;
}

function waveAgonal(t) {
  // Agonal / Dying Heart: very wide, bizarre, slow, irregular
  if (t < 0.08) return 0;
  if (t < 0.22) { const r = (t - 0.08) / 0.14; return 0.40 * Math.sin(r * Math.PI) * (1 + 0.3 * Math.sin(r * Math.PI * 3)); }
  if (t < 0.38) { const s = (t - 0.22) / 0.16; return -0.25 * Math.sin(s * Math.PI); }
  if (t < 0.55) { const tw = (t - 0.38) / 0.17; return 0.10 * Math.sin(tw * Math.PI); }
  return 0.005 * Math.sin(t * 15);
}

function wavePaced(t) {
  // Ventricular Paced: pacer spike then wide QRS
  if (t < 0.15) return 0;
  // Pacer spike (sharp vertical line)
  if (t >= 0.15 && t < 0.155) return 0.55;
  if (t >= 0.155 && t < 0.16) return -0.10;
  // Wide paced QRS
  if (t < 0.22) { const r = (t - 0.16) / 0.06; return -0.55 * Math.sin(r * Math.PI); }
  if (t < 0.34) { const r2 = (t - 0.22) / 0.12; return 0.30 * Math.sin(r2 * Math.PI); }
  if (t < 0.42) { const s = (t - 0.34) / 0.08; return -0.10 * Math.sin(s * Math.PI); }
  if (t < 0.55) return 0;
  if (t < 0.72) { const tw = (t - 0.55) / 0.17; return -0.20 * Math.sin(tw * Math.PI); }
  return 0;
}

// J Wave (Osborn wave) ‚Äî NSR with prominent J-point notch
function waveJWave(t) {
  if (t < 0.02) return 0;
  if (t < 0.12) { const p = (t - 0.02) / 0.10; return 0.12 * Math.sin(p * Math.PI); }
  if (t < 0.20) return 0;
  // Q wave
  if (t < 0.22) { const q = (t - 0.20) / 0.02; return -0.08 * Math.sin(q * Math.PI); }
  // R wave
  if (t < 0.26) { const r = (t - 0.22) / 0.04; return 0.90 * Math.sin(r * Math.PI); }
  // S wave
  if (t < 0.29) { const s = (t - 0.26) / 0.03; return -0.12 * Math.sin(s * Math.PI); }
  // J WAVE ‚Äî prominent positive hump at J point
  if (t < 0.34) { const j = (t - 0.29) / 0.05; return 0.28 * Math.sin(j * Math.PI); }
  // ST segment slightly elevated
  if (t < 0.42) return 0.04;
  // T wave
  if (t < 0.60) { const tw = (t - 0.42) / 0.18; return 0.20 * Math.sin(tw * Math.PI); }
  return 0;
}

// Delta Wave (WPW) ‚Äî short PR + slurred QRS upstroke + wide QRS
function waveDelta(t) {
  if (t < 0.02) return 0;
  // P wave
  if (t < 0.10) { const p = (t - 0.02) / 0.08; return 0.12 * Math.sin(p * Math.PI); }
  // SHORT PR interval (only to 0.16 instead of 0.20)
  if (t < 0.16) return 0;
  // DELTA WAVE ‚Äî slow slurred upstroke before the main R wave
  if (t < 0.22) { const d = (t - 0.16) / 0.06; return 0.35 * d; }
  // Merged R wave peak (wide QRS continues)
  if (t < 0.28) { const r = (t - 0.22) / 0.06; return 0.35 + 0.55 * Math.sin(r * Math.PI); }
  // S wave (wide)
  if (t < 0.34) { const s = (t - 0.28) / 0.06; return -0.10 * Math.sin(s * Math.PI); }
  // ST segment
  if (t < 0.44) return 0;
  // T wave (may be discordant)
  if (t < 0.62) { const tw = (t - 0.44) / 0.18; return -0.15 * Math.sin(tw * Math.PI); }
  return 0;
}

// ================================================================
// RHYTHM DEFINITIONS
// ================================================================
const RHYTHMS = {
  nsr:       { name:'Normal Sinus Rhythm', rate:72, regular:true, wave:waveNSR, cat:'sa',
               chars:'Rate 60-100 ¬∑ Regular ¬∑ Upright P before each QRS ¬∑ PR 0.12-0.20s ¬∑ Narrow QRS < 0.12s',
               etiology:'Normal cardiac rhythm originating from the SA node.',
               mgmt:'No treatment needed if asymptomatic.' },
  sbrad:     { name:'Sinus Bradycardia', rate:48, regular:true, wave:waveNSR, cat:'sa',
               chars:'Rate < 60 ¬∑ Regular ¬∑ Normal P waves ¬∑ Normal PR ¬∑ Narrow QRS',
               etiology:'Intrinsic sinus node disease, increased vagal tone, hypothermia, hypoxia, hypothyroidism, beta blockers, calcium channel blockers, inferior MI.',
               mgmt:'If symptomatic: Atropine 0.5mg IV. Consider TCP if unresponsive to atropine. Dopamine or epinephrine infusion.' },
  stach:     { name:'Sinus Tachycardia', rate:130, regular:true, wave:waveNSR, cat:'sa',
               chars:'Rate 100-160 ¬∑ Regular ¬∑ Normal P waves (may merge with T) ¬∑ Normal PR ¬∑ Narrow QRS',
               etiology:'Exercise, fever, pain, anxiety, hypovolemia, hyperthyroidism, anemia, heart failure, PE, sympathomimetic drugs.',
               mgmt:'Treat the underlying cause. Do NOT cardiovert sinus tach ‚Äî it will not work and can be harmful.' },
  afib:      { name:'Atrial Fibrillation', rate:110, regular:false, wave:waveAFib, cat:'atrial',
               chars:'Irregularly irregular ¬∑ No distinct P waves ¬∑ Fibrillatory baseline ¬∑ Narrow QRS (usually) ¬∑ Variable ventricular rate',
               etiology:'Heavy alcohol, acute stress, HTN, CAD, valvular disease, HF, hyperthyroidism, PE, post-cardiac surgery.',
               mgmt:'If unstable: synchronized cardioversion. If stable: rate control with diltiazem, beta-blockers. Anticoagulation for stroke prevention.' },
  aflutter:  { name:'Atrial Flutter', rate:150, regular:true, wave:waveAFlutter, cat:'atrial',
               chars:'Sawtooth flutter waves ~300/min ¬∑ Typically 2:1 conduction (rate ~150) ¬∑ Regular ¬∑ Narrow QRS',
               etiology:'CAD, hypertensive heart disease, cardiomyopathy, hypoxia, HF, pericarditis, myocarditis.',
               mgmt:'If unstable: synchronized cardioversion 50-100J. If stable: rate control. Suspect when rate ‚âà 150 bpm.' },
  svt:       { name:'SVT (AVNRT/PSVT)', rate:188, regular:true, wave:waveSVT, cat:'atrial',
               chars:'Rate 150-250 ¬∑ Regular ¬∑ P waves absent or hidden in QRS ¬∑ Very narrow QRS ¬∑ Abrupt onset/offset',
               etiology:'Reentry circuit in AV node (AVNRT most common). May occur at any age. Common in young adults and women. Not commonly associated with structural heart disease.',
               mgmt:'Vagal maneuvers (Valsalva, carotid massage). Adenosine 6mg rapid IV push ‚Üí 12mg ‚Üí 12mg. If unstable: synchronized cardioversion 50-100J.' },
  pac:       { name:'Premature Atrial Complex', rate:75, regular:false, wave:waveNSR, cat:'atrial',
               chars:'Premature beat with abnormal P wave ¬∑ Followed by incomplete compensatory pause ¬∑ Narrow QRS ¬∑ Underlying rhythm usually sinus',
               etiology:'Catecholamines, caffeine, tobacco, alcohol, sympathomimetics, electrolyte imbalance, hypoxia, digitalis toxicity.',
               mgmt:'Usually benign. Remove precipitating cause. Frequent PACs may precede A-Fib, A-Flutter, or SVT.' },
  junctional:{ name:'Junctional Rhythm', rate:50, regular:true, wave:waveJunctional, cat:'junct',
               chars:'Rate 40-60 ¬∑ Regular ¬∑ Inverted P waves before/after QRS or absent ¬∑ Narrow QRS',
               etiology:'SA node failure, increased vagal tone, digitalis toxicity, inferior MI, post-cardiac surgery.',
               mgmt:'If symptomatic: Atropine. Consider pacing if unresponsive.' },
  accel_junct:{ name:'Accelerated Junctional', rate:80, regular:true, wave:waveJunctional, cat:'junct',
               chars:'Rate 60-100 ¬∑ Regular ¬∑ Inverted/absent P waves ¬∑ Narrow QRS ¬∑ Rate exceeds junctional escape but < SVT',
               etiology:'Digitalis toxicity, inferior MI, post-cardiac surgery, rheumatic fever.',
               mgmt:'If from digitalis toxicity: hold digitalis. Usually well-tolerated. Monitor.' },
  pvc:       { name:'Premature Ventricular Complex', rate:72, regular:false, wave:waveNSR, cat:'vent',
               chars:'Wide, bizarre QRS ‚â• 0.12s ¬∑ No preceding P wave ¬∑ Compensatory pause ¬∑ T wave opposite to QRS deflection',
               etiology:'MI, ischemia, hypoxia, acidosis, electrolyte imbalance, heart failure, stimulants, digitalis toxicity.',
               mgmt:'Unifocal, infrequent: monitor. Frequent (>6/min), multifocal, R-on-T, couplets, runs: treat underlying cause. Amiodarone or lidocaine if symptomatic.' },
  vtach:     { name:'Ventricular Tachycardia', rate:165, regular:true, wave:waveVTach, cat:'vent',
               chars:'Rate > 100 ¬∑ Regular ¬∑ Wide QRS ‚â• 0.12s ¬∑ No P waves ¬∑ AV dissociation ¬∑ Monomorphic or polymorphic',
               etiology:'MI, ischemia, cardiomyopathy, electrolyte imbalance, drug toxicity, long QT syndrome.',
               mgmt:'Pulseless: Defibrillation + CPR (treat as VF). With pulse + unstable: synchronized cardioversion. With pulse + stable: Amiodarone 150mg IV or procainamide.' },
  torsades:  { name:'Torsades de Pointes', rate:200, regular:true, wave:waveVTach, cat:'vent',
               chars:'Polymorphic VT ¬∑ "Twisting of the points" ¬∑ QRS amplitude waxes and wanes ¬∑ Associated with prolonged QT',
               etiology:'Prolonged QT interval (congenital or acquired), hypomagnesemia, hypokalemia, drug-induced (antiarrhythmics, antibiotics, antipsychotics).',
               mgmt:'Magnesium sulfate 1-2g IV. Overdrive pacing. Correct underlying cause. Isoproterenol if refractory. If pulseless: defibrillate.' },
  vfib:      { name:'Ventricular Fibrillation', rate:0, regular:false, wave:null, cat:'vent',
               chars:'Chaotic ¬∑ No organized QRS ¬∑ No identifiable P, QRS, or T ¬∑ Pulseless ¬∑ Immediate intervention required',
               etiology:'MI, ischemia, electrical shock, drowning, drug toxicity, untreated VT, R-on-T phenomenon.',
               mgmt:'Immediate defibrillation 120-200J biphasic. CPR. Epinephrine 1mg q3-5min. Amiodarone 300mg ‚Üí 150mg. Treat H\'s and T\'s.' },
  asystole:  { name:'Asystole', rate:0, regular:false, wave:null, cat:'vent',
               chars:'Flat line ¬∑ No electrical activity ¬∑ Confirm in 2 leads ¬∑ Check connections ¬∑ Final pathway of arrest',
               etiology:'End-stage of VF, PEA. Severe hypoxia, hyperkalemia, hypothermia, drug overdose.',
               mgmt:'CPR. Epinephrine 1mg q3-5min. Search for reversible causes (H\'s and T\'s). Do NOT defibrillate (not a shockable rhythm). Consider termination if no ROSC.' },
  '1avb':    { name:'First-Degree AV Block', rate:65, regular:true, wave:wave1AVB, cat:'block',
               chars:'PR interval > 0.20s ¬∑ Constant PR ¬∑ All P waves conducted ¬∑ Not a true block ‚Äî a delay ¬∑ Usually at AV node',
               etiology:'Increased vagal tone, AV nodal blocking drugs (beta blockers, CCBs, digitalis), inferior MI, aging.',
               mgmt:'Usually benign. No treatment needed. Monitor for progression. Identify and describe the underlying rhythm.' },
  'wenck':   { name:'2nd-Degree Type I (Wenckebach)', rate:60, regular:false, wave:null, cat:'block',
               chars:'Progressive PR lengthening ‚Üí dropped QRS ‚Üí cycle repeats ¬∑ Grouped beating ¬∑ Usually at AV node level',
               etiology:'Inferior MI, digitalis toxicity, increased vagal tone, myocarditis, post-cardiac surgery.',
               mgmt:'Usually transient. If symptomatic: Atropine 0.5mg IV. Consider TCP if atropine fails. Monitor for progression.' },
  'mobitz2':  { name:'2nd-Degree Type II (Mobitz)', rate:55, regular:false, wave:null, cat:'block',
               chars:'Constant PR for conducted beats ¬∑ Sudden dropped QRS ¬∑ Conduction ratios 2:1, 3:1 ¬∑ Usually below Bundle of His ¬∑ Wide QRS',
               etiology:'Anterior MI, degenerative conduction disease, post-cardiac surgery.',
               mgmt:'More serious than Type I. TCP (transcutaneous pacing). Prepare for transvenous pacing. Atropine usually ineffective for infranodal block. May progress to complete block.' },
  '3avb':    { name:'Third-Degree (Complete) Heart Block', rate:35, regular:true, wave:null, cat:'block',
               chars:'Complete AV dissociation ¬∑ P waves march independently of QRS ¬∑ Ventricular escape rhythm ¬∑ Rate depends on escape focus',
               etiology:'Inferior or anterior MI, degenerative conduction disease, drug toxicity, post-cardiac surgery.',
               mgmt:'Life-threatening. Immediate TCP. Dopamine or epinephrine infusion. Prepare for transvenous pacing. Atropine may help if junctional escape (narrow QRS).' },
  sinus_arr: { name:'Sinus Arrhythmia', rate:68, regular:false, wave:waveNSR, cat:'sa',
               chars:'Rate 60-100 ¬∑ Irregular (varies with respiration) ¬∑ Normal P waves ¬∑ Normal PR ¬∑ Narrow QRS ¬∑ R-R shortens on inspiration',
               etiology:'Normal physiologic variant, especially in young healthy individuals. Enhanced vagal tone. R-R intervals vary with respiratory cycle.',
               mgmt:'Normal variant ‚Äî no treatment required. Benign finding. Common in children and young adults.' },
  sinus_arrest:{ name:'Sinus Arrest / Pause', rate:60, regular:false, wave:null, cat:'sa',
               chars:'Underlying sinus rhythm ¬∑ Sudden pause with NO P-QRS-T ¬∑ Pause is NOT a multiple of P-P interval ¬∑ Escape beat may follow',
               etiology:'SA node failure to fire. Increased vagal tone, SA node disease, digitalis/beta-blocker/CCB toxicity, MI, hyperkalemia.',
               mgmt:'If symptomatic or prolonged: Atropine 0.5mg IV. TCP if unresponsive. Identify and treat underlying cause. May need permanent pacemaker.' },
  wap:       { name:'Wandering Atrial Pacemaker', rate:65, regular:false, wave:null, cat:'atrial',
               chars:'Rate ‚â§ 100 ¬∑ Slightly irregular ¬∑ At least 3 different P wave morphologies ¬∑ Varying PR intervals ¬∑ Narrow QRS',
               etiology:'Enhanced vagal tone, COPD, heart disease, digitalis use. Pacemaker site shifts between SA node, atria, and AV junction.',
               mgmt:'Usually benign. No treatment typically needed. Monitor. Treat underlying cause if symptomatic.' },
  mat:       { name:'Multifocal Atrial Tachycardia', rate:120, regular:false, wave:null, cat:'atrial',
               chars:'Rate > 100 ¬∑ Irregular ¬∑ At least 3 different P wave morphologies ¬∑ Varying PR intervals ¬∑ Varying P-P intervals ¬∑ Narrow QRS',
               etiology:'Severe COPD (most common), acute illness, hypoxia, HF, theophylline use, hypomagnesemia, hypokalemia.',
               mgmt:'Treat underlying cause (COPD exacerbation, hypoxia). Magnesium sulfate. Correct electrolytes. Verapamil may help. Do NOT cardiovert ‚Äî will not work. Rate control with calcium channel blockers if needed.' },
  junct_tach:{ name:'Junctional Tachycardia', rate:130, regular:true, wave:waveJunctTach, cat:'junct',
               chars:'Rate 100-180 ¬∑ Regular ¬∑ Absent or retrograde (inverted) P waves ¬∑ Narrow QRS ¬∑ AV junction rate exceeds upper limit',
               etiology:'Digitalis toxicity (most common cause), MI, post-cardiac surgery, myocarditis, catecholamines, hypoxia.',
               mgmt:'If digitalis toxicity: hold digitalis, give Digibind (digoxin-specific antibody fragments). If hemodynamically unstable: consider amiodarone or cardioversion. Treat underlying cause.' },
  idiovent:  { name:'Idioventricular Rhythm', rate:32, regular:true, wave:waveIdioventricular, cat:'vent',
               chars:'Rate 20-40 ¬∑ Regular ¬∑ No P waves ¬∑ Wide bizarre QRS ‚â• 0.12s ¬∑ Ventricular escape rhythm ¬∑ T wave opposite QRS',
               etiology:'Last-resort escape rhythm when SA node and AV junction fail. Complete heart block, dying heart, post-resuscitation.',
               mgmt:'Treat underlying cause. If hemodynamically unstable: Atropine, dopamine, epinephrine, TCP. Do NOT suppress with lidocaine/amiodarone ‚Äî it may be the only rhythm keeping the patient alive.' },
  aivr:      { name:'Accelerated Idioventricular (AIVR)', rate:72, regular:true, wave:waveAIVR, cat:'vent',
               chars:'Rate 40-100 ¬∑ Regular ¬∑ No P waves ¬∑ Wide QRS ‚â• 0.12s ¬∑ Ventricular focus fires faster than intrinsic rate ¬∑ Often "reperfusion rhythm"',
               etiology:'Reperfusion after MI (good sign with thrombolytics/PCI), digitalis toxicity, myocarditis, post-resuscitation, electrolyte imbalance.',
               mgmt:'Usually benign and self-limiting. Monitor closely. Often seen as a reperfusion marker after successful PCI/thrombolysis. Avoid suppressing ‚Äî rarely causes hemodynamic compromise. If unstable: Atropine to increase SA rate above ventricular focus.' },
  agonal:    { name:'Agonal Rhythm', rate:18, regular:false, wave:waveAgonal, cat:'vent',
               chars:'Rate < 20 ¬∑ Irregular ¬∑ Very wide bizarre QRS ¬∑ No P waves ¬∑ Dying heart rhythm ¬∑ Near-terminal',
               etiology:'End-stage cardiac event. Severe hypoxia, acidosis, hyperkalemia. Often seen as final rhythm before asystole.',
               mgmt:'Full cardiac arrest protocol. CPR, epinephrine, search for and treat reversible causes (H\'s and T\'s). This rhythm indicates severe myocardial compromise.' },
  paced:     { name:'Ventricular Paced Rhythm', rate:72, regular:true, wave:wavePaced, cat:'vent',
               chars:'Pacer spike before each QRS ¬∑ Wide QRS (paced morphology) ¬∑ Regular ¬∑ Rate set by pacer (usually 60-80) ¬∑ Underlying rhythm may be visible',
               etiology:'Artificial pacemaker implanted for symptomatic bradycardia, complete heart block, sick sinus syndrome, or other conduction disorders.',
               mgmt:'Verify capture (each spike followed by QRS). Verify sensing (pacer recognizes intrinsic beats). Document pacer settings. If failure to capture: increase output, reposition, check connections.' },
};

// Build ECG control buttons
function buildECGControls() {
  const order = ['nsr','sbrad','stach','sinus_arr','sinus_arrest','afib','aflutter','svt','pac','wap','mat','junctional','accel_junct','junct_tach','pvc','vtach','torsades','vfib','asystole','idiovent','aivr','agonal','paced','1avb','wenck','mobitz2','3avb'];
  const container = document.getElementById('ecgControls');
  order.forEach(key => {
    const r = RHYTHMS[key];
    const btn = document.createElement('button');
    btn.className = 'ecg-btn' + (key === 'nsr' ? ' active' : '');
    btn.textContent = r.name
      .replace('First-Degree ','1¬∞ ')
      .replace('2nd-Degree Type I ','')
      .replace('2nd-Degree Type II ','')
      .replace('Third-Degree (Complete) Heart Block','3¬∞ AV Block')
      .replace('Ventricular Fibrillation','V-Fib')
      .replace('Ventricular Tachycardia','V-Tach')
      .replace('Premature Ventricular Complex','PVC')
      .replace('Atrial Fibrillation','A-Fib')
      .replace('Atrial Flutter','A-Flutter')
      .replace('(AVNRT/PSVT)','')
      .replace('Premature Atrial Complex','PAC')
      .replace('Accelerated Junctional','Accel Junct')
      .replace('Junctional Rhythm','Junctional')
      .replace('Junctional Tachycardia','Junct Tach')
      .replace('Torsades de Pointes','Torsades')
      .replace('Sinus Arrhythmia','Sinus Arrhy')
      .replace('Sinus Arrest / Pause','Sinus Arrest')
      .replace('Wandering Atrial Pacemaker','WAP')
      .replace('Multifocal Atrial Tachycardia','MAT')
      .replace('Idioventricular Rhythm','Idiovent')
      .replace('Accelerated Idioventricular (AIVR)','AIVR')
      .replace('Agonal Rhythm','Agonal')
      .replace('Ventricular Paced Rhythm','V-Paced')
      .trim();
    btn.onclick = () => {
      currentRhythm = key;
      ecgX = 0;
      document.querySelectorAll('#ecgControls .ecg-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      updateRhythmDisplay();
    };
    container.appendChild(btn);
  });
}

// ================================================================
// LIVE ECG MONITOR RENDERER
// ================================================================
let currentRhythm = 'nsr';
let ecgX = 0;
let ecgCanvas, ecgCtx;
let beatCounter = 0;
let wenckebachBeat = 0;

function updateRhythmDisplay() {
  const r = RHYTHMS[currentRhythm];
  document.getElementById('ecgRate').innerHTML = r.rate > 0 ? `${r.rate}<span>BPM</span>` : `---<span>BPM</span>`;
  document.getElementById('rhythmName').textContent = r.name + ' ‚Üó';
}

function initECG() {
  ecgCanvas = document.getElementById('ecgCanvas');
  ecgCtx = ecgCanvas.getContext('2d');
  resizeECGCanvas();
  requestAnimationFrame(drawECGFrame);
}

function resizeECGCanvas() {
  const parent = ecgCanvas.parentElement;
  ecgCanvas.width = parent.clientWidth;
  ecgCanvas.height = 280;
}

// Compute period in PIXELS for one cardiac cycle
// Canvas width = 6 seconds of ECG at 25mm/s paper speed
function getPeriod(rate, canvasWidth) {
  if (rate <= 0) return canvasWidth * 2;
  const pxPerSec = canvasWidth / 6; // 6-second strip
  const secPerBeat = 60 / rate;
  return pxPerSec * secPerBeat;
}

// Get waveform value at pixel position for the current rhythm
function getECGValue(xPos, rhythm, canvasWidth) {
  const r = RHYTHMS[rhythm];
  const period = getPeriod(r.rate, canvasWidth);

  if (rhythm === 'vfib') return waveVFib(xPos * 0.06);
  if (rhythm === 'asystole') return waveAsystole(xPos * 0.06);

  if (rhythm === 'torsades') {
    const secPerBeat = 60 / r.rate;
    const pxPerSec = canvasWidth / 6;
    const beatLen = pxPerSec * secPerBeat;
    const beatNum = Math.floor(xPos / beatLen);
    const t = (xPos % beatLen) / beatLen;
    return waveTorsades(t, beatNum);
  }

  if (rhythm === 'afib') {
    // Irregularly irregular: vary the R-R interval
    const basePeriod = period;
    const irregFactor = 0.65 + 0.70 * (0.5 + 0.5 * Math.sin(xPos * 0.007 + Math.sin(xPos * 0.003)));
    const irregPeriod = basePeriod * irregFactor;
    const t = (xPos % irregPeriod) / irregPeriod;
    return waveAFib(t, xPos * 0.06);
  }

  if (rhythm === 'aflutter') {
    const t = (xPos % period) / period;
    return waveAFlutter(t, xPos * 0.015);
  }

  if (rhythm === '3avb') {
    const t = (xPos % period) / period;
    return wave3AVB(t, xPos * 0.015, period * 0.015);
  }

  if (rhythm === 'pvc') {
    const cycleNum = Math.floor(xPos / period);
    const t = (xPos % period) / period;
    return cycleNum % 4 === 2 ? wavePVC(t) : waveNSR(t);
  }

  if (rhythm === 'pac') {
    const cycleNum = Math.floor(xPos / period);
    const t = (xPos % period) / period;
    return cycleNum % 5 === 3 ? waveNSR(t * 0.85) * 0.9 : waveNSR(t);
  }

  if (rhythm === 'wenck') {
    const groupPeriod = period * 4.3;
    const posInGroup = xPos % groupPeriod;
    const beatInGroup = Math.floor(posInGroup / (groupPeriod / 4));
    const t = (posInGroup % (groupPeriod / 4)) / (groupPeriod / 4);
    return waveWenck(t, beatInGroup);
  }

  if (rhythm === 'mobitz2') {
    const groupPeriod = period * 3;
    const posInGroup = xPos % groupPeriod;
    const beatInGroup = Math.floor(posInGroup / (groupPeriod / 3));
    const t = (posInGroup % (groupPeriod / 3)) / (groupPeriod / 3);
    if (beatInGroup === 2) {
      if (t > 0.05 && t < 0.15) { const p = (t - 0.05) / 0.10; return 0.12 * Math.sin(p * Math.PI); }
      return 0;
    }
    return waveNSR(t);
  }

  if (rhythm === 'sinus_arr') {
    // Sinus arrhythmia: R-R varies sinusoidally (breathing cycle)
    const breathCycle = canvasWidth * 1.5; // one breath ~ 4-5 seconds
    const breathPhase = (xPos % breathCycle) / breathCycle;
    const rateMultiplier = 0.75 + 0.50 * Math.sin(breathPhase * 2 * Math.PI);
    const varPeriod = period * rateMultiplier;
    const t = (xPos % varPeriod) / varPeriod;
    return waveNSR(t);
  }

  if (rhythm === 'sinus_arrest') {
    // Normal sinus with a pause every 5th beat (beat 3 is missing)
    const groupPeriod = period * 6; // 5 beats + 1 pause worth of time
    const posInGroup = xPos % groupPeriod;
    const beatInGroup = Math.floor(posInGroup / period);
    const t = (posInGroup % period) / period;
    if (beatInGroup === 3) return 0; // The arrest ‚Äî flat line
    if (beatInGroup >= 5) return 0; // still in the pause
    return waveNSR(t);
  }

  if (rhythm === 'wap') {
    // Wandering Atrial Pacemaker: slightly irregular, varying P morphology
    const varPeriod = period * (0.85 + 0.30 * Math.sin(xPos * 0.005));
    const beatNum = Math.floor(xPos / varPeriod);
    const t = (xPos % varPeriod) / varPeriod;
    return waveWAP(t, beatNum);
  }

  if (rhythm === 'mat') {
    // MAT: irregular, multiple P morphologies, rate > 100
    const varPeriod = period * (0.70 + 0.60 * (0.5 + 0.5 * Math.sin(xPos * 0.008 + Math.sin(xPos * 0.004))));
    const beatNum = Math.floor(xPos / varPeriod);
    const t = (xPos % varPeriod) / varPeriod;
    return waveMAT(t, beatNum);
  }

  if (rhythm === 'agonal') {
    // Agonal: very slow, irregular
    const varPeriod = period * (0.7 + 0.6 * Math.abs(Math.sin(xPos * 0.002)));
    const t = (xPos % varPeriod) / varPeriod;
    return waveAgonal(t);
  }

  // Default: use rhythm's wave function with correct period
  if (r.wave) {
    const t = (xPos % period) / period;
    return r.wave(t);
  }
  return 0;
}

function drawECGFrame() {
  const w = ecgCanvas.width, h = ecgCanvas.height;
  const mid = h * 0.48;
  const amp = h * 0.36;

  // 1. Draw ECG paper grid (clears canvas)
  drawECGPaper(ecgCtx, w, h);

  // 2. Draw waveform - sharp green trace
  ecgCtx.beginPath();
  ecgCtx.strokeStyle = '#00E676';
  ecgCtx.lineWidth = 2.2;
  ecgCtx.lineJoin = 'round';
  ecgCtx.lineCap = 'round';

  for (let px = 0; px < w; px++) {
    const xPos = ecgX + px;
    const y = getECGValue(xPos, currentRhythm, w);
    const py = mid - y * amp;
    if (px === 0) ecgCtx.moveTo(px, py);
    else ecgCtx.lineTo(px, py);
  }
  ecgCtx.stroke();

  // 3. Sweep cursor (eraser bar at the drawing head)
  const sweepPos = ecgX % w;
  // Dark eraser ahead of sweep
  ecgCtx.fillStyle = 'rgba(28,20,16,0.93)';
  ecgCtx.fillRect(sweepPos, 0, 60, h);
  // Green glow at leading edge
  const grad = ecgCtx.createLinearGradient(sweepPos - 4, 0, sweepPos + 8, 0);
  grad.addColorStop(0, 'transparent');
  grad.addColorStop(0.5, 'rgba(0,230,118,0.35)');
  grad.addColorStop(1, 'transparent');
  ecgCtx.fillStyle = grad;
  ecgCtx.fillRect(sweepPos - 4, 0, 12, h);

  ecgX += 1.5;
  requestAnimationFrame(drawECGFrame);
}

// ================================================================
// ECG COMPONENT VIEWER
// ================================================================
const compData = {
  p:  { color:'#FFD166', label:'P Wave', desc:'First positive deflection. Atrial depolarization. Duration < 0.12s. Upright in Lead II = sinus origin. Amplitude < 2.5mm. Absent in A-Fib, junctional, and ventricular rhythms. Inverted/retrograde in junctional rhythms.', range:[0.02,0.12], waveType:'nsr' },
  pr: { color:'#118AB2', label:'PR Interval', desc:'From P wave onset to QRS onset. Atrial depolarization + AV delay. Normal: 0.12‚Äì0.20s (3-5 small boxes). Prolonged > 0.20s = 1st degree AV block. Short < 0.12s = WPW syndrome or junctional origin. Absent if no P wave.', range:[0.02,0.20], waveType:'nsr' },
  qrs:{ color:'#00E676', label:'QRS Complex', desc:'Ventricular depolarization ‚Äî composed of Q, R, and S waves. Normal duration < 0.12s (< 3 small boxes). Wide ‚â• 0.12s indicates ventricular origin, bundle branch block, or accessory pathway (WPW). Amplitude and morphology help identify hypertrophy and infarction.', range:[0.20,0.29], waveType:'nsr' },
  st: { color:'#457B9D', label:'ST Segment', desc:'Period between end of ventricular depolarization and start of repolarization. Begins at J point, ends at T wave onset. Should be isoelectric (flat at baseline). Elevation ‚â• 1mm = acute myocardial injury (STEMI). Depression ‚â• 1mm = ischemia or reciprocal changes. Measured 0.04s (1mm) after J point.', range:[0.29,0.42], waveType:'nsr' },
  t:  { color:'#EF476F', label:'T Wave', desc:'Ventricular repolarization. Rounded and slightly asymmetric (gradual upstroke, steeper downstroke). Normally upright in Lead II. Tall peaked = hyperkalemia. Inverted = ischemia, strain, or BBB. Phase 3 of action potential. Contains the "vulnerable period" for R-on-T phenomenon.', range:[0.42,0.60], waveType:'nsr' },
  qt: { color:'#FF6B35', label:'QT Interval', desc:'Total ventricular depolarization + repolarization. QRS onset to T wave end. Normal: 0.36‚Äì0.44s. Must correct for HR ‚Üí QTc (Bazett formula: QTc = QT / ‚àöRR). Prolonged QTc > 0.46s (‚ôÄ) or > 0.45s (‚ôÇ) ‚Üí increased risk of Torsades de Pointes. Caused by drugs, electrolytes, congenital long QT syndrome.', range:[0.20,0.60], waveType:'nsr' },
  jwave:{ color:'#00BCD4', label:'J Wave (Osborn)', desc:'Small positive deflection at the J point ‚Äî the junction where the QRS complex meets the ST segment. Also called the Osborn wave. Classic finding in hypothermia (core temp < 32¬∞C / 90¬∞F). Amplitude increases as body temperature decreases. Also seen in hypercalcemia, Brugada syndrome, subarachnoid hemorrhage, and early repolarization (benign variant in young patients). Disappears with rewarming.', range:[0.28,0.34], waveType:'jwave' },
  delta:{ color:'#E040FB', label:'Delta Wave (WPW)', desc:'Slurred, slow upstroke at the beginning of the QRS complex caused by ventricular pre-excitation through an accessory pathway (Bundle of Kent) that bypasses the AV node. Hallmark of Wolff-Parkinson-White (WPW) syndrome. WPW triad: Short PR interval (< 0.12s) + Delta wave + Wide QRS (> 0.12s). Patients at risk for re-entrant SVT and rapid A-Fib with dangerously fast ventricular rates. Do NOT give AV nodal blockers (adenosine, verapamil, digoxin) in WPW with A-Fib ‚Äî may cause VF.', range:[0.16,0.26], waveType:'delta' }
};
let activeComp = 'p';

function drawCompWaveform() {
  const canvas = document.getElementById('ecgCompCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.parentElement.clientWidth;
  canvas.height = 220;
  const w = canvas.width, h = canvas.height;
  
  drawECGPaper(ctx, w, h);
  
  const mid = h * 0.48, amp = h * 0.36;
  const pxPerSec = w / 6;
  const period = pxPerSec * (60 / 72); // 72bpm NSR reference
  const comp = compData[activeComp];
  const offset = w * 0.08;
  
  // Pick waveform function based on waveType
  const waveFn = comp.waveType === 'jwave' ? waveJWave : comp.waveType === 'delta' ? waveDelta : waveNSR;
  
  // Highlight region
  const x1 = offset + comp.range[0] * period;
  const x2 = offset + comp.range[1] * period;
  ctx.fillStyle = comp.color + '20';
  ctx.fillRect(x1, 0, x2-x1, h);
  ctx.strokeStyle = comp.color + '50';
  ctx.lineWidth = 1.5;
  ctx.setLineDash([4,2]);
  ctx.beginPath(); ctx.moveTo(x1,0); ctx.lineTo(x1,h); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(x2,0); ctx.lineTo(x2,h); ctx.stroke();
  ctx.setLineDash([]);
  
  // Draw multiple complexes to fill canvas
  const numComplexes = Math.ceil(w / period) + 1;
  for (let c = 0; c < numComplexes; c++) {
    const ox = offset + c * period;
    ctx.beginPath();
    ctx.strokeStyle = c===0 ? '#00E676' : 'rgba(0,230,118,0.25)';
    ctx.lineWidth = c===0 ? 2.5 : 1.5;
    ctx.lineJoin = 'round';
    for (let px = 0; px < period; px++) {
      const t = px / period;
      const y = waveFn(t);
      const py = mid - y * amp;
      if (px===0) ctx.moveTo(ox+px, py); else ctx.lineTo(ox+px, py);
    }
    ctx.stroke();
    
    // Highlighted segment
    if (c===0) {
      ctx.beginPath();
      ctx.strokeStyle = comp.color;
      ctx.lineWidth = 3.5;
      const sp = Math.floor(comp.range[0] * period);
      const ep = Math.ceil(comp.range[1] * period);
      for (let px = sp; px <= ep; px++) {
        const t = px/period;
        const y = waveFn(t);
        const py = mid - y * amp;
        if (px===sp) ctx.moveTo(ox+px, py); else ctx.lineTo(ox+px, py);
      }
      ctx.stroke();
    }
  }
  
  // Label
  ctx.font = '600 13px "DM Sans"';
  ctx.fillStyle = comp.color;
  ctx.textAlign = 'center';
  ctx.fillText(comp.label, (x1+x2)/2, 18);
}

function showComp(key) {
  activeComp = key;
  const comp = compData[key];
  document.getElementById('compDetail').innerHTML = `<h4 style="color:${comp.color}">${comp.label}</h4><p>${comp.desc}</p>`;
  document.querySelectorAll('.comp-label').forEach(l => l.classList.remove('active'));
  const clicked = event.target.closest('.comp-label');
  if (clicked) clicked.classList.add('active');
  drawCompWaveform();
}

// ================================================================
// CONDUCTION ANIMATION ‚Äî Click any step or play all
// ================================================================
const conductionSteps = ['ts-sa','ts-inter','ts-av','ts-his','ts-purk'];
const conductionPositions = [{cx:130,cy:115},{cx:165,cy:170},{cx:200,cy:220},{cx:200,cy:260},{cx:200,cy:380}];
const conductionSvgIds = [
  ['cSA'],           // step 0: SA node
  ['cInter'],        // step 1: internodal
  ['cAV'],           // step 2: AV node
  ['cHis','cLBB','cRBB'], // step 3: His + bundle branches
  ['cPurk']          // step 4: Purkinje
];
let conductionAnimRunning = false;

function resetConduction() {
  conductionAnimRunning = false;
  conductionSteps.forEach(s => document.getElementById(s).classList.remove('active'));
  ['cSA','cInter','cAV','cHis','cLBB','cRBB','cPurk'].forEach(id => {
    document.getElementById(id).style.opacity = '0.2';
    document.getElementById(id).style.transition = 'opacity 0.4s';
  });
  const dot = document.getElementById('impulseDot');
  dot.style.opacity = '0';
  dot.style.transition = 'none';
}

function animateSingleStep(stepIdx) {
  if (conductionAnimRunning) return;
  const dot = document.getElementById('impulseDot');
  
  // Light up this step's SVG elements
  conductionSvgIds[stepIdx].forEach(id => {
    document.getElementById(id).style.transition = 'opacity 0.4s';
    document.getElementById(id).style.opacity = '1';
  });
  
  // Activate timeline label
  document.getElementById(conductionSteps[stepIdx]).classList.add('active');
  
  // Move impulse dot
  dot.style.transition = 'all 0.5s ease';
  dot.style.opacity = '1';
  dot.setAttribute('cx', conductionPositions[stepIdx].cx);
  dot.setAttribute('cy', conductionPositions[stepIdx].cy);
  
  // Fade dot after a moment
  setTimeout(() => {
    if (!conductionAnimRunning) dot.style.opacity = '0.4';
  }, 1200);
}

function startConductionAnim() {
  if (conductionAnimRunning) return;
  resetConduction();
  conductionAnimRunning = true;
  const dot = document.getElementById('impulseDot');
  
  function animStep(step) {
    if (step >= conductionSteps.length || !conductionAnimRunning) {
      conductionAnimRunning = false;
      setTimeout(() => { dot.style.opacity = '0'; }, 800);
      return;
    }
    animateSingleStep(step);
    const delay = step === 2 ? 1200 : 700; // longer pause at AV node
    setTimeout(() => animStep(step + 1), delay);
  }
  animStep(0);
}

// ================================================================
// DYSRHYTHMIA GALLERY
// ================================================================
const galleryCards = {
  sa: ['nsr','sbrad','stach','sinus_arr','sinus_arrest'],
  atrial: ['pac','afib','aflutter','svt','wap','mat'],
  junct: ['junctional','accel_junct','junct_tach'],
  vent: ['pvc','vtach','torsades','vfib','asystole','idiovent','aivr','agonal','paced'],
  block: ['1avb','wenck','mobitz2','3avb']
};

function drawStaticRhythm(ctx, w, h, key) {
  const r = RHYTHMS[key];
  drawECGPaper(ctx, w, h);
  
  const mid = h*0.48, amp = h*0.38;
  // Show ~3 seconds of rhythm
  const pxPerSec = w / 3;
  const period = r.rate > 0 ? pxPerSec * (60 / r.rate) : w;
  
  ctx.beginPath();
  ctx.strokeStyle = '#00E676';
  ctx.lineWidth = 1.8;
  ctx.lineJoin = 'round';
  
  for (let px = 0; px < w; px++) {
    let y = 0;
    const xVal = px;
    
    if (key === 'vfib') { y = waveVFib(xVal*0.08); }
    else if (key === 'asystole') { y = waveAsystole(xVal*0.08); }
    else if (key === 'torsades') {
      const beatLen = pxPerSec * (60/r.rate);
      const beat = Math.floor(xVal/beatLen);
      const t = (xVal%beatLen)/beatLen;
      y = waveTorsades(t, beat);
    } else if (key === 'afib') {
      const irregP = period*(0.65+0.70*(0.5+0.5*Math.sin(xVal*0.02)));
      const t = (xVal%irregP)/irregP;
      y = waveAFib(t, xVal*0.08);
    } else if (key === 'aflutter') {
      const t = (xVal%period)/period;
      y = waveAFlutter(t, xVal*0.02);
    } else if (key === '3avb') {
      const t = (xVal%period)/period;
      y = wave3AVB(t, xVal*0.02, period*0.02);
    } else if (key === 'pvc') {
      const cn = Math.floor(xVal/period);
      const t = (xVal%period)/period;
      y = cn%4===2 ? wavePVC(t) : waveNSR(t);
    } else if (key === 'pac') {
      const cn = Math.floor(xVal/period);
      const t = (xVal%period)/period;
      y = cn%5===3 ? waveNSR(t*0.85)*0.9 : waveNSR(t);
    } else if (key === 'wenck') {
      const cp = period*4.3;
      const pos = xVal%cp;
      const bic = Math.floor(pos/(cp/4));
      const t = (pos%(cp/4))/(cp/4);
      y = waveWenck(t, bic);
    } else if (key === 'mobitz2') {
      const cp = period*3;
      const pos = xVal%cp;
      const bic = Math.floor(pos/(cp/3));
      const t = (pos%(cp/3))/(cp/3);
      if (bic===2) { if(t>0.05&&t<0.15){const p=(t-0.05)/0.10;y=0.12*Math.sin(p*Math.PI);}else y=0; }
      else y = waveNSR(t);
    } else if (key === 'sinus_arr') {
      const breathCycle = w * 1.5;
      const breathPhase = (xVal % breathCycle) / breathCycle;
      const rateMultiplier = 0.75 + 0.50 * Math.sin(breathPhase * 2 * Math.PI);
      const varPeriod = period * rateMultiplier;
      const t = (xVal % varPeriod) / varPeriod;
      y = waveNSR(t);
    } else if (key === 'sinus_arrest') {
      const groupPeriod = period * 6;
      const posInGroup = xVal % groupPeriod;
      const beatInGroup = Math.floor(posInGroup / period);
      const t = (posInGroup % period) / period;
      if (beatInGroup === 3 || beatInGroup >= 5) y = 0;
      else y = waveNSR(t);
    } else if (key === 'wap') {
      const varPeriod = period * (0.85 + 0.30 * Math.sin(xVal * 0.04));
      const beatNum = Math.floor(xVal / varPeriod);
      const t = (xVal % varPeriod) / varPeriod;
      y = waveWAP(t, beatNum);
    } else if (key === 'mat') {
      const varPeriod = period * (0.70 + 0.60 * (0.5 + 0.5 * Math.sin(xVal * 0.04)));
      const beatNum = Math.floor(xVal / varPeriod);
      const t = (xVal % varPeriod) / varPeriod;
      y = waveMAT(t, beatNum);
    } else if (key === 'agonal') {
      const varPeriod = period * (0.7 + 0.6 * Math.abs(Math.sin(xVal * 0.01)));
      const t = (xVal % varPeriod) / varPeriod;
      y = waveAgonal(t);
    } else if (r.wave) {
      const t = (xVal%period)/period;
      y = r.wave(t);
    }
    
    const py = mid - y * amp;
    if (px===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  }
  ctx.stroke();
}

function buildGallery() {
  Object.entries(galleryCards).forEach(([cat, keys]) => {
    const container = document.getElementById(cat+'Gallery');
    if (!container) return;
    keys.forEach((key, idx) => {
      const r = RHYTHMS[key];
      if (!r) return;
      const badgeClass = cat==='sa'?'badge-sa':cat==='atrial'?'badge-atrial':cat==='junct'?'badge-junctional':cat==='vent'?'badge-ventricular':'badge-block';
      const catName = cat==='sa'?'SA Node':cat==='atrial'?'Atrial':cat==='junct'?'Junctional':cat==='vent'?'Ventricular':'AV Block';
      
      const div = document.createElement('div');
      div.className = 'rhythm-card';
      div.onclick = () => openRhythmModal(key);
      div.innerHTML = `
        <div class="rhythm-canvas-wrap ecg-paper-bg"><canvas id="gc-${cat}-${idx}" height="110"></canvas></div>
        <div class="rhythm-info">
          <h4>${r.name}</h4>
          <div class="rhythm-chars">${r.chars.split('¬∑').slice(0,3).join('¬∑')}</div>
          <span class="rhythm-badge ${badgeClass}">${catName}</span>
        </div>`;
      container.appendChild(div);
      
      setTimeout(() => {
        const canvas = document.getElementById(`gc-${cat}-${idx}`);
        if (!canvas) return;
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = 110;
        drawStaticRhythm(canvas.getContext('2d'), canvas.width, canvas.height, key);
      }, 150);
    });
  });
}

// ================================================================
// MODAL SYSTEM
// ================================================================
function openModal(id) {
  const body = document.getElementById('modalBody');
  body.innerHTML = getModalContent(id);
  document.getElementById('modalOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
  // Draw any rhythm strips in modal
  setTimeout(() => {
    document.querySelectorAll('.modal-rhythm-canvas').forEach(c => {
      c.width = c.parentElement.clientWidth;
      c.height = 140;
      const key = c.dataset.rhythm;
      if (key && RHYTHMS[key]) drawStaticRhythm(c.getContext('2d'), c.width, c.height, key);
    });
  }, 100);
}

function openRhythmModal(key) {
  const r = RHYTHMS[key];
  if (!r) return;
  const body = document.getElementById('modalBody');
  body.innerHTML = `
    <h2><span class="gradient">${r.name}</span></h2>
    <p class="modal-sub">Click the rhythm on the ECG monitor to view it live</p>
    <div class="ecg-paper-bg modal-rhythm-strip"><canvas class="modal-rhythm-canvas" data-rhythm="${key}" height="140"></canvas></div>
    <h3>üìã Characteristics</h3>
    <div class="modal-rhythm-chars">
      ${r.chars.split('¬∑').map(c => `<div class="char-item">‚Ä¢ ${c.trim()}</div>`).join('')}
    </div>
    <h3>üî¨ Etiology</h3>
    <p>${r.etiology}</p>
    <h3>üöë Management</h3>
    <div class="highlight-box red"><p style="margin:0">${r.mgmt}</p></div>
  `;
  document.getElementById('modalOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
  setTimeout(() => {
    document.querySelectorAll('.modal-rhythm-canvas').forEach(c => {
      c.width = c.parentElement.clientWidth;
      c.height = 140;
      drawStaticRhythm(c.getContext('2d'), c.width, c.height, key);
    });
  }, 100);
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
  document.body.style.overflow = '';
}

document.addEventListener('keydown', e => { if(e.key==='Escape') closeModal(); });

function getModalContent(id) {
  const M = {
    'risk-nonmod': `<h2><span class="gradient">Non-Modifiable Risk Factors</span></h2><p class="modal-sub">Factors that cannot be changed but must be assessed</p>
      <h3>Key Factors</h3><ul><li><strong>Advanced age</strong> ‚Äî Risk increases significantly with age</li><li><strong>Male sex</strong> ‚Äî Men have higher risk, especially before age 65</li><li><strong>Hereditary factors</strong> ‚Äî Family history of premature heart disease</li><li><strong>Ethnicity</strong> ‚Äî African Americans, Mexican Americans, American Indians, Native Hawaiians, and some Asian Americans have higher tendency for heart disease</li></ul>`,
    'risk-mod': `<h2><span class="gradient">Modifiable Risk Factors</span></h2><p class="modal-sub">Factors the patient can control to reduce cardiac risk</p>
      <h3>Lifestyle Modifications</h3><ul><li><strong>Smoking cessation</strong> ‚Äî or elimination of smoke exposure</li><li><strong>Blood pressure control</strong> ‚Äî Medical management of hypertension</li><li><strong>Diabetes management</strong> ‚Äî Tight glycemic control</li><li><strong>Cholesterol & lipid disorders</strong> ‚Äî Statins, diet modification</li><li><strong>Regular exercise</strong> ‚Äî At least 150 min/week moderate intensity</li><li><strong>Weight loss</strong> ‚Äî Maintain healthy BMI</li><li><strong>Dietary improvements</strong> ‚Äî Low sodium, heart-healthy diet</li></ul>`,
    'risk-prevent': `<h2><span class="gradient">Prevention Strategies</span></h2><p class="modal-sub">Pharmacologic and community-based prevention</p>
      <h3>Pharmacologic Prevention</h3><ul><li><strong>Statins</strong> ‚Äî Cholesterol reduction</li><li><strong>Aspirin</strong> ‚Äî Antiplatelet therapy</li><li><strong>Beta blockers</strong> ‚Äî Rate and BP control</li></ul>
      <h3>Community Education</h3><ul><li>Nutrition education programs</li><li>Smoking cessation and prevention (especially for children)</li><li>Diabetes and hypertension screening</li><li><strong>Teaching CPR and early AED use</strong> ‚Äî Critical to improve cardiac arrest outcomes</li></ul>`,
    'phys-cycle': `<h2><span class="gradient">The Cardiac Cycle</span></h2><p class="modal-sub">One complete heartbeat ‚Äî systole and diastole at ~70 bpm in resting adults (~0.8s per cycle)</p>
      <h3>Systole (Ventricular Contraction) ‚Äî ~0.3s</h3>
      <ul><li><strong>Isovolumetric Contraction:</strong> All valves closed. Ventricular pressure rises rapidly. Volume stays constant. Produces the QRS complex on ECG.</li>
      <li><strong>Ventricular Ejection:</strong> Pressure exceeds aortic/PA pressure ‚Üí semilunar valves open. Blood ejected into aorta and pulmonary artery. LV ejects ~70 mL (stroke volume). Ejection Fraction (EF) = SV/EDV √ó 100. Normal EF = 55-70%.</li></ul>
      <h3>Diastole (Ventricular Relaxation) ‚Äî ~0.5s</h3>
      <ul><li><strong>Isovolumetric Relaxation:</strong> All valves closed again. Ventricular pressure drops rapidly.</li>
      <li><strong>Passive Filling (Rapid + Slow):</strong> AV valves open ‚Üí blood flows from atria to ventricles passively due to pressure gradient. Accounts for ~70-80% of ventricular filling.</li>
      <li><strong>Atrial Systole (Atrial Kick):</strong> Atria contract during late diastole. Contributes final 20-30% of ventricular filling. Loss of atrial kick (A-Fib) can reduce CO by 20-30%.</li></ul>
      <h3>Heart Sounds</h3>
      <ul><li><strong>S‚ÇÅ ("Lub"):</strong> Closure of AV valves (mitral + tricuspid). Marks onset of systole.</li>
      <li><strong>S‚ÇÇ ("Dub"):</strong> Closure of semilunar valves (aortic + pulmonic). Marks onset of diastole.</li>
      <li><strong>S‚ÇÉ (Ventricular Gallop):</strong> Rapid filling in dilated ventricle. May indicate CHF in adults.</li>
      <li><strong>S‚ÇÑ (Atrial Gallop):</strong> Atrial contraction against stiff ventricle. Indicates ventricular hypertrophy or ischemia.</li></ul>
      <div class="highlight-box"><p style="margin:0"><strong>Clinical Pearl:</strong> Coronary perfusion occurs primarily during diastole. Tachycardia shortens diastole ‚Üí reduced coronary filling time ‚Üí potential ischemia.</p></div>`,
    'phys-preload': `<h2><span class="gradient">Preload & Frank-Starling Law</span></h2><p class="modal-sub">The relationship between myocardial fiber stretch and contractile force</p>
      <div class="highlight-box gold"><p style="margin:0"><strong>Frank-Starling Law:</strong> The greater the stretch (preload) on myocardial fibers before contraction, the greater the force of contraction ‚Äî up to a physiologic limit. Beyond that limit, further stretching actually decreases contractile force.</p></div>
      <h3>What Determines Preload?</h3>
      <ul><li><strong>Venous return:</strong> Primary determinant. More blood returning to heart = more stretch</li>
      <li><strong>End-Diastolic Volume (EDV):</strong> Volume in ventricle at end of diastole (~120 mL). Direct measure of preload</li>
      <li><strong>Venous tone:</strong> Venoconstriction ‚Üë preload; venodilation ‚Üì preload</li>
      <li><strong>Blood volume:</strong> Hemorrhage, dehydration ‚Üì preload. Fluid overload ‚Üë preload</li>
      <li><strong>Atrial kick:</strong> Loss (A-Fib) reduces EDV by 20-30%</li>
      <li><strong>Body position:</strong> Supine ‚Üë venous return; standing ‚Üì venous return</li>
      <li><strong>Intrathoracic pressure:</strong> Positive pressure ventilation ‚Üì venous return</li></ul>
      <h3>Clinical Applications</h3>
      <ul><li><strong>Fluid bolus:</strong> ‚Üë preload ‚Üí ‚Üë SV in hypovolemia (ascending limb of Starling curve)</li>
      <li><strong>CHF:</strong> Heart operates on descending limb ‚Äî additional fluid worsens function</li>
      <li><strong>Nitroglycerin:</strong> Venodilator ‚Üí ‚Üì preload ‚Üí ‚Üì myocardial O‚ÇÇ demand. Helps in CHF/angina</li>
      <li><strong>Leg elevation / Trendelenburg:</strong> ‚Üë venous return ‚Üí ‚Üë preload (used in hypotension)</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>EMS Pearl:</strong> Think of preload as "volume loading." Assess by looking at JVD (elevated = high preload) and lung sounds (crackles = fluid overload).</p></div>`,
    'phys-afterload': `<h2><span class="gradient">Afterload & Contractility</span></h2><p class="modal-sub">The resistance the heart must overcome plus its intrinsic force generation</p>
      <h3>Afterload</h3>
      <ul><li><strong>Definition:</strong> The pressure the ventricle must generate to open the semilunar valve and eject blood. For the LV, this is primarily aortic pressure (systemic vascular resistance, SVR).</li>
      <li><strong>Increased by:</strong> Hypertension, aortic stenosis, vasoconstriction (from catecholamines, vasopressors)</li>
      <li><strong>Decreased by:</strong> Vasodilators (NTG, nitroprusside), sepsis (pathologic vasodilation), neurogenic shock</li>
      <li><strong>Effect on heart:</strong> ‚Üë afterload = heart works harder = ‚Üë myocardial O‚ÇÇ demand = ‚Üì SV. Chronic ‚Üë afterload ‚Üí LV hypertrophy</li></ul>
      <h3>Myocardial Contractility (Inotropy)</h3>
      <ul><li><strong>Definition:</strong> Intrinsic ability of myocardium to generate force independent of preload and afterload</li>
      <li><strong>Positive inotropes (‚Üë contractility):</strong> Catecholamines (epinephrine, norepinephrine, dopamine, dobutamine), digitalis, calcium, glucagon</li>
      <li><strong>Negative inotropes (‚Üì contractility):</strong> Beta-blockers, calcium channel blockers, hypoxia, acidosis, ischemia, hyperkalemia</li>
      <li><strong>Measured clinically as:</strong> Ejection Fraction (EF). Normal 55-70%. EF < 40% = systolic heart failure (HFrEF)</li></ul>
      <div class="highlight-box"><p style="margin:0"><strong>Wall Tension (Law of Laplace):</strong> Wall Tension = (Pressure √ó Radius) / (2 √ó Wall Thickness). Dilated hearts have higher wall tension ‚Üí higher O‚ÇÇ demand. Hypertrophied hearts have lower wall tension per unit.</p></div>`,
    'phys-co': `<h2><span class="gradient">Cardiac Output & Hemodynamics</span></h2>
      <div class="formula">CO = SV √ó HR</div>
      <p style="text-align:center"><strong>Normal: ~5 L/min</strong> (70 mL √ó 72 bpm) ¬∑ Can increase to 20-25 L/min with exercise</p>
      <h3>Stroke Volume Determinants</h3>
      <ul><li><strong>Preload:</strong> Volume (Frank-Starling law)</li>
      <li><strong>Afterload:</strong> Resistance (inversely related to SV)</li>
      <li><strong>Contractility:</strong> Intrinsic force (inotropy)</li></ul>
      <h3>Heart Rate Determinants</h3>
      <ul><li><strong>Chronotropy:</strong> Rate of impulse formation. Sympathetic ‚Üë HR (positive chronotropy). Parasympathetic ‚Üì HR (negative chronotropy)</li>
      <li><strong>Dromotropy:</strong> Speed of conduction through AV node</li>
      <li><strong>Optimal HR:</strong> Very high HR (>150) shortens diastolic filling time ‚Üí ‚Üì SV ‚Üí may actually ‚Üì CO despite ‚Üë rate</li></ul>
      <h3>Blood Pressure & MAP</h3>
      <div class="formula">MAP = CO √ó SVR &nbsp;&nbsp;|&nbsp;&nbsp; MAP = DBP + ‚Öì(SBP ‚àí DBP)</div>
      <ul><li><strong>MAP:</strong> Mean Arterial Pressure. Driving pressure for organ perfusion. Normal: 70-105 mmHg. Goal: ‚â• 65 mmHg</li>
      <li><strong>Pulse Pressure:</strong> SBP ‚àí DBP. Normal ~40 mmHg. Narrow = ‚Üì SV (cardiogenic shock, tamponade). Wide = aortic regurgitation, sepsis</li>
      <li><strong>SBP reflects:</strong> CO and arterial compliance</li>
      <li><strong>DBP reflects:</strong> SVR and aortic valve competence</li></ul>
      <div class="highlight-box gold"><p style="margin:0"><strong>Cardiac Index (CI):</strong> CO adjusted for body size. CI = CO / BSA. Normal: 2.5-4.0 L/min/m¬≤. CI < 2.2 = cardiogenic shock.</p></div>`,
    'phys-ans': `<h2><span class="gradient">Autonomic Nervous System Control</span></h2><p class="modal-sub">Sympathetic and parasympathetic regulation of cardiac function</p>
      <h3>Sympathetic ("Fight or Flight")</h3>
      <ul><li><strong>Neurotransmitters:</strong> Norepinephrine (nerve terminals), Epinephrine (adrenal medulla)</li>
      <li><strong>Alpha-1 receptors:</strong> Peripheral vasoconstriction ‚Üí ‚Üë SVR ‚Üí ‚Üë BP</li>
      <li><strong>Beta-1 receptors (heart):</strong> ‚Üë HR (chronotropy), ‚Üë contractility (inotropy), ‚Üë conduction velocity (dromotropy), ‚Üë automaticity</li>
      <li><strong>Beta-2 receptors (lungs/vasculature):</strong> Bronchodilation, vasodilation in skeletal muscle</li>
      <li><strong>Dopaminergic receptors:</strong> Renal and mesenteric vasodilation (low-dose dopamine)</li></ul>
      <h3>Parasympathetic ("Rest and Digest")</h3>
      <ul><li><strong>Neurotransmitter:</strong> Acetylcholine (ACh) via Vagus nerve (CN X)</li>
      <li><strong>Muscarinic receptors:</strong> ‚Üì HR, ‚Üì conduction velocity (especially AV node), ‚Üì contractility (minimal effect on ventricles)</li>
      <li><strong>Vagal tone:</strong> Dominant at rest. SA node without autonomic input fires at ~100 bpm; vagal tone brings resting rate to 60-80</li></ul>
      <h3>Baroreceptor Reflex</h3>
      <ul><li>Stretch receptors in carotid sinus and aortic arch sense pressure changes</li>
      <li>‚Üë BP ‚Üí ‚Üë baroreceptor firing ‚Üí ‚Üë parasympathetic, ‚Üì sympathetic ‚Üí ‚Üì HR, ‚Üì SVR</li>
      <li>‚Üì BP ‚Üí ‚Üì baroreceptor firing ‚Üí ‚Üë sympathetic, ‚Üì parasympathetic ‚Üí ‚Üë HR, ‚Üë SVR</li></ul>
      <div class="highlight-box"><p style="margin:0"><strong>Drug Knowledge:</strong> Atropine blocks ACh (‚Üë HR). Beta-blockers block beta-1 (‚Üì HR, ‚Üì contractility). Epinephrine stimulates alpha-1 + beta-1 + beta-2.</p></div>`,
    'phys-electrolytes': `<h2><span class="gradient">Electrolytes & Cardiac Action Potential</span></h2><p class="modal-sub">Ions and electrical events that drive each heartbeat</p>
      <h3>Cardiac Action Potential (5 Phases)</h3>
      <ul><li><strong>Phase 0 ‚Äî Rapid Depolarization:</strong> Fast Na‚Å∫ channels open ‚Üí massive Na‚Å∫ influx ‚Üí cell becomes positive inside. Produces the upstroke. Corresponds to QRS complex.</li>
      <li><strong>Phase 1 ‚Äî Early Repolarization:</strong> Na‚Å∫ channels close, brief K‚Å∫ efflux. Brief, small repolarization.</li>
      <li><strong>Phase 2 ‚Äî Plateau:</strong> Ca¬≤‚Å∫ enters via slow L-type channels, balanced by K‚Å∫ efflux. Plateau maintains depolarization ‚Üí sustained contraction. Unique to cardiac muscle. Absolute refractory period.</li>
      <li><strong>Phase 3 ‚Äî Repolarization:</strong> Ca¬≤‚Å∫ channels close, K‚Å∫ efflux continues ‚Üí cell returns to negative resting potential. Corresponds to T wave. Relative refractory period ("vulnerable period" ‚Äî R-on-T).</li>
      <li><strong>Phase 4 ‚Äî Resting Potential:</strong> Stable at ~-90mV (working cells). Na‚Å∫/K‚Å∫ ATPase pump restores ion gradients. In pacemaker cells, Phase 4 has spontaneous slow depolarization ("funny current") ‚Üí automaticity.</li></ul>
      <h3>Key Electrolytes</h3>
      <ul><li><strong>Sodium (Na‚Å∫):</strong> Primary ion for depolarization (Phase 0). Hyponatremia ‚Üí ‚Üì contractility, dysrhythmias</li>
      <li><strong>Potassium (K‚Å∫):</strong> Primary ion for repolarization. <strong>Hyperkalemia:</strong> Tall peaked T waves ‚Üí widened QRS ‚Üí sine wave ‚Üí asystole. <strong>Hypokalemia:</strong> Flattened T waves, prominent U waves, ‚Üë risk of dysrhythmias</li>
      <li><strong>Calcium (Ca¬≤‚Å∫):</strong> Essential for Phase 2 plateau and excitation-contraction coupling. <strong>Hypercalcemia:</strong> Shortened QT. <strong>Hypocalcemia:</strong> Prolonged QT ‚Üí risk of Torsades</li>
      <li><strong>Magnesium (Mg¬≤‚Å∫):</strong> Stabilizes cell membranes. Cofactor for Na‚Å∫/K‚Å∫ ATPase. <strong>Hypomagnesemia:</strong> ‚Üë risk of Torsades, refractory VF. Treatment of Torsades = Mag sulfate 1-2g IV</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>ECG Pearl:</strong> Always think electrolytes when you see QT changes, T wave changes, or refractory arrest. K‚Å∫ and Ca¬≤‚Å∫ are the most immediately life-threatening.</p></div>`,
    'phys-coronary': `<h2><span class="gradient">Coronary Circulation</span></h2><p class="modal-sub">Blood supply to the myocardium</p>
      <h3>Left Coronary Artery (LCA)</h3>
      <ul><li><strong>Left Main:</strong> Short trunk, divides into LAD and LCx. Occlusion = "widow maker"</li>
      <li><strong>LAD (Left Anterior Descending):</strong> Supplies anterior wall of LV, anterior 2/3 of septum, apex. Most commonly occluded in MI. ST elevation in V1-V4 = anterior STEMI.</li>
      <li><strong>LCx (Left Circumflex):</strong> Supplies lateral and posterior walls of LV. ST elevation in I, aVL, V5-V6 = lateral STEMI.</li></ul>
      <h3>Right Coronary Artery (RCA)</h3>
      <ul><li>Supplies RA, RV, inferior wall of LV, posterior 1/3 of septum</li>
      <li>Supplies SA node (~60%) and AV node (~85-90%) ‚Üí RCA occlusion may cause bradycardia, heart blocks</li>
      <li>ST elevation in II, III, aVF = inferior STEMI. Always check right-sided leads (V4R) for RV infarct</li></ul>
      <div class="highlight-box gold"><p style="margin:0"><strong>Key Principle:</strong> Coronary perfusion occurs primarily during diastole because myocardial compression during systole occludes intramural vessels. This is why tachycardia (‚Üì diastolic time) and hypotension (‚Üì diastolic pressure) are dangerous ‚Äî both reduce coronary perfusion.</p></div>
      <h3>Coronary Dominance</h3>
      <ul><li>Right-dominant (~85%): RCA gives off posterior descending artery (PDA)</li>
      <li>Left-dominant (~8%): LCx gives off PDA</li>
      <li>Co-dominant (~7%): Both contribute</li></ul>`,
    'phys-bp': `<h2><span class="gradient">Blood Pressure & Perfusion</span></h2><p class="modal-sub">Understanding hemodynamic parameters for field assessment</p>
      <div class="formula">BP = CO √ó SVR &nbsp;&nbsp;|&nbsp;&nbsp; CO = SV √ó HR</div>
      <h3>Blood Pressure Components</h3>
      <ul><li><strong>Systolic (SBP):</strong> Peak pressure during ventricular contraction. Reflects CO and arterial compliance. Normal ~120 mmHg.</li>
      <li><strong>Diastolic (DBP):</strong> Minimum pressure during ventricular relaxation. Reflects SVR and aortic valve competence. Normal ~80 mmHg.</li>
      <li><strong>Pulse Pressure:</strong> SBP ‚àí DBP. Normal ~40 mmHg. Narrow (<25) = reduced SV (tamponade, tension pneumo, cardiogenic shock). Wide (>40) = ‚Üë SV or ‚Üì SVR (sepsis, aortic regurgitation).</li></ul>
      <h3>Shock Physiology</h3>
      <ul><li><strong>Hypovolemic:</strong> ‚Üì preload ‚Üí ‚Üì SV ‚Üí ‚Üì CO ‚Üí compensatory ‚Üë HR, ‚Üë SVR</li>
      <li><strong>Cardiogenic:</strong> ‚Üì contractility ‚Üí ‚Üì SV ‚Üí ‚Üì CO ‚Üí ‚Üë SVR (cold, clamped down)</li>
      <li><strong>Distributive (septic/neurogenic/anaphylactic):</strong> ‚Üì‚Üì SVR ‚Üí ‚Üì BP despite normal/‚Üë CO initially</li>
      <li><strong>Obstructive (tamponade, tension pneumo, PE):</strong> Mechanical obstruction ‚Üí ‚Üì ventricular filling or ejection</li></ul>
      <div class="highlight-box"><p style="margin:0"><strong>Compensatory Mechanisms:</strong> Baroreceptor reflex ‚Üí ‚Üë HR, ‚Üë SVR. Hormonal: RAAS (renin-angiotensin-aldosterone), ADH (water retention), catecholamine surge. Decompensation occurs when mechanisms are exhausted ‚Üí refractory hypotension.</p></div>`,
    'step1': `<h2><span class="gradient">Step 1: Analyze the Rate</span></h2>
      <h3>Methods</h3><ul><li><strong>6-Second Count:</strong> Count R waves in 6 seconds (30 large boxes), multiply by 10</li><li><strong>Triplicate (Rule of 300s):</strong> 300 √∑ (# large boxes between R-R) = rate</li><li><strong>R-R Method:</strong> 1500 √∑ (# small boxes between R-R) = rate</li></ul>
      <div class="highlight-box"><p style="margin:0"><strong>Brady &lt; 60</strong> ¬∑ <strong>Normal 60-100</strong> ¬∑ <strong>Tachy &gt; 100</strong></p></div>`,
    'step2': `<h2><span class="gradient">Step 2: Analyze the Rhythm</span></h2>
      <ul><li>Compare R-R intervals across the entire strip</li><li><strong>Regular:</strong> R-R intervals consistent throughout</li><li><strong>Regularly Irregular:</strong> Repeating pattern (e.g., Wenckebach, sinus arrhythmia)</li><li><strong>Irregularly Irregular:</strong> No pattern whatsoever (hallmark of A-Fib)</li></ul>`,
    'step3': `<h2><span class="gradient">Step 3: Analyze the QRS Complex</span></h2>
      <ul><li>Are QRS complexes present and uniform?</li><li><strong>Narrow QRS (&lt; 0.12s / 3 small boxes):</strong> Supraventricular origin ‚Äî impulse travels normally through ventricles</li><li><strong>Wide QRS (‚â• 0.12s):</strong> Ventricular origin OR aberrant conduction (BBB, WPW)</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>Clinical Pearl:</strong> Wide complex tachycardia ‚Äî treat as VT until proven otherwise.</p></div>`,
    'step4': `<h2><span class="gradient">Step 4: Analyze P Waves</span></h2>
      <h3>5 Components to Observe</h3><ul><li>Are P waves present?</li><li>Are P waves occurring at regular intervals?</li><li>Is there one P wave for each QRS complex?</li><li>Are P waves upright or inverted?</li><li>Do all P waves look alike?</li></ul>
      <div class="highlight-box"><p style="margin:0"><strong>To be called "sinus rhythm":</strong> 1:1 P:QRS ratio + upright P in Lead II + consistent morphology</p></div>`,
    'step5': `<h2><span class="gradient">Step 5: Analyze PR Interval</span></h2>
      <ul><li>Normal: <strong>0.12‚Äì0.20 seconds</strong> (3-5 small boxes)</li><li>Consistent? ‚Äî Same PR throughout = normal conduction</li><li>Prolonged (&gt; 0.20s)? ‚Äî First-degree AV block</li><li>Progressively lengthening? ‚Äî Wenckebach (Type I)</li><li>Short (&lt; 0.12s)? ‚Äî Junctional rhythm or WPW syndrome</li><li>Variable? ‚Äî May indicate wandering pacemaker or 3rd-degree block</li></ul>`,
    'block-1st': `<h2><span class="gradient">First-Degree AV Block</span></h2><div class="ecg-paper-bg modal-rhythm-strip"><canvas class="modal-rhythm-canvas" data-rhythm="1avb" height="140"></canvas></div>
      <div class="highlight-box gold"><p style="margin:0"><strong>Not a true block ‚Äî it's a delay.</strong> PR &gt; 0.20s but constant. All P waves are conducted.</p></div>
      <h3>Characteristics</h3><ul><li>PR interval prolonged (&gt; 0.20s / 5 small boxes) but constant</li><li>1:1 P:QRS relationship maintained</li><li>Usually occurs at the AV node level</li><li>Not a rhythm itself ‚Äî superimposed on another rhythm</li></ul><h3>Management</h3><p>Usually benign. No treatment needed. Monitor for progression.</p>`,
    'block-2nd1': `<h2><span class="gradient">Second-Degree Type I (Wenckebach)</span></h2><div class="ecg-paper-bg modal-rhythm-strip"><canvas class="modal-rhythm-canvas" data-rhythm="wenck" height="140"></canvas></div>
      <div class="highlight-box gold"><p style="margin:0"><strong>PR progressively lengthens ‚Üí dropped QRS ‚Üí cycle repeats</strong></p></div>
      <h3>Characteristics</h3><ul><li>Progressive PR lengthening until a beat is dropped</li><li>Grouped beating pattern</li><li>Usually at AV node level</li><li>R-R intervals shorten before the dropped beat</li></ul><h3>Management</h3><p>Usually transient. If symptomatic: Atropine 0.5mg IV. TCP if atropine fails.</p>`,
    'block-2nd2': `<h2><span class="gradient">Second-Degree Type II (Mobitz)</span></h2><div class="ecg-paper-bg modal-rhythm-strip"><canvas class="modal-rhythm-canvas" data-rhythm="mobitz2" height="140"></canvas></div>
      <div class="highlight-box red"><p style="margin:0"><strong>More dangerous than Type I.</strong> Constant PR for conducted beats, then sudden dropped QRS. Usually below Bundle of His.</p></div>
      <h3>Characteristics</h3><ul><li>PR interval constant for all conducted beats</li><li>Sudden non-conducted P wave (dropped QRS)</li><li>Conduction ratios: 2:1, 3:1, 4:1</li><li>QRS often wide (infranodal)</li></ul><h3>Management</h3><p>TCP indicated. Prepare for transvenous pacing. Atropine usually ineffective. May progress to complete block.</p>`,
    'block-3rd': `<h2><span class="gradient">Third-Degree (Complete) Heart Block</span></h2><div class="ecg-paper-bg modal-rhythm-strip"><canvas class="modal-rhythm-canvas" data-rhythm="3avb" height="140"></canvas></div>
      <div class="highlight-box red"><p style="margin:0"><strong>Complete AV dissociation.</strong> No atrial impulses reach the ventricles. P waves march independently of QRS complexes.</p></div>
      <h3>Characteristics</h3><ul><li>P waves and QRS complexes are completely independent</li><li>Atrial rate &gt; ventricular rate</li><li>Ventricular escape: junctional (40-60, narrow) or ventricular (20-40, wide)</li></ul><h3>Management</h3><p>Life-threatening. Immediate TCP. Dopamine or epinephrine infusion. Prepare for transvenous pacing.</p>`,
    'acs-patho': `<h2><span class="gradient">ACS Pathophysiology</span></h2><p class="modal-sub">Understanding the complete cascade from stable plaque to myocardial necrosis</p>
      <h3>Stage 1 ‚Äî Endothelial Injury & Atherosclerosis</h3>
      <ul><li>Begins with injury to the vascular endothelium (hypertension, smoking, diabetes, hyperlipidemia, turbulent flow)</li>
      <li>Lipids (LDL cholesterol) infiltrate the intimal layer and become oxidized</li>
      <li>Macrophages engulf oxidized LDL ‚Üí become "foam cells" ‚Üí form fatty streaks</li>
      <li>Over years, smooth muscle cells migrate and proliferate, forming a fibrous cap over the lipid core</li>
      <li>Result: <strong>Stable atherosclerotic plaque</strong> that progressively narrows the lumen</li></ul>
      <h3>Stage 2 ‚Äî Plaque Rupture / Erosion</h3>
      <ul><li>Vulnerable plaques have thin fibrous caps, large lipid cores, and active inflammation</li>
      <li>Physical or hemodynamic stress causes the cap to rupture, exposing thrombogenic lipid core to blood</li>
      <li>Platelet adhesion ‚Üí activation ‚Üí aggregation at the site of rupture</li>
      <li>Coagulation cascade activates ‚Üí thrombin generation ‚Üí fibrin mesh stabilizes the clot</li>
      <li><strong>Complete occlusion = STEMI</strong> (transmural ischemia). <strong>Partial occlusion = NSTEMI/Unstable Angina</strong></li></ul>
      <h3>Stage 3 ‚Äî Ischemia ‚Üí Injury ‚Üí Infarction</h3>
      <ul><li><strong>Ischemia (minutes):</strong> O‚ÇÇ supply < O‚ÇÇ demand. Reversible. Subendocardial. ECG: T-wave changes, ST depression</li>
      <li><strong>Injury (minutes to hours):</strong> Prolonged ischemia ‚Üí cellular damage begins. Partially reversible with reperfusion. ECG: ST elevation (STEMI)</li>
      <li><strong>Infarction (hours):</strong> Irreversible necrosis. Troponin release. ECG: Pathological Q waves develop. Scar tissue replaces muscle</li>
      <li><strong>"Time is Muscle":</strong> ~1.9 million myocytes die per minute of occlusion. Early reperfusion = more myocardial salvage</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>Wavefront Phenomenon:</strong> Necrosis begins at the subendocardium (most vulnerable to ischemia due to highest O‚ÇÇ demand and most distal blood supply) and spreads like a wavefront toward the epicardium over 4-6 hours. This is why door-to-balloon time matters.</p></div>`,

    'acs-spectrum': `<h2><span class="gradient">The ACS Spectrum</span></h2><p class="modal-sub">Three conditions sharing the same pathology ‚Äî differentiated by ECG and biomarkers</p>
      <h3>Unstable Angina (UA)</h3>
      <ul><li>Partial coronary occlusion with transient ischemia</li>
      <li>Chest pain at rest, new-onset, or crescendo pattern (increasing frequency/severity)</li>
      <li>ECG: May show ST depression, T-wave inversion, or be normal</li>
      <li>Troponin: <strong>Negative</strong> (no myocardial necrosis)</li>
      <li>Differentiating feature: Chest pain not relieved by rest or NTG within 15 minutes</li></ul>
      <h3>NSTEMI (Non-ST Elevation MI)</h3>
      <ul><li>Partial or intermittent coronary occlusion with subendocardial necrosis</li>
      <li>ECG: ST depression ‚â• 0.5mm, T-wave inversion ‚â• 2mm, or non-diagnostic. <strong>No ST elevation</strong></li>
      <li>Troponin: <strong>Positive</strong> (myocardial necrosis confirmed)</li>
      <li>Treatment: Anticoagulation, antiplatelets, risk stratification, early invasive strategy within 24-72 hours</li></ul>
      <h3>STEMI (ST Elevation MI)</h3>
      <ul><li><strong>Complete coronary occlusion</strong> with transmural ischemia/infarction</li>
      <li>ECG: ST elevation ‚â• 1mm in 2+ contiguous limb leads OR ‚â• 2mm in 2+ contiguous precordial leads</li>
      <li>Troponin: Positive (but don't wait for results ‚Äî diagnose by ECG)</li>
      <li>Treatment: <strong>Emergent reperfusion</strong> ‚Äî PCI (door-to-balloon < 90 min) or fibrinolytics (door-to-needle < 30 min)</li></ul>
      <div class="highlight-box gold"><p style="margin:0"><strong>STEMI Equivalents:</strong> New LBBB with ACS symptoms, de Winter T waves (upsloping ST depression + tall peaked T waves in precordial leads = proximal LAD occlusion), Wellens syndrome (deep T-wave inversions V2-V3 = critical LAD stenosis), and posterior MI (ST depression V1-V3 with tall R waves).</p></div>`,

    'acs-signs': `<h2><span class="gradient">ACS Signs & Symptoms</span></h2><p class="modal-sub">Recognition of both classic and atypical presentations</p>
      <h3>Classic Presentation</h3>
      <ul><li><strong>Chest pain/pressure:</strong> Substernal, crushing, squeezing, "elephant sitting on chest." Duration > 15-20 minutes (unlike stable angina)</li>
      <li><strong>Radiation:</strong> Left arm (most common), jaw, neck, shoulder, back, epigastrium</li>
      <li><strong>Diaphoresis:</strong> Cold, clammy, profuse sweating ‚Äî highly specific for AMI</li>
      <li><strong>Dyspnea:</strong> From LV dysfunction, pulmonary congestion, or anxiety</li>
      <li><strong>Nausea/Vomiting:</strong> Especially with inferior MI (vagal stimulation)</li>
      <li><strong>Sense of impending doom:</strong> Patient feels like they are dying ‚Äî take this seriously</li>
      <li><strong>Weakness/Fatigue:</strong> Sudden onset, unable to perform normal activities</li>
      <li><strong>Pallor:</strong> Ashen, gray appearance from sympathetic activation</li></ul>
      <h3>Atypical Presentations ‚Äî "Silent MI"</h3>
      <ul><li><strong>Women:</strong> More likely to present with fatigue, dyspnea, back/jaw pain, nausea, dizziness rather than classic chest pain. May report indigestion or flu-like symptoms</li>
      <li><strong>Elderly (>75):</strong> May present with altered mental status, syncope, weakness, or dyspnea without any chest pain. AMS may be only symptom</li>
      <li><strong>Diabetics:</strong> Autonomic neuropathy blunts pain perception. May present with unexplained diaphoresis, weakness, or dyspnea only</li>
      <li><strong>Post-surgical/intubated patients:</strong> Cannot report symptoms; watch for hemodynamic changes, new dysrhythmias, ST changes on monitor</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>EMS Pearl:</strong> Treat all chest pain as AMI until proven otherwise. Up to 30% of MIs present atypically. Maintain high index of suspicion in women, elderly, and diabetics. If in doubt, get a 12-lead.</p></div>
      <h3>Associated Assessment Findings</h3>
      <ul><li>Vital signs: Tachycardia (sympathetic), bradycardia (inferior MI/vagal), hypertension (sympathetic) or hypotension (cardiogenic shock)</li>
      <li>JVD: Suggests RV involvement or CHF</li>
      <li>Lung sounds: Crackles/rales = pulmonary edema from LV failure</li>
      <li>New heart murmur: Papillary muscle dysfunction or VSD</li>
      <li>Peripheral edema: Chronic right heart failure</li></ul>`,

    'acs-12lead': `<h2><span class="gradient">12-Lead ECG & STEMI Recognition</span></h2><p class="modal-sub">The single most important diagnostic tool in the field for ACS</p>
      <h3>ECG Changes in ACS Evolution</h3>
      <ul><li><strong>Hyperacute T waves:</strong> Earliest sign (minutes). Tall, broad, peaked T waves. Often missed ‚Äî occurs before ST elevation</li>
      <li><strong>ST elevation:</strong> Acute injury. Indicates transmural ischemia. The hallmark of STEMI</li>
      <li><strong>ST depression:</strong> Subendocardial ischemia (NSTEMI) or reciprocal changes opposite the area of injury</li>
      <li><strong>T-wave inversion:</strong> Ischemia or early infarction. Deep symmetric inversions = concerning</li>
      <li><strong>Pathological Q waves:</strong> Myocardial necrosis (hours to days). Width > 0.04s or depth > 1/3 of R wave amplitude. Indicates completed infarction</li></ul>
      <h3>STEMI Criteria</h3>
      <div class="highlight-box gold"><p style="margin:0"><strong>ST Elevation:</strong> ‚â• 1mm (0.1mV) in 2 or more contiguous limb leads, OR ‚â• 2mm (0.2mV) in 2 or more contiguous precordial leads (V1-V6). Measured at the J point relative to the TP segment (or PR segment).</p></div>
      <h3>Contiguous Lead Groups</h3>
      <ul><li><strong>Septal:</strong> V1, V2 ‚Äî LAD</li>
      <li><strong>Anterior:</strong> V3, V4 ‚Äî LAD</li>
      <li><strong>Lateral:</strong> V5, V6, I, aVL ‚Äî LCx</li>
      <li><strong>Inferior:</strong> II, III, aVF ‚Äî RCA (85%) or LCx (15%)</li>
      <li><strong>Right ventricular:</strong> V4R (right-sided leads) ‚Äî Proximal RCA</li>
      <li><strong>Posterior:</strong> V7, V8, V9 ‚Äî Posterior descending artery (PDA)</li></ul>
      <h3>Reciprocal Changes</h3>
      <ul><li>ST depression in leads opposite to the area of ST elevation ‚Äî <strong>confirms the STEMI diagnosis</strong></li>
      <li>Inferior STEMI ‚Üí reciprocal depression in I, aVL</li>
      <li>Anterior STEMI ‚Üí reciprocal depression in II, III, aVF</li>
      <li>Presence of reciprocal changes increases specificity for acute MI</li></ul>
      <h3>Special Lead Placements</h3>
      <ul><li><strong>Right-sided ECG (V3R‚ÄìV6R):</strong> Obtain with EVERY inferior STEMI. V4R is most sensitive for RV infarct. ST elevation ‚â• 1mm in V4R = RV involvement. Contraindication to NTG and volume depletion</li>
      <li><strong>Posterior ECG (V7‚ÄìV9):</strong> Obtain when ST depression in V1-V3 without clear anterior cause. ST elevation ‚â• 0.5mm in V7-V9 = posterior STEMI</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>Critical Rule:</strong> A normal 12-lead does NOT rule out ACS. Only ~50% of AMIs present with diagnostic ST changes on the initial ECG. Serial ECGs every 15 minutes if clinical suspicion is high.</p></div>`,

    'acs-territory': `<h2><span class="gradient">Infarct Territories</span></h2><p class="modal-sub">Matching leads to walls, arteries, and expected complications</p>
      <h3>Anterior Wall MI</h3>
      <ul><li><strong>Leads:</strong> V1‚ÄìV4 (septal-anterior)</li>
      <li><strong>Artery:</strong> LAD (Left Anterior Descending) ‚Äî "widow maker"</li>
      <li><strong>Affected:</strong> Anterior wall LV, anterior septum, apex, bundle branches</li>
      <li><strong>Complications:</strong> CHF, cardiogenic shock (large area of LV), VF/VT, BBB (RBBB or LAFB), ventricular aneurysm, free wall rupture, VSD</li>
      <li><strong>Highest mortality</strong> of all STEMI locations due to large territory</li></ul>
      <h3>Inferior Wall MI</h3>
      <ul><li><strong>Leads:</strong> II, III, aVF</li>
      <li><strong>Artery:</strong> RCA (85%) or LCx (15%)</li>
      <li><strong>Affected:</strong> Inferior wall LV, SA node, AV node</li>
      <li><strong>Complications:</strong> Sinus bradycardia (SA node ischemia), AV blocks (1st, 2nd Type I, 3rd degree), RV infarction (check V4R), hypotension, papillary muscle rupture ‚Üí acute mitral regurgitation</li>
      <li><strong>Always obtain right-sided leads</strong> with inferior STEMI</li></ul>
      <h3>Lateral Wall MI</h3>
      <ul><li><strong>Leads:</strong> I, aVL, V5, V6</li>
      <li><strong>Artery:</strong> LCx (Left Circumflex) or diagonal branches of LAD</li>
      <li><strong>Affected:</strong> Lateral wall LV</li>
      <li><strong>Complications:</strong> Often presents with anterolateral or inferolateral pattern. Isolated lateral MI less common</li></ul>
      <h3>Posterior Wall MI</h3>
      <ul><li><strong>Standard leads:</strong> ST depression V1-V3 (reciprocal), tall R waves V1-V2, upright T waves V1-V2</li>
      <li><strong>Posterior leads (V7-V9):</strong> ST elevation ‚â• 0.5mm confirms</li>
      <li><strong>Artery:</strong> PDA (posterior descending artery), from RCA or LCx</li>
      <li><strong>Often missed:</strong> Must suspect when V1-V3 show "mirror image" of STEMI</li></ul>
      <h3>Right Ventricular MI</h3>
      <ul><li><strong>Lead:</strong> V4R (ST elevation ‚â• 1mm)</li>
      <li><strong>Artery:</strong> Proximal RCA</li>
      <li><strong>Complications:</strong> Preload-dependent ‚Äî hypotension, JVD, clear lungs ("triad"). <strong>Do NOT give NTG or diuretics</strong> (reduce preload ‚Üí cardiovascular collapse). Treat with fluid bolus (250-500mL NS)</li></ul>
      <div class="highlight-box"><p style="margin:0"><strong>Quick Reference:</strong> Inferior = II, III, aVF (RCA). Anterior = V1-V4 (LAD). Lateral = I, aVL, V5-V6 (LCx). Posterior = mirror V1-V3 (PDA). RV = V4R (proximal RCA).</p></div>`,

    'acs-mgmt': `<h2><span class="gradient">ACS EMS Management</span></h2><p class="modal-sub">Time-critical interventions from first patient contact through cath lab arrival</p>
      <h3>Immediate Assessment (First 5 Minutes)</h3>
      <ul><li>Primary survey ‚Äî ABC, vital signs, SpO‚ÇÇ, level of consciousness</li>
      <li><strong>12-lead ECG:</strong> Obtain within 5 minutes of patient contact. If STEMI identified ‚Üí activate cath lab immediately</li>
      <li>IV access ‚Äî large bore (18g or larger) √ó 2 if possible</li>
      <li>Cardiac monitor ‚Äî continuous monitoring for dysrhythmias</li>
      <li>Focused history: OPQRST for chest pain, SAMPLE, cardiac risk factors, medication list (especially anticoagulants, PDE5 inhibitors)</li></ul>
      <h3>Pharmacological Management</h3>
      <ul><li><strong>Aspirin 324mg PO (chewed):</strong> Irreversible COX-1 inhibition ‚Üí blocks thromboxane A‚ÇÇ ‚Üí inhibits platelet aggregation. Give ASAP unless true allergy. Single most impactful prehospital drug for ACS ‚Äî 23% mortality reduction</li>
      <li><strong>Nitroglycerin 0.4mg SL:</strong> Venodilation ‚Üí ‚Üì preload ‚Üí ‚Üì myocardial O‚ÇÇ demand. Coronary vasodilation ‚Üí ‚Üë collateral flow. May repeat √ó 3 every 3-5 min. <strong>Contraindications:</strong> SBP < 90, HR < 50 or > 100, RV infarct, PDE5 inhibitor use within 24-48 hours</li>
      <li><strong>Oxygen:</strong> Only if SpO‚ÇÇ < 94% or respiratory distress. Routine O‚ÇÇ in normoxic patients may worsen outcomes (AVOID trial). Hyperoxia causes coronary vasoconstriction</li>
      <li><strong>Analgesics:</strong> Fentanyl 25-50mcg IV (preferred ‚Äî less hypotension, less emesis) or Morphine 2-4mg IV (use cautiously ‚Äî CRUSADE registry showed association with higher mortality). Titrate to pain relief</li>
      <li><strong>Anticoagulation:</strong> Heparin 60 U/kg IV bolus (max 4000U) per protocol, or Enoxaparin 0.5mg/kg IV for STEMI</li></ul>
      <h3>STEMI-Specific Actions</h3>
      <ul><li><strong>Cath lab activation:</strong> Transmit 12-lead ECG to receiving facility. Target first medical contact-to-balloon < 90 minutes</li>
      <li><strong>Transport decision:</strong> PCI-capable center preferred. If > 120 min transport to PCI ‚Üí consider fibrinolytics (tenecteplase, alteplase, reteplase)</li>
      <li><strong>Fibrinolytic checklist:</strong> Screen for absolute contraindications (active internal bleeding, suspected aortic dissection, recent head trauma/stroke < 3 months, intracranial neoplasm, known bleeding disorder)</li>
      <li><strong>Serial 12-leads:</strong> Repeat every 15 minutes. Monitor for reperfusion (resolution of ST elevation, reperfusion dysrhythmias like AIVR, pain resolution)</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>Do NOT delay transport for interventions.</strong> Aspirin and 12-lead are the two most critical prehospital actions. Everything else can happen en route. The cath lab saves lives ‚Äî get there fast.</p></div>
      <h3>Special Considerations</h3>
      <ul><li><strong>RV Infarct:</strong> No NTG, no diuretics, no morphine. Volume loading with NS 250-500mL boluses</li>
      <li><strong>Cocaine-induced:</strong> No beta-blockers (unopposed alpha stimulation ‚Üí coronary vasospasm). Use benzodiazepines, NTG, calcium channel blockers</li>
      <li><strong>New-onset LBBB + ACS symptoms:</strong> Treat as STEMI equivalent. Use Sgarbossa criteria for diagnosis</li>
      <li><strong>Arrest during STEMI:</strong> Consider transport with mechanical CPR for cath lab PCI during arrest</li></ul>`,

    'acs-complications': `<h2><span class="gradient">Complications of Acute MI</span></h2><p class="modal-sub">What can go wrong after myocardial infarction ‚Äî early and late</p>
      <h3>Dysrhythmias (Most Common Complication)</h3>
      <ul><li><strong>PVCs:</strong> Very common post-MI. Isolated PVCs typically benign. Concern: R-on-T phenomenon ‚Üí VF</li>
      <li><strong>VT/VF:</strong> Leading cause of death in the first hour. Primary VF (within 24h) ‚Äî electrical instability. Late VF (after 24h) ‚Äî scarring, worse prognosis</li>
      <li><strong>Sinus bradycardia:</strong> Common with inferior MI (vagal). Usually responsive to atropine</li>
      <li><strong>AV blocks:</strong> Inferior MI ‚Üí Type I (usually transient). Anterior MI ‚Üí Type II or complete block (often permanent, needs pacer)</li>
      <li><strong>Accelerated idioventricular rhythm (AIVR):</strong> "Reperfusion rhythm" ‚Äî actually a good sign after PCI/thrombolytics</li></ul>
      <h3>Pump Failure</h3>
      <ul><li><strong>Acute heart failure:</strong> LV dysfunction ‚Üí pulmonary edema. Killip classification I-IV</li>
      <li><strong>Cardiogenic shock:</strong> Killip Class IV. > 40% LV damage. Mortality 50-80% without revascularization</li>
      <li><strong>RV failure:</strong> Hypotension, JVD, clear lungs. Preload dependent. Treat with fluids, avoid vasodilators</li></ul>
      <h3>Mechanical Complications (Days 2-14)</h3>
      <ul><li><strong>Papillary muscle rupture:</strong> Acute severe mitral regurgitation. Sudden pulmonary edema, new loud systolic murmur. Most common with inferior MI (posteromedial papillary muscle has single blood supply from PDA)</li>
      <li><strong>Ventricular septal rupture:</strong> New harsh holosystolic murmur. Sudden hemodynamic deterioration. Occurs at border of infarcted and viable tissue</li>
      <li><strong>Free wall rupture:</strong> Catastrophic ‚Äî cardiac tamponade, PEA, death within minutes. Risk factors: first MI, anterior wall, age > 60, female</li>
      <li><strong>Ventricular aneurysm:</strong> Thinned, scarred wall that bulges during systole. Persistent ST elevation weeks after MI. Risk of thrombus formation and VT</li></ul>
      <h3>Other Complications</h3>
      <ul><li><strong>Pericarditis (Dressler Syndrome):</strong> Autoimmune-mediated. Occurs 2-10 weeks post-MI. Fever, pleuritic chest pain, friction rub. Treat with NSAIDs, colchicine. Avoid anticoagulants (hemorrhagic pericarditis risk)</li>
      <li><strong>Mural thrombus:</strong> Forms on akinetic or dyskinetic wall segments (especially anterior/apical). Risk of systemic embolization ‚Üí stroke. Anticoagulate</li>
      <li><strong>Reinfarction/stent thrombosis:</strong> Recurrent chest pain, re-elevation of ST segments. Emergency re-catheterization</li></ul>
      <div class="highlight-box"><p style="margin:0"><strong>Killip Classification:</strong> I = No CHF signs. II = Rales, S‚ÇÉ, JVD. III = Frank pulmonary edema. IV = Cardiogenic shock. Mortality increases dramatically with each class.</p></div>`,

    'acs-mimics': `<h2><span class="gradient">ACS Mimics & Differentials</span></h2><p class="modal-sub">Not all chest pain is ACS ‚Äî but don't miss the ones that can also kill</p>
      <h3>Life-Threatening Differentials ("The Big 6")</h3>
      <ul><li><strong>Aortic Dissection:</strong> Sudden "tearing/ripping" pain radiating to back. BP differential between arms > 20mmHg. Unequal pulses. Do NOT give anticoagulants or fibrinolytics</li>
      <li><strong>Pulmonary Embolism:</strong> Sudden dyspnea, pleuritic chest pain, tachycardia. Risk factors: DVT, immobilization, surgery, OCP use. S1Q3T3 on ECG (only 20% of cases)</li>
      <li><strong>Tension Pneumothorax:</strong> Acute dyspnea, unilateral absent breath sounds, tracheal deviation, JVD, hypotension. Needle decompression immediately</li>
      <li><strong>Cardiac Tamponade:</strong> Beck's triad, pulsus paradoxus, electrical alternans</li>
      <li><strong>Esophageal Rupture (Boerhaave):</strong> After forceful vomiting. Subcutaneous emphysema, mediastinal air</li>
      <li><strong>Acute Pericarditis:</strong> Sharp, pleuritic, positional (worse supine, better leaning forward). Diffuse ST elevation with PR depression. Friction rub</li></ul>
      <h3>Non-Life-Threatening Mimics</h3>
      <ul><li><strong>GERD / Esophageal Spasm:</strong> Burning, may respond to antacids, positional. Can mimic ACS almost exactly. NTG may actually relieve esophageal spasm (complicating diagnosis)</li>
      <li><strong>Musculoskeletal (Costochondritis):</strong> Reproducible with palpation, pleuritic, positional. But note: 5-7% of patients with reproducible chest wall tenderness DO have ACS</li>
      <li><strong>Anxiety / Panic Attack:</strong> Chest tightness, dyspnea, paresthesias, hyperventilation. Diagnosis of exclusion ‚Äî always rule out ACS first</li>
      <li><strong>Cholecystitis / Biliary colic:</strong> RUQ pain radiating to right shoulder. May mimic inferior MI</li>
      <li><strong>Pulmonary:</strong> Pneumonia (fever, productive cough), pleuritis (pleuritic), asthma (wheezing)</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>Golden Rule:</strong> In the field, treat as ACS until proven otherwise. A 12-lead ECG and aspirin are low-risk, high-yield interventions. Never assume "it's just anxiety" or "it's just GERD" without a 12-lead and thorough assessment. Let the ED rule it out.</p></div>`,

    'emerg-hf': `<h2><span class="gradient">Heart Failure & Acute Pulmonary Edema</span></h2><p class="modal-sub">When the heart can no longer meet the body's metabolic demands</p>
      <h3>Left Heart Failure (LHF)</h3>
      <ul><li><strong>Pathophysiology:</strong> LV unable to adequately pump blood forward ‚Üí blood backs up into pulmonary vasculature ‚Üí ‚Üë pulmonary capillary pressure ‚Üí fluid leaks into alveoli (pulmonary edema)</li>
      <li><strong>Signs/Symptoms:</strong> Dyspnea (especially on exertion), orthopnea, paroxysmal nocturnal dyspnea (PND), crackles/rales (bilateral, dependent), pink frothy sputum (severe), tachycardia, S‚ÇÉ gallop, diaphoresis, anxiety</li>
      <li><strong>Key distinction:</strong> HFrEF (EF < 40%, systolic failure, "wet and cold") vs. HFpEF (EF > 50%, diastolic failure, stiff ventricle cannot relax/fill properly, "wet and warm")</li></ul>
      <h3>Right Heart Failure (RHF)</h3>
      <ul><li><strong>Pathophysiology:</strong> RV unable to pump blood forward ‚Üí blood backs up into systemic venous circulation</li>
      <li><strong>Signs/Symptoms:</strong> JVD, peripheral edema (dependent ‚Äî ankles, sacrum), hepatomegaly (liver congestion), ascites, weight gain</li>
      <li><strong>Most common cause:</strong> Left heart failure (LHF ‚Üí pulmonary HTN ‚Üí RHF). Also from COPD (cor pulmonale), PE, RV infarct</li></ul>
      <h3>NYHA Functional Classification</h3>
      <ul><li><strong>Class I:</strong> No limitation of physical activity. Ordinary activity causes no symptoms</li>
      <li><strong>Class II:</strong> Slight limitation. Comfortable at rest. Ordinary activity causes fatigue, dyspnea</li>
      <li><strong>Class III:</strong> Marked limitation. Comfortable only at rest. Less than ordinary activity causes symptoms</li>
      <li><strong>Class IV:</strong> Unable to carry on any activity without discomfort. Symptoms at rest</li></ul>
      <h3>Acute Pulmonary Edema ‚Äî EMS Management</h3>
      <ul><li><strong>Position:</strong> Sitting upright with legs dependent (‚Üì venous return to heart)</li>
      <li><strong>CPAP/BiPAP (NIPPV):</strong> First-line treatment. 5-10 cm H‚ÇÇO. Splints open alveoli, ‚Üì preload, ‚Üì afterload, ‚Üì work of breathing. Reduces intubation rates by 50% and mortality by 40%</li>
      <li><strong>Nitroglycerin:</strong> SL 0.4mg or IV drip (start 10-20 mcg/min, titrate). Venodilation ‚Üí ‚Üì preload ‚Üí ‚Üì pulmonary congestion. Can use aggressively in acute CHF (high-dose NTG strategy)</li>
      <li><strong>Oxygen:</strong> Target SpO‚ÇÇ > 94%. Use with CPAP/BiPAP</li>
      <li><strong>Furosemide (Lasix):</strong> 40-80mg IV. Venodilation within minutes (before diuretic effect). Reduces preload</li>
      <li><strong>Morphine:</strong> 2-4mg IV ‚Äî use cautiously. ‚Üì Preload, ‚Üì anxiety. Some evidence of harm; many protocols have removed it</li>
      <li><strong>If SBP < 90 (cardiogenic shock):</strong> CPAP, vasopressors (dopamine/norepinephrine), defer NTG and diuretics</li></ul>
      <div class="highlight-box gold"><p style="margin:0"><strong>EMS Pearl:</strong> CPAP is the game-changer for acute pulmonary edema. If you have one intervention, make it CPAP. NTG drip + CPAP is the gold standard combination for acute decompensated heart failure with adequate BP.</p></div>`,

    'emerg-shock': `<h2><span class="gradient">Cardiogenic Shock</span></h2><p class="modal-sub">The most severe form of pump failure ‚Äî mortality 40-50% even with aggressive treatment</p>
      <h3>Definition & Pathophysiology</h3>
      <ul><li>Cardiac output is so severely reduced that tissue perfusion is critically inadequate despite adequate intravascular volume</li>
      <li>SBP < 90 mmHg (or > 30 mmHg drop from baseline) sustained for > 30 minutes</li>
      <li>Cardiac index < 2.2 L/min/m¬≤ with adequate preload (PCWP > 15 mmHg)</li>
      <li><strong>Downward spiral:</strong> ‚Üì CO ‚Üí ‚Üì coronary perfusion ‚Üí more ischemia ‚Üí further ‚Üì contractility ‚Üí further ‚Üì CO</li></ul>
      <h3>Clinical Presentation</h3>
      <ul><li>Profound hypotension unresponsive to fluids</li>
      <li>Tachycardia (compensatory), weak thready pulse</li>
      <li>Cold, clammy, mottled skin (peripheral vasoconstriction)</li>
      <li>Altered mental status (cerebral hypoperfusion)</li>
      <li>Oliguria/anuria (renal hypoperfusion)</li>
      <li>Pulmonary edema (LV backup) ‚Äî crackles, dyspnea, pink frothy sputum</li>
      <li>JVD (if biventricular failure or RV involvement)</li></ul>
      <h3>Causes</h3>
      <ul><li><strong>AMI (most common ‚Äî 80%):</strong> Usually > 40% LV mass infarcted. Anterior MI highest risk</li>
      <li>Acute valvular failure (papillary muscle rupture, acute MR, acute AR)</li>
      <li>Ventricular septal rupture, free wall rupture</li>
      <li>Myocarditis, Takotsubo cardiomyopathy</li>
      <li>End-stage cardiomyopathy decompensation</li></ul>
      <h3>EMS & Emergency Management</h3>
      <ul><li><strong>Airway:</strong> Early intubation if severe respiratory failure. CPAP/BiPAP if mentating</li>
      <li><strong>Vasopressors:</strong> Norepinephrine (first-line per SOAP II trial) ‚Äî vasopressor + mild inotrope. Dopamine 5-20 mcg/kg/min ‚Äî inotrope + vasopressor at higher doses. Dobutamine 2-20 mcg/kg/min ‚Äî pure inotrope (‚Üë contractility, ‚Üì afterload; requires adequate BP)</li>
      <li><strong>Emergent reperfusion:</strong> PCI is the definitive treatment if caused by AMI. Early cath lab activation</li>
      <li><strong>Mechanical support:</strong> Intra-Aortic Balloon Pump (IABP) ‚Äî counterpulsation ‚Üë coronary perfusion during diastole, ‚Üì afterload during systole. Impella, ECMO in refractory cases</li>
      <li><strong>Avoid:</strong> Excessive fluids (already volume overloaded), beta-blockers (‚Üì contractility further)</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>Key Differentiation:</strong> Cardiogenic shock = cold + wet (poor perfusion + congestion). Hypovolemic shock = cold + dry. Distributive shock = warm + dry or warm + wet. Always assess skin temperature, moisture, JVD, and lung sounds.</p></div>`,

    'emerg-tamp': `<h2><span class="gradient">Cardiac Tamponade</span></h2><p class="modal-sub">Fluid accumulation in the pericardial sac compressing the heart</p>
      <h3>Pathophysiology</h3>
      <ul><li>Normal pericardial space contains 15-50 mL of serous fluid</li>
      <li>Rapid accumulation of even 100-200 mL can cause tamponade (acute). Slow accumulation may tolerate > 1L (chronic)</li>
      <li>External pressure compresses the thin-walled chambers first (RA ‚Üí RV) ‚Üí ‚Üì filling ‚Üí ‚Üì stroke volume ‚Üí ‚Üì cardiac output</li>
      <li>Compensatory tachycardia initially maintains CO, then decompensates ‚Üí obstructive shock</li></ul>
      <h3>Beck's Triad (Classic ‚Äî present in only ~30%)</h3>
      <ul><li><strong>1. Hypotension</strong> (‚Üì CO ‚Üí ‚Üì BP) ‚Äî may be absent early</li>
      <li><strong>2. JVD</strong> (‚Üë venous pressure from impaired filling) ‚Äî earliest sign</li>
      <li><strong>3. Muffled/distant heart sounds</strong> (fluid dampens sound transmission)</li></ul>
      <h3>Other Clinical Findings</h3>
      <ul><li><strong>Pulsus paradoxus:</strong> > 10 mmHg drop in SBP during inspiration (exaggeration of normal physiology). Highly sensitive. Measure with BP cuff ‚Äî note pressure at first Korotkoff sound (expiration only) vs. heard throughout respiratory cycle</li>
      <li><strong>Tachycardia:</strong> Compensatory ‚Äî often the first vital sign change</li>
      <li><strong>Electrical alternans on ECG:</strong> Alternating QRS amplitude (heart swinging in fluid). Highly specific but not always present</li>
      <li><strong>Low-voltage QRS:</strong> Fluid dampens electrical signal</li>
      <li><strong>Kussmaul sign:</strong> JVD worsens with inspiration (paradoxical)</li></ul>
      <h3>Causes</h3>
      <ul><li><strong>Trauma:</strong> Penetrating (knife/GSW ‚Äî especially stab wounds to "cardiac box"). Blunt deceleration</li>
      <li><strong>Medical:</strong> Pericarditis, malignancy (lung, breast, lymphoma), uremia (renal failure), post-MI (free wall rupture), post-cardiac surgery, aortic dissection into pericardium</li></ul>
      <h3>Management</h3>
      <ul><li><strong>Prehospital:</strong> Rapid transport. IV fluid bolus (500mL-1L NS) to ‚Üë preload ‚Üí temporarily ‚Üë filling pressures. Avoid vasodilators (NTG, morphine). Monitor for PEA arrest</li>
      <li><strong>Definitive:</strong> Pericardiocentesis (needle aspiration ‚Äî even 20-30mL removal can dramatically improve hemodynamics). Pericardial window (surgical). Thoracotomy if traumatic</li></ul>
      <div class="highlight-box"><p style="margin:0"><strong>EMS Pearl:</strong> In the setting of penetrating trauma to the anterior chest with PEA arrest ‚Üí think tamponade. JVD + hypotension + clear lungs = tamponade until proven otherwise. Fluid bolus is the bridge to the OR.</p></div>`,

    'emerg-dissect': `<h2><span class="gradient">Aortic Dissection</span></h2><p class="modal-sub">Tearing of the aortic wall ‚Äî catastrophic if missed</p>
      <h3>Pathophysiology</h3>
      <ul><li>Tear in the tunica intima allows blood to enter the media ‚Üí creates a false lumen</li>
      <li>The dissection flap can propagate proximally or distally, occluding branch arteries</li>
      <li>Can extend into coronary arteries (‚Üí MI), carotid arteries (‚Üí stroke), renal arteries (‚Üí renal failure), or mesenteric arteries (‚Üí bowel ischemia)</li>
      <li>Risk factors: Hypertension (#1), Marfan syndrome, bicuspid aortic valve, coarctation, cocaine use, pregnancy, connective tissue disorders</li></ul>
      <h3>Stanford Classification</h3>
      <ul><li><strong>Type A (60%):</strong> Involves the ascending aorta (regardless of origin). Surgical emergency. Mortality increases 1-2% per hour without surgery</li>
      <li><strong>Type B (40%):</strong> Involves descending aorta only (distal to left subclavian). Medical management (BP and HR control) unless complicated</li></ul>
      <h3>Clinical Presentation</h3>
      <ul><li><strong>Pain:</strong> Sudden onset, maximum intensity at onset ("worst pain of my life"), "tearing" or "ripping" quality. Anterior chest (Type A), interscapular back (Type B). May migrate as dissection extends</li>
      <li><strong>BP differential:</strong> > 20 mmHg difference between arms (dissection flap compromises subclavian)</li>
      <li><strong>Pulse deficits:</strong> Unequal radial or femoral pulses</li>
      <li><strong>Aortic regurgitation:</strong> New diastolic murmur (Type A ‚Äî extends to aortic root)</li>
      <li><strong>Neurologic deficits:</strong> Stroke symptoms if carotid involved</li>
      <li><strong>Often hypertensive</strong> at presentation (despite looking "shocky")</li></ul>
      <h3>Management</h3>
      <ul><li><strong>Two large-bore IVs</strong> ‚Äî anticipate hemodynamic collapse</li>
      <li><strong>Heart rate control:</strong> Target HR < 60 bpm. Esmolol drip (first-line), labetalol. Beta-blockers BEFORE vasodilators (prevent reflex tachycardia)</li>
      <li><strong>BP control:</strong> Target SBP 100-120 mmHg. Reduces aortic wall shear stress</li>
      <li><strong>Pain control:</strong> Aggressive. Pain drives tachycardia and hypertension</li>
      <li><strong>Do NOT give:</strong> Fibrinolytics, anticoagulants, antiplatelet agents. Can be catastrophic if MI is mimicking dissection</li>
      <li><strong>Transport:</strong> Rapid to facility with cardiothoracic surgery capability</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>Critical Pearl:</strong> Aortic dissection can mimic AMI (if dissection extends into coronary ostia, usually RCA ‚Üí inferior STEMI pattern). If you give tPA for "STEMI" and it's actually a dissection ‚Üí patient dies. Always consider dissection in the differential. Red flags: tearing pain, maximal at onset, BP differential, pulse deficits, wide mediastinum on CXR.</p></div>`,

    'emerg-htn': `<h2><span class="gradient">Hypertensive Crisis</span></h2><p class="modal-sub">When blood pressure becomes immediately life-threatening</p>
      <h3>Hypertensive Urgency</h3>
      <ul><li>SBP > 180 and/or DBP > 120 mmHg <strong>WITHOUT</strong> evidence of end-organ damage</li>
      <li>Patient may be asymptomatic or have headache, anxiety, epistaxis</li>
      <li>Goal: Gradual BP reduction over 24-48 hours with oral medications</li>
      <li>Does NOT require emergency IV medications</li></ul>
      <h3>Hypertensive Emergency</h3>
      <ul><li>SBP > 180 and/or DBP > 120 mmHg <strong>WITH</strong> evidence of acute end-organ damage:</li>
      <li><strong>Brain:</strong> Hypertensive encephalopathy (headache, AMS, seizures, visual changes), ischemic stroke, hemorrhagic stroke</li>
      <li><strong>Heart:</strong> Acute MI, acute heart failure/pulmonary edema, aortic dissection</li>
      <li><strong>Kidneys:</strong> Acute kidney injury (‚Üë creatinine, hematuria, oliguria)</li>
      <li><strong>Eyes:</strong> Papilledema, retinal hemorrhages, hypertensive retinopathy</li>
      <li><strong>Vascular:</strong> Aortic dissection, eclampsia (pregnancy-related)</li></ul>
      <h3>Management Principles</h3>
      <ul><li><strong>Goal:</strong> Reduce MAP by no more than 25% in the first hour, then gradually to 160/100 over next 2-6 hours</li>
      <li><strong>Why controlled reduction?</strong> Chronically hypertensive patients have shifted cerebral autoregulation curve. Rapid drops ‚Üí watershed infarction, stroke, MI</li>
      <li><strong>IV Agents:</strong> Nicardipine drip (5-15 mg/hr), Labetalol (10-20mg IV push, then drip), Nitroprusside (0.25-10 mcg/kg/min ‚Äî ICU only, cyanide toxicity risk), Esmolol (for dissection)</li>
      <li><strong>Special situations:</strong> Eclampsia ‚Üí Magnesium sulfate + Labetalol or Hydralazine. Aortic dissection ‚Üí Esmolol (rate before pressure). Cocaine ‚Üí Benzodiazepines first, NO beta-blockers</li></ul>
      <div class="highlight-box gold"><p style="margin:0"><strong>EMS Pearl:</strong> Don't chase numbers. Look for end-organ damage (AMS, chest pain, dyspnea, focal neuro deficits, visual changes). A patient with SBP 200 but no symptoms is urgency (transport, monitor). SBP 200 with pulmonary edema or stroke symptoms is emergency (treat aggressively en route).</p></div>`,

    'emerg-pe': `<h2><span class="gradient">Pulmonary Embolism</span></h2><p class="modal-sub">Blood clot obstructing pulmonary vasculature ‚Äî a great masquerader</p>
      <h3>Pathophysiology</h3>
      <ul><li>Most commonly from DVT (deep vein thrombosis) in the lower extremities or pelvis</li>
      <li>Clot travels through RV ‚Üí lodges in pulmonary arteries</li>
      <li>Obstruction ‚Üí ‚Üë pulmonary vascular resistance ‚Üí ‚Üë RV afterload ‚Üí RV dilation and failure ‚Üí ‚Üì LV filling ‚Üí ‚Üì CO ‚Üí cardiovascular collapse</li>
      <li><strong>Virchow's Triad:</strong> Stasis (immobilization), Endothelial injury (surgery, trauma), Hypercoagulability (malignancy, OCP, pregnancy, clotting disorders)</li></ul>
      <h3>Clinical Presentation</h3>
      <ul><li><strong>Dyspnea:</strong> Sudden onset, most common symptom (73%). Often out of proportion to exam findings</li>
      <li><strong>Pleuritic chest pain:</strong> Sharp, worsens with breathing (66%)</li>
      <li><strong>Tachycardia and tachypnea:</strong> Often the earliest vital sign changes</li>
      <li><strong>Hypotension:</strong> Indicates massive PE with hemodynamic compromise</li>
      <li><strong>Unilateral leg swelling:</strong> Suggests concurrent DVT (only present in ~30%)</li>
      <li><strong>SpO‚ÇÇ:</strong> May be normal (especially submassive) or significantly low</li>
      <li><strong>Syncope:</strong> Suggests massive PE. Post-syncopal hypotension = ominous</li></ul>
      <h3>ECG Findings</h3>
      <ul><li><strong>S1Q3T3:</strong> Deep S in Lead I, Q wave in III, inverted T in III ‚Äî classic but only present in 20%</li>
      <li><strong>Right heart strain:</strong> Right axis deviation, RBBB (new), T-wave inversions V1-V4</li>
      <li><strong>Sinus tachycardia:</strong> Most common ECG finding (40%)</li>
      <li><strong>A-fib:</strong> New-onset atrial fibrillation from RV dilation</li></ul>
      <h3>Classification & Management</h3>
      <ul><li><strong>Massive PE:</strong> Hypotension (SBP < 90) or cardiac arrest. Mortality > 50%. Treatment: systemic thrombolytics (tPA 100mg IV or tenecteplase), heparin, surgical embolectomy</li>
      <li><strong>Submassive PE:</strong> Normotensive but RV dysfunction on echo. Heparin anticoagulation, consider thrombolytics if deteriorating</li>
      <li><strong>Low-risk PE:</strong> Hemodynamically stable, no RV dysfunction. Anticoagulation (heparin ‚Üí warfarin/DOAC)</li>
      <li><strong>PEA arrest suspected PE:</strong> Push-dose tPA (50mg IV bolus) during CPR. Continue CPR for ‚â• 60-90 minutes after thrombolytics</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>EMS Pearl:</strong> Think PE when: sudden dyspnea + clear lungs + normal CXR + pleuritic chest pain + recent immobilization/surgery/DVT risk. The classic triad (dyspnea, pleuritic pain, hemoptysis) is present in < 20% of cases. High index of suspicion is key.</p></div>`,

    'emerg-pericarditis': `<h2><span class="gradient">Acute Pericarditis</span></h2><p class="modal-sub">Inflammation of the pericardial sac ‚Äî the great STEMI mimic</p>
      <h3>Pathophysiology</h3>
      <ul><li>Inflammation of the visceral and parietal pericardium</li>
      <li><strong>Causes:</strong> Viral (Coxsackie B, Echo ‚Äî most common), bacterial, post-MI (Dressler syndrome 2-10 weeks), uremia (renal failure), autoimmune (lupus, RA), malignancy, post-cardiac surgery, trauma, radiation</li></ul>
      <h3>Clinical Presentation</h3>
      <ul><li><strong>Chest pain:</strong> Sharp, pleuritic (worse with inspiration), positional (worse supine, improved leaning forward). Sudden onset. May radiate to trapezius ridge (unique to pericarditis)</li>
      <li><strong>Pericardial friction rub:</strong> High-pitched scratchy sound. Best heard with diaphragm at LLSB with patient leaning forward. Has up to 3 components (atrial, ventricular systolic, ventricular diastolic). Pathognomonic but evanescent</li>
      <li><strong>Low-grade fever:</strong> Especially viral pericarditis</li>
      <li><strong>Dyspnea:</strong> If significant effusion develops</li></ul>
      <h3>ECG ‚Äî 4 Stages</h3>
      <ul><li><strong>Stage 1 (acute):</strong> Diffuse ST elevation (concave up, "smiley face") in nearly ALL leads (not territory-specific). PR depression (especially in II, aVF, V4-V6). PR elevation in aVR. This is the key differentiator from STEMI</li>
      <li><strong>Stage 2:</strong> ST segments normalize, T waves flatten</li>
      <li><strong>Stage 3:</strong> Diffuse T-wave inversions</li>
      <li><strong>Stage 4:</strong> ECG normalizes</li></ul>
      <h3>Pericarditis vs. STEMI</h3>
      <ul><li><strong>Pericarditis:</strong> Diffuse ST elevation (all leads), concave-up ("smiley"), PR depression, no reciprocal changes, no Q waves</li>
      <li><strong>STEMI:</strong> Focal ST elevation (territory-specific), convex-up ("frowny"/"tombstone"), reciprocal ST depression, Q waves develop</li></ul>
      <div class="highlight-box gold"><p style="margin:0"><strong>Critical Distinction:</strong> If you're unsure whether diffuse ST elevation is pericarditis or STEMI, treat as STEMI and transport to PCI center. Let the cardiologist sort it out. It's safer to cath a pericarditis patient than to miss a STEMI.</p></div>`,

    'emerg-syncope': `<h2><span class="gradient">Cardiac Syncope</span></h2><p class="modal-sub">When the heart causes sudden loss of consciousness ‚Äî highest risk of sudden death</p>
      <h3>Why Cardiac Syncope Matters</h3>
      <ul><li>Cardiac syncope carries 1-year mortality of 18-33% (vs. 0-12% for non-cardiac causes)</li>
      <li>May be the only warning before sudden cardiac death</li>
      <li>Two main mechanisms: structural/obstructive disease or dysrhythmia</li></ul>
      <h3>Dysrhythmic Causes</h3>
      <ul><li><strong>Bradydysrhythmias:</strong> Sick sinus syndrome, high-grade AV blocks (Mobitz II, 3rd degree), pacemaker malfunction</li>
      <li><strong>Tachydysrhythmias:</strong> VT, SVT (if very rapid), Torsades de Pointes, WPW with rapid A-Fib</li>
      <li><strong>Brugada Syndrome:</strong> Coved ST elevation in V1-V3, RBBB pattern. Risk of fatal VF, especially during rest/sleep. Family history of sudden death</li>
      <li><strong>Long QT Syndrome:</strong> QTc > 0.47s. Risk of Torsades de Pointes. Congenital or drug-induced. Triggers: exercise (LQT1), auditory stimuli (LQT2), sleep (LQT3)</li></ul>
      <h3>Structural/Obstructive Causes</h3>
      <ul><li><strong>HOCM (Hypertrophic Obstructive Cardiomyopathy):</strong> #1 cause of sudden cardiac death in young athletes. Thickened septum obstructs LVOT during exertion. Systolic murmur that increases with Valsalva/standing</li>
      <li><strong>Aortic Stenosis:</strong> Fixed obstruction to LV outflow. Exertional syncope. Harsh crescendo-decrescendo systolic murmur</li>
      <li><strong>Massive PE:</strong> Acute RV failure ‚Üí ‚Üì CO ‚Üí syncope</li>
      <li><strong>Cardiac Tamponade:</strong> Impaired filling ‚Üí ‚Üì CO</li>
      <li><strong>Atrial myxoma:</strong> Tumor obstructs mitral valve intermittently (positional symptoms)</li></ul>
      <h3>EMS Assessment</h3>
      <ul><li>12-lead ECG on every syncopal patient ‚Äî look for long QT, Brugada pattern, WPW (delta wave), heart blocks, VT</li>
      <li>Exertional syncope = cardiac until proven otherwise (especially in young athletes)</li>
      <li>Family history of sudden death in young relatives = red flag</li>
      <li>Syncopal episode without prodrome (no lightheadedness, nausea) = likely cardiac</li>
      <li>Monitor continuously during transport ‚Äî may have recurrent episodes</li></ul>
      <div class="highlight-box red"><p style="margin:0"><strong>High-Risk Features Requiring Immediate Evaluation:</strong> Syncope during exertion, while supine, or without prodrome. Family history of sudden death < 50 years. Known heart disease. Abnormal ECG. New chest pain or dyspnea before event.</p></div>`,
    'resus-cpr': `<h2><span class="gradient">High-Quality CPR</span></h2><div class="formula">Rate: 100-120/min ¬∑ Depth: ‚â• 2 inches ¬∑ Full recoil ¬∑ Minimize interruptions</div>
      <ul><li>Use CPR feedback device</li><li>Avoid excessive ventilation</li><li>Maintain high chest compression fraction (CCF)</li><li>Switch compressors every 2 minutes</li></ul>`,
    'resus-defib': `<h2><span class="gradient">Defibrillation</span></h2><ul><li>Most common initial rhythm in sudden cardiac arrest: <strong>VF</strong></li><li>Most effective treatment: electrical defibrillation</li><li>Probability of success decreases rapidly over time</li><li>VF converts to asystole within minutes</li><li>Biphasic: 120-200J (follow device). Monophasic: 360J.</li></ul>`,
    'resus-cardio': `<h2><span class="gradient">Synchronized Cardioversion</span></h2><ul><li>For unstable tachycardias other than VF and pulseless VT</li><li>Delivers shock ~10ms after peak of R wave</li><li>Avoids vulnerable period (R-on-T phenomenon)</li><li>Initial energies: Narrow regular 50-100J ¬∑ Narrow irregular 120-200J ¬∑ Wide regular 100J ¬∑ Wide irregular = defibrillation</li></ul>`,
    'resus-pea': `<h2><span class="gradient">PEA & Asystole</span></h2><h3>Non-Shockable Rhythms</h3>
      <ul><li><strong>PEA:</strong> Organized electrical activity without a pulse. Search for reversible causes.</li><li><strong>Pseudo-PEA:</strong> PEA with mechanical cardiac activity on ultrasound ‚Äî more amenable to resuscitation.</li><li><strong>Asystole:</strong> No electrical activity. Confirm in 2 leads. Check connections.</li></ul>
      <h3>H's and T's</h3><ul><li><strong>H's:</strong> Hypovolemia, Hypoxia, Hydrogen (acidosis), Hypo/Hyperkalemia, Hypothermia</li><li><strong>T's:</strong> Tension pneumothorax, Tamponade, Toxins, Thrombosis (PE), Thrombosis (MI)</li></ul>`,
    'resus-pit': `<h2><span class="gradient">Pit Crew CPR</span></h2><ul><li>Team-based approach with designated roles</li><li>Compressor, Airway, IV/IO/Meds, Monitor/Defib, Team Leader</li><li>Seamless role rotation every 2 minutes</li><li>Minimize interruptions in compressions</li><li>Real-time quality feedback</li></ul>`,
    'resus-rosc': `<h2><span class="gradient">Post-ROSC Care</span></h2><ul><li>Optimize ventilation and oxygenation (target SpO‚ÇÇ 94-99%)</li><li>12-lead ECG ‚Äî cath lab activation for STEMI</li><li>Targeted temperature management (TTM)</li><li>Hemodynamic support (vasopressors if needed)</li><li>Treat underlying cause</li><li>Rapid transport to appropriate facility</li></ul>`,
  };
  return M[id] || `<h2>Content</h2><p>Detailed content for this topic.</p>`;
}

// ================================================================
// TABS
// ================================================================
function showTab(tabId, btn) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  if (btn) btn.classList.add('active');
}

// ================================================================
// HEART INTERACTIVITY
// ================================================================
document.querySelectorAll('.heart-chamber').forEach(el => {
  el.addEventListener('click', () => {
    const target = el.dataset.chamber;
    document.querySelectorAll('.info-item').forEach(i => i.classList.remove('active'));
    const item = document.querySelector(`.info-item[data-target="${target}"]`);
    if (item) { item.classList.add('active'); item.scrollIntoView({behavior:'smooth',block:'nearest'}); }
  });
});
document.querySelectorAll('.info-item').forEach(el => {
  el.addEventListener('click', () => {
    document.querySelectorAll('.info-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
  });
});

// ================================================================
// SCROLL & NAV
// ================================================================
const observer = new IntersectionObserver(entries => {
  entries.forEach(e => { if(e.isIntersecting) e.target.classList.add('visible'); });
}, {threshold:0.08});
document.querySelectorAll('section, .fade-up').forEach(el => observer.observe(el));

window.addEventListener('scroll', () => {
  const scrolled = window.scrollY / (document.documentElement.scrollHeight - window.innerHeight);
  document.getElementById('progressBar').style.width = (scrolled*100)+'%';
  const sections = document.querySelectorAll('section[id]');
  let current = '';
  sections.forEach(s => { if(window.scrollY >= s.offsetTop - 200) current = s.id; });
  document.querySelectorAll('.nav-link').forEach(l => {
    l.classList.toggle('active', l.getAttribute('href') === '#'+current);
  });
});

// ================================================================
// HERO ECG
// ================================================================
function drawHeroEcg() {
  const canvas = document.getElementById('heroEcgCanvas');
  if (!canvas) return;
  canvas.width = canvas.parentElement.clientWidth;
  canvas.height = 100;
  const ctx = canvas.getContext('2d');
  drawECGPaper(ctx, canvas.width, canvas.height);
  const w=canvas.width, h=canvas.height, mid=h*0.5, amp=h*0.35;
  const pxPerSec = w / 6;
  const period = pxPerSec * (60 / 72); // 72 bpm NSR
  ctx.beginPath();
  ctx.strokeStyle = '#00E676';
  ctx.lineWidth = 2;
  ctx.lineJoin = 'round';
  for (let px=0;px<w;px++) {
    const t = (px%period)/period;
    const y = waveNSR(t);
    const py = mid - y*amp;
    if(px===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  }
  ctx.stroke();
}

// ================================================================
// QUIZ
// ================================================================
const quizQuestions = [
  { q:'Identify this rhythm:', sub:'Analyze rate, regularity, P waves.', rhythm:'afib',
    options:['Sinus Tachycardia','Atrial Fibrillation','Atrial Flutter','SVT'], answer:1,
    explain:'Irregularly irregular with no distinct P waves and fibrillatory baseline = A-Fib.' },
  { q:'Normal PR interval?', sub:'Time from P wave onset to QRS onset.', rhythm:'nsr',
    options:['0.06‚Äì0.10s','0.12‚Äì0.20s','0.20‚Äì0.40s','0.04‚Äì0.12s'], answer:1,
    explain:'Normal PR: 0.12‚Äì0.20s. Prolonged (>0.20s) = 1¬∞ AV block. Short = WPW or junctional.' },
  { q:'Identify this lethal rhythm:', sub:'No organized complexes visible.', rhythm:'vfib',
    options:['V-Tach','Torsades de Pointes','Ventricular Fibrillation','Artifact'], answer:2,
    explain:'Chaotic ventricular rhythm, no QRS. Pulseless. Immediate defibrillation required.' },
  { q:'What does the QRS complex represent?', sub:'',
    options:['Atrial depolarization','Ventricular repolarization','Ventricular depolarization','AV nodal delay'], answer:2,
    explain:'QRS = ventricular depolarization. Normal < 0.12s. Wide ‚â• 0.12s = ventricular origin or BBB.' },
  { q:'Cardiac output formula?', sub:'',
    options:['CO = HR √∑ SV','CO = SV √ó HR','CO = MAP √ó SVR','CO = BP √ó PR'], answer:1,
    explain:'CO = SV √ó HR. Normal ~5 L/min.' },
  { q:'Identify this rhythm:', sub:'Note wide QRS and rate.', rhythm:'vtach',
    options:['SVT with aberrancy','Ventricular Tachycardia','Sinus Tachycardia','Atrial Flutter'], answer:1,
    explain:'Wide-complex tachycardia ‚â•0.12s QRS, rate >100, no P waves. Life-threatening.' },
  { q:'Beck\'s Triad indicates:', sub:'Classic tamponade findings.',
    options:['Brady, HTN, irregular breathing','JVD, muffled sounds, hypotension','Chest pain, dyspnea, tachycardia','Fever, murmur, hemorrhages'], answer:1,
    explain:'Beck\'s: JVD + muffled heart sounds + hypotension. Also pulsus paradoxus, electrical alternans.' },
  { q:'SA node intrinsic rate:', sub:'',
    options:['20‚Äì40 bpm','40‚Äì60 bpm','60‚Äì100 bpm','100‚Äì150 bpm'], answer:2,
    explain:'SA node: 60-100. AV junction backup: 40-60. Ventricular escape: 20-40.' },
  { q:'CPR compression rate:', sub:'Per current AHA guidelines.',
    options:['60‚Äì80/min','80‚Äì100/min','100‚Äì120/min','120‚Äì140/min'], answer:2,
    explain:'100-120/min, depth ‚â•2in, full recoil, minimize interruptions.' },
  { q:'Identify this rhythm:', sub:'P waves independent of QRS.', rhythm:'3avb',
    options:['2nd-Degree Type I','2nd-Degree Type II','Third-Degree AV Block','Sinus Bradycardia'], answer:2,
    explain:'Complete AV dissociation. P waves march independently. Ventricular escape. May require pacing.' }
];
let quizIdx=0, quizScore=0;

function buildQuiz(){ renderQuestion(); }
function renderQuestion(){
  const c = document.getElementById('quizContainer');
  if(quizIdx >= quizQuestions.length){
    const pct = Math.round((quizScore/quizQuestions.length)*100);
    c.innerHTML = `<div class="quiz-question-card quiz-score"><div class="big-num" style="color:${pct>=70?'var(--ecg-green)':'var(--warning)'}">${pct}%</div><p style="font-size:1.05rem;margin:0.8rem 0">${quizScore} of ${quizQuestions.length} correct</p><p style="color:var(--text-secondary)">${pct>=90?'Outstanding!':pct>=70?'Good job! Review missed concepts.':'Keep studying!'}</p><button class="ecg-btn" style="margin-top:1rem" onclick="quizIdx=0;quizScore=0;renderQuestion()">Retake Quiz</button></div>`;
    return;
  }
  const q = quizQuestions[quizIdx];
  let html = `<div class="quiz-question-card"><div class="quiz-progress">${quizQuestions.map((_,i)=>`<div class="quiz-dot ${i<quizIdx?'done':i===quizIdx?'current':''}"></div>`).join('')}</div><div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.4rem">Question ${quizIdx+1} of ${quizQuestions.length}</div><div class="quiz-q">${q.q}</div><div class="quiz-q-sub">${q.sub}</div>`;
  if(q.rhythm) html += `<div class="ecg-paper-bg" style="margin-bottom:1rem"><canvas id="quizRC" height="110"></canvas></div>`;
  html += `<div class="quiz-options">${q.options.map((o,i)=>`<button class="quiz-opt" onclick="checkAnswer(${i})">${o}</button>`).join('')}</div><div class="quiz-feedback" id="quizFb"></div><button class="quiz-next" id="quizNext" onclick="quizIdx++;renderQuestion()">Next ‚Üí</button></div>`;
  c.innerHTML = html;
  if(q.rhythm) setTimeout(()=>{
    const cv = document.getElementById('quizRC');
    if(!cv)return;
    cv.width = cv.parentElement.clientWidth;
    cv.height = 110;
    drawStaticRhythm(cv.getContext('2d'), cv.width, cv.height, q.rhythm);
  },80);
}
function checkAnswer(idx){
  const q = quizQuestions[quizIdx];
  const opts = document.querySelectorAll('.quiz-opt');
  const fb = document.getElementById('quizFb');
  opts.forEach((o,i)=>{ o.style.pointerEvents='none'; if(i===q.answer)o.classList.add('correct'); if(i===idx&&idx!==q.answer)o.classList.add('wrong'); });
  if(idx===q.answer){ quizScore++; fb.style.background='rgba(6,214,160,0.1)'; fb.style.color='var(--ecg-green)'; fb.innerHTML=`‚úì Correct! ${q.explain}`; }
  else { fb.style.background='rgba(230,57,70,0.1)'; fb.style.color='var(--arterial)'; fb.innerHTML=`‚úó Incorrect. ${q.explain}`; }
  fb.classList.add('show');
  document.getElementById('quizNext').classList.add('show');
}

// ================================================================
// INIT
// ================================================================
window.addEventListener('load', () => {
  buildECGControls();
  initECG();
  drawCompWaveform();
  buildGallery();
  buildQuiz();
  drawHeroEcg();
  setTimeout(startConductionAnim, 1000);
});
window.addEventListener('resize', () => {
  resizeECGCanvas();
  drawCompWaveform();
  drawHeroEcg();
});
</script>
</body>
</html>
